<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Garden State Parkway Runner (Babylon.js)</title>
  <style>
    html,body { margin:0; padding:0; width:100vw; height:100vh; overflow:hidden; background:#98b4d4; }
    #renderCanvas { width:100vw; height:100vh; display:block; }
    #msg {
      position:fixed; bottom:0; left:0; width:100vw; color:#fff; text-align:center; font-size:1.2em;
      font-family:sans-serif; text-shadow:0 0 7px #333;
      z-index:2; pointer-events:none;
    }
  </style>
</head>
<body>
<canvas id="renderCanvas"></canvas>
<div id="msg"></div>
<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script>
const canvas = document.getElementById('renderCanvas');
const engine = new BABYLON.Engine(canvas, true, {preserveDrawingBuffer:true, stencil:true});
const scene = new BABYLON.Scene(engine);
scene.clearColor = new BABYLON.Color4(0.54,0.77,0.92,1); // sky
scene.fogMode = BABYLON.Scene.FOGMODE_EXP2;
scene.fogDensity = 0.016;
scene.fogColor = scene.clearColor;

const camera = new BABYLON.FollowCamera("FollowCam", new BABYLON.Vector3(0,4,-8), scene);
camera.radius = 13; camera.heightOffset = 3.4; camera.rotationOffset = 0; camera.cameraAcceleration = 0.14; camera.maxCameraSpeed = 10;
camera.attachControl(canvas, true);
camera.lowerBetaLimit = 0.8; camera.upperBetaLimit = 1.2;

// Lights
const light1 = new BABYLON.HemisphericLight("hemi", new BABYLON.Vector3(0,1,0), scene);
light1.intensity = 0.95;

// Road
const roadWidth = 9, laneCount = 3, laneWidth = roadWidth/laneCount;
const roadMat = new BABYLON.StandardMaterial("roadMat", scene);
roadMat.diffuseColor = new BABYLON.Color3(0.26,0.26,0.26);

const road = BABYLON.MeshBuilder.CreateBox("road", {width:roadWidth, height:0.1, depth:160}, scene);
road.position = new BABYLON.Vector3(0,0,77);
road.material = roadMat;

// Lane Dashes
for(let lane=-1; lane<=1; lane++) {
  for(let i=0; i<30; i++) {
    let dash = BABYLON.MeshBuilder.CreateBox("dash", {width:0.12, height:0.025, depth:1.04}, scene);
    dash.position = new BABYLON.Vector3(lane*laneWidth,0.06,i*5-8);
    let dashMat = new BABYLON.StandardMaterial("dashMat", scene);
    dashMat.diffuseColor = new BABYLON.Color3(1,1,1);
    dash.material = dashMat;
  }
}

// Trees
for(let i=0; i<34; i++) {
  for(let side of [-1,1]) {
    let trunk = BABYLON.MeshBuilder.CreateCylinder("trunk",{diameterTop:0.17,diameterBottom:0.22,height:2.7},scene);
    trunk.position = new BABYLON.Vector3(side*(roadWidth/2+1.15+Math.random()*0.4),1.35,i*5-7+Math.random()*2);
    let trunkMat = new BABYLON.StandardMaterial("trunkMat",scene);
    trunkMat.diffuseColor = new BABYLON.Color3(0.49,0.36,0.19);
    trunk.material = trunkMat;
    // Foliage
    let leaf = BABYLON.MeshBuilder.CreateSphere("leaf",{diameter:1.02+Math.random()*0.33,segments:5},scene);
    leaf.position = new BABYLON.Vector3(trunk.position.x, trunk.position.y+1.23, trunk.position.z);
    let leafMat = new BABYLON.StandardMaterial("leafMat",scene);
    leafMat.diffuseColor = new BABYLON.Color3(0.17+Math.random()*0.05,0.51+Math.random()*0.18,0.18+Math.random()*0.1);
    leaf.material = leafMat;
  }
}

// Player Car
const playerColors = [new BABYLON.Color3(0.98,0.89,0.26),new BABYLON.Color3(0.29,0.8,0.39),new BABYLON.Color3(0.7,0.18,0.23)];
let playerLane = 1, laneTarget = 1, changingLane = false, laneLerp = 0;
const player = BABYLON.MeshBuilder.CreateBox("player", {width:1.04, height:0.6, depth:2.1}, scene);
player.position = new BABYLON.Vector3(0,0.33,2.7);
const playerMat = new BABYLON.StandardMaterial("playerMat",scene);
playerMat.diffuseColor = playerColors[0];
player.material = playerMat;

// Windshield
let windshield = BABYLON.MeshBuilder.CreateBox("windshield",{width:0.97,height:0.21,depth:0.7},scene);
windshield.position = new BABYLON.Vector3(0,0.68,0.45);
windshield.parent = player;
let windshieldMat = new BABYLON.StandardMaterial("wMat",scene);
windshieldMat.diffuseColor = new BABYLON.Color3(0.72,0.97,1); windshieldMat.alpha=0.73;
windshield.material = windshieldMat;

camera.lockedTarget = player;

// Traffic
const trafficColors = [
  new BABYLON.Color3(0.34,0.34,0.93), new BABYLON.Color3(1,0.35,0.23),
  new BABYLON.Color3(0.25,0.95,0.38), new BABYLON.Color3(1,0.82,0.2), new BABYLON.Color3(0.9,0.87,1)
];
const laneSpeeds = [0.38,0.3,0.22];
let playerZ = 2.7, speed = laneSpeeds[1], score = 0;
let traffic = [];

function createTrafficCar(lane, z) {
  let car = BABYLON.MeshBuilder.CreateBox("car",{width:1.02,height:0.62,depth:2},scene);
  car.position = new BABYLON.Vector3((lane-1)*laneWidth,0.33,z);
  let cMat = new BABYLON.StandardMaterial("carMat",scene);
  cMat.diffuseColor = trafficColors[Math.floor(Math.random()*trafficColors.length)];
  car.material = cMat;
  car.metadata = {lane,speed:laneSpeeds[lane],kind:'car'};
  // Wheels
  for(let dx of [-0.39,0.39]) {
    for(let dz of [-0.72,0.72]) {
      let w = BABYLON.MeshBuilder.CreateCylinder("w",{diameter:0.18,height:0.21},scene);
      w.rotation.x = Math.PI/2;
      w.position = new BABYLON.Vector3(dx,0.09,dz);
      w.parent = car;
      let wMat = new BABYLON.StandardMaterial("wMat",scene);
      wMat.diffuseColor = new BABYLON.Color3(0.11,0.11,0.11);
      w.material = wMat;
    }
  }
  traffic.push(car);
  return car;
}

function spawnCluster(zOffset=67) {
  let lanes = [0,1,2].sort(()=>Math.random()-0.5).slice(0,2+(Math.random()>0.7?1:0));
  for(let ln of lanes) createTrafficCar(ln, player.position.z+zOffset+Math.random()*3.2);
}
for(let i=0;i<11;i++) spawnCluster(i*15+17);

// Speeders and Cops
let effects = [];
function spawnSpeederAndCop() {
  let lanes = [0,1,2], lane = lanes[Math.floor(Math.random()*3)];
  // Speeder
  let speeder = BABYLON.MeshBuilder.CreateBox("speeder",{width:0.88,height:0.47,depth:1.59},scene);
  speeder.position = new BABYLON.Vector3((lane-1)*laneWidth,0.26,player.position.z+5);
  let spMat = new BABYLON.StandardMaterial("spMat",scene);
  spMat.diffuseColor = new BABYLON.Color3(0.13,0.22,0.95);
  speeder.material = spMat;
  speeder.metadata = {lane,speed:1.23,kind:'speeder',elapsed:0};
  effects.push(speeder);
  // Cop after delay
  setTimeout(()=>{
    let cop = BABYLON.MeshBuilder.CreateBox("cop",{width:1.01,height:0.59,depth:2.12},scene);
    cop.position = new BABYLON.Vector3((lane-1)*laneWidth,0.32,player.position.z+3.3);
    let copMat = new BABYLON.StandardMaterial("copMat",scene);
    copMat.diffuseColor = new BABYLON.Color3(0.14,0.14,0.14);
    cop.material = copMat;
    // Roof lights
    let lightbar = BABYLON.MeshBuilder.CreateBox("lightbar",{width:0.6,height:0.11,depth:0.3},scene);
    lightbar.position = new BABYLON.Vector3(0,0.66,0.38);
    lightbar.parent = cop;
    let lbMat = new BABYLON.StandardMaterial("lbMat",scene);
    lbMat.diffuseColor = new BABYLON.Color3(0.12,0.24,1);
    lightbar.material = lbMat;
    cop.metadata = {lane,speed:1.09,kind:'cop',flash:0,lightbar};
    effects.push(cop);
  },650);
}
let speederTimer = 2.6 + Math.random()*3.3;

// Controls
let msg = document.getElementById('msg');
let isMobile = /Mobi|Android/i.test(navigator.userAgent);
msg.textContent = isMobile ? "Swipe left/right to switch lanes!" : "Use â¬…ï¸ / âž¡ï¸ arrows to switch lanes!";

function goLeft()  { if (playerLane>0&&!changingLane) { laneTarget=--playerLane; changingLane=true; laneLerp=0; } }
function goRight() { if (playerLane<2&&!changingLane) { laneTarget=++playerLane; changingLane=true; laneLerp=0; } }

window.addEventListener('keydown',e=>{
  if(e.code==='ArrowLeft') goLeft();
  if(e.code==='ArrowRight') goRight();
  if(e.key==='r' && crashed) location.reload();
});

let tStartX=0, dx=0, swiping=false, crashed=false;
if(isMobile) {
  canvas.addEventListener('touchstart',e=>{ if(e.touches.length===1){tStartX=e.touches[0].clientX;dx=0;swiping=true;}});
  canvas.addEventListener('touchmove',e=>{ if(swiping){dx = e.touches[0].clientX-tStartX;}});
  canvas.addEventListener('touchend',e=>{
    if(swiping){
      if(dx < -25) goLeft();
      else if(dx > 25) goRight();
      swiping=false; dx=0;
    }
  });
}

// Game loop
scene.onBeforeRenderObservable.add(()=>{
  if (crashed) return;

  // Lane speeds
  speed = laneSpeeds[playerLane];
  playerZ += speed * engine.getDeltaTime()/66.5;
  player.position.z = playerZ;

  // Lane changing animation
  if (changingLane) {
    laneLerp += engine.getDeltaTime()/210;
    player.position.x = BABYLON.Scalar.Lerp(player.position.x, (playerLane-1)*laneWidth, laneLerp*1.11);
    if(Math.abs(player.position.x-(playerLane-1)*laneWidth)<0.035) {
      player.position.x = (playerLane-1)*laneWidth;
      changingLane=false;
    }
  }

  // Move camera forward
  camera.target = player;

  // Traffic logic
  for(let car of traffic) {
    car.position.z -= speed * engine.getDeltaTime()/66.5;
    if(car.position.z < player.position.z-12.5) { car.dispose(); car.metadata.dead=true; }
    // Collision
    if(!car.metadata.dead && Math.abs(car.position.z-player.position.z)<1.15 && Math.abs(car.position.x-player.position.x)<0.68) {
      crashed = true;
      msg.textContent = "ðŸ’¥ CRASHED! Tap or press R to restart. Score: " + Math.floor(player.position.z*2);
      if(isMobile) canvas.addEventListener('touchend',()=>location.reload(),{once:true});
    }
  }
  // Prune old traffic, add new
  while(traffic.length && (traffic[0].metadata.dead || traffic[0].position.z<player.position.z-12.5)) traffic.shift();
  if(traffic.length<12) spawnCluster(38+Math.random()*18);

  // Animate speeders/cops
  for(let i=effects.length-1;i>=0;i--) {
    let obj = effects[i];
    if(obj.metadata.kind==='speeder') {
      obj.position.z += obj.metadata.speed;
      obj.metadata.elapsed += engine.getDeltaTime()/1000;
      if(obj.position.z > player.position.z+66) { obj.dispose(); effects.splice(i,1);}
    } else if(obj.metadata.kind==='cop') {
      obj.position.z += obj.metadata.speed;
      // Roof light bar flash
      if(obj.metadata.lightbar)
        obj.metadata.lightbar.material.diffuseColor = Math.random()>0.52 ? new BABYLON.Color3(1,0.15,0.19): new BABYLON.Color3(0.12,0.24,1);
      if(obj.position.z > player.position.z+66) { obj.dispose(); effects.splice(i,1);}
    }
  }
  // Speeders/cops spawner
  speederTimer -= engine.getDeltaTime()/1000;
  if(speederTimer<=0) {
    spawnSpeederAndCop();
    speederTimer = 3.2+Math.random()*6;
  }

  // Score
  score = Math.floor(player.position.z*2);
  if(!crashed) msg.textContent = (isMobile ? "Swipe":"Use â¬…ï¸/âž¡ï¸") + " to switch lanes! | Score: " + score;
});

engine.runRenderLoop(()=>scene.render());
window.addEventListener("resize",()=>engine.resize());
</script>
</body>
</html>