<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>UPC Scanner</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f5f5f5;
      text-align: center;
      margin: 0;
      padding: 20px;
    }
    h1 {
      margin-bottom: 20px;
    }
    #scanner-container {
      position: relative;
      width: 100%;
      max-width: 640px;
      margin: 0 auto;
      border: 2px solid #333;
      background: #000;
    }
    #video-container {
      width: 100%;
      height: auto;
    }
    #scan-line {
      position: absolute;
      left: 0;
      width: 100%;
      height: 2px;
      background: red;
      animation: scan 3s linear infinite;
    }
    @keyframes scan {
      0% { top: 0; }
      100% { top: 100%; }
    }
    #confidence-meter {
      width: 100%;
      height: 10px;
      background: #eee;
      margin-top: 5px;
    }
    #confidence-bar {
      width: 0%;
      height: 100%;
      background: green;
    }
    #upc-result {
      width: 80%;
      padding: 10px;
      font-size: 16px;
      margin: 10px auto;
      display: block;
    }
    .btn {
      padding: 10px 20px;
      font-size: 16px;
      margin: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>UPC Scanner</h1>
  <div id="scanner-container">
    <div id="video-container"></div>
    <div id="scan-line"></div>
  </div>
  <div id="confidence-meter">
    <div id="confidence-bar"></div>
  </div>
  <input type="text" id="upc-result" placeholder="Scanned UPC" readonly>
  <div>
    <button id="copy-button" class="btn">Copy UPC</button>
    <button id="google-button" class="btn">Google Images</button>
  </div>

  <!-- Include Quagga.js from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <script>
    (function() {
      // Configuration parameters
      const detectionThreshold = 0.8; // Minimum confidence required
      const consecutiveRequired = 3;  // Consecutive detections required to lock in UPC
      let consecutiveCount = 0;
      let lastDetectedCode = "";
      let locked = false;

      // Initialize the scanner using Quagga.js
      function initScanner() {
        Quagga.init({
          inputStream: {
            type: "LiveStream",
            constraints: {
              width: { min: 640 },
              height: { min: 480 },
              facingMode: "environment"
            },
            target: document.querySelector("#video-container")
          },
          decoder: {
            // Support both UPC-A and UPC-E
            readers: ["upc_reader", "upc_e_reader"]
          },
          locate: true
        }, function(err) {
          if (err) {
            console.error(err);
            return;
          }
          Quagga.start();
        });

        // Use onProcessed for real-time visual feedback on confidence
        Quagga.onProcessed(function(result) {
          if (result && result.codeResult) {
            let score = result.codeResult.score || 0;
            updateConfidence(score);
          } else {
            updateConfidence(0);
          }
        });

        // Handle barcode detections
        Quagga.onDetected(handleDetection);
      }

      // Handle detected barcodes with consecutive matching logic
      function handleDetection(result) {
        if (locked || !result.codeResult) return;
        let code = result.codeResult.code;
        let score = result.codeResult.score || 0;

        if (score >= detectionThreshold) {
          if (code === lastDetectedCode) {
            consecutiveCount++;
          } else {
            consecutiveCount = 1;
            lastDetectedCode = code;
          }
          if (consecutiveCount >= consecutiveRequired) {
            lockUPC(code);
          }
        } else {
          consecutiveCount = 0;
          lastDetectedCode = "";
        }
      }

      // Update the confidence meter UI
      function updateConfidence(score) {
        let percentage = Math.min(100, Math.floor(score * 100));
        document.getElementById("confidence-bar").style.width = percentage + "%";
      }

      // Lock in the UPC code and display it in the input field
      function lockUPC(code) {
        locked = true;
        document.getElementById("upc-result").value = code;
        // Optionally, you can stop the scanner if desired:
        // Quagga.stop();
      }

      // Copy the UPC to the clipboard
      function copyUPC() {
        let upc = document.getElementById("upc-result").value;
        if (!upc) return;
        navigator.clipboard.writeText(upc)
          .then(() => alert("UPC copied to clipboard!"))
          .catch(err => alert("Error copying UPC: " + err));
      }

      // Open a Google Images search for the UPC in a new tab
      function googleSearchUPC() {
        let upc = document.getElementById("upc-result").value;
        if (!upc) return;
        let url = "https://www.google.com/search?tbm=isch&q=" + encodeURIComponent(upc);
        window.open(url, "_blank");
      }

      // Initialize event listeners for buttons
      function initEvents() {
        document.getElementById("copy-button").addEventListener("click", copyUPC);
        document.getElementById("google-button").addEventListener("click", googleSearchUPC);
      }

      // Start the application
      function startApp() {
        initScanner();
        initEvents();
      }

      // Kick off the app on page load
      document.addEventListener("DOMContentLoaded", startApp);
    })();
  </script>
</body>
</html>
