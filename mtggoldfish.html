<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MTG Mobile Goldfisher</title>
    <style>
        :root {
            --bg-color: #121212;
            --zone-bg: #1e1e1e;
            --highlight-color: #00bcd4;
            --text-color: #e0e0e0;
            --card-width: 90px;  /* Smaller for mobile */
            --card-height: 125px;
            --card-back-url: url('https://backs.scryfall.io/large/back/1/1/11111111-1111-1111-1111-111111111111.jpg');
        }

        /* --- SCREEN LOCKING & BASICS --- */
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: sans-serif;
            overflow: hidden; /* CRITICAL: Disables scrolling */
            touch-action: none; /* CRITICAL: Disables browser gestures */
            overscroll-behavior: none; /* Disables bounce effect */
            user-select: none;
            -webkit-user-select: none;
        }

        /* --- LAYOUT --- */
        .screen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            z-index: 10;
            background: var(--bg-color);
        }

        .hidden { display: none !important; }

        /* --- BATTLEFIELD GRID --- */
        #battlefield-screen {
            display: grid;
            grid-template-columns: 25% 50% 25%; /* Left/Right cols smaller */
            grid-template-rows: 50px 1fr 160px; /* Top bar, Field, Hand */
            gap: 5px;
            padding: 5px;
            box-sizing: border-box;
            padding-bottom: 20px; /* Safety for Home Bar */
        }

        /* --- ZONES --- */
        .zone {
            background-color: var(--zone-bg);
            border: 1px dashed #444;
            border-radius: 6px;
            position: relative;
            overflow: hidden; /* Cards stay inside unless dragged */
        }

        .zone-label {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(255,255,255,0.1);
            font-size: 1.2rem;
            font-weight: 800;
            pointer-events: none;
            text-transform: uppercase;
            text-align: center;
        }

        /* Top Bar */
        #top-bar {
            grid-column: 1 / 4;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #222;
            border-radius: 4px;
            padding: 0 10px;
        }

        /* Middle Row */
        #commander-zone { grid-column: 1 / 2; grid-row: 2 / 3; height: 140px; }
        #battlefield-zone { 
            grid-column: 2 / 3; 
            grid-row: 2 / 3; 
            display: flex; 
            flex-wrap: wrap; 
            align-content: flex-start; 
            overflow-y: auto; /* Allow scrolling INSIDE the field */
            gap: 5px;
            padding: 5px;
        }
        .right-col { grid-column: 3 / 4; grid-row: 2 / 3; display: flex; flex-direction: column; gap: 5px; }
        #graveyard-zone, #exile-zone { flex-grow: 1; }

        /* Bottom Row (Hand) */
        #bottom-area {
            grid-column: 1 / 4;
            grid-row: 3 / 4;
            display: flex;
            gap: 5px;
            overflow: hidden;
        }
        #library-zone { width: 80px; position: relative; cursor: pointer; }
        #hand-zone {
            flex-grow: 1;
            display: flex;
            flex-wrap: nowrap;
            overflow-x: auto; /* Horizontal scroll for hand */
            align-items: center;
            gap: -20px; /* Slight overlap */
            padding: 0 10px;
            background: #181818;
            border-top: 2px solid #333;
        }

        /* --- CARD STYLING --- */
        .mtg-card {
            width: var(--card-width);
            height: var(--card-height);
            background-color: #333;
            border-radius: 5px;
            background-size: cover;
            background-position: center;
            flex-shrink: 0; /* Don't squash in hand */
            box-shadow: 1px 1px 4px rgba(0,0,0,0.5);
            /* Touch settings */
            touch-action: none; /* PREVENTS SCROLLING WHEN TOUCHING CARD */
        }
        
        .mtg-card.tapped {
            transform: rotate(90deg);
            opacity: 0.8;
        }

        /* DRAGGING GHOST (The card following your finger) */
        #drag-ghost {
            position: fixed;
            width: var(--card-width);
            height: var(--card-height);
            opacity: 0.8;
            pointer-events: none; /* Click through to elements below */
            z-index: 9999;
            transform: scale(1.1);
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            display: none;
            background-size: cover;
            border-radius: 5px;
        }

        /* Highlight Zone on Drag */
        .zone.drag-active { border-color: var(--highlight-color); background: rgba(0,255,255,0.05); }

        /* --- IMPORT SCREEN STYLES --- */
        .input-group { margin: 15px 0; width: 90%; }
        textarea { width: 100%; height: 150px; background: #333; color: white; border: none; padding: 10px; }
        .btn { padding: 10px 20px; font-size: 1rem; border-radius: 5px; border: none; font-weight: bold; margin: 5px; }
        .btn-primary { background: var(--highlight-color); color: black; }
        
        /* Loading Spinner */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; display: flex; justify-content: center; align-items: center; }

    </style>
</head>
<body>

    <div id="drag-ghost"></div>

    <div id="loader" class="hidden"><h2 style="color:white;">Loading Deck...</h2></div>

    <div id="import-screen" class="screen" style="justify-content: center; align-items: center; overflow-y: auto;">
        <h2>Mobile Goldfisher</h2>
        
        <div class="input-group">
            <label>Paste Decklist:</label>
            <textarea id="deck-paste" placeholder="1 The Wise Mothman (PIP) 4..."></textarea>
        </div>

        <div class="input-group">
            <label>Card Back Image:</label>
            <input type="file" id="card-back-upload" accept="image/*" style="color: white;">
        </div>

        <button onclick="loadDeck()" class="btn btn-primary">START GAME</button>
    </div>

    <div id="battlefield-screen" class="screen hidden">
        
        <div id="top-bar">
            <span id="info-text">Turn 1</span>
            <button onclick="untapAll()" class="btn btn-primary" style="padding: 5px 15px; font-size: 0.8rem;">UNTAP</button>
        </div>

        <div id="commander-zone" class="zone" data-id="commander"><div class="zone-label">CMD</div></div>
        
        <div id="battlefield-zone" class="zone" data-id="battlefield"><div class="zone-label">FIELD</div></div>
        
        <div class="right-col">
            <div id="graveyard-zone" class="zone" data-id="graveyard"><div class="zone-label">GY</div></div>
            <div id="exile-zone" class="zone" data-id="exile"><div class="zone-label">EXILE</div></div>
        </div>

        <div id="bottom-area">
            <div id="library-zone" class="zone" onclick="drawCard()">
                <div class="zone-label" style="font-size: 0.8rem;">LIB <br><span id="lib-count">99</span></div>
            </div>
            <div id="hand-zone" class="zone" data-id="hand"><div class="zone-label">HAND</div></div>
        </div>
    </div>

<script>
    // --- STATE ---
    let gameState = {
        library: [], hand: [], battlefield: [], graveyard: [], exile: [], commander: []
    };
    
    // --- 1. SETUP & IMPORT ---
    
    async function loadDeck() {
        const text = document.getElementById('deck-paste').value;
        const fileInput = document.getElementById('card-back-upload');
        
        if(!text) return alert("Paste a decklist!");

        // Handle Custom Card Back Upload
        if(fileInput.files && fileInput.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.documentElement.style.setProperty('--card-back-url', `url('${e.target.result}')`);
            }
            reader.readAsDataURL(fileInput.files[0]);
        }

        document.getElementById('loader').classList.remove('hidden');

        // Parse Deck
        const deck = await parseDeck(text);
        
        // Init Game
        gameState.commander = deck.filter(c => c.isCommander);
        gameState.library = deck.filter(c => !c.isCommander);
        shuffle(gameState.library);
        
        // Draw 7
        gameState.hand = gameState.library.splice(0, 7);

        renderGame();
        
        document.getElementById('import-screen').classList.add('hidden');
        document.getElementById('battlefield-screen').classList.remove('hidden');
        document.getElementById('loader').classList.add('hidden');
    }

    async function parseDeck(text) {
        const lines = text.split('\n');
        let cards = [];
        let isCmd = true; // Assume first card is commander

        for(let line of lines) {
            // Regex for "1 Name (SET) 123"
            const match = line.match(/^(\d+)\s+(.+?)\s+\((\w+)\)\s+(\d+.*)$/);
            if(match) {
                const count = parseInt(match[1]);
                const set = match[3].toLowerCase();
                const cn = match[4].split(' ')[0];
                const img = `https://api.scryfall.com/cards/${set}/${cn}?format=image&version=large`;

                for(let i=0; i<count; i++) {
                    cards.push({
                        id: 'c' + Math.random().toString(36).substr(2, 9),
                        name: match[2],
                        img: img,
                        isCommander: isCmd && i===0
                    });
                    if(isCmd && i===0) isCmd = false; // Only first card is commander
                }
            }
        }
        return cards;
    }

    function shuffle(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
    }

    // --- 2. RENDERING ---

    function renderGame() {
        renderZone('hand');
        renderZone('commander');
        renderZone('battlefield');
        renderZone('graveyard');
        renderZone('exile');
        document.getElementById('lib-count').innerText = gameState.library.length;
    }

    function createCardEl(card) {
        const el = document.createElement('div');
        el.className = 'mtg-card';
        el.style.backgroundImage = `url('${card.img}')`;
        el.dataset.id = card.id;
        
        // TOUCH EVENTS FOR MOBILE DRAG
        el.addEventListener('touchstart', handleTouchStart, {passive: false});
        el.addEventListener('touchmove', handleTouchMove, {passive: false});
        el.addEventListener('touchend', handleTouchEnd);
        
        // Tap on click (short touch)
        el.addEventListener('click', () => el.classList.toggle('tapped'));

        return el;
    }

    function renderZone(zoneId) {
        const zone = document.getElementById(zoneId + '-zone');
        // Save label
        const label = zone.querySelector('.zone-label');
        zone.innerHTML = '';
        if(label) zone.appendChild(label);

        gameState[zoneId].forEach(card => {
            zone.appendChild(createCardEl(card));
        });
    }

    // --- 3. CUSTOM TOUCH DRAG ENGINE ---
    // Standard HTML5 DnD does NOT work on mobile. This replaces it.

    let dragSrcEl = null;
    let dragCardId = null;
    let ghost = document.getElementById('drag-ghost');
    let touchOffsetX = 0;
    let touchOffsetY = 0;

    function handleTouchStart(e) {
        // Prevent default to stop scrolling immediately
        e.preventDefault(); 
        
        const touch = e.touches[0];
        dragSrcEl = e.target;
        dragCardId = dragSrcEl.dataset.id;
        
        // Calculate offset so card doesn't jump to top-left of finger
        const rect = dragSrcEl.getBoundingClientRect();
        touchOffsetX = touch.clientX - rect.left;
        touchOffsetY = touch.clientY - rect.top;

        // Setup Ghost
        ghost.style.backgroundImage = dragSrcEl.style.backgroundImage;
        ghost.style.display = 'block';
        ghost.style.left = (touch.clientX - touchOffsetX) + 'px';
        ghost.style.top = (touch.clientY - touchOffsetY) + 'px';

        // Visually hide original
        dragSrcEl.style.opacity = '0.3';
    }

    function handleTouchMove(e) {
        e.preventDefault(); // LOCK SCREEN - Crucial!
        const touch = e.touches[0];

        // Move Ghost
        ghost.style.left = (touch.clientX - touchOffsetX) + 'px';
        ghost.style.top = (touch.clientY - touchOffsetY) + 'px';

        // Highlight zones under finger
        document.querySelectorAll('.zone').forEach(z => z.classList.remove('drag-active'));
        const elUnder = document.elementFromPoint(touch.clientX, touch.clientY);
        const zoneUnder = elUnder ? elUnder.closest('.zone') : null;
        if(zoneUnder) zoneUnder.classList.add('drag-active');
    }

    function handleTouchEnd(e) {
        ghost.style.display = 'none';
        if(dragSrcEl) dragSrcEl.style.opacity = '1';

        const touch = e.changedTouches[0];
        const elUnder = document.elementFromPoint(touch.clientX, touch.clientY);
        const zoneUnder = elUnder ? elUnder.closest('.zone') : null;

        if(zoneUnder) {
            const targetZoneId = zoneUnder.dataset.id;
            const sourceZoneId = dragSrcEl.parentElement.dataset.id;
            
            if(targetZoneId && targetZoneId !== sourceZoneId) {
                moveCard(dragCardId, sourceZoneId, targetZoneId);
            }
        }
        
        // Cleanup
        document.querySelectorAll('.zone').forEach(z => z.classList.remove('drag-active'));
        dragSrcEl = null;
    }

    function moveCard(id, from, to) {
        const idx = gameState[from].findIndex(c => c.id === id);
        if(idx > -1) {
            const card = gameState[from].splice(idx, 1)[0];
            gameState[to].push(card);
            renderGame();
        }
    }

    // --- 4. GAME ACTIONS ---
    
    window.drawCard = function() {
        if(gameState.library.length > 0) {
            gameState.hand.push(gameState.library.shift());
            renderGame();
        }
    }

    window.untapAll = function() {
        document.querySelectorAll('.tapped').forEach(e => e.classList.remove('tapped'));
    }

</script>
</body>
</html>
