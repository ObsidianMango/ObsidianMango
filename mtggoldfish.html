<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MTG Goldfish Final</title>
    <style>
        :root {
            --bg-color: #121212;
            --field-bg: #1a1a1a;
            --card-width: 85px;
            --card-height: 119px;
            --card-back-bg: url('https://backs.scryfall.io/large/back/1/1/11111111-1111-1111-1111-111111111111.jpg') center/cover;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--bg-color);
            color: white;
            font-family: sans-serif;
            overflow: hidden; 
            touch-action: none; 
            user-select: none; -webkit-user-select: none;
        }

        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; z-index: 10;
            background: var(--bg-color); 
            transition: opacity 0.3s;
        }
        .hidden { display: none !important; }

        /* --- 1. IMPORT SCREEN --- */
        #import-screen { padding: 20px; overflow-y: auto; box-sizing: border-box; }
        .input-group { margin-bottom: 15px; width: 100%; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #ccc; }
        textarea { width: 100%; height: 120px; background: #333; color: white; border: 1px solid #555; padding: 10px; border-radius: 4px;}
        input[type="text"], input[type="color"] { width: 100%; padding: 10px; background: #333; color: white; border: 1px solid #555; margin-top: 5px; border-radius: 4px;}
        input[type="color"] { height: 50px; padding: 2px; }
        .btn { padding: 15px; width: 100%; background: #00bcd4; border: none; font-weight: bold; border-radius: 4px; font-size: 1.1rem; color: black; margin-top: 10px; box-shadow: 0 4px 0 #008ba3;}
        .btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #008ba3; }

        /* --- 2. MULLIGAN SCREEN --- */
        #mulligan-screen { align-items: center; justify-content: center; background: #111; }
        #mulligan-hand { 
            display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; 
            padding: 10px; max-width: 100%; 
        }
        .mulligan-btn-group { display: flex; gap: 20px; margin-top: 30px; }
        .btn-keep { background: #4caf50; color: white; width: 120px; }
        .btn-mull { background: #f44336; color: white; width: 120px; }

        /* --- 3. GAME SCREEN --- */
        #game-screen { display: flex; flex-direction: column; }
        #top-bar { height: 40px; background: #222; display: flex; align-items: center; justify-content: space-between; padding: 0 10px; z-index: 20; border-bottom: 1px solid #444; }
        
        #battlefield {
            flex-grow: 1; position: relative;
            background-color: var(--field-bg);
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 20px 20px;
            overflow: hidden; 
        }

        .fixed-zone {
            position: absolute; width: 70px; height: 90px; right: 10px;
            border: 2px dashed #555; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.5); z-index: 5;
            font-size: 0.8rem; font-weight: bold; color: #aaa;
            text-align: center; pointer-events: none; 
        }
        #zone-gy { top: 10px; }
        #zone-exile { top: 110px; }
        .zone-highlight { border-color: #00bcd4; background: rgba(0, 188, 212, 0.2); }

        #hand-container {
            height: 150px; background: #0e0e0e; border-top: 2px solid #333;
            display: flex; align-items: center; overflow-x: auto; 
            padding-left: 10px; z-index: 20;
        }

        /* Library Deck Back */
        #library-btn {
            position: absolute; bottom: 160px; left: 10px;
            width: 65px; height: 91px;
            background: var(--card-back-bg);
            border-radius: 4px; box-shadow: 3px 3px 8px #000;
            z-index: 10; display: flex; align-items: center; justify-content: center;
            font-weight: bold; text-shadow: 1px 1px 2px black; font-size: 1.2rem;
            color: white; border: 1px solid #444;
        }

        /* --- CARD STYLES --- */
        .card {
            width: var(--card-width); height: var(--card-height);
            background-color: #222; border-radius: 5px;
            background-size: cover; background-position: center;
            box-shadow: 1px 1px 4px rgba(0,0,0,0.5);
            position: relative; flex-shrink: 0; margin-right: 8px;
            transform-origin: center center;
        }

        /* Name Overlay */
        .card-name {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.85); color: #fff;
            font-size: 10px; text-align: center; padding: 2px 0;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            border-bottom-left-radius: 5px; border-bottom-right-radius: 5px;
            pointer-events: none;
        }

        .card.on-field { position: absolute; margin: 0; z-index: 1; }
        .card.tapped { transform: rotate(90deg); }
        .card-loader {
            position: absolute; top: 50%; left: 50%;
            width: 20px; height: 20px;
            border: 3px solid #555; border-top: 3px solid #00bcd4;
            border-radius: 50%; animation: spin 1s linear infinite;
            transform: translate(-50%, -50%);
        }
        @keyframes spin { 0% {transform: translate(-50%, -50%) rotate(0deg);} 100% {transform: translate(-50%, -50%) rotate(360deg);} }

        /* Drag Ghost */
        #ghost {
            position: fixed; pointer-events: none; z-index: 9999;
            width: var(--card-width); height: var(--card-height);
            opacity: 0.6; display: none; background-size: cover; border-radius: 5px;
            box-shadow: 0 0 15px cyan;
        }
    </style>
</head>
<body>

    <div id="ghost"></div>

    <div id="import-screen" class="screen">
        <h2 style="color:#00bcd4;">MTG Goldfish Setup</h2>
        
        <div class="input-group">
            <label>Deck List</label>
            <textarea id="deck-input" placeholder="1 Sol Ring (PIP) 239..."></textarea>
        </div>

        <div class="input-group">
            <label>Card Back Style</label>
            <input type="text" id="back-url-input" placeholder="Image URL (Optional)">
            <div style="display:flex; align-items:center; gap:10px; margin-top:5px;">
                <span style="font-size:0.9rem;">Or Pick Color:</span>
                <input type="color" id="back-color-input" value="#333333">
            </div>
            <input type="file" id="back-file-input" accept="image/*" style="margin-top:10px;">
        </div>

        <button onclick="processDeck()" class="btn">DEAL HAND</button>
    </div>

    <div id="mulligan-screen" class="screen hidden">
        <h2 style="color:white; margin-bottom: 20px;">Opening Hand</h2>
        <div id="mulligan-hand"></div>
        <div class="mulligan-btn-group">
            <button onclick="mulligan()" class="btn btn-mull">MULLIGAN</button>
            <button onclick="keepHand()" class="btn btn-keep">KEEP</button>
        </div>
    </div>

    <div id="game-screen" class="screen hidden">
        <div id="top-bar">
            <span>Turn <span id="turn-count" style="color:#00bcd4; font-weight:bold;">1</span></span>
            <button onclick="untapAll()" style="background:#444; color:white; border:none; padding:8px 12px; border-radius:4px;">Untap All</button>
        </div>

        <div id="battlefield">
            <div id="zone-gy" class="fixed-zone">GRAVE<br>YARD</div>
            <div id="zone-exile" class="fixed-zone">EXILE</div>
        </div>

        <div id="library-btn" onclick="drawCard()">99</div>
        <div id="hand-container"></div>
    </div>

<script>
    // --- STATE ---
    let library = [];
    let currentHand = [];
    let zIndexCounter = 100;

    // --- 1. SETUP & PARSING ---
    async function processDeck() {
        const text = document.getElementById('deck-input').value;
        if(!text) return alert("Please paste a deck list.");

        // Card Back Logic
        const colorVal = document.getElementById('back-color-input').value;
        const urlVal = document.getElementById('back-url-input').value;
        const fileInput = document.getElementById('back-file-input').files[0];

        // Priority: File > URL > Color
        if (fileInput) {
            const reader = new FileReader();
            reader.onload = (e) => setBack(`url('${e.target.result}') center/cover`);
            reader.readAsDataURL(fileInput);
        } else if (urlVal) {
            setBack(`url('${urlVal}') center/cover`);
        } else {
            setBack(`${colorVal}`); // Plain color
        }

        // Parse & Shuffle
        library = await parseDeck(text);
        shuffle(library);

        // Draw 7 for Mulligan View
        dealOpeningHand();
        
        // Switch to Mulligan Screen
        document.getElementById('import-screen').classList.add('hidden');
        document.getElementById('mulligan-screen').classList.remove('hidden');
    }

    function setBack(cssValue) {
        document.documentElement.style.setProperty('--card-back-bg', cssValue);
    }

    async function parseDeck(text) {
        const lines = text.split('\n');
        let cards = [];
        let isCmd = true; 

        for(let line of lines) {
            const match = line.match(/^(\d+)\s+(.+?)\s+\((\w+)\)\s+(\d+.*)$/);
            if(match) {
                const count = parseInt(match[1]);
                const set = match[3].toLowerCase();
                const cn = match[4].split(' ')[0];
                const imgUrl = `https://api.scryfall.com/cards/${set}/${cn}?format=image&version=large`;

                for(let i=0; i<count; i++) {
                    const cardObj = {
                        id: 'c'+Math.random().toString(36).substr(2,9),
                        name: match[2],
                        img: imgUrl,
                        isCommander: (isCmd && i===0)
                    };

                    if(cardObj.isCommander) {
                        isCmd = false;
                        // Pre-load commander to field later
                        cardObj.startOnField = true;
                        cards.push(cardObj); 
                    } else {
                        cards.push(cardObj);
                    }
                }
            }
        }
        return cards;
    }

    function shuffle(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
    }

    // --- 2. MULLIGAN LOGIC ---
    function dealOpeningHand() {
        // Find Commander and separate it (it shouldn't be in hand)
        const cmdIndex = library.findIndex(c => c.startOnField);
        let cmd = null;
        if(cmdIndex > -1) {
            cmd = library.splice(cmdIndex, 1)[0];
            // We store it temporarily to add to field later
            window.commanderCard = cmd; 
        }

        // Draw 7
        currentHand = library.splice(0, 7);
        renderMulliganView();
    }

    function renderMulliganView() {
        const container = document.getElementById('mulligan-hand');
        container.innerHTML = '';
        currentHand.forEach(c => {
            const el = createCardElement(c);
            // Disable interactions for mulligan view
            el.style.pointerEvents = 'none'; 
            container.appendChild(el);
        });
    }

    function mulligan() {
        // Return hand to library
        library.push(...currentHand);
        currentHand = [];
        shuffle(library);
        
        // Draw new 7
        currentHand = library.splice(0, 7);
        renderMulliganView();
    }

    function keepHand() {
        document.getElementById('mulligan-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');

        // Render Hand to Game Hand Container
        currentHand.forEach(c => createCardInHand(c));

        // Render Commander to Field (Top Left)
        if(window.commanderCard) {
            createCardOnField(window.commanderCard, 20, 20);
        }

        updateCounts();
    }

    // --- 3. CARD FACTORY ---
    function createCardElement(cardData) {
        const el = document.createElement('div');
        el.className = 'card';
        el.dataset.id = cardData.id;

        // Loader
        const loader = document.createElement('div');
        loader.className = 'card-loader';
        el.appendChild(loader);

        // Name Tag
        const nameTag = document.createElement('div');
        nameTag.className = 'card-name';
        nameTag.innerText = cardData.name;
        el.appendChild(nameTag);

        // Image
        const img = new Image();
        img.src = cardData.img;
        img.onload = () => {
            el.style.backgroundImage = `url('${cardData.img}')`;
            if(el.contains(loader)) el.removeChild(loader);
        };

        // Interactions
        el.addEventListener('click', () => {
            if(el.parentElement.id === 'battlefield') el.classList.toggle('tapped');
        });

        // Touch
        el.addEventListener('touchstart', handleTouchStart, {passive: false});
        el.addEventListener('touchmove', handleTouchMove, {passive: false});
        el.addEventListener('touchend', handleTouchEnd);

        return el;
    }

    function createCardInHand(c) {
        document.getElementById('hand-container').appendChild(createCardElement(c));
    }

    function createCardOnField(c, x, y) {
        const el = createCardElement(c);
        el.classList.add('on-field');
        el.style.left = x + 'px';
        el.style.top = y + 'px';
        document.getElementById('battlefield').appendChild(el);
    }

    // --- 4. TOUCH ENGINE ---
    let dragItem = null;
    let ghost = document.getElementById('ghost');
    let touchOffsetX = 0, touchOffsetY = 0;
    let startX = 0, startY = 0;

    function handleTouchStart(e) {
        const touch = e.touches[0];
        startX = touch.clientX; startY = touch.clientY;
        
        const target = e.currentTarget;
        dragItem = target;
        const rect = target.getBoundingClientRect();
        touchOffsetX = touch.clientX - rect.left;
        touchOffsetY = touch.clientY - rect.top;
    }

    function handleTouchMove(e) {
        const touch = e.touches[0];
        if (Math.abs(touch.clientX - startX) > 5 || Math.abs(touch.clientY - startY) > 5) {
            e.preventDefault();
            
            if(ghost.style.display !== 'block') {
                ghost.style.display = 'block';
                ghost.style.backgroundImage = dragItem.style.backgroundImage;
                dragItem.style.opacity = '0.3';
            }
            ghost.style.left = (touch.clientX - touchOffsetX) + 'px';
            ghost.style.top = (touch.clientY - touchOffsetY) + 'px';
            checkZones(touch.clientX, touch.clientY);
        }
    }

    function handleTouchEnd(e) {
        ghost.style.display = 'none';
        document.querySelectorAll('.zone-highlight').forEach(z => z.classList.remove('zone-highlight'));

        if (!dragItem) return;
        dragItem.style.opacity = '1';

        const touch = e.changedTouches[0];
        if (Math.abs(touch.clientX - startX) < 10 && Math.abs(touch.clientY - startY) < 10) {
            dragItem = null; return; // Tap
        }

        finalizeDrop(touch.clientX, touch.clientY);
        dragItem = null;
    }

    function checkZones(x, y) {
        highlightZone('zone-gy', x, y);
        highlightZone('zone-exile', x, y);
    }

    function highlightZone(id, x, y) {
        const el = document.getElementById(id);
        const r = el.getBoundingClientRect();
        if(x > r.left && x < r.right && y > r.top && y < r.bottom) el.classList.add('zone-highlight');
        else el.classList.remove('zone-highlight');
    }

    function finalizeDrop(x, y) {
        const fieldRect = document.getElementById('battlefield').getBoundingClientRect();
        const handRect = document.getElementById('hand-container').getBoundingClientRect();
        const gyRect = document.getElementById('zone-gy').getBoundingClientRect();
        const exRect = document.getElementById('zone-exile').getBoundingClientRect();

        if(isInRect(x,y,gyRect)) return moveToZone(dragItem, 'zone-gy');
        if(isInRect(x,y,exRect)) return moveToZone(dragItem, 'zone-exile');

        if (y < handRect.top) {
            // Move to Field
            dragItem.classList.add('on-field');
            dragItem.style.position = 'absolute';
            dragItem.style.left = (x - fieldRect.left - touchOffsetX) + 'px';
            dragItem.style.top = (y - fieldRect.top - touchOffsetY) + 'px';
            dragItem.style.zIndex = zIndexCounter++;
            document.getElementById('battlefield').appendChild(dragItem);
        } else {
            // Move to Hand
            dragItem.classList.remove('on-field');
            dragItem.style.position = 'relative';
            dragItem.style.left = 'auto'; dragItem.style.top = 'auto';
            document.getElementById('hand-container').appendChild(dragItem);
        }
    }

    function isInRect(x, y, r) { return x > r.left && x < r.right && y > r.top && y < r.bottom; }

    function moveToZone(el, zoneId) {
        el.classList.add('on-field');
        el.style.position = 'absolute';
        const zone = document.getElementById(zoneId);
        const rect = zone.getBoundingClientRect();
        const fieldRect = document.getElementById('battlefield').getBoundingClientRect();
        
        el.style.left = (rect.left - fieldRect.left + 5) + 'px';
        el.style.top = (rect.top - fieldRect.top + 5) + 'px';
        el.style.transform = `rotate(${Math.floor(Math.random()*20)-10}deg)`;
        el.style.zIndex = zIndexCounter++;
        document.getElementById('battlefield').appendChild(el);
    }

    // --- 5. UTILS ---
    function drawCard() {
        if(library.length === 0) return;
        createCardInHand(library.shift());
        updateCounts();
    }
    function untapAll() {
        document.querySelectorAll('.tapped').forEach(e => e.classList.remove('tapped'));
        const tc = document.getElementById('turn-count');
        tc.innerText = parseInt(tc.innerText) + 1;
    }
    function updateCounts() {
        document.getElementById('library-btn').innerText = library.length;
    }
</script>
</body>
</html>
