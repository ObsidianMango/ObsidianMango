<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MTG Goldfish Pro</title>
    <style>
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --primary-color: #00bcd4;
            --accent-color: #ff4081;
            --field-bg: #1a1a1a;
            --card-width: 85px;
            --card-height: 119px;
            --card-back-bg: url('https://backs.scryfall.io/large/back/1/1/11111111-1111-1111-1111-111111111111.jpg') center/cover;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--bg-color);
            color: white;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            overflow: hidden; 
            touch-action: none; 
            user-select: none; -webkit-user-select: none;
        }

        /* --- SCREENS --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; z-index: 10;
            background: var(--bg-color); 
            transition: transform 0.3s ease-in-out, opacity 0.3s;
        }
        .hidden { display: none !important; }

        /* --- 1. SETUP HUB (New Opening Screen) --- */
        #setup-hub {
            align-items: center; justify-content: flex-start;
            padding: 20px; overflow-y: auto;
            background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
        }

        h1.main-title {
            font-size: 2.5rem; color: var(--primary-color);
            text-shadow: 0 0 10px rgba(0, 188, 212, 0.4);
            margin: 30px 0 10px 0; text-align: center;
        }
        p.subtitle { color: #888; margin-bottom: 40px; text-align: center; }

        .setup-options {
            display: flex; gap: 20px; width: 100%; max-width: 600px;
            margin-bottom: 30px; justify-content: center;
        }
        
        .option-card {
            flex: 1; background: var(--surface-color);
            border: 1px solid #333; border-radius: 12px;
            padding: 20px; text-align: center; cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .option-card:active { transform: scale(0.98); background: #252525; }
        .option-card h3 { margin: 10px 0 5px; color: white; }
        .option-card p { font-size: 0.8rem; color: #aaa; margin: 0; }
        .option-icon { font-size: 2rem; margin-bottom: 10px; display: block; }

        /* Custom Deck Input Area */
        #custom-deck-area {
            width: 100%; max-width: 600px;
            background: #222; padding: 20px; border-radius: 8px;
            display: none; /* Hidden by default */
            border: 1px solid #444;
        }
        .show-input #custom-deck-area { display: block; animation: slideDown 0.3s ease; }

        @keyframes slideDown { from {opacity:0; transform:translateY(-10px);} to {opacity:1; transform:translateY(0);} }

        textarea { 
            width: 100%; height: 100px; background: #111; color: #eee; 
            border: 1px solid #444; padding: 10px; border-radius: 4px; resize: none;
            font-family: monospace;
        }
        
        .action-btn {
            background: var(--primary-color); color: #000;
            border: none; padding: 12px; width: 100%;
            font-weight: bold; font-size: 1rem; border-radius: 6px;
            margin-top: 15px; cursor: pointer;
            box-shadow: 0 4px 0 #008ba3;
        }
        .action-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #008ba3; }

        /* --- PRECON BROWSER --- */
        #precon-browser {
            width: 100%; max-width: 800px; display: none;
        }
        .show-precons #precon-browser { display: block; animation: fadeIn 0.3s; }

        .series-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px; margin-top: 10px;
        }
        .series-card {
            background: #2a2a2a; border-radius: 8px; overflow: hidden;
            position: relative; height: 100px; cursor: pointer;
            border: 1px solid #444; transition: 0.2s;
        }
        .series-card:hover { border-color: var(--primary-color); }
        .series-img { width: 100%; height: 100%; object-fit: cover; opacity: 0.6; }
        .series-label {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.8); padding: 5px; font-size: 0.8rem;
            text-align: center; font-weight: bold;
        }

        /* --- MODAL (Deck Selection) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 100;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        
        .modal-content {
            background: #222; width: 90%; max-width: 400px; max-height: 80%;
            border-radius: 12px; padding: 20px; border: 1px solid #444;
            display: flex; flex-direction: column;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }
        .modal-header { font-size: 1.2rem; font-weight: bold; margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 10px;}
        .deck-list { overflow-y: auto; flex: 1; }
        .deck-item {
            padding: 15px; background: #333; margin-bottom: 10px;
            border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: space-between;
        }
        .deck-item:active { background: var(--primary-color); color: black; }
        .close-modal { margin-top: 10px; background: transparent; border: 1px solid #555; color: #888; padding: 10px; border-radius: 6px; width: 100%; }

        /* --- 2. MULLIGAN SCREEN --- */
        #mulligan-screen { align-items: center; justify-content: center; background: #111; }
        #mulligan-hand { 
            display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; 
            padding: 10px; max-width: 100%; 
        }
        
        /* Bigger cards for visibility */
        #mulligan-hand .card { width: 140px; height: 196px; }
        
        /* HIDDEN TEXT ON MULLIGAN SCREEN */
        #mulligan-hand .card-name { display: none !important; }

        .mulligan-btn-group { display: flex; gap: 20px; margin-top: 30px; }
        .btn-keep { background: #4caf50; color: white; width: 120px; }
        .btn-mull { background: #f44336; color: white; width: 120px; }
        .btn { border: none; padding: 15px; font-weight: bold; border-radius: 4px; font-size: 1rem; cursor: pointer; }

        /* --- 3. GAME SCREEN --- */
        #game-screen { display: flex; flex-direction: column; }
        #top-bar { height: 40px; background: #222; display: flex; align-items: center; justify-content: space-between; padding: 0 10px; z-index: 20; border-bottom: 1px solid #444; }
        
        #battlefield {
            flex-grow: 1; position: relative;
            background-color: var(--field-bg);
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 20px 20px;
            overflow: hidden; 
        }

        .fixed-zone {
            position: absolute; width: 70px; height: 90px; right: 10px;
            border: 2px dashed #555; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.5); z-index: 5;
            font-size: 0.8rem; font-weight: bold; color: #aaa;
            text-align: center; pointer-events: none; 
        }
        #zone-gy { top: 10px; }
        #zone-exile { top: 110px; }
        .zone-highlight { border-color: #00bcd4; background: rgba(0, 188, 212, 0.2); }

        #hand-container {
            height: 150px; background: #0e0e0e; border-top: 2px solid #333;
            display: flex; align-items: center; overflow-x: auto; 
            padding-left: 10px; z-index: 20;
        }

        #library-btn {
            position: absolute; bottom: 160px; left: 10px;
            width: 65px; height: 91px;
            background: var(--card-back-bg);
            border-radius: 4px; box-shadow: 3px 3px 8px #000;
            z-index: 10; display: flex; align-items: center; justify-content: center;
            font-weight: bold; text-shadow: 1px 1px 2px black; font-size: 1.2rem;
            color: white; border: 1px solid #444;
        }

        /* --- CARD STYLES --- */
        .card {
            width: var(--card-width); height: var(--card-height);
            background-color: #222; border-radius: 5px;
            background-size: cover; background-position: center;
            box-shadow: 1px 1px 4px rgba(0,0,0,0.5);
            position: relative; flex-shrink: 0; margin-right: 8px;
            transform-origin: center center;
        }

        /* Name Overlay - Centered in bottom half */
        .card-name {
            position: absolute; 
            top: 75%; transform: translateY(-50%);
            left: 5%; width: 90%;
            background: rgba(0,0,0,0.85); color: #fff;
            font-size: 10px; text-align: center; padding: 4px 0;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            border-radius: 5px; 
            pointer-events: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.6);
        }

        .card.on-field { position: absolute; margin: 0; z-index: 1; }
        .card.tapped { transform: rotate(90deg); }
        .card-loader {
            position: absolute; top: 50%; left: 50%;
            width: 20px; height: 20px;
            border: 3px solid #555; border-top: 3px solid #00bcd4;
            border-radius: 50%; animation: spin 1s linear infinite;
            transform: translate(-50%, -50%);
        }
        @keyframes spin { 0% {transform: translate(-50%, -50%) rotate(0deg);} 100% {transform: translate(-50%, -50%) rotate(360deg);} }

        /* Drag Ghost */
        #ghost {
            position: fixed; pointer-events: none; z-index: 9999;
            width: var(--card-width); height: var(--card-height);
            opacity: 0.6; display: none; background-size: cover; border-radius: 5px;
            box-shadow: 0 0 15px cyan;
        }
    </style>
</head>
<body>

    <div id="ghost"></div>

    <div id="setup-hub" class="screen">
        <h1 class="main-title">MTG Goldfish</h1>
        <p class="subtitle">Solo Testing Environment</p>

        <div class="setup-options">
            <div class="option-card" onclick="showSection('input')">
                <span class="option-icon">üìù</span>
                <h3>Paste Deck</h3>
                <p>Import text list</p>
            </div>
            <div class="option-card" onclick="showSection('precon')">
                <span class="option-icon">üì¶</span>
                <h3>Precons</h3>
                <p>Browse series</p>
            </div>
        </div>

        <div id="custom-deck-area">
            <label style="color:#ccc; font-weight:bold;">Deck List</label>
            <textarea id="deck-input" placeholder="1 Sol Ring (PIP) 239..."></textarea>
            
            <div style="margin-top:15px; display:flex; gap:10px; align-items:center;">
                <input type="color" id="back-color-input" value="#333333" style="height:40px; width:40px; padding:0; border:none;">
                <span style="font-size:0.8rem; color:#888;">Card Back Color</span>
            </div>

            <button onclick="processDeck()" class="action-btn">SHUFFLE & PLAY</button>
        </div>

        <div id="precon-browser">
            <h3 style="color:white; border-bottom:1px solid #333; padding-bottom:10px;">Select Series</h3>
            <div class="series-grid" id="series-grid">
                </div>
        </div>
    </div>

    <div id="deck-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header" id="modal-title">Select Deck</div>
            <div class="deck-list" id="modal-list"></div>
            <button class="close-modal" onclick="closeModal()">Cancel</button>
        </div>
    </div>

    <div id="mulligan-screen" class="screen hidden">
        <h2 style="color:white; margin-bottom: 20px;">Opening Hand</h2>
        <div id="mulligan-hand"></div>
        <div class="mulligan-btn-group">
            <button onclick="mulligan()" class="btn btn-mull">MULLIGAN</button>
            <button onclick="keepHand()" class="btn btn-keep">KEEP</button>
        </div>
    </div>

    <div id="game-screen" class="screen hidden">
        <div id="top-bar">
            <span>Turn <span id="turn-count" style="color:#00bcd4; font-weight:bold;">1</span></span>
            <button onclick="untapAll()" style="background:#444; color:white; border:none; padding:8px 12px; border-radius:4px;">Untap All</button>
        </div>

        <div id="battlefield">
            <div id="zone-gy" class="fixed-zone">GRAVE<br>YARD</div>
            <div id="zone-exile" class="fixed-zone">EXILE</div>
        </div>

        <div id="library-btn" onclick="drawCard()">99</div>
        <div id="hand-container"></div>
    </div>

<script>
    // --- PRECON DATA (Abbreviated for Demo) ---
    const PRECONS = {
        "LCC": {
            name: "Lost Caverns of Ixalan",
            img: "https://cards.scryfall.io/art_crop/front/c/c/ccf8fd83-c00a-45cd-b777-9aa208c70f64.jpg?1699971939",
            decks: [
                {
                    name: "Veloci-Ramp-Tor",
                    list: `1 Pantlaza, Sun-Favored (LCC) 4\n1 Sol Ring (LCC) 313\n1 Arcane Signet (LCC) 299\n1 Command Tower (LCC) 325\n1 Cultivate (LCC) 235\n1 Zacama, Primal Calamity (LCC) 296\n1 Ghalta, Primal Hunger (RIX) 130\n1 Etali, Primal Storm (LCC) 230\n1 Wakening Sun's Avatar (LCC) 125\n1 Temple Altisaur (LCC) 122\n1 Apex Altisaur (LCC) 232`
                },
                {
                    name: "Explorers of the Deep",
                    list: `1 Hakbal of the Surging Soul (LCC) 3\n1 Sol Ring (LCC) 313\n1 Merfolk Sovereign (LCC) 245\n1 Kumena, Tyrant of Orazca (LCC) 274\n1 Deeproot Elite (RIX) 127\n1 Simic Growth Chamber (LCC) 351\n1 Hinterland Harbor (LCC) 336\n1 Hardened Scales (LCC) 238\n1 Branching Evolution (LCC) 233`
                }
            ]
        },
        "LTC": {
            name: "Lord of the Rings",
            img: "https://cards.scryfall.io/art_crop/front/4/6/46d742aa-4931-4514-b7d5-e8e09155535e.jpg?1686970104",
            decks: [
                {
                    name: "Food and Fellowship",
                    list: `1 Frodo, Adventurous Hobbit (LTC) 2\n1 Sam, Loyal Attendant (LTC) 7\n1 Sol Ring (LTC) 284\n1 Arcane Signet (LTC) 273\n1 The Gaffer (LTC) 12\n1 Banquet Guests (LTC) 47\n1 Birds of Paradise (LTC) 275\n1 Chromatic Lantern (LTC) 277\n1 Graypelt Refuge (LTC) 316`
                },
                {
                    name: "Riders of Rohan",
                    list: `1 Eowyn, Shieldmaiden (LTC) 1\n1 Forth Eorlingas! (LTC) 56\n1 Sol Ring (LTC) 284\n1 Path to Exile (LTC) 105\n1 Combat Celebrant (AKH) 125\n1 Frontline Medic (LTC) 93\n1 Gilraen, Dunedain Protector (LTC) 13\n1 Clifftop Retreat (LTC) 304`
                }
            ]
        },
        "CMM": {
            name: "Commander Masters",
            img: "https://cards.scryfall.io/art_crop/front/2/6/265d9571-0672-46a2-938d-0b1965fbb606.jpg?1689797277",
            decks: [
                {
                    name: "Eldrazi Unbound",
                    list: `1 Zhulodok, Void Gorger (CMM) 704\n1 Sol Ring (CMM) 410\n1 Worn Powerstone (CMM) 984\n1 All Is Dust (CMM) 800\n1 Kozilek, the Great Distortion (CMM) 2\n1 It That Betrays (CMM) 805\n1 Endbringer (CMM) 802\n1 Geode Golem (CMM) 396\n1 Shrine of the Forsaken Gods (CMM) 1045`
                },
                {
                    name: "Sliver Swarm",
                    list: `1 Sliver Gravemother (CMM) 707\n1 Sol Ring (CMM) 410\n1 Sliver Hivelord (CMM) 937\n1 Cloudshredder Sliver (MH1) 195\n1 Galerider Sliver (CMM) 84\n1 Manaweft Sliver (CMM) 303\n1 Crystalline Sliver (CMM) 942\n1 Command Tower (CMM) 420`
                }
            ]
        }
    };

    // --- STATE ---
    let library = [];
    let currentHand = [];
    let zIndexCounter = 100;

    // --- INITIALIZATION ---
    function init() {
        const grid = document.getElementById('series-grid');
        Object.keys(PRECONS).forEach(key => {
            const set = PRECONS[key];
            const div = document.createElement('div');
            div.className = 'series-card';
            div.innerHTML = `
                <img src="${set.img}" class="series-img">
                <div class="series-label">${set.name}</div>
            `;
            div.onclick = () => openDeckModal(key);
            grid.appendChild(div);
        });
    }
    init();

    // --- UI NAVIGATION ---
    function showSection(type) {
        const wrapper = document.getElementById('setup-hub');
        if(type === 'input') {
            wrapper.classList.add('show-input');
            wrapper.classList.remove('show-precons');
        } else {
            wrapper.classList.add('show-precons');
            wrapper.classList.remove('show-input');
        }
    }

    function openDeckModal(key) {
        const set = PRECONS[key];
        document.getElementById('modal-title').innerText = set.name + " Decks";
        const list = document.getElementById('modal-list');
        list.innerHTML = '';
        
        set.decks.forEach(deck => {
            const item = document.createElement('div');
            item.className = 'deck-item';
            item.innerHTML = `<span>${deck.name}</span> <span style="font-size:1.2rem;">‚ûî</span>`;
            item.onclick = () => loadPrecon(deck.list);
            list.appendChild(item);
        });

        document.getElementById('deck-modal').classList.add('active');
    }

    function closeModal() {
        document.getElementById('deck-modal').classList.remove('active');
    }

    function loadPrecon(listText) {
        document.getElementById('deck-input').value = listText;
        closeModal();
        processDeck();
    }

    // --- 1. PARSING & GAME START ---
    async function processDeck() {
        const text = document.getElementById('deck-input').value;
        if(!text) return alert("Please paste a deck list or select a precon.");

        const colorVal = document.getElementById('back-color-input').value;
        setBack(`${colorVal}`);

        library = await parseDeck(text);
        shuffle(library);

        dealOpeningHand();
        
        document.getElementById('setup-hub').classList.add('hidden');
        document.getElementById('mulligan-screen').classList.remove('hidden');
    }

    function setBack(cssValue) {
        document.documentElement.style.setProperty('--card-back-bg', cssValue);
    }

    async function parseDeck(text) {
        const lines = text.split('\n');
        let cards = [];
        let isCmd = true; 

        for(let line of lines) {
            const match = line.match(/^(\d+)\s+(.+?)\s+\((\w+)\)\s+(\d+.*)$/);
            if(match) {
                const count = parseInt(match[1]);
                const set = match[3].toLowerCase();
                const cn = match[4].split(' ')[0];
                const imgUrl = `https://api.scryfall.com/cards/${set}/${cn}?format=image&version=large`;

                for(let i=0; i<count; i++) {
                    const cardObj = {
                        id: 'c'+Math.random().toString(36).substr(2,9),
                        name: match[2],
                        img: imgUrl,
                        isCommander: (isCmd && i===0)
                    };

                    if(cardObj.isCommander) {
                        isCmd = false;
                        cardObj.startOnField = true;
                        cards.push(cardObj); 
                    } else {
                        cards.push(cardObj);
                    }
                }
            }
        }
        return cards;
    }

    function shuffle(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
    }

    // --- 2. MULLIGAN LOGIC ---
    function dealOpeningHand() {
        const cmdIndex = library.findIndex(c => c.startOnField);
        let cmd = null;
        if(cmdIndex > -1) {
            cmd = library.splice(cmdIndex, 1)[0];
            window.commanderCard = cmd; 
        }

        currentHand = library.splice(0, 7);
        renderMulliganView();
    }

    function renderMulliganView() {
        const container = document.getElementById('mulligan-hand');
        container.innerHTML = '';
        currentHand.forEach(c => {
            const el = createCardElement(c);
            el.style.pointerEvents = 'none'; 
            container.appendChild(el);
        });
    }

    function mulligan() {
        library.push(...currentHand);
        currentHand = [];
        shuffle(library);
        currentHand = library.splice(0, 7);
        renderMulliganView();
    }

    function keepHand() {
        document.getElementById('mulligan-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');

        currentHand.forEach(c => createCardInHand(c));

        if(window.commanderCard) {
            createCardOnField(window.commanderCard, 20, 20);
        }
        updateCounts();
    }

    // --- 3. CARD FACTORY ---
    function createCardElement(cardData) {
        const el = document.createElement('div');
        el.className = 'card';
        el.dataset.id = cardData.id;

        const loader = document.createElement('div');
        loader.className = 'card-loader';
        el.appendChild(loader);

        const nameTag = document.createElement('div');
        nameTag.className = 'card-name';
        nameTag.innerText = cardData.name;
        el.appendChild(nameTag);

        const img = new Image();
        img.src = cardData.img;
        img.onload = () => {
            el.style.backgroundImage = `url('${cardData.img}')`;
            if(el.contains(loader)) el.removeChild(loader);
        };

        el.addEventListener('click', () => {
            if(el.parentElement.id === 'battlefield') el.classList.toggle('tapped');
        });

        el.addEventListener('touchstart', handleTouchStart, {passive: false});
        el.addEventListener('touchmove', handleTouchMove, {passive: false});
        el.addEventListener('touchend', handleTouchEnd);

        return el;
    }

    function createCardInHand(c) {
        document.getElementById('hand-container').appendChild(createCardElement(c));
    }

    function createCardOnField(c, x, y) {
        const el = createCardElement(c);
        el.classList.add('on-field');
        el.style.left = x + 'px';
        el.style.top = y + 'px';
        document.getElementById('battlefield').appendChild(el);
    }

    // --- 4. TOUCH ENGINE ---
    let dragItem = null;
    let ghost = document.getElementById('ghost');
    let touchOffsetX = 0, touchOffsetY = 0;
    let startX = 0, startY = 0;

    function handleTouchStart(e) {
        const touch = e.touches[0];
        startX = touch.clientX; startY = touch.clientY;
        
        const target = e.currentTarget;
        dragItem = target;
        const rect = target.getBoundingClientRect();
        touchOffsetX = touch.clientX - rect.left;
        touchOffsetY = touch.clientY - rect.top;
    }

    function handleTouchMove(e) {
        const touch = e.touches[0];
        if (Math.abs(touch.clientX - startX) > 5 || Math.abs(touch.clientY - startY) > 5) {
            e.preventDefault();
            
            if(ghost.style.display !== 'block') {
                ghost.style.display = 'block';
                ghost.style.backgroundImage = dragItem.style.backgroundImage;
                dragItem.style.opacity = '0.3';
            }
            ghost.style.left = (touch.clientX - touchOffsetX) + 'px';
            ghost.style.top = (touch.clientY - touchOffsetY) + 'px';
            checkZones(touch.clientX, touch.clientY);
        }
    }

    function handleTouchEnd(e) {
        ghost.style.display = 'none';
        document.querySelectorAll('.zone-highlight').forEach(z => z.classList.remove('zone-highlight'));

        if (!dragItem) return;
        dragItem.style.opacity = '1';

        const touch = e.changedTouches[0];
        if (Math.abs(touch.clientX - startX) < 10 && Math.abs(touch.clientY - startY) < 10) {
            dragItem = null; return; // Tap
        }

        finalizeDrop(touch.clientX, touch.clientY);
        dragItem = null;
    }

    function checkZones(x, y) {
        highlightZone('zone-gy', x, y);
        highlightZone('zone-exile', x, y);
    }

    function highlightZone(id, x, y) {
        const el = document.getElementById(id);
        const r = el.getBoundingClientRect();
        if(x > r.left && x < r.right && y > r.top && y < r.bottom) el.classList.add('zone-highlight');
        else el.classList.remove('zone-highlight');
    }

    function finalizeDrop(x, y) {
        const fieldRect = document.getElementById('battlefield').getBoundingClientRect();
        const handRect = document.getElementById('hand-container').getBoundingClientRect();
        const gyRect = document.getElementById('zone-gy').getBoundingClientRect();
        const exRect = document.getElementById('zone-exile').getBoundingClientRect();

        if(isInRect(x,y,gyRect)) return moveToZone(dragItem, 'zone-gy');
        if(isInRect(x,y,exRect)) return moveToZone(dragItem, 'zone-exile');

        if (y < handRect.top) {
            dragItem.classList.add('on-field');
            dragItem.style.position = 'absolute';
            dragItem.style.left = (x - fieldRect.left - touchOffsetX) + 'px';
            dragItem.style.top = (y - fieldRect.top - touchOffsetY) + 'px';
            dragItem.style.zIndex = zIndexCounter++;
            document.getElementById('battlefield').appendChild(dragItem);
        } else {
            dragItem.classList.remove('on-field');
            dragItem.style.position = 'relative';
            dragItem.style.left = 'auto'; dragItem.style.top = 'auto';
            document.getElementById('hand-container').appendChild(dragItem);
        }
    }

    function isInRect(x, y, r) { return x > r.left && x < r.right && y > r.top && y < r.bottom; }

    function moveToZone(el, zoneId) {
        el.classList.add('on-field');
        el.style.position = 'absolute';
        const zone = document.getElementById(zoneId);
        const rect = zone.getBoundingClientRect();
        const fieldRect = document.getElementById('battlefield').getBoundingClientRect();
        
        el.style.left = (rect.left - fieldRect.left + 5) + 'px';
        el.style.top = (rect.top - fieldRect.top + 5) + 'px';
        el.style.transform = `rotate(${Math.floor(Math.random()*20)-10}deg)`;
        el.style.zIndex = zIndexCounter++;
        document.getElementById('battlefield').appendChild(el);
    }

    // --- 5. UTILS ---
    function drawCard() {
        if(library.length === 0) return;
        createCardInHand(library.shift());
        updateCounts();
    }
    function untapAll() {
        document.querySelectorAll('.tapped').forEach(e => e.classList.remove('tapped'));
        const tc = document.getElementById('turn-count');
        tc.innerText = parseInt(tc.innerText) + 1;
    }
    function updateCounts() {
        document.getElementById('library-btn').innerText = library.length;
    }
</script>
</body>
</html>
