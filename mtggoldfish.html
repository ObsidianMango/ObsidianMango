<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MTG Goldfish Final</title>
    <style>
        :root {
            --bg-color: #121212;
            --field-bg: #1a1a1a;
            --accent: #00bcd4;
            
            /* DYNAMIC CARD SIZING VARIABLES */
            --card-width: 85px;
            --card-height: calc(var(--card-width) * 1.39);
            
            --card-back-bg: url('https://backs.scryfall.io/large/back/1/1/11111111-1111-1111-1111-111111111111.jpg') center/cover;
        }

        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            background-color: var(--bg-color);
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden; 
            touch-action: none; 
            user-select: none; -webkit-user-select: none;
        }

        /* --- UTILS --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; z-index: 10;
            background: var(--bg-color); 
            transition: opacity 0.3s;
        }
        .hidden { display: none !important; }
        
        /* Global Toggle for Text */
        body.hide-card-text .card-name { display: none !important; }

        /* --- 1. IMPORT SCREEN --- */
        #import-screen { 
            display: flex; flex-direction: column; 
            padding: 20px; box-sizing: border-box; 
            background: linear-gradient(135deg, #121212 0%, #1e1e1e 100%);
        }
        
        .import-header { text-align: center; margin-bottom: 20px; }
        .import-header h1 { margin: 0; color: var(--accent); letter-spacing: 1px; }
        .import-header p { margin: 5px 0 0; color: #777; font-size: 0.9rem; }

        .import-container {
            display: flex; gap: 20px; flex: 1; min-height: 0;
            flex-direction: row; 
        }
        @media (max-width: 768px) { .import-container { flex-direction: column; } }

        .panel { 
            flex: 1; background: #222; border-radius: 8px; padding: 15px; 
            border: 1px solid #333; display: flex; flex-direction: column;
        }
        .panel h3 { margin-top: 0; border-bottom: 2px solid var(--accent); padding-bottom: 10px; display: inline-block; }

        textarea { 
            flex: 1; width: 100%; background: #111; color: #ddd; 
            border: 1px solid #444; padding: 10px; border-radius: 4px; resize: none; 
            font-family: monospace; box-sizing: border-box;
        }

        #set-browser { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        #set-search {
            width: 100%; padding: 10px; background: #111; color: white;
            border: 1px solid #444; border-radius: 4px; margin-bottom: 10px;
            box-sizing: border-box;
        }
        #set-list {
            flex: 1; overflow-y: auto; display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
            gap: 10px; padding-right: 5px;
        }
        .set-item {
            background: #333; padding: 10px; border-radius: 4px; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; text-align: center;
            border: 1px solid #444; transition: 0.2s; position: relative;
        }
        .set-item:hover { background: #444; border-color: var(--accent); }
        .set-icon { width: 32px; height: 32px; margin-bottom: 5px; }
        .set-name { font-size: 0.8rem; font-weight: bold; color: #eee; }
        .set-code { font-size: 0.7rem; color: #888; text-transform: uppercase; margin-top: 2px;}

        .options-row { margin-top: 15px; display: flex; gap: 10px; align-items: center; justify-content: space-between; flex-wrap: wrap;}
        .card-back-picker { display: flex; align-items: center; gap: 10px; }
        input[type="color"] { height: 40px; border: none; background: none; cursor: pointer; }
        
        .main-btn {
            background: var(--accent); color: black; font-weight: bold;
            padding: 15px 30px; border: none; border-radius: 4px;
            font-size: 1.1rem; cursor: pointer; width: 100%; margin-top: 15px;
            box-shadow: 0 4px 0 #008ba3; transition: 0.1s;
        }
        .main-btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #008ba3; }

        /* --- PRECON MODAL --- */
        #precon-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 50;
            display: flex; flex-direction: column; padding: 20px; box-sizing: border-box;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .close-btn { background: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold;}
        
        #deck-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); 
            gap: 15px; overflow-y: auto; padding-bottom: 20px;
        }
        .deck-option {
            background: #222; border: 1px solid #444; border-radius: 6px;
            overflow: hidden; cursor: pointer; transition: transform 0.2s;
            display: flex; flex-direction: column;
        }
        .deck-option:hover { transform: scale(1.03); border-color: var(--accent); }
        .deck-img { width: 100%; height: 210px; background-size: cover; background-position: top center; }
        .deck-info { padding: 10px; text-align: center; }
        .deck-title { font-weight: bold; font-size: 0.9rem; color: var(--accent); }
        .deck-colors { margin-top: 5px; font-size: 0.8rem; color: #ccc; }

        /* --- 2. MULLIGAN SCREEN --- */
        #mulligan-screen { align-items: center; justify-content: center; background: #111; }
        #mulligan-hand { 
            display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; 
            padding: 10px; max-width: 100%; 
        }
        /* Specific Mulligan Size (Fixed large) */
        #mulligan-hand .card { width: 140px; height: 196px; }
        #mulligan-hand .card-name { display: none; }

        .mulligan-btn-group { display: flex; gap: 20px; margin-top: 30px; }
        .btn-keep { background: #4caf50; color: white; width: 120px; height: 50px; border:none; border-radius: 4px; font-weight: bold; font-size: 1.1rem; cursor: pointer;}
        .btn-mull { background: #f44336; color: white; width: 120px; height: 50px; border:none; border-radius: 4px; font-weight: bold; font-size: 1.1rem; cursor: pointer;}

        /* --- 3. GAME SCREEN --- */
        #game-screen { display: flex; flex-direction: column; }
        
        /* UPDATED TOP BAR */
        #top-bar { 
            height: 50px; background: #222; 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 0 10px; z-index: 20; border-bottom: 1px solid #444; 
        }
        .top-bar-left { display: flex; align-items: center; gap: 15px; font-weight: bold; font-size: 0.9rem;}
        .top-bar-right { display: flex; align-items: center; gap: 10px; }

        /* New Controls */
        #size-slider { width: 80px; accent-color: var(--accent); cursor: pointer; }
        .icon-btn { 
            background: #333; border: 1px solid #555; color: white; 
            width: 36px; height: 32px; border-radius: 4px; cursor: pointer; 
            font-weight: bold; display: flex; align-items: center; justify-content: center;
        }
        .icon-btn.active { background: var(--accent); color: black; border-color: var(--accent); }
        .untap-btn { background: #444; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: bold;}
        .untap-btn:active { background: #666; }

        #battlefield {
            flex-grow: 1; position: relative;
            background-color: var(--field-bg);
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 20px 20px;
            overflow: hidden; 
        }

        .fixed-zone {
            position: absolute; width: 70px; height: 90px; right: 10px;
            border: 2px dashed #555; border-radius: 6px;
            display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.5); z-index: 5;
            font-size: 0.8rem; font-weight: bold; color: #aaa;
            text-align: center; pointer-events: none; 
        }
        #zone-gy { top: 10px; }
        #zone-exile { top: 110px; }
        .zone-highlight { border-color: var(--accent); background: rgba(0, 188, 212, 0.2); }

        #hand-container {
            height: 160px; background: #0e0e0e; border-top: 2px solid #333;
            display: flex; align-items: center; overflow-x: auto; 
            padding-left: 10px; z-index: 20;
        }

        #library-btn {
            position: absolute; bottom: 170px; left: 10px;
            width: 65px; height: 91px;
            background: var(--card-back-bg);
            border-radius: 4px; box-shadow: 3px 3px 8px #000;
            z-index: 10; display: flex; align-items: center; justify-content: center;
            font-weight: bold; text-shadow: 1px 1px 2px black; font-size: 1.2rem;
            color: white; border: 1px solid #444;
        }

        /* --- CARD STYLES --- */
        .card {
            width: var(--card-width); height: var(--card-height);
            background-color: #222; border-radius: 5px;
            background-size: cover; background-position: center;
            box-shadow: 1px 1px 4px rgba(0,0,0,0.5);
            position: relative; flex-shrink: 0; margin-right: 8px;
            transform-origin: center center;
        }

        /* Name Overlay */
        .card-name {
            position: absolute; 
            top: 75%; transform: translateY(-50%);
            left: 5%; width: 90%;
            background: rgba(0,0,0,0.85); color: #fff;
            font-size: 10px; text-align: center; padding: 4px 0;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            border-radius: 5px; pointer-events: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.6);
        }

        .card.on-field { position: absolute; margin: 0; z-index: 1; }
        .card.tapped { transform: rotate(90deg); }
        .card-loader {
            position: absolute; top: 50%; left: 50%;
            width: 20px; height: 20px;
            border: 3px solid #555; border-top: 3px solid var(--accent);
            border-radius: 50%; animation: spin 1s linear infinite;
            transform: translate(-50%, -50%);
        }
        @keyframes spin { 0% {transform: translate(-50%, -50%) rotate(0deg);} 100% {transform: translate(-50%, -50%) rotate(360deg);} }

        #global-loader {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.8); z-index: 200;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner { width: 50px; height: 50px; border: 5px solid #333; border-top: 5px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }

        #ghost {
            position: fixed; pointer-events: none; z-index: 9999;
            width: var(--card-width); height: var(--card-height);
            opacity: 0.6; display: none; background-size: cover; border-radius: 5px;
            box-shadow: 0 0 15px cyan;
        }
    </style>
</head>
<body>

    <div id="ghost"></div>
    <div id="global-loader" class="hidden"><div class="spinner"></div><p style="margin-top:20px; font-weight:bold;">Fetching Cards...</p></div>

    <div id="precon-modal" class="hidden">
        <div class="modal-header">
            <h2 id="modal-title" style="margin:0; color:var(--accent);">Select Deck</h2>
            <button class="close-btn" onclick="closePreconModal()">CLOSE</button>
        </div>
        <p style="color:#aaa; font-size:0.9rem; margin-top:-10px; margin-bottom:15px;">
            Select a Commander below to auto-generate a 100-card deck (Commander + 99).
        </p>
        <div id="deck-grid"></div>
    </div>

    <div id="import-screen" class="screen">
        <div class="import-header">
            <h1>MTG GOLDFISH</h1>
            <p>Deck Tester & Precon Browser</p>
        </div>

        <div class="import-container">
            <div class="panel">
                <h3>Custom Deck</h3>
                <textarea id="deck-input" placeholder="1 Sol Ring (PIP) 239...&#10;1 Command Tower"></textarea>
                <div class="options-row">
                    <div class="card-back-picker">
                        <span>Back:</span>
                        <input type="color" id="back-color-input" value="#333333">
                        <input type="text" id="back-url-input" placeholder="URL" style="width:80px; padding:5px; background:#333; color:white; border:1px solid #555;">
                    </div>
                </div>
                <button onclick="processDeck()" class="main-btn">DEAL HAND</button>
            </div>

            <div class="panel" id="set-browser">
                <h3>Browse Precon Sets</h3>
                <input type="text" id="set-search" placeholder="Search Commander Sets..." onkeyup="filterSets()">
                <div id="set-list">
                    <div style="color:#777; padding:20px; text-align:center; width:100%;">Loading Sets...</div>
                </div>
            </div>
        </div>
    </div>

    <div id="mulligan-screen" class="screen hidden">
        <h2 style="color:white; margin-bottom: 20px;">Opening Hand</h2>
        <div id="mulligan-hand"></div>
        <div class="mulligan-btn-group">
            <button onclick="mulligan()" class="btn-mull">MULLIGAN</button>
            <button onclick="keepHand()" class="btn-keep">KEEP</button>
        </div>
    </div>

    <div id="game-screen" class="screen hidden">
        <div id="top-bar">
            <div class="top-bar-left">
                <span>Turn <span id="turn-count" style="color:var(--accent);">1</span></span>
            </div>
            <div class="top-bar-right">
                <input type="range" id="size-slider" min="50" max="150" value="85" title="Card Size" oninput="adjustCardSize(this.value)">
                <button id="toggle-text-btn" class="icon-btn active" onclick="toggleCardText()" title="Toggle Card Text">Aa</button>
                <button onclick="untapAll()" class="untap-btn">Untap</button>
            </div>
        </div>

        <div id="battlefield">
            <div id="zone-gy" class="fixed-zone">GRAVE<br>YARD</div>
            <div id="zone-exile" class="fixed-zone">EXILE</div>
        </div>

        <div id="library-btn" onclick="drawCard()">99</div>
        <div id="hand-container"></div>
    </div>

<script>
    // --- STATE ---
    let library = [];
    let currentHand = [];
    let zIndexCounter = 100;
    let allSets = [];

    // --- 0. NEW UI FUNCTIONS ---
    function adjustCardSize(val) {
        document.documentElement.style.setProperty('--card-width', val + 'px');
        // Height is automatically calculated in CSS via calc(), but we need to ensure consistency
    }

    function toggleCardText() {
        document.body.classList.toggle('hide-card-text');
        const btn = document.getElementById('toggle-text-btn');
        if(document.body.classList.contains('hide-card-text')) {
            btn.classList.remove('active');
            btn.style.color = '#777';
        } else {
            btn.classList.add('active');
            btn.style.color = 'black';
        }
    }

    // --- INITIALIZATION ---
    window.onload = async () => {
        try {
            const resp = await fetch('https://api.scryfall.com/sets');
            const data = await resp.json();
            // Filter only commander sets
            allSets = data.data.filter(s => s.set_type === 'commander' && s.card_count > 0);
            renderSets(allSets);
        } catch (e) {
            document.getElementById('set-list').innerHTML = '<div style="color:red">Error loading sets.</div>';
        }
    };

    // --- 1. SET BROWSER LOGIC ---
    function renderSets(sets) {
        const container = document.getElementById('set-list');
        container.innerHTML = '';
        
        sets.forEach(set => {
            const el = document.createElement('div');
            el.className = 'set-item';
            el.onclick = () => openPreconModal(set);
            
            const icon = document.createElement('img');
            icon.src = set.icon_svg_uri;
            icon.className = 'set-icon';
            
            const name = document.createElement('div');
            name.className = 'set-name';
            name.innerText = set.name;

            const code = document.createElement('div');
            code.className = 'set-code';
            code.innerText = set.code.toUpperCase();

            el.appendChild(icon);
            el.appendChild(name);
            el.appendChild(code);
            container.appendChild(el);
        });
    }

    function filterSets() {
        const query = document.getElementById('set-search').value.toLowerCase();
        const filtered = allSets.filter(s => s.name.toLowerCase().includes(query) || s.code.toLowerCase().includes(query));
        renderSets(filtered);
    }

    // --- 2. PRECON MODAL LOGIC ---
    async function openPreconModal(set) {
        document.getElementById('global-loader').classList.remove('hidden');
        document.getElementById('modal-title').innerText = set.name + " Decks";
        
        const query = `set:${set.code} (type:legendary type:creature) (rarity:mythic) -type:background`;
        const url = `https://api.scryfall.com/cards/search?q=${encodeURIComponent(query)}&order=edhrec`;

        try {
            const resp = await fetch(url);
            const json = await resp.json();
            
            const grid = document.getElementById('deck-grid');
            grid.innerHTML = '';

            if(!json.data || json.data.length === 0) {
                grid.innerHTML = '<p style="color:white; width:100%; text-align:center;">No Face Commanders found (Mythic Legends).</p>';
            } else {
                json.data.forEach(card => {
                    const el = document.createElement('div');
                    el.className = 'deck-option';
                    el.onclick = () => loadPreconFromCommander(card, set.code);

                    const art = card.image_uris ? card.image_uris.art_crop : (card.card_faces ? card.card_faces[0].image_uris.art_crop : '');
                    
                    const imgDiv = document.createElement('div');
                    imgDiv.className = 'deck-img';
                    imgDiv.style.backgroundImage = `url('${art}')`;

                    const info = document.createElement('div');
                    info.className = 'deck-info';
                    info.innerHTML = `<div class="deck-title">${card.name}</div><div class="deck-colors">Color ID: ${card.color_identity.join('') || 'C'}</div>`;

                    el.appendChild(imgDiv);
                    el.appendChild(info);
                    grid.appendChild(el);
                });
            }

            document.getElementById('global-loader').classList.add('hidden');
            document.getElementById('precon-modal').classList.remove('hidden');

        } catch(e) {
            alert("Error fetching commanders");
            document.getElementById('global-loader').classList.add('hidden');
        }
    }

    function closePreconModal() {
        document.getElementById('precon-modal').classList.add('hidden');
    }

    // --- 3. FETCHING PRECON ---
    async function loadPreconFromCommander(commander, setCode) {
        closePreconModal();
        document.getElementById('global-loader').classList.remove('hidden');
        
        const colors = commander.color_identity.join('');
        const colorQuery = colors.length === 0 ? `id:c` : `id<=${colors}`;
        const query = `set:${setCode} ${colorQuery} -type:token unique:cards game:paper`;
        let apiUrl = `https://api.scryfall.com/cards/search?q=${encodeURIComponent(query)}`;

        let allCards = [];
        let hasMore = true;

        try {
            while(hasMore) {
                const resp = await fetch(apiUrl);
                const json = await resp.json();
                if(json.data) allCards.push(...json.data);
                
                if(json.has_more) {
                    apiUrl = json.next_page;
                    await new Promise(r => setTimeout(r, 50)); 
                } else {
                    hasMore = false;
                }
            }

            allCards = allCards.filter(c => c.name !== commander.name);
            shuffle(allCards);
            if (allCards.length > 99) allCards = allCards.slice(0, 99);

            let parsedLibrary = allCards.map(c => {
                let img = 'https://backs.scryfall.io/large/back/1/1/11111111-1111-1111-1111-111111111111.jpg';
                if(c.image_uris) img = c.image_uris.large;
                else if(c.card_faces && c.card_faces[0].image_uris) img = c.card_faces[0].image_uris.large;

                return {
                    id: 'c' + Math.random().toString(36).substr(2, 9),
                    name: c.name,
                    img: img,
                    isCommander: false
                };
            });

            let cmdImg = commander.image_uris ? commander.image_uris.large : commander.card_faces[0].image_uris.large;
            parsedLibrary.push({
                id: 'cmd', name: commander.name, img: cmdImg, isCommander: true
            });

            startGameWithLibrary(parsedLibrary);

        } catch (e) {
            alert("Error loading deck.");
            console.error(e);
        } finally {
            document.getElementById('global-loader').classList.add('hidden');
        }
    }

    // --- 4. MANUAL IMPORT LOGIC ---
    async function processDeck() {
        const text = document.getElementById('deck-input').value;
        if(!text) return alert("Please paste a deck list.");

        const colorVal = document.getElementById('back-color-input').value;
        const urlVal = document.getElementById('back-url-input').value;

        if (urlVal) setBack(`url('${urlVal}') center/cover`);
        else setBack(`${colorVal}`);

        document.getElementById('global-loader').classList.remove('hidden');
        
        library = await parseDeck(text);
        startGameWithLibrary(library);
        document.getElementById('global-loader').classList.add('hidden');
    }

    function startGameWithLibrary(cards) {
        library = cards;
        shuffle(library);
        dealOpeningHand();
        
        document.getElementById('import-screen').classList.add('hidden');
        document.getElementById('mulligan-screen').classList.remove('hidden');
    }

    function setBack(cssValue) {
        document.documentElement.style.setProperty('--card-back-bg', cssValue);
    }

    async function parseDeck(text) {
        const lines = text.split('\n');
        let cards = [];
        let isCmd = true; 

        for(let line of lines) {
            const match = line.match(/^(\d+)\s+(.+?)\s*(\(.*\))?\s*(\d+.*)?$/); 
            if(match) {
                const count = parseInt(match[1]);
                const name = match[2].trim();
                
                const searchUrl = `https://api.scryfall.com/cards/named?fuzzy=${encodeURIComponent(name)}`;
                let imgUrl = '';
                
                try {
                    const resp = await fetch(searchUrl);
                    const json = await resp.json();
                    if(json.image_uris) imgUrl = json.image_uris.large;
                    else if(json.card_faces) imgUrl = json.card_faces[0].image_uris.large;
                } catch(e) { console.log("Card not found", name); }

                if(!imgUrl) continue;

                for(let i=0; i<count; i++) {
                    const cardObj = {
                        id: 'c'+Math.random().toString(36).substr(2,9),
                        name: name,
                        img: imgUrl,
                        isCommander: (isCmd && i===0)
                    };
                    if(cardObj.isCommander) isCmd = false;
                    cards.push(cardObj);
                }
            }
        }
        return cards;
    }

    function shuffle(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [arr[i], arr[j]] = [arr[j], arr[i]];
        }
    }

    // --- 5. GAMEPLAY LOGIC ---
    function dealOpeningHand() {
        const cmdIndex = library.findIndex(c => c.isCommander); 
        let cmd = null;
        if(cmdIndex > -1) {
            cmd = library.splice(cmdIndex, 1)[0];
            window.commanderCard = cmd; 
            window.commanderCard.startOnField = true;
        }
        currentHand = library.splice(0, 7);
        renderMulliganView();
    }

    function renderMulliganView() {
        const container = document.getElementById('mulligan-hand');
        container.innerHTML = '';
        currentHand.forEach(c => {
            const el = createCardElement(c);
            el.style.pointerEvents = 'none'; 
            container.appendChild(el);
        });
    }

    function mulligan() {
        library.push(...currentHand);
        currentHand = [];
        shuffle(library);
        currentHand = library.splice(0, 7);
        renderMulliganView();
    }

    function keepHand() {
        document.getElementById('mulligan-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        currentHand.forEach(c => createCardInHand(c));
        if(window.commanderCard) createCardOnField(window.commanderCard, 20, 20);
        updateCounts();
    }

    function createCardElement(cardData) {
        const el = document.createElement('div');
        el.className = 'card';
        el.dataset.id = cardData.id;

        const loader = document.createElement('div');
        loader.className = 'card-loader';
        el.appendChild(loader);

        const nameTag = document.createElement('div');
        nameTag.className = 'card-name';
        nameTag.innerText = cardData.name;
        el.appendChild(nameTag);

        const img = new Image();
        img.src = cardData.img;
        img.onload = () => {
            el.style.backgroundImage = `url('${cardData.img}')`;
            if(el.contains(loader)) el.removeChild(loader);
        };

        el.addEventListener('click', () => {
            if(el.parentElement.id === 'battlefield') el.classList.toggle('tapped');
        });
        el.addEventListener('touchstart', handleTouchStart, {passive: false});
        el.addEventListener('touchmove', handleTouchMove, {passive: false});
        el.addEventListener('touchend', handleTouchEnd);

        return el;
    }

    function createCardInHand(c) {
        document.getElementById('hand-container').appendChild(createCardElement(c));
    }

    function createCardOnField(c, x, y) {
        const el = createCardElement(c);
        el.classList.add('on-field');
        el.style.left = x + 'px';
        el.style.top = y + 'px';
        document.getElementById('battlefield').appendChild(el);
    }

    // --- 6. TOUCH ENGINE ---
    let dragItem = null;
    let ghost = document.getElementById('ghost');
    let touchOffsetX = 0, touchOffsetY = 0;
    let startX = 0, startY = 0;

    function handleTouchStart(e) {
        const touch = e.touches[0];
        startX = touch.clientX; startY = touch.clientY;
        const target = e.currentTarget;
        dragItem = target;
        const rect = target.getBoundingClientRect();
        touchOffsetX = touch.clientX - rect.left;
        touchOffsetY = touch.clientY - rect.top;
    }

    function handleTouchMove(e) {
        const touch = e.touches[0];
        if (Math.abs(touch.clientX - startX) > 5 || Math.abs(touch.clientY - startY) > 5) {
            e.preventDefault();
            if(ghost.style.display !== 'block') {
                ghost.style.display = 'block';
                ghost.style.backgroundImage = dragItem.style.backgroundImage;
                dragItem.style.opacity = '0.3';
            }
            ghost.style.left = (touch.clientX - touchOffsetX) + 'px';
            ghost.style.top = (touch.clientY - touchOffsetY) + 'px';
            checkZones(touch.clientX, touch.clientY);
        }
    }

    function handleTouchEnd(e) {
        ghost.style.display = 'none';
        document.querySelectorAll('.zone-highlight').forEach(z => z.classList.remove('zone-highlight'));
        if (!dragItem) return;
        dragItem.style.opacity = '1';
        const touch = e.changedTouches[0];
        if (Math.abs(touch.clientX - startX) < 10 && Math.abs(touch.clientY - startY) < 10) {
            dragItem = null; return; 
        }
        finalizeDrop(touch.clientX, touch.clientY);
        dragItem = null;
    }

    function checkZones(x, y) {
        highlightZone('zone-gy', x, y);
        highlightZone('zone-exile', x, y);
    }

    function highlightZone(id, x, y) {
        const el = document.getElementById(id);
        const r = el.getBoundingClientRect();
        if(x > r.left && x < r.right && y > r.top && y < r.bottom) el.classList.add('zone-highlight');
        else el.classList.remove('zone-highlight');
    }

    function finalizeDrop(x, y) {
        const fieldRect = document.getElementById('battlefield').getBoundingClientRect();
        const handRect = document.getElementById('hand-container').getBoundingClientRect();
        const gyRect = document.getElementById('zone-gy').getBoundingClientRect();
        const exRect = document.getElementById('zone-exile').getBoundingClientRect();

        if(isInRect(x,y,gyRect)) return moveToZone(dragItem, 'zone-gy');
        if(isInRect(x,y,exRect)) return moveToZone(dragItem, 'zone-exile');

        if (y < handRect.top) {
            dragItem.classList.add('on-field');
            dragItem.style.position = 'absolute';
            dragItem.style.left = (x - fieldRect.left - touchOffsetX) + 'px';
            dragItem.style.top = (y - fieldRect.top - touchOffsetY) + 'px';
            dragItem.style.zIndex = zIndexCounter++;
            document.getElementById('battlefield').appendChild(dragItem);
        } else {
            dragItem.classList.remove('on-field');
            dragItem.style.position = 'relative';
            dragItem.style.left = 'auto'; dragItem.style.top = 'auto';
            document.getElementById('hand-container').appendChild(dragItem);
        }
    }

    function isInRect(x, y, r) { return x > r.left && x < r.right && y > r.top && y < r.bottom; }

    function moveToZone(el, zoneId) {
        el.classList.add('on-field');
        el.style.position = 'absolute';
        const zone = document.getElementById(zoneId);
        const rect = zone.getBoundingClientRect();
        const fieldRect = document.getElementById('battlefield').getBoundingClientRect();
        el.style.left = (rect.left - fieldRect.left + 5) + 'px';
        el.style.top = (rect.top - fieldRect.top + 5) + 'px';
        el.style.transform = `rotate(${Math.floor(Math.random()*20)-10}deg)`;
        el.style.zIndex = zIndexCounter++;
        document.getElementById('battlefield').appendChild(el);
    }

    function drawCard() {
        if(library.length === 0) return;
        createCardInHand(library.shift());
        updateCounts();
    }
    function untapAll() {
        document.querySelectorAll('.tapped').forEach(e => e.classList.remove('tapped'));
        const tc = document.getElementById('turn-count');
        tc.innerText = parseInt(tc.innerText) + 1;
    }
    function updateCounts() {
        document.getElementById('library-btn').innerText = library.length;
    }
</script>
</body>
</html>
