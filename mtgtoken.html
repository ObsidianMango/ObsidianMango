<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MTG Token Master</title>
    <style>
        :root {
            --bg-color: #121212;
            --surface: #1e1e1e;
            --accent: #b08d55;
            --text-sub: #aaaaaa;
        }

        body {
            background-color: var(--bg-color);
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            margin: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overscroll-behavior-y: none;
        }

        /* --- Search Bar --- */
        .search-box {
            width: 100%;
            max-width: 600px;
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            position: sticky;
            top: 10px;
            z-index: 50;
        }

        input {
            flex: 1;
            padding: 14px;
            border-radius: 8px;
            border: 1px solid #333;
            background: #2a2a2a;
            color: white;
            font-size: 16px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        .btn-action {
            background: var(--accent);
            color: #000;
            border: none;
            border-radius: 8px;
            padding: 0 20px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        /* --- The Start Screen / Library --- */
        #library {
            width: 100%;
            max-width: 800px;
            display: none; /* Hidden if tokens exist */
        }
        
        .lib-category {
            margin-bottom: 25px;
        }
        
        .cat-title {
            color: var(--text-sub);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.8rem;
            margin-bottom: 10px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }

        .lib-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
        }

        .lib-item {
            background: var(--surface);
            border: 1px solid #333;
            padding: 15px 5px;
            border-radius: 8px;
            text-align: center;
            font-size: 0.9rem;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .lib-item:active { transform: scale(0.95); background: var(--accent); color: black; }

        /* --- Active Token Grid --- */
        #board {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
            width: 100%;
            max-width: 900px;
            padding-bottom: 100px;
        }

        .token-card {
            position: relative;
            aspect-ratio: 2.5/3.5;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.6);
            background: #222;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .card-bg {
            width: 100%; height: 100%;
            object-fit: cover;
        }

        /* The Overlay with Numbers */
        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0,0,0,0.25);
            pointer-events: none; /* Let clicks pass through */
            z-index: 10;
        }

        .counter {
            font-size: 5rem;
            font-weight: 800;
            color: white;
            text-shadow: 0 2px 0 #000, 0 -2px 0 #000, 2px 0 0 #000, -2px 0 0 #000, 2px 2px 0 #000;
        }

        /* Interaction Zones */
        .zone {
            position: absolute;
            top: 0; bottom: 0;
            z-index: 20;
        }
        /* Left 40% = Minus */
        .zone-left { left: 0; width: 40%; }
        /* Right 40% = Plus */
        .zone-right { right: 0; width: 40%; }
        /* Center 20% = Inspect */
        .zone-center { left: 40%; width: 20%; display: flex; align-items: flex-end; justify-content: center; padding-bottom: 10px; }
        
        .zone-icon {
            font-size: 1.5rem;
            opacity: 0.5;
            background: rgba(0,0,0,0.5);
            border-radius: 50%;
            padding: 5px;
            pointer-events: none;
        }

        /* Visual Feedback */
        .zone:active { background: rgba(255,255,255,0.1); }
        
        .btn-delete {
            position: absolute;
            top: 0; right: 0;
            background: #ff4444;
            color: white;
            border: none;
            width: 30px; height: 30px;
            z-index: 30;
            font-weight: bold;
            border-bottom-left-radius: 8px;
            cursor: pointer;
        }

        /* --- Full Screen Modal --- */
        #modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 200;
            justify-content: center;
            align-items: center;
            padding: 20px;
            backdrop-filter: blur(5px);
        }
        #modal img {
            max-width: 100%;
            max-height: 90vh;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }

        /* --- Search Results --- */
        #results {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding: 10px;
            width: 100%;
            max-width: 800px;
            margin-bottom: 20px;
        }
        .res-thumb {
            height: 150px;
            border-radius: 8px;
            cursor: pointer;
        }

    </style>
</head>
<body>

    <div class="search-box">
        <input type="text" id="searchInput" placeholder="Search (e.g. Map, Angel)...">
        <button class="btn-action" onclick="searchScryfall()">Find</button>
    </div>

    <div id="results"></div>

    <div id="library">
        
        <div class="lib-category">
            <div class="cat-title">Utilities</div>
            <div class="lib-grid">
                <div class="lib-item" onclick="quickAdd('Treasure')">üí∞ Treasure</div>
                <div class="lib-item" onclick="quickAdd('Food')">üçó Food</div>
                <div class="lib-item" onclick="quickAdd('Clue')">üîç Clue</div>
                <div class="lib-item" onclick="quickAdd('Map')">üó∫Ô∏è Map</div>
                <div class="lib-item" onclick="quickAdd('Blood')">ü©∏ Blood</div>
                <div class="lib-item" onclick="quickAdd('The One Ring')">üíç The Ring</div>
            </div>
        </div>

        <div class="lib-category">
            <div class="cat-title">Creatures</div>
            <div class="lib-grid">
                <div class="lib-item" onclick="quickAdd('Goblin')">üë∫ Goblin</div>
                <div class="lib-item" onclick="quickAdd('Zombie')">üßü Zombie</div>
                <div class="lib-item" onclick="quickAdd('Soldier')">üõ°Ô∏è Soldier</div>
                <div class="lib-item" onclick="quickAdd('Elf Warrior')">üßù Elf</div>
                <div class="lib-item" onclick="quickAdd('Angel')">üëº Angel</div>
                <div class="lib-item" onclick="quickAdd('Dragon')">üêâ Dragon</div>
                <div class="lib-item" onclick="quickAdd('Spirit')">üëª Spirit</div>
                <div class="lib-item" onclick="quickAdd('Construct')">ü§ñ Construct</div>
            </div>
        </div>

        <div class="lib-category">
            <div class="cat-title">Special</div>
            <div class="lib-grid">
                <div class="lib-item" onclick="quickAdd('Copy')">üü¶ Copy</div>
                <div class="lib-item" onclick="quickAdd('Incubator')">ü•ö Incubator</div>
                <div class="lib-item" onclick="quickAdd('Powerstone')">üíé Powerstone</div>
                <div class="lib-item" onclick="quickAdd('City\'s Blessing')">üèôÔ∏è City Bless</div>
                <div class="lib-item" onclick="quickAdd('Monarch')">üëë Monarch</div>
            </div>
        </div>

    </div>

    <div id="board"></div>

    <div id="modal" onclick="this.style.display='none'">
        <img id="modal-img" src="">
    </div>

    <script>
        const board = document.getElementById('board');
        const library = document.getElementById('library');
        const results = document.getElementById('results');
        const searchInput = document.getElementById('searchInput');

        // Initialize
        loadTokens();

        // 1. Quick Add from Library
        async function quickAdd(name) {
            // Visual feedback
            const loading = document.createElement('div');
            loading.innerText = "Loading...";
            loading.style.color = "#888";
            loading.style.textAlign = "center";
            library.prepend(loading);

            try {
                // Find latest printed version of this token
                const res = await fetch(`https://api.scryfall.com/cards/search?q=t%3Atoken+!"${name}"&order=released`);
                const data = await res.json();
                
                if (data.data && data.data.length > 0) {
                    const img = getImgUrl(data.data[0]);
                    addToken(img);
                    library.style.display = 'none'; // Hide library once game starts
                } else {
                    alert('Token not found.');
                }
            } catch (e) {
                alert('Connection error.');
            }
            loading.remove();
        }

        // 2. Search Function
        async function searchScryfall() {
            const query = searchInput.value;
            if(!query) return;

            results.innerHTML = 'Loading...';
            
            try {
                const res = await fetch(`https://api.scryfall.com/cards/search?q=t%3Atoken+${query}`);
                const data = await res.json();
                
                results.innerHTML = '';
                if(!data.data) { results.innerHTML = 'No results.'; return; }

                data.data.slice(0, 20).forEach(card => {
                    const img = getImgUrl(card);
                    if(img) {
                        const thumb = document.createElement('img');
                        thumb.src = img;
                        thumb.className = 'res-thumb';
                        thumb.onclick = () => {
                            addToken(img);
                            results.innerHTML = ''; // Clear results
                            searchInput.value = '';
                            library.style.display = 'none';
                        };
                        results.appendChild(thumb);
                    }
                });
            } catch(e) {
                results.innerHTML = 'Error searching.';
            }
        }

        // 3. Add Token to Board
        function addToken(url, val = 1) {
            const div = document.createElement('div');
            div.className = 'token-card';
            div.innerHTML = `
                <img src="${url}" class="card-bg">
                <button class="btn-delete" onclick="removeToken(this)">‚úï</button>
                
                <div class="zone zone-left" onclick="update(this, -1)"></div>
                
                <div class="zone zone-center" onclick="viewCard('${url}')">
                    <span class="zone-icon">üëÅÔ∏è</span>
                </div>
                
                <div class="zone zone-right" onclick="update(this, 1)"></div>

                <div class="overlay">
                    <div class="counter">${val}</div>
                </div>
            `;
            board.appendChild(div);
            saveState();
        }

        // 4. Update Counter
        function update(el, change) {
            const valDiv = el.parentElement.querySelector('.counter');
            let current = parseInt(valDiv.innerText);
            valDiv.innerText = current + change;
            saveState();
        }

        // 5. Remove Token
        function removeToken(btn) {
            if(confirm('Remove token?')) {
                btn.parentElement.remove();
                saveState();
            }
        }

        // 6. View Full Card
        function viewCard(url) {
            const modal = document.getElementById('modal');
            const img = document.getElementById('modal-img');
            img.src = url;
            modal.style.display = 'flex';
        }

        // 7. Save/Load
        function saveState() {
            const tokens = [];
            document.querySelectorAll('.token-card').forEach(card => {
                tokens.push({
                    img: card.querySelector('.card-bg').src,
                    val: parseInt(card.querySelector('.counter').innerText)
                });
            });
            localStorage.setItem('mtg_tokens_v3', JSON.stringify(tokens));
            
            // Toggle Library Visibility
            if (tokens.length === 0) {
                library.style.display = 'block';
            } else {
                library.style.display = 'none'; // Keep hidden if we have tokens
            }
        }

        function loadTokens() {
            const saved = localStorage.getItem('mtg_tokens_v3');
            const tokens = saved ? JSON.parse(saved) : [];
            
            if (tokens.length > 0) {
                tokens.forEach(t => addToken(t.img, t.val));
                library.style.display = 'none';
            } else {
                library.style.display = 'block';
            }
        }

        // Helper: Get Image URL
        function getImgUrl(card) {
            if(card.image_uris) return card.image_uris.normal;
            if(card.card_faces && card.card_faces[0].image_uris) return card.card_faces[0].image_uris.normal;
            return null;
        }

        // Enter key search
        searchInput.addEventListener('keypress', (e) => {
            if(e.key === 'Enter') searchScryfall();
        });

    </script>
</body>
</html>
