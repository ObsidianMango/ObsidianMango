<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>4-7-8 Breathing</title>
  <link rel="manifest" href="manifest.json">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      width: 100%; height: 100%;
      background: #121212;
      display: flex; align-items: center; justify-content: center; overflow: hidden;
      font-family: sans-serif; position: relative;
    }
    #progress {
      position: absolute; top: 0; left: 0;
      width: 0%; height: 100%; z-index: 0;
    }
    #circle {
      position: relative; z-index: 1;
      width: 200px; height: 200px; border-radius: 50%;
      background: #222; display: flex;
      align-items: center; justify-content: center;
      color: #fff; font-size: 4rem;
      transition: transform 1s ease-in-out, background 0.5s;
    }
    #circle::before {
      content: ''; position: absolute;
      width: 250px; height: 250px; border-radius: 50%;
      border: 2px dashed rgba(255,255,255,0.5);
      transition: transform 1s ease-in-out;
    }
    button {
      position: absolute; bottom: 40px;
      padding: 12px 24px; font-size: 1rem;
      background: #333; color: #fff; border: none;
      cursor: pointer; z-index: 1;
    }
    button:hover { background: #555; }
    #installBtn, #shareBtn { right: 20px; top: 20px; bottom: auto; }
    #installBtn { display: none; }
    #shareBtn { left: 20px; }
  </style>
</head>
<body>
  <div id="progress"></div>
  <div id="circle">Start</div>
  <button id="startBtn">Start</button>
  <button id="installBtn">Install App</button>
  <button id="shareBtn">Share</button>

  <script>
    // Service Worker & PWA install
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }
    let deferredPrompt;
    const installBtn = document.getElementById('installBtn');
    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'block';
    });
    installBtn.addEventListener('click', async () => {
      installBtn.style.display = 'none';
      deferredPrompt.prompt();
      deferredPrompt = null;
    });

    // Emergency Share
    const shareBtn = document.getElementById('shareBtn');
    shareBtn.addEventListener('click', async () => {
      const data = {
        title: '4-7-8 Breathing',
        text: 'Quick calm-down exercise',
        url: window.location.href
      };
      if (navigator.share) {
        await navigator.share(data);
      } else {
        await navigator.clipboard.writeText(window.location.href);
        alert('Link copied to clipboard');
      }
    });

    // Breathing App Logic
    const startBtn = document.getElementById('startBtn');
    const circle = document.getElementById('circle');
    const prog = document.getElementById('progress');
    startBtn.addEventListener('click', startBreathing);

    async function startBreathing() {
      startBtn.style.display = 'none';
      while (true) {
        await phase(4, '#4caf50', 1.4, 'inhale', [200]);
        await phase(7, '#b71c1c', 1.0, 'hold', [100]);
        await phase(8, '#2196f3', 0.7, 'exhale', [200]);
      }
    }

    async function phase(sec, color, scale, name, vibratePattern) {
      prog.style.background = color;
      prog.style.transition = `width ${sec}s linear`;
      prog.style.width = '0%';
      requestAnimationFrame(() => prog.style.width = '100%');

      circle.style.background = color;
      circle.style.transform = `scale(${scale})`;
      circle.classList.toggle('inhale', name === 'inhale');
      circle.classList.toggle('exhale', name === 'exhale');

      if (navigator.vibrate) navigator.vibrate(vibratePattern);

      for (let i = sec; i > 0; i--) {
        circle.textContent = i;
        await wait(1000);
      }
    }

    function wait(ms) {
      return new Promise(res => setTimeout(res, ms));
    }

    // Wind-effect transforms
    const style = document.createElement('style');
    style.textContent = `
      #circle.inhale::before { transform: scale(0.6); }
      #circle.exhale::before { transform: scale(1.4); }
    `;
    document.head.append(style);
  </script>
</body>
</html>