<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>4‑7‑8 Breathing</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="manifest" href="manifest.json">
  <style>
    * { margin:0; padding:0; box‑sizing:border-box; }
    html, body {
      width:100%; height:100%; overflow:hidden;
      display:flex; align-items:center; justify-content:center;
      background:#121212; font-family:sans-serif; position:relative;
    }
    #progress {
      position:absolute; top:0; left:0;
      width:0%; height:100%; background:#4caf50;
      z-index:0; transition:none;
    }
    #circle {
      position:relative; z-index:1;
      width:200px; height:200px; border-radius:50%;
      background:#222; display:flex;
      align-items:center; justify-content:center;
      color:#fff; font-size:4rem; cursor:pointer;
      transition:background .5s, transform 1s ease-in-out;
    }
    #circle::before {
      content:''; position:absolute;
      width:250px; height:250px; border-radius:50%;
      border:2px dashed rgba(255,255,255,0.5);
      transform:scale(1); opacity:1;
      transition:transform 4s ease-in-out;
    }
    #circle.inhale::before  { transform:scale(0.6); }
    #circle.exhale::before  { animation:flowOut 8s ease-out forwards; }
    @keyframes flowOut {
      from { transform:scale(1.4); opacity:1; }
      to   { transform:scale(2.2); opacity:0; }
    }
    button {
      position:absolute; bottom:20px; padding:8px 16px;
      background:#333; color:#fff; border:none; cursor:pointer;
      font-size:1rem; z-index:1;
    }
    #installBtn { right:20px; display:none; }
    #shareBtn   { left:20px; }
    button:hover { background:#555; }
  </style>
</head>
<body>
  <div id="progress"></div>
  <div id="circle">Start</div>
  <button id="installBtn">Install</button>
  <button id="shareBtn">Share</button>

  <script>
    // PWA install prompt
    let deferredPrompt;
    const installBtn = document.getElementById('installBtn');
    window.addEventListener('beforeinstallprompt', e => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'block';
    });
    installBtn.addEventListener('click', async () => {
      installBtn.style.display = 'none';
      deferredPrompt.prompt();
      deferredPrompt = null;
    });
    // service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js');
    }
    // emergency share
    document.getElementById('shareBtn').addEventListener('click', async () => {
      const data = { title:'4‑7‑8 Breathing', text:'Quick calm‑down', url:location.href };
      if (navigator.share) await navigator.share(data);
      else { await navigator.clipboard.writeText(location.href); alert('Link copied'); }
    });

    const circle = document.getElementById('circle');
    const prog   = document.getElementById('progress');
    let running = false;

    circle.addEventListener('click', () => {
      if (!running) startBreathing();
    });

    async function startBreathing() {
      running = true;
      while (true) {
        await phase(4, '#4caf50','inhale', [200]);
        await phase(7, '#b71c1c','hold'  , [100]);
        await phase(8, '#2196f3','exhale', [200]);
      }
    }

    async function phase(sec, color, mode, vib) {
      // progress bar
      prog.style.background = color;
      prog.style.transition = `width ${sec}s linear`;
      prog.style.width = '0%';
      requestAnimationFrame(()=> prog.style.width='100%');
      // circle visuals
      circle.style.background = color;
      circle.className = mode;
      if (mode!=='hold') circle.style.transform = mode==='inhale' ? 'scale(1.4)' : 'scale(1.4)';
      else circle.style.transform = 'scale(1)';
      // vibrate
      if (navigator.vibrate) navigator.vibrate(vib);
      // countdown
      for (let i=sec;i>0;i--) {
        circle.textContent = i;
        await new Promise(r=>setTimeout(r,1000));
      }
    }
  </script>
</body>
</html>
