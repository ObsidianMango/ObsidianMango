<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arcane | Deck Builder</title>
    <style>
        :root {
            --bg-deep: #050505;
            --bg-glass: rgba(16, 16, 20, 0.9);
            --bg-panel: #18181b;
            --bg-surface: #27272a;
            --primary: #8b5cf6;
            --primary-glow: rgba(139, 92, 246, 0.5);
            --special: #f59e0b;
            --text-main: #ffffff;
            --text-muted: #a1a1aa;
            --border: rgba(255, 255, 255, 0.08);
            
            /* MTG Colors */
            --c-w: #fef08a; --c-u: #3b82f6; --c-b: #6b7280; 
            --c-r: #ef4444; --c-g: #22c55e; --c-c: #9ca3af;

            --safe-top: env(safe-area-inset-top);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- HEADER --- */
        header {
            flex-shrink: 0;
            background: var(--bg-glass);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            z-index: 50;
            padding-top: var(--safe-top);
            display: flex;
            flex-direction: column;
        }

        .nav-top {
            height: 60px;
            display: flex;
            align-items: center;
            padding: 0 16px;
            gap: 12px;
        }

        .brand { font-weight: 900; font-size: 1.2rem; letter-spacing: -1px; background: linear-gradient(to right, #fff, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .search-box { flex: 1; position: relative; }
        .search-input {
            width: 100%;
            background: rgba(255,255,255,0.07);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 14px;
            padding: 10px 10px 10px 38px;
            color: white;
            font-size: 0.95rem;
            transition: 0.3s;
        }
        .search-input:focus { background: #000; border-color: var(--primary); outline: none; box-shadow: 0 0 15px var(--primary-glow); }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); opacity: 0.7; }

        .btn-icon {
            width: 40px; height: 40px;
            display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            border: 1px solid var(--border);
            color: white; cursor: pointer; transition: 0.2s;
            position: relative;
        }
        .btn-icon:active { transform: scale(0.95); background: var(--primary); }
        .btn-icon.active { background: var(--primary); border-color: var(--primary); }
        
        .badge {
            position: absolute; top: -4px; right: -4px;
            background: var(--primary); min-width: 16px; height: 16px; padding:0 4px;
            border-radius: 10px; font-size: 10px; font-weight:700; display: flex; align-items: center; justify-content: center;
            border: 2px solid var(--bg-deep); display: none;
        }

        /* --- FILTER BAR --- */
        .nav-bottom {
            padding: 0 16px 12px 16px;
            display: flex; align-items: center; gap: 12px;
            overflow-x: auto;
            scrollbar-width: none;
        }
        .nav-bottom::-webkit-scrollbar { display: none; }

        .mana-group { display: flex; gap: 8px; flex-shrink: 0; }
        .mana-circle {
            width: 28px; height: 28px; border-radius: 50%;
            cursor: pointer; transition: 0.2s;
            border: 2px solid rgba(255,255,255,0.1);
            position: relative;
        }
        .mana-circle.active {
            box-shadow: 0 0 0 2px #60a5fa, 0 0 10px rgba(96, 165, 250, 0.5);
            transform: scale(1.1); border-color: transparent;
        }
        .mc-w { background: var(--c-w); } .mc-u { background: var(--c-u); }
        .mc-b { background: var(--c-b); } .mc-r { background: var(--c-r); }
        .mc-g { background: var(--c-g); } .mc-c { background: var(--c-c); }

        .sep { width: 1px; height: 24px; background: var(--border); flex-shrink: 0; }

        .type-scroll { display: flex; gap: 8px; }
        .chip {
            padding: 6px 14px;
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 0.75rem; font-weight: 600; color: var(--text-muted);
            white-space: nowrap; cursor: pointer; transition: 0.2s;
        }
        .chip.active {
            background: var(--primary); color: white; border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        /* --- GRID --- */
        .grid-container {
            flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;
            padding: 15px 10px 100px 10px;
        }
        .card-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px; max-width: 1400px; margin: 0 auto;
        }
        @media (max-width: 600px) { .card-grid { grid-template-columns: 1fr 1fr; gap: 10px; } }

        .card-wrapper { animation: fadeUp 0.5s ease forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeUp { to { opacity: 1; transform: translateY(0); } }

        .card-item {
            position: relative; aspect-ratio: 2.5/3.5; border-radius: 12px;
            background: var(--bg-panel); overflow: hidden; cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3); border: 1px solid transparent;
        }
        .card-item:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.5); border-color: rgba(255,255,255,0.2); }
        .card-img { width: 100%; height: 100%; object-fit: cover; opacity: 0; transition: opacity 0.4s; }
        .card-img.loaded { opacity: 1; }

        .fav-indicator {
            position: absolute; top: 0; right: 0; padding: 10px;
            color: white; 
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            font-size: 1.4rem; z-index: 5;
            opacity: 0.5; transition: 0.2s;
        }
        .card-wrapper.in-deck .fav-indicator { opacity: 1; color: #ef4444; }
        .fav-indicator:hover { transform: scale(1.2); opacity: 1; }

        /* --- DECK LAYERS --- */
        .full-layer {
            position: fixed; inset: 0; background: var(--bg-deep); z-index: 60;
            display: flex; flex-direction: column;
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .full-layer.active { transform: translateY(0); }
        .layer-header {
            padding: 15px 20px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-glass); padding-top: max(15px, var(--safe-top));
        }
        .layer-title { font-size: 1.2rem; font-weight: 800; display: flex; align-items: center; gap: 10px; }
        .layer-close { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); border-radius: 50%; cursor: pointer; }
        
        .layer-content { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; }

        /* VIEW TOGGLE */
        .view-toggle { display: flex; background: rgba(255,255,255,0.1); border-radius: 8px; padding: 2px; }
        .vt-btn { padding: 6px 12px; font-size: 0.8rem; cursor: pointer; border-radius: 6px; color: #888; }
        .vt-btn.active { background: var(--bg-panel); color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        /* DECK VIEW STYLES */
        .commander-zone {
            background: radial-gradient(circle at center, rgba(139, 92, 246, 0.15) 0%, rgba(0,0,0,0) 70%);
            border: 1px dashed var(--primary); border-radius: 16px; padding: 20px;
            text-align: center; margin-bottom: 30px;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .commander-zone.has-cmdr { display: flex; border-style: solid; background: radial-gradient(circle at center, rgba(245, 158, 11, 0.1) 0%, rgba(0,0,0,0) 80%); border-color: var(--special); }
        
        .type-section { margin-bottom: 25px; }
        .type-header { 
            font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); 
            border-bottom: 1px solid var(--border); padding-bottom: 8px; margin-bottom: 15px;
            display: flex; justify-content: space-between;
        }
        
        .deck-list-item {
            display: flex; align-items: center; gap: 12px; padding: 8px 10px;
            background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 6px;
            border: 1px solid transparent; transition: 0.2s; cursor: pointer;
        }
        .deck-list-item:active { background: rgba(255,255,255,0.07); }
        .deck-card-name { flex: 1; font-weight: 500; font-size: 0.95rem; }
        
        .deck-mana { display: flex; align-items: center; gap: 3px; }
        .mana-pip { 
            width: 14px; height: 14px; border-radius: 50%; display: inline-block; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.5); position: relative;
        }
        .mana-pip.generic {
            background: #9ca3af; color: #000; font-size: 9px; font-weight: 800;
            display: flex; align-items: center; justify-content: center;
        }
        .mana-pip.W { background: var(--c-w); } .mana-pip.U { background: var(--c-u); } 
        .mana-pip.B { background: var(--c-b); } .mana-pip.R { background: var(--c-r); } 
        .mana-pip.G { background: var(--c-g); } .mana-pip.C { background: var(--c-c); } 
        
        .btn-delete { width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: #666; margin-left: 8px; }
        .btn-delete:hover { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

        .btn-destroy-deck {
            width: 100%; padding: 15px; background: rgba(220, 38, 38, 0.1);
            border: 1px solid rgba(220, 38, 38, 0.5); color: #ef4444;
            border-radius: 12px; font-weight: 800; font-size: 0.9rem; letter-spacing: 1px;
            cursor: pointer; margin-top: 40px; text-transform: uppercase;
        }

        .deck-footer {
            position: absolute; bottom: 0; left: 0; right: 0;
            padding: 20px; background: var(--bg-glass); border-top: 1px solid var(--border);
            display: flex; gap: 10px; backdrop-filter: blur(10px);
        }

        /* --- SHEET & POP-OUT MENU --- */
        .sheet-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(8px); z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .sheet-backdrop.active { opacity: 1; pointer-events: auto; }
        .sheet-panel {
            position: absolute; top: 0; right: 0; bottom: 0; width: 85%; max-width: 400px;
            background: #121212; border-left: 1px solid var(--border);
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            display: flex; flex-direction: column; box-shadow: -20px 0 50px rgba(0,0,0,0.7);
        }
        .sheet-backdrop.active .sheet-panel { transform: translateX(0); }
        .sheet-header { padding: 25px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .sheet-body { flex: 1; overflow-y: auto; padding: 25px; }
        .sheet-footer { padding: 20px; background: var(--bg-panel); border-top: 1px solid var(--border); }
        .visit-counter { margin-top: 5px; text-align: center; font-family: 'Courier New', monospace; font-size: 0.8rem; color: var(--text-muted); opacity: 0.6; }
        .visit-number { color: #4ade80; font-weight: bold; letter-spacing: 1px; }

        .filter-section { margin-bottom: 30px; }
        .fs-title { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700; margin-bottom: 12px; letter-spacing: 1px; }
        .fs-grid { display: flex; flex-wrap: wrap; gap: 10px; }
        .fs-mana { display: flex; gap: 15px; justify-content: center; margin-bottom: 10px; }
        .fs-mana .mana-circle { width: 40px; height: 40px; }

        .set-list { max-height: 250px; overflow-y: auto; background: #000; border: 1px solid var(--border); border-radius: 8px; }
        .set-row { padding: 12px 15px; border-bottom: 1px solid #222; display: flex; align-items: center; gap: 10px; cursor: pointer; color: #aaa; }
        .set-row.selected { color: white; background: #1a1a20; }
        .set-row.pinned { border-bottom: 1px solid var(--primary-glow); }

        .btn-apply { width: 100%; padding: 16px; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 800; font-size: 1rem; cursor: pointer; }

        /* --- DEEP ANALYSIS CSS --- */
        .analysis-grid { display: grid; grid-template-columns: 1fr; gap: 16px; max-width: 800px; margin: 0 auto; }
        @media(min-width: 768px) { .analysis-grid { grid-template-columns: 1fr 1fr; } .span-2 { grid-column: span 2; } }

        .stat-card {
            background: var(--bg-surface); border: 1px solid var(--border); border-radius: 16px;
            padding: 16px; position: relative; overflow: hidden;
        }
        .stat-header { 
            font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; 
            color: var(--text-muted); font-weight: 700; margin-bottom: 12px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .dash-row { display: flex; gap: 12px; margin-bottom: 16px; }
        .dash-box { 
            flex: 1; background: var(--bg-panel); padding: 12px; border-radius: 12px; 
            text-align: center; border: 1px solid var(--border);
        }
        .dash-val { font-size: 1.4rem; font-weight: 800; color: white; margin-bottom: 4px; }
        .dash-lbl { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; }

        .donut-container { position: relative; width: 160px; height: 160px; margin: 0 auto; }
        .donut { width: 100%; height: 100%; border-radius: 50%; background: conic-gradient(var(--chart-gradient)); mask: radial-gradient(transparent 60%, black 61%); -webkit-mask: radial-gradient(transparent 60%, black 61%); }
        .donut-center { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; flex-direction: column; pointer-events: none; }
        
        .curve-chart { display: flex; align-items: flex-end; height: 140px; padding-top: 20px; gap: 6px; }
        .curve-col { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 100%; }
        .curve-bar { 
            width: 100%; min-width: 8px; border-radius: 4px 4px 0 0; 
            background: linear-gradient(to top, var(--primary), #a78bfa);
            min-height: 2px; position: relative; transition: height 0.5s;
        }
        .curve-count { font-size: 0.75rem; color: white; margin-bottom: 4px; font-weight: 700; }
        .curve-label { font-size: 0.7rem; color: var(--text-muted); margin-top: 6px; }

        /* FULL SCREEN CARD MODAL */
        .modal { position: fixed; inset: 0; z-index: 200; background: rgba(0,0,0,0.92); backdrop-filter: blur(15px); display: flex; justify-content: center; align-items: center; opacity: 0; pointer-events: none; transition: opacity 0.3s; }
        .modal.active { opacity: 1; pointer-events: auto; }
        .modal-content-area { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; position: relative; }
        .modal-card-wrapper { width: 90%; max-width: 420px; display: flex; flex-direction: column; align-items: center; transition: transform 0.3s, opacity 0.2s; }
        .card-3d-wrap { width: 100%; border-radius: 18px; position: relative; overflow: hidden; box-shadow: 0 30px 60px rgba(0,0,0,0.6); transform-style: preserve-3d; margin-bottom: 25px; background: #000; cursor: pointer; }
        .modal-img { width: 100%; display: block; position: relative; z-index: 1; }
        .foil-overlay { position: absolute; inset: 0; z-index: 2; background: linear-gradient(115deg, transparent 20%, rgba(255, 255, 255, 0.3) 50%, transparent 80%); mix-blend-mode: overlay; opacity: 0; pointer-events: none; background-size: 200% 200%; transition: opacity 0.2s; }
        .card-3d-wrap:hover .foil-overlay { opacity: 1; }
        .modal-actions { display: flex; gap: 10px; width: 100%; justify-content: center; flex-wrap: wrap; }
        .action-btn { background: #27272a; border: 1px solid var(--border); color: white; padding: 10px 20px; border-radius: 30px; font-weight: 600; text-decoration: none; display: flex; align-items: center; gap: 8px; cursor: pointer; transition: 0.2s; font-size: 0.9rem; }
        .action-btn:hover { background: #3f3f46; }
        .action-btn.primary-btn { background: var(--primary); border-color: var(--primary); }
        .action-btn.delete-btn { color: white; background: #ef4444; border-color: #ef4444; }
        .action-btn.cmdr-btn { color: var(--special); border-color: var(--special); background: rgba(245, 158, 11, 0.1); }
        .modal-close-btn { position: absolute; top: 20px; right: 20px; z-index: 210; width: 44px; height: 44px; background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; cursor: pointer; }
        
        .nav-arrow { position: absolute; top: 50%; transform: translateY(-50%); font-size: 3rem; color: white; opacity: 0.3; cursor: pointer; padding: 20px; z-index: 10; }
        @media (max-width: 600px) { .nav-arrow { display: none; } }

        /* IMPORT MODAL */
        .import-area { width: 100%; height: 200px; background: #111; color: #fff; border: 1px solid #333; padding: 15px; border-radius: 10px; font-family: monospace; resize: none; margin-bottom: 15px; }

    </style>
</head>
<body>

    <header>
        <div class="nav-top">
            <div class="brand"><span>‚ú¶</span> Zenith</div>
            <div class="search-box">
                <span class="search-icon">üîç</span>
                <input type="text" class="search-input" id="searchInput" placeholder="Search cards..." onkeypress="handleEnter(event)">
            </div>
            
            <div class="btn-icon" id="deckIcon" onclick="openDeckView()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>
                <div class="badge" id="deckCount" style="background:var(--special); color:black;">0</div>
            </div>

            <div class="btn-icon" id="filterBtn" onclick="toggleSheet()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 21v-7m0-4V3m8 18v-9m0-4V3m8 18v-5m0-4V3M1 14h6m2-6h6m2 8h6"></path></svg>
                <div class="badge" id="filterCount">0</div>
            </div>
        </div>

        <div class="nav-bottom">
            <div class="mana-group">
                <div class="mana-circle mc-w" data-key="w" onclick="toggleColor('w')"></div>
                <div class="mana-circle mc-u" data-key="u" onclick="toggleColor('u')"></div>
                <div class="mana-circle mc-b" data-key="b" onclick="toggleColor('b')"></div>
                <div class="mana-circle mc-r" data-key="r" onclick="toggleColor('r')"></div>
                <div class="mana-circle mc-g" data-key="g" onclick="toggleColor('g')"></div>
                <div class="mana-circle mc-c" data-key="c" onclick="toggleColor('c')"></div>
            </div>
            <div class="sep"></div>
            <div class="type-scroll">
                <div class="chip" data-key="creature" onclick="toggleType('creature')">Creature</div>
                <div class="chip" data-key="artifact" onclick="toggleType('artifact')">Artifact</div>
                <div class="chip" data-key="enchantment" onclick="toggleType('enchantment')">Enchantment</div>
                <div class="chip" data-key="instant" onclick="toggleType('instant')">Instant</div>
                <div class="chip" data-key="sorcery" onclick="toggleType('sorcery')">Sorcery</div>
                <div class="chip" data-key="land" onclick="toggleType('land')">Land</div>
            </div>
        </div>
    </header>

    <div class="grid-container" id="mainScroll">
        <div class="card-grid" id="grid"></div>
        <div id="loader" style="padding:40px; text-align:center; opacity:0; color:#555;">Loading...</div>
    </div>

    <div class="sheet-backdrop" id="sheet" onclick="toggleSheet()">
        <div class="sheet-panel" onclick="event.stopPropagation()">
            <div class="sheet-header">
                <span style="font-size:1.2rem; font-weight:800;">Command Center</span>
                <span style="color:#666; cursor:pointer;" onclick="resetFilters()">Reset All</span>
            </div>
            <div class="sheet-body">
                
                <div class="filter-section">
                    <div class="fs-title">Sort By</div>
                    <select id="sortSelect" class="search-input" style="padding:12px;">
                        <option value="released">Release Date (Newest)</option>
                        <option value="usd">Price: High to Low</option>
                        <option value="usd_asc">Price: Low to High</option>
                    </select>
                </div>

                <div class="filter-section">
                    <div class="fs-title">Color Identity</div>
                    <div class="fs-mana">
                        <div class="mana-circle mc-w" data-key="w" onclick="toggleColor('w')"></div>
                        <div class="mana-circle mc-u" data-key="u" onclick="toggleColor('u')"></div>
                        <div class="mana-circle mc-b" data-key="b" onclick="toggleColor('b')"></div>
                    </div>
                    <div class="fs-mana">
                        <div class="mana-circle mc-r" data-key="r" onclick="toggleColor('r')"></div>
                        <div class="mana-circle mc-g" data-key="g" onclick="toggleColor('g')"></div>
                        <div class="mana-circle mc-c" data-key="c" onclick="toggleColor('c')"></div>
                    </div>
                </div>

                <div class="filter-section">
                    <div class="fs-title">Card Types</div>
                    <div class="fs-grid">
                        <div class="chip" data-key="creature" onclick="toggleType('creature')">Creature</div>
                        <div class="chip" data-key="artifact" onclick="toggleType('artifact')">Artifact</div>
                        <div class="chip" data-key="enchantment" onclick="toggleType('enchantment')">Enchantment</div>
                        <div class="chip" data-key="instant" onclick="toggleType('instant')">Instant</div>
                        <div class="chip" data-key="sorcery" onclick="toggleType('sorcery')">Sorcery</div>
                        <div class="chip" data-key="planeswalker" onclick="toggleType('planeswalker')">Planeswalker</div>
                        <div class="chip" data-key="land" onclick="toggleType('land')">Land</div>
                    </div>
                </div>

                <div class="filter-section">
                    <div class="fs-title">Sets</div>
                    <input type="text" id="setSearch" placeholder="Find a set..." style="width:100%; padding:10px; background:#111; border:1px solid #333; color:white; border-radius:6px; margin-bottom:8px;">
                    <div class="set-list" id="setList"></div>
                </div>

            </div>
            <div class="sheet-footer">
                <button class="btn-apply" onclick="applyAdvFilters()">Apply Configuration</button>
                <div class="visit-counter">ARCHIVE ACCESS: <span id="visitorCount" class="visit-number">000000</span></div>
            </div>
        </div>
    </div>

    <div class="full-layer" id="deckLayer">
        <div class="layer-header">
            <div class="layer-title"><span style="color:var(--special)">‚ú¶</span> Deck</div>
            <div class="view-toggle">
                <div class="vt-btn active" id="btnList" onclick="setDeckView('list')">List</div>
                <div class="vt-btn" id="btnGrid" onclick="setDeckView('grid')">Grid</div>
            </div>
            <div class="layer-close" onclick="closeDeckView()">√ó</div>
        </div>
        <div class="layer-content">
            <div class="commander-zone" id="commanderZone"></div>
            <div id="deckListContainer"></div>
        </div>
        <div class="deck-footer">
            <button class="btn-apply" style="background:var(--bg-panel); border:1px solid var(--border); flex:1;" onclick="openImportModal()">Import</button>
            <button class="btn-apply" style="flex:1;" onclick="openAnalysis()">Stats & Analysis</button>
        </div>
    </div>

    <div class="full-layer" id="importLayer" style="z-index:70;">
        <div class="layer-header">
            <div class="layer-title">Import Text</div>
            <div class="layer-close" onclick="closeImportModal()">√ó</div>
        </div>
        <div class="layer-content">
            <p style="color:#aaa; font-size:0.9rem; margin-top:0;">Paste decklist (e.g. Moxfield, ManaBox export). One card per line.</p>
            <textarea class="import-area" id="importText" placeholder="1 Sol Ring&#10;20 Swamp&#10;..."></textarea>
            <div id="importStatus" style="color:var(--special); font-size:0.9rem; min-height:20px;"></div>
            <button class="btn-apply" onclick="processImport()">Process Import</button>
        </div>
    </div>

    <div class="full-layer" id="analysisLayer" style="z-index:75;">
        <div class="layer-header">
            <div class="layer-title">Deck Analysis</div>
            <div class="layer-close" onclick="closeAnalysis()">√ó</div>
        </div>
        <div class="layer-content" id="analysisContent"></div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-close-btn" onclick="closeModal()">√ó</div>
        <div class="modal-content-area" id="swipeArea" onclick="handleBgClick(event)">
            <div class="nav-arrow nav-left" onclick="navigateCard(-1); event.stopPropagation()">&#10094;</div>
            <div class="nav-arrow nav-right" onclick="navigateCard(1); event.stopPropagation()">&#10095;</div>

            <div class="modal-card-wrapper" id="modalContent">
                <div class="card-3d-wrap" id="card3d" onclick="closeModal()">
                    <img src="" id="modalImg" class="modal-img">
                    <div class="foil-overlay" id="foilLayer"></div>
                </div>
                
                <div style="text-align:center; margin-bottom:20px;" onclick="event.stopPropagation()">
                    <h2 id="modalTitle" style="margin:0 0 5px 0; pointer-events:none;"></h2>
                    <div id="modalType" style="color:var(--text-muted); font-size:0.9rem; pointer-events:none;"></div>
                </div>

                <div class="modal-actions" onclick="event.stopPropagation()">
                    <div id="modalActionContainer" style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- STATE ---
        const state = {
            sets: [], selectedSets: new Set(['sld']), // DEFAULT: Secret Lair
            page: 1, hasMore: true, isLoading: false, nextUrl: null,
            data: [], 
            deck: JSON.parse(localStorage.getItem('arcane_deck_v2') || '[]'),
            commanderId: localStorage.getItem('arcane_cmdr_v2') || null,
            viewingDeck: false,
            deckViewMode: 'list',
            currentCardIndex: 0,
            activeContextList: [],
            filters: { colors: new Set(), types: new Set(), q: '' }
        };

        const els = { grid: document.getElementById('grid'), loader: document.getElementById('loader'), search: document.getElementById('searchInput') };

        window.addEventListener('DOMContentLoaded', async () => {
            await loadSets();
            fetchCards(true);
            initInfiniteScroll();
            initFoilEffect();
            initSwipe();
            initVisitorCount();
            updateDeckCount();
        });

        /* --- VISITOR COUNT --- */
        function initVisitorCount() {
            let count = parseInt(localStorage.getItem('arcane_visits') || '28491');
            localStorage.setItem('arcane_visits', ++count);
            document.getElementById('visitorCount').textContent = count;
        }

        /* --- FILTER SYNC LOGIC --- */
        function toggleColor(c) { 
            state.filters.colors.has(c) ? state.filters.colors.delete(c) : state.filters.colors.add(c);
            updateFilterUI(); 
            if(!document.getElementById('sheet').classList.contains('active')) fetchCards(true);
        }

        function toggleType(t) {
            state.filters.types.has(t) ? state.filters.types.delete(t) : state.filters.types.add(t);
            updateFilterUI();
            if(!document.getElementById('sheet').classList.contains('active')) fetchCards(true);
        }

        function updateFilterUI() {
            document.querySelectorAll(`[data-key]`).forEach(elem => {
                const key = elem.dataset.key;
                const isColor = ['w','u','b','r','g','c'].includes(key);
                const isActive = isColor ? state.filters.colors.has(key) : state.filters.types.has(key);
                if(isActive) elem.classList.add('active'); else elem.classList.remove('active');
            });
            const count = state.filters.colors.size + state.filters.types.size + (state.selectedSets.has('ALL') ? 0 : 1);
            const badge = document.getElementById('filterCount');
            badge.textContent = count;
            badge.style.display = count ? 'flex' : 'none';
        }

        function resetFilters() {
            state.filters.colors.clear(); state.filters.types.clear();
            state.selectedSets.clear(); state.selectedSets.add('ALL');
            document.getElementById('sortSelect').value = 'released';
            updateFilterUI(); renderSetList();
        }

        /* --- DECK MANAGEMENT --- */
        function toggleDeckCard(idOrCard, onlyAdd = false) {
            let id, card;
            if (typeof idOrCard === 'string') {
                id = idOrCard;
                card = state.deck.find(c => c.id === id) || state.data.find(c => c.id === id);
            } else {
                card = idOrCard;
                id = card.id;
            }

            const idx = state.deck.findIndex(c => c.id === id);
            let wasRemoved = false;
            
            if(idx > -1) {
                if(!onlyAdd) {
                    state.deck.splice(idx, 1);
                    if(state.commanderId === id) state.commanderId = null;
                    wasRemoved = true;
                }
            } else {
                if(card) {
                    const isBasic = card.type_line.includes('Basic Land');
                    if(isBasic || idx === -1) {
                        state.deck.push(card);
                    }
                }
            }
            
            saveDeck();
            updateDeckCount();
            
            const el = document.querySelector(`.card-wrapper[data-id="${id}"]`);
            if(el) {
                if(wasRemoved) el.classList.remove('in-deck');
                else el.classList.add('in-deck');
            }
            
            if(document.getElementById('modal').classList.contains('active')) {
                if(state.viewingDeck && wasRemoved && state.activeContextList === state.deck) {
                   closeModal();
                   renderDeck(); 
                   return;
                }
                const currentModalCard = state.activeContextList[state.currentCardIndex];
                if(currentModalCard && currentModalCard.id === id) {
                    updateModalButtons(currentModalCard);
                }
            }
            if(state.viewingDeck) renderDeck();
        }

        function destroyDeck() {
            if(confirm('Warning: This will completely obliterate your current deck list. Are you sure?')) {
                state.deck = [];
                state.commanderId = null;
                saveDeck();
                updateDeckCount();
                document.querySelectorAll('.in-deck').forEach(e => e.classList.remove('in-deck'));
                renderDeck();
            }
        }

        function setCommander(id) {
            state.commanderId = (state.commanderId === id) ? null : id;
            saveDeck();
            const currentModalCard = state.activeContextList[state.currentCardIndex];
            if(currentModalCard && currentModalCard.id === id) updateModalButtons(currentModalCard);
            if(state.viewingDeck) renderDeck();
        }

        function saveDeck() {
            localStorage.setItem('arcane_deck_v2', JSON.stringify(state.deck));
            localStorage.setItem('arcane_cmdr_v2', state.commanderId || '');
        }

        function updateDeckCount() {
            const b = document.getElementById('deckCount');
            b.textContent = state.deck.length;
            b.style.display = state.deck.length > 0 ? 'flex' : 'none';
        }

        /* --- DECK VIEW --- */
        function openDeckView() {
            state.viewingDeck = true;
            document.getElementById('deckLayer').classList.add('active');
            renderDeck();
        }
        function closeDeckView() { 
            state.viewingDeck = false;
            document.getElementById('deckLayer').classList.remove('active'); 
        }
        
        function setDeckView(mode) {
            state.deckViewMode = mode;
            document.getElementById('btnList').className = mode === 'list' ? 'vt-btn active' : 'vt-btn';
            document.getElementById('btnGrid').className = mode === 'grid' ? 'vt-btn active' : 'vt-btn';
            renderDeck();
        }

        function renderDeck() {
            const container = document.getElementById('deckListContainer');
            const cmdrZone = document.getElementById('commanderZone');
            const commander = state.deck.find(c => c.id === state.commanderId);
            if(commander) {
                const img = commander.image_uris?.normal || commander.card_faces?.[0]?.image_uris?.normal;
                cmdrZone.className = 'commander-zone has-cmdr';
                cmdrZone.innerHTML = `
                    <div onclick="openModalForDeckCard('${commander.id}')" style="cursor:pointer;">
                        <img src="${img}" style="height:200px; border-radius:12px; box-shadow:0 10px 40px rgba(245, 158, 11, 0.3);">
                        <div style="margin-top:10px; font-weight:bold; color:var(--special);">üëë ${commander.name}</div>
                    </div>
                `;
            } else {
                cmdrZone.className = 'commander-zone';
                cmdrZone.innerHTML = ''; 
            }

            container.innerHTML = '';
            const rest = state.deck.filter(c => c.id !== state.commanderId);

            if(rest.length === 0 && !commander) {
                container.innerHTML = '<div style="text-align:center; color:#555; margin-top:50px;">Deck is empty.<br>Search cards and tap ‚ô• to add.</div>';
                return;
            }

            if(state.deckViewMode === 'list') {
                const groups = { Creature:[], Artifact:[], Enchantment:[], Instant:[], Sorcery:[], Planeswalker:[], Land:[], Other:[] };
                rest.forEach(c => {
                    const t = c.type_line;
                    if(t.includes('Land')) groups.Land.push(c);
                    else if(t.includes('Creature')) groups.Creature.push(c);
                    else if(t.includes('Artifact')) groups.Artifact.push(c);
                    else if(t.includes('Enchantment')) groups.Enchantment.push(c);
                    else if(t.includes('Instant')) groups.Instant.push(c);
                    else if(t.includes('Sorcery')) groups.Sorcery.push(c);
                    else if(t.includes('Planeswalker')) groups.Planeswalker.push(c);
                    else groups.Other.push(c);
                });

                ['Creature', 'Artifact', 'Enchantment', 'Instant', 'Sorcery', 'Planeswalker', 'Other', 'Land'].forEach(type => {
                    const cards = groups[type];
                    if(cards && cards.length > 0) {
                        const section = document.createElement('div');
                        section.className = 'type-section';
                        section.innerHTML = `<div class="type-header"><span>${type}s</span><span>${cards.length}</span></div>`;
                        cards.forEach(c => {
                            const row = document.createElement('div');
                            row.className = 'deck-list-item';
                            row.onclick = (e) => { 
                                if(e.target.closest('.btn-delete')) return; 
                                openModalForDeckCard(c.id); 
                            };
                            row.innerHTML = `
                                <div class="deck-card-name">${c.name}</div>
                                <div class="deck-mana">${renderManaCost(c.mana_cost)}</div>
                                <div class="btn-delete" onclick="toggleDeckCard('${c.id}')">‚úï</div>
                            `;
                            section.appendChild(row);
                        });
                        container.appendChild(section);
                    }
                });
            } else {
                const gridDiv = document.createElement('div');
                gridDiv.className = 'card-grid';
                rest.forEach((c) => {
                    let img = c.image_uris?.normal || c.card_faces?.[0]?.image_uris?.normal;
                    if(img) {
                        const item = document.createElement('div');
                        item.className = 'card-wrapper in-deck'; 
                        item.innerHTML = `
                            <div class="card-item" onclick="openModalForDeckCard('${c.id}')">
                                <img src="${img}" class="card-img loaded">
                                <div class="fav-indicator" onclick="event.stopPropagation(); toggleDeckCard('${c.id}', true)">‚ô•</div>
                            </div>`;
                        gridDiv.appendChild(item);
                    }
                });
                container.appendChild(gridDiv);
            }

            const btnDestroy = document.createElement('button');
            btnDestroy.className = 'btn-destroy-deck';
            btnDestroy.innerText = 'Destroy Deck';
            btnDestroy.onclick = destroyDeck;
            container.appendChild(btnDestroy);
        }

        function renderManaCost(cost) {
            if(!cost) return '';
            const regex = /{([^}]+)}/g;
            let html = '';
            let match;
            const colorMap = { 'W': varColor('w'), 'U': varColor('u'), 'B': varColor('b'), 'R': varColor('r'), 'G': varColor('g'), 'C': varColor('c') };

            while ((match = regex.exec(cost)) !== null) {
                const symbol = match[1];
                if(!isNaN(symbol) || symbol === 'X') {
                    html += `<div class="mana-pip generic">${symbol}</div>`;
                } else {
                    html += `<div class="mana-pip" style="background:${colorMap[symbol] || '#ccc'}"></div>`;
                }
            }
            return html;
        }
        function varColor(k) { return getComputedStyle(document.body).getPropertyValue(`--c-${k}`).trim(); }

        /* --- IMPORT FUNCTIONALITY (UPDATED FOR MULTIPLES) --- */
        function openImportModal() { document.getElementById('importLayer').classList.add('active'); }
        function closeImportModal() { document.getElementById('importLayer').classList.remove('active'); document.getElementById('importStatus').textContent = ''; }
        
        async function processImport() {
            const txt = document.getElementById('importText').value;
            if(!txt.trim()) return;
            const status = document.getElementById('importStatus');
            status.textContent = 'Parsing...';
            
            const rawLines = txt.split('\n');
            // Stores: { name: "Swamp", count: 20 }
            const requests = [];

            rawLines.forEach(l => {
                if(!l.trim() || l.trim().startsWith('//')) return;
                
                // Parse "20 Swamp" or "1 Sol Ring"
                // Regex matches leading digits optionally followed by 'x'
                const match = l.trim().match(/^(\d+)[xX]?\s+(.*)/);
                let count = 1;
                let cleanLine = l.trim();
                
                if(match) {
                    count = parseInt(match[1]);
                    cleanLine = match[2];
                }

                // Handle Set Codes if present: "Swamp (UST) 214"
                const setMatch = cleanLine.match(/(.*?)\s+\(([\w\d]{3,})\)\s+(\d+)/);
                
                if(setMatch) {
                    requests.push({ 
                        identifier: { set: setMatch[2].toLowerCase(), collector_number: setMatch[3] },
                        count: count
                    });
                } else {
                    let name = cleanLine.replace(/\s\*F\*$/, ''); // Remove foil tag
                    requests.push({
                        identifier: { name: name },
                        count: count
                    });
                }
            });
            
            if(requests.length === 0) { status.textContent = "No valid cards."; return; }

            // Scryfall /cards/collection takes identifiers only
            // We need to batch requests, then map results back to counts
            const batches = [];
            let temp = [];
            requests.forEach(r => {
                temp.push(r.identifier);
                if(temp.length === 75) { batches.push(temp); temp = []; }
            });
            if(temp.length) batches.push(temp);

            let addedCount = 0;
            status.textContent = `Fetching ${requests.length} unique cards...`;

            // We need to map returned cards back to their requested counts.
            // Since Scryfall returns a list of found cards, we will iterate our 'requests'
            // and try to find the matching card in the results.

            for(const batchIdentifiers of batches) {
                try {
                    const res = await fetch('https://api.scryfall.com/cards/collection', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({identifiers: batchIdentifiers})
                    });
                    const json = await res.json();
                    
                    if(json.data) {
                        // For each card returned, find out how many we wanted
                        // This is slightly inefficient (O(N^2)) but fine for deck sizes (100 cards)
                        
                        // We iterate the original requests that correspond to this batch
                        // Note: Scryfall returns them in any order.
                        
                        // Better strategy: For every returned card, check if it matches a request in the global list
                        // But we might have multiple requests for "Swamp".
                        
                        // Strategy: Iterate over the batch identifiers we just sent.
                        // Find the corresponding card in json.data.
                        // Find the corresponding count in 'requests'.
                        
                        // Since 'batchIdentifiers' is a slice of 'requests' identifiers,
                        // we can correlate via index if we are careful, but let's just use matching.
                        
                        // Simplified: We loop through the cards returned.
                        // For each card, we check if we have a pending request for it.
                        
                        json.data.forEach(card => {
                            // Find matching request(s)
                            const matchingReqs = requests.filter(req => {
                                if(req.identifier.set && req.identifier.collector_number) {
                                    return req.identifier.set === card.set && req.identifier.collector_number === card.collector_number;
                                } else {
                                    return req.identifier.name.toLowerCase() === card.name.toLowerCase();
                                }
                            });

                            matchingReqs.forEach(req => {
                                // Prevent double adding if card appears multiple times in response (unlikely but possible with fuzziness)
                                // We consume the request? No, just add.
                                
                                const isBasic = card.type_line.includes('Basic Land');
                                
                                // How many to add?
                                const numToAdd = req.count;
                                
                                // Logic:
                                // If Basic Land -> Add 'numToAdd' copies.
                                // If Non-Basic -> Add 1 copy (Singleton), unless we forced it? 
                                // User asked for "simple land cards" multiple support.
                                // Let's strictly allow multiples for Basics, and 1 for others (safe default).
                                
                                const actualAdd = isBasic ? numToAdd : 1;
                                
                                for(let i=0; i<actualAdd; i++) {
                                    // Check singleton for non-basics inside the loop just in case
                                    if(isBasic || !state.deck.some(d => d.id === card.id)) {
                                        state.deck.push(card);
                                        addedCount++;
                                    }
                                }
                            });
                        });
                    }
                } catch(e) { console.error(e); }
            }

            saveDeck();
            updateDeckCount();
            status.textContent = `Done! Added ${addedCount} cards.`;
            setTimeout(() => {
                closeImportModal();
                if(state.viewingDeck) renderDeck();
            }, 1000);
        }

        /* --- DEEP ANALYSIS --- */
        function openAnalysis() {
            if(state.deck.length === 0) return alert('Deck is empty!');
            document.getElementById('analysisLayer').classList.add('active');
            renderAnalysis();
        }
        function closeAnalysis() { document.getElementById('analysisLayer').classList.remove('active'); }

        function calculateStats() {
            const stats = { count: state.deck.length, totalPrice: 0, totalCmc: 0, nonLandCount: 0, pips: { W:0, U:0, B:0, R:0, G:0, C:0, Total:0 }, curve: { 0:0, 1:0, 2:0, 3:0, 4:0, 5:0, 6:0, '7+':0 }, maxCurve: 0, types: {}, rarity: { common:0, uncommon:0, rare:0, mythic:0 } };
            state.deck.forEach(c => {
                stats.totalPrice += parseFloat(c.prices?.usd || 0);
                if(!c.type_line.includes('Land')) {
                    stats.totalCmc += (c.cmc || 0); stats.nonLandCount++;
                    const cmcIdx = Math.min(Math.floor(c.cmc||0), 7); const key = cmcIdx === 7 ? '7+' : cmcIdx;
                    stats.curve[key]++; if(stats.curve[key] > stats.maxCurve) stats.maxCurve = stats.curve[key];
                }
                if(c.mana_cost) { const matches = c.mana_cost.match(/\{([WUBRGCc])\}/g); if(matches) matches.forEach(m => { const sym = m.replace(/[\{\}]/g, ''); if(stats.pips[sym] !== undefined) { stats.pips[sym]++; stats.pips.Total++; } }); }
                const mainType = c.type_line.split('‚Äî')[0].trim().split(' ').pop(); stats.types[mainType] = (stats.types[mainType] || 0) + 1;
                if(stats.rarity[c.rarity] !== undefined) stats.rarity[c.rarity]++;
            });
            return stats;
        }

        function renderAnalysis() {
            const s = calculateStats();
            const avgCmc = s.nonLandCount ? (s.totalCmc / s.nonLandCount).toFixed(2) : '0.00';
            const priceStr = s.totalPrice.toLocaleString('en-US', {style:'currency', currency:'USD'});
            let gradStr = ''; let currentDeg = 0; const colors = ['W','U','B','R','G','C'];
            colors.forEach(k => {
                const count = s.pips[k];
                if(count > 0) {
                    const pct = count / s.pips.Total; const deg = pct * 360; const color = varColor(k.toLowerCase());
                    gradStr += `${color} ${currentDeg}deg ${currentDeg + deg}deg, `; currentDeg += deg;
                }
            });
            gradStr = gradStr.slice(0, -2) || '#333 0deg 360deg';
            
            let html = `
            <div class="analysis-grid">
                <div class="span-2"><div class="dash-row"><div class="dash-box"><div class="dash-val" style="color:#4ade80;">${priceStr}</div><div class="dash-lbl">Value</div></div><div class="dash-box"><div class="dash-val">${avgCmc}</div><div class="dash-lbl">Avg CMC</div></div><div class="dash-box"><div class="dash-val">${s.count}</div><div class="dash-lbl">Cards</div></div></div></div>
                <div class="stat-card span-2"><div class="stat-header">Mana Curve</div><div class="curve-chart">${Object.keys(s.curve).map(k => { const h = s.maxCurve ? (s.curve[k] / s.maxCurve) * 100 : 0; return `<div class="curve-col"><div class="curve-count">${s.curve[k]||''}</div><div class="curve-bar" style="height:${h}%"></div><div class="curve-label">${k}</div></div>`; }).join('')}</div></div>
                <div class="stat-card"><div class="stat-header">Pips</div><div class="donut-container"><div class="donut" style="--chart-gradient:${gradStr}"></div><div class="donut-center"><div class="donut-val">${s.pips.Total}</div></div></div></div>
                <div class="stat-card"><div class="stat-header">Types</div>${Object.entries(s.types).sort((a,b)=>b[1]-a[1]).map(([t, c]) => `<div style="display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.05);"><span>${t}</span><span style="font-weight:bold;">${c}</span></div>`).join('')}</div>
            </div>`;
            document.getElementById('analysisContent').innerHTML = html;
        }

        /* --- API & SEARCH --- */
        async function fetchCards(reset = false) {
            if(state.isLoading) return;
            state.isLoading = true; els.loader.style.opacity = 1;
            if(reset) { state.data = []; state.page = 1; state.hasMore = true; state.nextUrl = null; els.grid.innerHTML = ''; document.getElementById('mainScroll').scrollTop = 0; }
            
            try {
                let url = state.nextUrl;
                if(!url) {
                    const parts = [];
                    // Sync filters
                    const qInput = els.search.value.trim();
                    if(qInput) parts.push(qInput.includes(':') ? `(${qInput})` : `(${qInput} OR o:${qInput})`);
                    if(state.filters.colors.size) parts.push(`id:${Array.from(state.filters.colors).join('')}`);
                    if(state.filters.types.size) parts.push(`(${Array.from(state.filters.types).map(t=>`t:${t}`).join(' OR ')})`);
                    if(!state.selectedSets.has('ALL')) parts.push(`(${Array.from(state.selectedSets).map(x => `set:${x}`).join(' OR ')})`);

                    const sort = document.getElementById('sortSelect').value;
                    let sortStr = `order=${sort}`;
                    if(sort === 'usd_asc') sortStr = 'order=usd&dir=asc';
                    
                    // Default released, but support price too
                    if(sort === 'released') sortStr = 'order=released&dir=desc';

                    const qStr = parts.length ? `q=${encodeURIComponent(parts.join(' AND '))}` : `q=date>=2020`;
                    url = `${API}/cards/search?${qStr}&${sortStr}&page=${state.page}`;
                }

                const res = await fetch(url); const json = await res.json();
                if(json.code === 'not_found') { els.grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px; color:#666;">No cards found.</div>'; state.hasMore = false; }
                else {
                    const offset = state.data.length;
                    state.data = [...state.data, ...json.data];
                    state.hasMore = json.has_more; state.nextUrl = json.next_page;
                    json.data.forEach((c, i) => renderCardElement(c, offset + i));
                }
            } catch(e) { console.error(e); } finally { state.isLoading = false; els.loader.style.opacity = 0; }
        }

        function renderCardElement(c, idx) {
            let img = c.image_uris?.normal || c.card_faces?.[0]?.image_uris?.normal; if(!img) return;
            const inDeck = state.deck.some(d => d.id === c.id);
            const div = document.createElement('div');
            div.className = `card-wrapper ${inDeck ? 'in-deck' : ''}`; div.dataset.id = c.id; div.style.animationDelay = `${(idx % 10) * 0.05}s`;
            
            div.innerHTML = `
                <div class="card-item" onclick="openModalForSearch(${idx})">
                    <img src="${img}" class="card-img" onload="this.classList.add('loaded')">
                    <div class="fav-indicator" onclick="event.stopPropagation(); toggleDeckCard('${c.id}', true)">‚ô•</div>
                </div>`;
            els.grid.appendChild(div);
        }

        /* --- SETS (Restored) --- */
        async function loadSets() {
            const cached = localStorage.getItem('mtg_sets_v7');
            if(cached) state.sets = JSON.parse(cached);
            else { 
                const r = await fetch('https://api.scryfall.com/sets'); const j = await r.json(); 
                state.sets = j.data.filter(s => ['expansion','core','masters','commander','box','promo'].includes(s.set_type)); 
                localStorage.setItem('mtg_sets_v7', JSON.stringify(state.sets)); 
            }
            renderSetList();
        }

        function renderSetList() {
            const list = document.getElementById('setList'); list.innerHTML = '';
            
            const master = document.createElement('div'); const isAll = state.selectedSets.has('ALL');
            master.className = `set-row special ${isAll ? 'selected' : ''}`; master.innerHTML = `<div>${isAll?'‚úî':'‚óã'}</div><div>All Sets</div>`;
            master.onclick = () => { state.selectedSets.clear(); state.selectedSets.add('ALL'); renderSetList(); };
            list.appendChild(master);

            const sldDeck = document.createElement('div'); const isSld = state.selectedSets.has('sld') && state.selectedSets.size === 1;
            sldDeck.className = `set-row pinned ${isSld ? 'selected' : ''}`; sldDeck.innerHTML = `<div>${isSld?'‚òÖ':'‚òÜ'}</div><div>Secret Lair Drop (All)</div>`;
            sldDeck.onclick = () => { state.selectedSets.clear(); state.selectedSets.add('sld'); renderSetList(); };
            list.appendChild(sldDeck);

            const term = document.getElementById('setSearch').value.toLowerCase();
            state.sets.forEach(s => {
                if(s.code === 'sld') return;
                if(term && !s.name.toLowerCase().includes(term) && !s.code.includes(term)) return;
                const div = document.createElement('div'); const isSel = state.selectedSets.has(s.code);
                div.className = `set-row ${isSel ? 'selected' : ''}`; div.innerHTML = `<div>${isSel?'‚úî':'‚óã'}</div><div>${s.name}</div>`;
                div.onclick = () => { state.selectedSets.delete('ALL'); state.selectedSets.has(s.code)?state.selectedSets.delete(s.code):state.selectedSets.add(s.code); if(state.selectedSets.size===0)state.selectedSets.add('ALL'); renderSetList(); };
                list.appendChild(div);
            });
        }
        document.getElementById('setSearch').addEventListener('input', renderSetList);

        /* --- MODAL LOGIC (SWIPE/TILT) --- */
        function openModalForSearch(idx) {
            state.activeContextList = state.data;
            openModal(idx);
        }
        function openModalForDeckCard(id) {
            const idx = state.deck.findIndex(c => c.id === id);
            state.activeContextList = state.deck;
            openModal(idx);
        }
        function openModal(idx) {
            state.currentCardIndex = idx;
            const c = state.activeContextList[idx];
            updateModalContent(c);
            document.getElementById('modal').classList.add('active');
        }
        function updateModalContent(c) {
            let img = c.image_uris?.png || c.card_faces?.[0]?.image_uris?.png;
            document.getElementById('modalImg').src = img;
            document.getElementById('modalTitle').textContent = c.name;
            document.getElementById('modalType').textContent = c.type_line;
            updateModalButtons(c);
        }
        function updateModalButtons(c) {
            const container = document.getElementById('modalActionContainer');
            const inDeck = state.deck.some(d => d.id === c.id);
            const isCmdr = state.commanderId === c.id;
            const price = c.prices?.usd || '--';
            let html = '';
            if(inDeck) {
                html += `<button class="action-btn delete-btn" onclick="toggleDeckCard({id:'${c.id}'})">‚úï Remove</button>`;
            } else {
                html += `<button class="action-btn primary-btn" onclick="toggleDeckCard(state.activeContextList[state.currentCardIndex])">‚ô• Add</button>`;
            }
            if(inDeck && c.type_line.includes('Legendary') && c.type_line.includes('Creature')) {
                html += isCmdr ? `<button class="action-btn cmdr-btn" onclick="setCommander('${c.id}')">Unset Cmdr</button>` : `<button class="action-btn cmdr-btn" onclick="setCommander('${c.id}')">üëë Set Cmdr</button>`;
            }
            html += `<a href="${c.scryfall_uri}" target="_blank" class="action-btn">Scryfall</a>`;
            container.innerHTML = html;
        }
        function closeModal() { document.getElementById('modal').classList.remove('active'); }

        function handleEnter(e) { if(e.key === 'Enter') { els.search.blur(); fetchCards(true); } }
        function toggleSheet() { document.getElementById('sheet').classList.toggle('active'); }
        function applyAdvFilters() { toggleSheet(); fetchCards(true); }

        function initFoilEffect() {
            const wrap = document.getElementById('card3d'); const foil = document.getElementById('foilLayer');
            wrap.addEventListener('mousemove', (e) => {
                const rect = wrap.getBoundingClientRect();
                const x = e.clientX - rect.left; const y = e.clientY - rect.top;
                const rX = ((y - rect.height/2) / (rect.height/2)) * -10;
                const rY = ((x - rect.width/2) / (rect.width/2)) * 10;
                wrap.style.transform = `perspective(1000px) rotateX(${rX}deg) rotateY(${rY}deg)`;
                foil.style.backgroundPosition = `${x/5+y/5}%`; foil.style.opacity = 1;
            });
            wrap.addEventListener('mouseleave', () => { wrap.style.transform = 'perspective(1000px) rotateX(0) rotateY(0)'; foil.style.opacity = 0; });
        }
        
        let touchStartX = 0; let touchEndX = 0;
        function initSwipe() {
            const area = document.getElementById('swipeArea');
            area.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, {passive: true});
            area.addEventListener('touchend', e => { touchEndX = e.changedTouches[0].screenX; handleSwipeGesture(); }, {passive: true});
        }
        function handleSwipeGesture() {
            if (touchEndX < touchStartX - 50) navigateCard(1);
            if (touchEndX > touchStartX + 50) navigateCard(-1);
        }
        function handleBgClick(e) { if(e.target.id === 'swipeArea') closeModal(); }
        
        function navigateCard(direction) {
            const wrapper = document.getElementById('modalContent');
            if(state.activeContextList.length === 0) return;
            wrapper.style.transform = direction === 1 ? 'translateX(-20px)' : 'translateX(20px)';
            wrapper.style.opacity = '0';
            setTimeout(() => {
                let newIndex = state.currentCardIndex + direction;
                if (newIndex >= state.activeContextList.length) newIndex = 0;
                if (newIndex < 0) newIndex = state.activeContextList.length - 1;
                state.currentCardIndex = newIndex;
                updateModalContent(state.activeContextList[newIndex]);
                wrapper.style.transform = direction === 1 ? 'translateX(20px)' : 'translateX(-20px)';
                requestAnimationFrame(() => { wrapper.style.transform = 'translateX(0)'; wrapper.style.opacity = '1'; });
            }, 200);
        }
        
        function initInfiniteScroll() {
            const el = document.getElementById('mainScroll');
            el.addEventListener('scroll', () => {
                if(el.scrollTop + el.clientHeight >= el.scrollHeight - 300) {
                    if(state.hasMore && !state.isLoading) { state.page++; fetchCards(); }
                }
            });
        }
    </script>
</body>
</html>
