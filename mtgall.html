<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Arcane Mobile</title>
    <style>
        :root {
            --bg-body: #09090b;
            --bg-surface: #18181b;
            --bg-glass: rgba(24, 24, 27, 0.85);
            --primary: #8b5cf6; /* Vivid Purple */
            --primary-glow: rgba(139, 92, 246, 0.5);
            --text-main: #ffffff;
            --text-sub: #a1a1aa;
            --border: #27272a;
            --safe-area-bottom: env(safe-area-inset-bottom);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- Header --- */
        header {
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            background: var(--bg-surface);
            border-bottom: 1px solid var(--border);
            z-index: 50;
        }

        .brand { font-weight: 800; font-size: 1.2rem; letter-spacing: -0.5px; display: flex; align-items: center; gap: 8px; }
        .brand span { color: var(--primary); font-size: 1.5rem; }

        .filter-toggle {
            background: var(--border);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* --- Main Grid --- */
        .scroller {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 15px;
            scroll-behavior: smooth;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); /* Adaptive grid */
            gap: 15px;
            padding-bottom: 80px; /* Space for bottom content */
        }

        /* Mobile Adjustments for Grid */
        @media (max-width: 600px) {
            .card-grid {
                grid-template-columns: 1fr 1fr; /* Strict 2 column on mobile */
                gap: 10px;
            }
            .filter-toggle {
                background: var(--primary); /* Highlight filter btn on mobile */
            }
        }

        .card-item {
            position: relative;
            aspect-ratio: 2.5/3.5;
            border-radius: 10px;
            background: var(--bg-surface);
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .card-item:active { transform: scale(0.96); } 
        @media(hover: hover) { .card-item:hover { transform: translateY(-5px); } }

        .card-img {
            width: 100%; height: 100%; object-fit: cover;
            opacity: 0; transition: opacity 0.3s;
        }
        .card-img.loaded { opacity: 1; }

        /* Skeleton Loading State */
        .skeleton {
            background: linear-gradient(110deg, #1f1f23 8%, #2a2a30 18%, #1f1f23 33%);
            background-size: 200% 100%;
            animation: shine 1.5s linear infinite;
        }
        @keyframes shine { to { background-position-x: -200%; } }

        /* --- Filter Sheet (Mobile Bottom Sheet / Desktop Sidebar) --- */
        .filters-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            backdrop-filter: blur(4px);
            z-index: 100;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        .filters-overlay.open { opacity: 1; pointer-events: auto; }

        .filter-panel {
            position: absolute;
            background: var(--bg-surface);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            padding: 20px;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
        }

        /* Desktop: Sidebar */
        @media (min-width: 769px) {
            .filter-panel {
                top: 0; right: 0; bottom: 0;
                width: 350px;
                transform: translateX(100%);
                border-left: 1px solid var(--border);
            }
            .filters-overlay.open .filter-panel { transform: translateX(0); }
        }

        /* Mobile: Bottom Sheet */
        @media (max-width: 768px) {
            .filter-panel {
                bottom: 0; left: 0; right: 0;
                height: 85vh; /* 85% height */
                border-radius: 20px 20px 0 0;
                transform: translateY(100%);
            }
            .filters-overlay.open .filter-panel { transform: translateY(0); }
        }

        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .panel-title { font-weight: bold; font-size: 1.2rem; }
        .close-btn { background: none; border: none; color: var(--text-sub); font-size: 1.5rem; padding: 5px; cursor: pointer; }

        .search-input {
            width: 100%;
            background: #09090b;
            border: 1px solid var(--border);
            padding: 12px;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .filter-section { margin-bottom: 25px; }
        .filter-label { color: var(--text-sub); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; display: block; font-weight: 700; }

        select {
            width: 100%; padding: 12px; background: #09090b; border: 1px solid var(--border);
            color: white; border-radius: 8px; appearance: none;
        }

        .mana-row { display: flex; gap: 10px; justify-content: space-between; }
        .mana-btn {
            width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--border);
            background: #09090b; color: #666; font-weight: bold;
            display: grid; place-items: center; cursor: pointer; transition: 0.2s;
        }
        .mana-btn.active { border-color: white; transform: scale(1.1); color: #09090b; }
        /* Colors */
        .mana-btn[data-c="w"].active { background: #fffbd5; }
        .mana-btn[data-c="u"].active { background: #aae0fa; }
        .mana-btn[data-c="b"].active { background: #cbc2bf; }
        .mana-btn[data-c="r"].active { background: #f9aa8f; }
        .mana-btn[data-c="g"].active { background: #9bd3ae; }

        .apply-btn {
            margin-top: auto;
            width: 100%;
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 12px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
        }

        /* --- Fullscreen Modal (Swipeable) --- */
        .modal {
            position: fixed; inset: 0; z-index: 200;
            background: rgba(0,0,0,0.95);
            display: flex; flex-direction: column;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal.active { opacity: 1; pointer-events: auto; }

        .modal-header {
            padding: 15px; display: flex; justify-content: flex-end;
        }
        
        .modal-body {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; position: relative;
        }

        /* 3D Card Effect */
        .modal-card {
            width: 85%; max-width: 350px;
            border-radius: 14px;
            box-shadow: 0 0 50px rgba(139, 92, 246, 0.2);
            transition: transform 0.2s; /* Immediate response for swipe */
            touch-action: pan-y; /* Allow vertical scroll, hijack horizontal */
        }

        .modal-info {
            margin-top: 20px;
            text-align: center;
            color: white;
            width: 100%;
            max-width: 500px;
        }

        .price-tag {
            display: inline-block;
            background: #27272a;
            padding: 8px 16px;
            border-radius: 20px;
            color: #4ade80;
            font-weight: bold;
            margin-top: 10px;
            text-decoration: none;
        }

        .loader-bar {
            height: 3px; width: 100%; background: transparent;
            position: absolute; top: 60px; left: 0; overflow: hidden;
        }
        .loader-bar .progress {
            width: 50%; height: 100%; background: var(--primary);
            position: absolute; left: -50%;
            animation: load 1s infinite linear;
            display: none;
        }
        .loader-bar.loading .progress { display: block; }
        @keyframes load { 0% { left: -50%; } 100% { left: 100%; } }

    </style>
</head>
<body>

    <header>
        <div class="brand"><span>✦</span> Archive</div>
        <button class="filter-toggle" onclick="toggleFilters()">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg>
            Filters
        </button>
    </header>

    <div class="loader-bar" id="loaderBar"><div class="progress"></div></div>

    <div class="scroller" id="scrollContainer">
        <div class="card-grid" id="grid">
            </div>
        <div id="endOfList" style="height: 50px; text-align: center; color: #666; margin-top: 20px;"></div>
    </div>

    <div class="filters-overlay" id="filterOverlay" onclick="toggleFilters()">
        <div class="filter-panel" onclick="event.stopPropagation()">
            <div class="panel-header">
                <span class="panel-title">Filters</span>
                <button class="close-btn" onclick="toggleFilters()">×</button>
            </div>
            
            <input type="text" id="searchInput" class="search-input" placeholder="Card name, type, text...">
            
            <div class="filter-section">
                <span class="filter-label">Set / Release</span>
                <select id="setSelect">
                    <option value="fdn">Foundations (Latest)</option>
                    <option value="dsk">Duskmourn</option>
                    <option value="blb">Bloomburrow</option>
                    <option value="mh3">Modern Horizons 3</option>
                    </select>
            </div>

            <div class="filter-section">
                <span class="filter-label">Colors</span>
                <div class="mana-row">
                    <div class="mana-btn" data-c="w" onclick="toggleMana(this)">W</div>
                    <div class="mana-btn" data-c="u" onclick="toggleMana(this)">U</div>
                    <div class="mana-btn" data-c="b" onclick="toggleMana(this)">B</div>
                    <div class="mana-btn" data-c="r" onclick="toggleMana(this)">R</div>
                    <div class="mana-btn" data-c="g" onclick="toggleMana(this)">G</div>
                </div>
            </div>

            <button class="apply-btn" onclick="applyFilters()">Show Cards</button>
        </div>
    </div>

    <div class="modal" id="modal">
        <div class="modal-header">
            <button class="close-btn" onclick="closeModal()" style="color: white; font-size: 2rem;">&times;</button>
        </div>
        <div class="modal-body" id="modalBody">
            <img src="" id="modalImg" class="modal-card">
            <div class="modal-info">
                <h2 id="modalTitle" style="margin-bottom: 5px;"></h2>
                <div id="modalType" style="color: var(--text-sub); margin-bottom: 15px;"></div>
                <a href="#" id="modalPrice" target="_blank" class="price-tag">View on TCGPlayer</a>
            </div>
            <div style="margin-top: 20px; color: #666; font-size: 0.8rem;">
                Swipe left/right to browse
            </div>
        </div>
    </div>

    <script>
        // --- DATA & STATE ---
        let cards = [];
        let nextPage = null;
        let isLoading = false;
        let currentIdx = 0;
        
        // --- ELEMENTS ---
        const grid = document.getElementById('grid');
        const loaderBar = document.getElementById('loaderBar');
        const setSelect = document.getElementById('setSelect');
        const scrollContainer = document.getElementById('scrollContainer');
        const modal = document.getElementById('modal');
        const modalImg = document.getElementById('modalImg');

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            // 1. Load Sets in Background
            loadSets(); 
            // 2. Fetch Initial Cards (Default: Latest Set 'Foundations' for speed)
            fetchCards(`https://api.scryfall.com/cards/search?q=set:fdn&order=usd`);
            // 3. Infinite Scroll Observer
            setupInfiniteScroll();
        });

        // --- SETS MANAGEMENT (Optimized) ---
        async function loadSets() {
            // Check LocalStorage first
            const cached = localStorage.getItem('mtg_sets_v1');
            if(cached) {
                populateSetDropdown(JSON.parse(cached));
                // Refetch quietly to update cache
                fetchSetsApi();
            } else {
                await fetchSetsApi();
            }
        }

        async function fetchSetsApi() {
            try {
                // Fetch only expansions to keep payload small
                const resp = await fetch('https://api.scryfall.com/sets');
                const json = await resp.json();
                const mainSets = json.data.filter(s => ['expansion', 'core', 'masters', 'commander'].includes(s.set_type));
                
                localStorage.setItem('mtg_sets_v1', JSON.stringify(mainSets));
                populateSetDropdown(mainSets);
            } catch(e) { console.error(e); }
        }

        function populateSetDropdown(sets) {
            setSelect.innerHTML = '<option value="">All Sets</option>';
            sets.forEach(s => {
                const opt = document.createElement('option');
                opt.value = s.code;
                opt.textContent = `${s.name} (${s.code.toUpperCase()})`;
                if(s.code === 'fdn') opt.selected = true; // Default
            });
        }

        // --- CARD FETCHING ---
        async function fetchCards(url, append = false) {
            if(isLoading || !url) return;
            isLoading = true;
            loaderBar.classList.add('loading');

            if(!append) {
                cards = [];
                grid.innerHTML = '';
                // Add skeletons
                for(let i=0; i<10; i++) grid.innerHTML += `<div class="card-item skeleton"></div>`;
            }

            try {
                const resp = await fetch(url);
                const json = await resp.json();
                
                // Clear skeletons if new fetch
                if(!append) grid.innerHTML = '';

                if(json.data) {
                    cards = append ? [...cards, ...json.data] : json.data;
                    nextPage = json.has_more ? json.next_page : null;
                    renderCards(json.data, append);
                }
            } catch(e) {
                console.error(e);
            } finally {
                isLoading = false;
                loaderBar.classList.remove('loading');
            }
        }

        function renderCards(newCards, append) {
            // Offset used to calculate correct index for click handler
            const baseIdx = append ? cards.length - newCards.length : 0;

            const html = newCards.map((c, i) => {
                // Image logic (Face A or Normal)
                let img = c.image_uris?.normal || c.card_faces?.[0]?.image_uris?.normal || '';
                if(!img) return ''; // Skip cards with no images

                return `
                <div class="card-item" onclick="openModal(${baseIdx + i})">
                    <img src="${img}" class="card-img" onload="this.classList.add('loaded')">
                </div>
                `;
            }).join('');

            grid.insertAdjacentHTML('beforeend', html);
        }

        // --- FILTERS ---
        function toggleFilters() {
            document.getElementById('filterOverlay').classList.toggle('open');
        }

        function toggleMana(btn) {
            btn.classList.toggle('active');
        }

        function applyFilters() {
            toggleFilters();
            
            // Build Query
            let q = [];
            const text = document.getElementById('searchInput').value;
            if(text) q.push(text);

            const set = document.getElementById('setSelect').value;
            if(set) q.push(`set:${set}`);

            const colors = Array.from(document.querySelectorAll('.mana-btn.active')).map(b => b.dataset.c).join('');
            if(colors) q.push(`id:${colors}`); // Identity filter

            const queryStr = encodeURIComponent(q.join(' '));
            // Default sort by Price USD Descending
            fetchCards(`https://api.scryfall.com/cards/search?q=${queryStr}&order=usd`);
        }

        // --- INFINITE SCROLL ---
        function setupInfiniteScroll() {
            const observer = new IntersectionObserver((entries) => {
                if(entries[0].isIntersecting && nextPage) {
                    fetchCards(nextPage, true);
                }
            }, { rootMargin: '200px' });
            
            observer.observe(document.getElementById('endOfList'));
        }

        // --- MODAL & SWIPE LOGIC ---
        function openModal(idx) {
            currentIdx = idx;
            updateModal();
            modal.classList.add('active');
        }

        function closeModal() {
            modal.classList.remove('active');
        }

        function updateModal() {
            const c = cards[currentIdx];
            if(!c) return;

            let img = c.image_uris?.png || c.card_faces?.[0]?.image_uris?.png || ''; // High res
            modalImg.src = img;
            
            document.getElementById('modalTitle').textContent = c.name;
            document.getElementById('modalType').textContent = c.type_line;
            
            const price = c.prices?.usd || c.prices?.usd_foil || '---';
            const link = document.getElementById('modalPrice');
            link.textContent = `$${price} | Buy on TCGPlayer`;
            link.href = c.purchase_uris?.tcgplayer || '#';
        }

        // Swipe Handling
        let touchStartX = 0;
        let touchEndX = 0;

        const modalBody = document.getElementById('modalBody');

        modalBody.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
        }, {passive: true});

        modalBody.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, {passive: true});

        function handleSwipe() {
            const threshold = 50;
            if (touchEndX < touchStartX - threshold) {
                // Swipe Left -> Next
                nextCard();
            }
            if (touchEndX > touchStartX + threshold) {
                // Swipe Right -> Prev
                prevCard();
            }
        }

        function nextCard() {
            if(currentIdx < cards.length - 1) {
                currentIdx++;
                animateModal('left');
            } else if (nextPage) {
                // Auto load more if at end?
                // For now, just stop.
            }
        }

        function prevCard() {
            if(currentIdx > 0) {
                currentIdx--;
                animateModal('right');
            }
        }

        function animateModal(dir) {
            // Simple animation class toggle
            modalImg.style.opacity = '0.5';
            setTimeout(() => {
                updateModal();
                modalImg.style.opacity = '1';
            }, 150);
        }

    </script>
</body>
</html>
