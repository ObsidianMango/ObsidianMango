<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>MangoLab ‚Äî A Single-File Interactive Art + Sound Playground</title>
<meta name="theme-color" content="#0b0f14" />
<style>
  /* ===========
     MANGOLAB: single-file, modern CSS goodies
     - :has() for parent selection
     - container queries for responsive cards
     - @property for animatable custom props
     - color-scheme + light/dark themes
     - View-Transitions friendly classes
     =========== */

  :root {
    --bg: #0b0f14;
    --panel: #10161f;
    --ink: #e8f0ff;
    --muted: #8aa0c1;
    --accent: #6ceb9b;
    --accent-2: #8ab6ff;
    --danger: #ff6b6b;
    --radius: 14px;
    --shadow: 0 10px 30px -10px rgba(0,0,0,.6);
    color-scheme: dark;
  }

  /* Light mode variables (toggled via [data-theme="light"]) */
  :root[data-theme="light"] {
    --bg: #f6f7fb;
    --panel: #ffffff;
    --ink: #0b1320;
    --muted: #4b5a72;
    --accent: #007a5a;
    --accent-2: #2458ff;
    color-scheme: light;
  }

  @property --spin {
    syntax: "<number>";
    inherits: false;
    initial-value: 0;
  }

  @keyframes floaty {
    from { transform: translateY(0px) }
    to   { transform: translateY(-6px) }
  }

  html, body {
    height: 100%;
    margin: 0;
    background: radial-gradient(1200px 800px at 70% -10%, rgba(108,235,155,.08), transparent 60%),
                radial-gradient(900px 600px at 20% 110%, rgba(36,88,255,.07), transparent 55%),
                var(--bg);
    color: var(--ink);
    font: 15px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
    overflow: hidden;
  }

  /* Top bar */
  .chrome {
    position: fixed; inset: 0 0 auto 0;
    display: grid; grid-template-columns: 1fr auto auto auto;
    gap: 8px; align-items: center;
    padding: env(safe-area-inset-top) 14px 10px 14px;
    background: color-mix(in oklch, var(--bg) 70%, transparent);
    backdrop-filter: blur(10px) saturate(120%);
    border-bottom: 1px solid color-mix(in oklch, var(--ink) 10%, transparent);
    z-index: 5;
  }
  .title {
    font-weight: 800; letter-spacing: .4px;
    display:flex; align-items:center; gap:.6rem;
  }
  .title .logo {
    width: 26px; height: 26px; border-radius: 9px;
    background:
      conic-gradient(from calc(var(--spin)*1turn), var(--accent), var(--accent-2), var(--accent)) border-box;
    -webkit-mask:
      radial-gradient(9px at 50% 50%, #000 98%, transparent) subtract,
      linear-gradient(#000 0 0);
    mask:
      radial-gradient(9px at 50% 50%, #000 98%, transparent) subtract,
      linear-gradient(#000 0 0);
    animation: floaty 2.4s ease-in-out infinite alternate;
    box-shadow: inset 0 0 0 2px color-mix(in oklch, var(--ink) 15%, transparent),
                var(--shadow);
  }
  .title small { color: var(--muted); font-weight: 600; }

  .btn {
    appearance: none; border: 0; cursor: pointer;
    padding: 10px 14px; border-radius: 999px; font-weight: 700;
    background: linear-gradient(180deg, color-mix(in oklch, var(--panel) 100%, transparent), color-mix(in oklch, var(--panel) 80%, transparent));
    color: var(--ink);
    box-shadow: var(--shadow);
    transition: transform .12s ease, background .2s ease, box-shadow .2s ease;
    display:inline-flex; gap:.5rem; align-items:center;
  }
  .btn:hover { transform: translateY(-1px) }
  .btn:active { transform: translateY(0) scale(.98) }
  .btn.primary { background: linear-gradient(180deg, color-mix(in oklch, var(--accent) 30%, var(--panel)), color-mix(in oklch, var(--accent) 10%, var(--panel))); }
  .btn.danger { background: linear-gradient(180deg, color-mix(in oklch, var(--danger) 25%, var(--panel)), color-mix(in oklch, var(--danger) 10%, var(--panel))); }
  .btn .dot { width:8px;height:8px;border-radius:50%; background:currentColor; opacity:.7 }

  /* Dock */
  .dock {
    position: fixed; inset: auto 0 0 0;
    display: grid; grid-auto-flow: column; gap: 12px; place-content: center;
    padding: 14px 10px calc(10px + env(safe-area-inset-bottom));
    pointer-events: none; z-index: 4;
  }
  .dock .btn { pointer-events: auto; }

  /* Panels */
  .grid {
    position: absolute; inset: 56px 0 70px 0; /* below chrome, above dock */
    display: grid;
    grid-template-columns: 360px 1fr;
    gap: 14px; padding: 14px; overflow: hidden;
  }
  @container (max-width: 820px) {
    /* Will kick in when we wrap panels in container; we create a container below */
  }
  .sidebar, .stage {
    background: linear-gradient(180deg, color-mix(in oklch, var(--panel) 85%, transparent), color-mix(in oklch, var(--panel) 70%, transparent));
    border: 1px solid color-mix(in oklch, var(--ink) 8%, transparent);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: clip;
    position: relative;
  }
  .stage { display: grid; grid-template-rows: 1fr auto; }
  .stage .surface { position: relative; overflow: clip; }
  .stage-footer {
    display: flex; align-items: center; gap: 10px;
    padding: 10px 12px; border-top: 1px solid color-mix(in oklch, var(--ink) 8%, transparent);
    background: color-mix(in oklch, var(--panel) 92%, transparent);
  }
  .kpis {
    display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;
    padding: 12px; border-top: 1px solid color-mix(in oklch, var(--ink) 8%, transparent);
    background: color-mix(in oklch, var(--panel) 95%, transparent);
  }
  .kpi {
    background: color-mix(in oklch, var(--panel) 85%, transparent);
    border: 1px solid color-mix(in oklch, var(--ink) 8%, transparent);
    border-radius: 12px; padding: 10px;
  }
  .kpi b { font-size: 18px; display:block }
  .kpi small { color: var(--muted) }

  .sidebar {
    display:grid; grid-template-rows: auto 1fr;
  }
  .sidebar header {
    display:flex; align-items:center; justify-content:space-between;
    padding: 12px; border-bottom: 1px solid color-mix(in oklch, var(--ink) 8%, transparent);
  }
  .sidebar .controls {
    padding: 12px; display:grid; gap:12px; overflow:auto;
    container-type: inline-size; container-name: side;
  }
  .card {
    background: color-mix(in oklch, var(--panel) 92%, transparent);
    border: 1px solid color-mix(in oklch, var(--ink) 8%, transparent);
    border-radius: 12px; padding: 12px; display:grid; gap:10px;
  }
  .card h3 { margin:0; font-size:14px; text-transform:uppercase; letter-spacing:.08em; color:var(--muted) }
  .range {
    display:grid; grid-template-columns: 1fr auto; align-items:center; gap: 10px;
  }
  .range input[type="range"] { width:100% }
  .switch {
    display:flex; align-items:center; justify-content:space-between;
  }
  .switch input { accent-color: var(--accent) }

  /* Responsive reflow using :has() to collapse sidebar on small screens */
  @media (max-width: 980px) {
    .grid { grid-template-columns: 1fr; }
    .sidebar { order: 2; height: 40dvh; }
    .stage { order: 1; }
  }

  /* Hints overlay */
  .hint {
    position:absolute; inset:auto 12px 12px auto;
    background: color-mix(in oklch, var(--panel) 95%, transparent);
    border: 1px solid color-mix(in oklch, var(--ink) 10%, transparent);
    padding: 8px 10px; border-radius: 10px; color: var(--muted); font-weight: 600;
  }

  /* Badges */
  .badge {
    padding: 4px 8px; border-radius: 999px; font-weight: 700; font-size: 12px;
    background: color-mix(in oklch, var(--accent) 20%, var(--panel));
    border: 1px solid color-mix(in oklch, var(--ink) 10%, transparent);
  }

  /* Slotted monos for tiny readouts */
  .mono { font: 600 12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; color: var(--muted) }

  /* Toasts */
  .toasts {
    position: fixed; inset: 60px 10px auto auto; display:grid; gap:8px; z-index: 6;
  }
  .toast {
    background: color-mix(in oklch, var(--panel) 92%, transparent);
    border: 1px solid color-mix(in oklch, var(--ink) 10%, transparent);
    color: var(--ink); padding: 8px 10px; border-radius: 10px; box-shadow: var(--shadow);
    animation: fadein .25s ease-out;
  }
  @keyframes fadein { from{ opacity:0; transform: translateY(-6px) } to { opacity:1; transform: none } }

  /* View Transitions hook */
  ::view-transition-old(root), ::view-transition-new(root) { animation-duration: .35s }

</style>
</head>
<body>
  <div class="chrome">
    <div class="title">
      <div class="logo" aria-hidden="true"></div>
      MangoLab <small>‚Äî single-file demo of modern web sorcery</small>
    </div>
    <button class="btn" id="themeBtn" title="Toggle Theme">üåì Theme</button>
    <button class="btn" id="shareBtn" title="Share link">üîó Share</button>
    <button class="btn primary" id="saveBtn" title="Save snapshot">üì∏ Snapshot</button>
  </div>

  <div class="grid" id="grid">
    <section class="sidebar" id="sidebar">
      <header>
        <div><span class="badge">Controls</span></div>
        <div class="mono" id="fpsReadout">fps: ‚Äî</div>
      </header>

      <div class="controls">
        <div class="card">
          <h3>Scene</h3>
          <div class="range">
            <label>Complexity</label>
            <input type="range" min="0" max="1" step="0.001" value="0.55" id="complexity">
          </div>
          <div class="range">
            <label>Flow Speed</label>
            <input type="range" min="0" max="1" step="0.001" value="0.43" id="flow">
          </div>
          <div class="switch">
            <label>Rain</label>
            <input type="checkbox" id="rainToggle" checked>
          </div>
          <div class="switch">
            <label>Post-glow</label>
            <input type="checkbox" id="glowToggle" checked>
          </div>
        </div>

        <div class="card">
          <h3>Soundscape</h3>
          <div class="switch">
            <label>Ambient Chimes</label>
            <input type="checkbox" id="chimeToggle" checked>
          </div>
          <div class="range">
            <label>Breeze Rate</label>
            <input type="range" min="0" max="1" step="0.001" value="0.35" id="breeze">
          </div>
          <div class="range">
            <label>Chime Brightness</label>
            <input type="range" min="0" max="1" step="0.001" value="0.6" id="brightness">
          </div>
          <div class="switch">
            <label>Reverb</label>
            <input type="checkbox" id="reverbToggle" checked>
          </div>
        </div>

        <div class="card">
          <h3>Utilities</h3>
          <div class="switch">
            <label>High DPI (Sharper)</label>
            <input type="checkbox" id="hiDPIToggle" checked>
          </div>
          <div class="switch">
            <label>Show Stats</label>
            <input type="checkbox" id="statsToggle" checked>
          </div>
          <button class="btn danger" id="panicBtn" title="Stop all audio">üõë Panic (Silence)</button>
        </div>

        <div class="card">
          <h3>About</h3>
          <div style="color:var(--muted)">
            <p><b>MangoLab</b> is a one-file app that fuses a GPU shader canvas (WebGL2) with a procedural weather engine and generative bell chimes (Web Audio).</p>
            <ul style="margin:.5em 0 0 1em;padding:0">
              <li>Flow-field shader background</li>
              <li>Physically inspired rain + gust bursts</li>
              <li>FM bell tones in just intonation</li>
              <li>View-Transitions theme flip</li>
              <li>Container queries, :has(), @property</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <section class="stage" id="stage">
      <div class="surface">
        <canvas id="gl" aria-label="Generative scene" role="img"></canvas>
        <canvas id="overlay" aria-hidden="true"></canvas>
        <div class="hint mono" id="hint">tap / click to toggle chimes</div>
      </div>
      <div class="kpis">
        <div class="kpi">
          <small>Gust</small>
          <b id="gustReadout">‚Äî</b>
          <small class="mono">poisson Œª varies</small>
        </div>
        <div class="kpi">
          <small>Drops</small>
          <b id="dropsReadout">‚Äî</b>
          <small class="mono">active particles</small>
        </div>
        <div class="kpi">
          <small>Pitch</small>
          <b id="pitchReadout">‚Äî</b>
          <small class="mono">Hz (current bell)</small>
        </div>
      </div>
      <div class="stage-footer">
        <span class="mono">MangoLab v1.0</span>
        <span class="mono" style="margin-left:auto">WebGL2 + Web Audio + modern CSS</span>
      </div>
    </section>
  </div>

  <div class="dock">
    <button class="btn" id="randomizeBtn">üé≤ Randomize</button>
    <button class="btn" id="pauseBtn">‚è∏ Pause</button>
    <button class="btn" id="resumeBtn" disabled>‚ñ∂Ô∏è Resume</button>
  </div>

  <div class="toasts" id="toasts" aria-live="polite" aria-atomic="true"></div>

<script type="module">
/* =========================================================
   MangoLab ‚Äî Single-file modern web demo by your friendly bot
   Sections:
   1) Utilities + tiny toast system
   2) View-Transitions theme toggle
   3) WebGL2 flow-field shader (background)
   4) 2D overlay rain particles (gusts & droplets)
   5) Web Audio "breeze & chimes" engine (FM bells + reverb)
   6) Controls wiring, perf stats, snapshot/save/share
   ========================================================= */

/* -----------------------------
 * 1) Utilities & Toasts
 * ----------------------------- */
const $ = sel => document.querySelector(sel);
const on = (el, ev, fn, opts) => el.addEventListener(ev, fn, opts);
const clamp = (x, a, b) => Math.max(a, Math.min(b, x));
const lerp = (a,b,t) => a + (b-a)*t;
const hash = () => Math.random().toString(36).slice(2,8);
function toast(msg, ms=1800) {
  const t = document.createElement('div');
  t.className = 'toast mono';
  t.textContent = msg;
  $('#toasts').appendChild(t);
  setTimeout(()=> t.remove(), ms);
}

/* Spin the conic logo subtly */
let spin = 0;
function tickSpin() {
  spin = (spin + 0.0007) % 1;
  document.documentElement.style.setProperty('--spin', spin);
  requestAnimationFrame(tickSpin);
}
tickSpin();

/* -----------------------------
 * 2) Theme toggle with View Transitions
 * ----------------------------- */
const themeBtn = $('#themeBtn');
on(themeBtn, 'click', () => {
  if (!document.startViewTransition) {
    flipTheme();
  } else {
    document.startViewTransition(flipTheme);
  }
  toast(`theme: ${document.documentElement.dataset.theme || 'dark'}`);
});
function flipTheme() {
  const root = document.documentElement;
  const next = root.dataset.theme === 'light' ? '' : 'light';
  if (next) root.dataset.theme = next; else delete root.dataset.theme;
}

/* -----------------------------
 * 3) WebGL2 flow-field shader background
 *    - Elegant, fast, no external deps
 * ----------------------------- */
const glCanvas = $('#gl');
let gl, program, startTime;
let pxRatio = window.devicePixelRatio || 1;
let glPaused = false;
const uniforms = {};
const opts = {
  complexity: 0.55,
  flow: 0.43,
  glow: true,
  rain: true,
  hiDPI: true,
};

const vert = `#version 300 es
in vec2 p;
out vec2 v;
void main(){
  v = p*0.5+0.5;
  gl_Position = vec4(p,0.0,1.0);
}`;
const frag = `#version 300 es
precision highp float;
in vec2 v;
out vec4 o;

uniform float u_time;
uniform vec2  u_res;
uniform float u_complexity; // 0..1 detail
uniform float u_flow;       // 0..1 speed
uniform bool  u_glow;

#define PI 3.14159265359

// quick hash
float h21(vec2 p){ p=fract(p*vec2(123.34,345.45)); p+=dot(p,p+34.45); return fract(p.x*p.y); }

// rotation
mat2 rot(float a){ float c=cos(a), s=sin(a); return mat2(c,-s,s,c); }

// fbm-ish noise using sin domain warp
float n2(vec2 p){
  float t = 0.0;
  float a = 0.5;
  for(int i=0;i<5;i++){
    t += a * sin(p.x)*sin(p.y);
    p *= 1.7;
    p += vec2(1.3, -1.7);
    a *= 0.55;
    p *= rot(1.2);
  }
  return t*0.5+0.5;
}

// palette
vec3 palette(float x){
  vec3 a = vec3(0.05,0.10,0.12);
  vec3 b = vec3(0.0,0.25,0.50);
  vec3 c = vec3(0.12,0.60,0.38);
  vec3 d = vec3(0.70,0.85,1.00);
  return mix(mix(a,b,smoothstep(0.0,0.4,x)), mix(c,d,smoothstep(0.4,1.0,x)), .7);
}

void main(){
  vec2 uv = (gl_FragCoord.xy/u_res.xy);
  vec2 p = (uv*2.0-1.0) * vec2(u_res.x/u_res.y, 1.0);

  float t = u_time * mix(0.1, 1.8, u_flow);

  // domain warp field
  vec2 q = p;
  q += 0.25*sin(3.0*q.yx + t*vec2(1.1, 1.7));
  q += 0.35*cos(2.0*q.yx - t*vec2(0.7, 1.3));

  float detail = mix(0.6, 2.4, u_complexity);
  float f = n2(q*detail + t*0.15);
  vec3 col = palette(f);

  // subtle vignetting
  float vign = smoothstep(1.2, 0.3, length(p));
  col *= mix(0.5,1.2,vign);

  // glow overlay
  if(u_glow){
    float ring = smoothstep(0.8, 0.2, abs(0.8 - length(q)));
    col += 0.18*ring*vec3(0.3,0.6,1.0);
  }

  o = vec4(col,1.0);
}`;

function createGL() {
  gl = glCanvas.getContext('webgl2', { antialias: true, premultipliedAlpha: true });
  if (!gl) {
    toast('WebGL2 unavailable ‚Äî falling back to 2D'); 
    return false;
  }
  const vs = gl.createShader(gl.VERTEX_SHADER);
  gl.shaderSource(vs, vert); gl.compileShader(vs);
  const fs = gl.createShader(gl.FRAGMENT_SHADER);
  gl.shaderSource(fs, frag); gl.compileShader(fs);

  program = gl.createProgram();
  gl.attachShader(program, vs);
  gl.attachShader(program, fs);
  gl.bindAttribLocation(program, 0, 'p');
  gl.linkProgram(program);
  gl.useProgram(program);

  const quad = gl.createBuffer();
  gl.bindBuffer(gl.ARRAY_BUFFER, quad);
  gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([
    -1,-1,  1,-1, -1, 1,
    -1, 1,  1,-1,  1, 1
  ]), gl.STATIC_DRAW);
  gl.enableVertexAttribArray(0);
  gl.vertexAttribPointer(0, 2, gl.FLOAT, false, 0, 0);

  // uniforms
  uniforms.time = gl.getUniformLocation(program, 'u_time');
  uniforms.res = gl.getUniformLocation(program, 'u_res');
  uniforms.c = gl.getUniformLocation(program, 'u_complexity');
  uniforms.f = gl.getUniformLocation(program, 'u_flow');
  uniforms.g = gl.getUniformLocation(program, 'u_glow');

  startTime = performance.now();
  resize();
  return true;
}

function resize() {
  const dpr = opts.hiDPI ? (window.devicePixelRatio || 1) : 1;
  pxRatio = dpr;
  const rect = $('#stage .surface').getBoundingClientRect();
  const w = Math.max(2, Math.floor(rect.width * dpr));
  const h = Math.max(2, Math.floor(rect.height * dpr));
  glCanvas.width = w; glCanvas.height = h;
  glCanvas.style.width = rect.width + 'px';
  glCanvas.style.height = rect.height + 'px';
  if (gl) {
    gl.viewport(0,0,w,h);
    gl.uniform2f(uniforms.res, w, h);
  }
  overlayResize(rect.width, rect.height, dpr);
}
addEventListener('resize', resize);

/* Render loop */
let rafId;
function renderGL() {
  if (!gl || glPaused) return;
  const t = (performance.now() - startTime) * 0.001;
  gl.useProgram(program);
  gl.uniform1f(uniforms.time, t);
  gl.uniform1f(uniforms.c, opts.complexity);
  gl.uniform1f(uniforms.f, opts.flow);
  gl.uniform1i(uniforms.g, opts.glow ? 1 : 0);
  gl.drawArrays(gl.TRIANGLES, 0, 6);
  rafId = requestAnimationFrame(renderGL);
}

/* -----------------------------
 * 4) 2D Overlay: rain particles
 * ----------------------------- */
const overlay = $('#overlay');
const octx = overlay.getContext('2d', { alpha: true, desynchronized: true });
let drops = [];
let gust = 0;
let overlayPaused = false;
let overlayW=0, overlayH=0, overlayDPR=1;

function overlayResize(w, h, dpr){
  overlayDPR = dpr; overlayW = w; overlayH = h;
  overlay.width = Math.floor(w*dpr);
  overlay.height = Math.floor(h*dpr);
  overlay.style.width = w + 'px';
  overlay.style.height = h + 'px';
}

function spawnDrop(n=1){
  for(let i=0;i<n;i++){
    drops.push({
      x: Math.random()*overlayW,
      y: -10 - Math.random()*overlayH*0.2,
      vy: 200 + Math.random()*260,
      vx: (Math.random()*2-1)*20,
      len: 8+Math.random()*14,
      life: 1
    });
  }
}
function updateRain(dt){
  const wind = lerp(-60, 120, (Math.sin(performance.now()*0.0002)+1)/2) + gust*80;
  let alive=0;
  for(let d of drops){
    d.vx += (wind - d.vx)*0.08;
    d.x += d.vx*dt;
    d.y += d.vy*dt;
    if (d.y < overlayH + 30) alive++;
  }
  drops = drops.filter(d => d.y < overlayH + 30);
  return alive;
}
function drawRain(){
  octx.setTransform(overlayDPR,0,0,overlayDPR,0,0);
  octx.clearRect(0,0,overlayW,overlayH);
  octx.globalCompositeOperation = 'lighter';
  octx.strokeStyle = 'rgba(180,210,255,0.55)';
  octx.lineWidth = 1.2;
  octx.beginPath();
  for(let d of drops){
    octx.moveTo(d.x, d.y);
    octx.lineTo(d.x - d.vx*0.02, d.y - d.len);
  }
  octx.stroke();

  // surface splashes at bottom
  octx.globalCompositeOperation = 'screen';
  octx.fillStyle = 'rgba(150,190,255,0.20)';
  for(let d of drops){
    if (d.y >= overlayH - 2) {
      octx.beginPath();
      octx.ellipse(d.x, overlayH-1, 6, 1.2, 0, 0, Math.PI*2);
      octx.fill();
    }
  }
}
let lastT = performance.now();
function loopOverlay(){
  if (overlayPaused) return;
  const now = performance.now();
  const dt = Math.min(0.05, (now - lastT)/1000);
  lastT = now;

  // Poisson-like gusts
  const breezeRate = Number($('#breeze').value); // 0..1
  const lambda = lerp(0.08, 1.5, breezeRate);
  if (Math.random() < lambda * dt) {
    gust = clamp(gust + 0.35 + Math.random()*0.4, 0, 1.6);
    if (audio.started && $('#chimeToggle').checked) chimes.strikeBurst(Math.floor(1+Math.random()*3));
  }
  gust *= 0.96;

  if (opts.rain) {
    spawnDrop(Math.floor(3 + 12*gust));
    const alive = updateRain(dt);
    drawRain();
    $('#dropsReadout').textContent = alive.toString();
  } else {
    octx.clearRect(0,0,overlayW,overlayH);
    $('#dropsReadout').textContent = '0';
  }
  $('#gustReadout').textContent = gust.toFixed(2);

  requestAnimationFrame(loopOverlay);
}

/* -----------------------------
 * 5) Web Audio ‚Äî Breeze & Chimes
 *    FM bells + convolution reverb
 * ----------------------------- */
const audio = {
  ctx: null,
  started: false,
  master: null,
  reverb: null,
  convolver: null,
};

function makeImpulseResponse(ctx, seconds=2.5, decay=2.0) {
  const rate = ctx.sampleRate;
  const len = seconds * rate;
  const ir = ctx.createBuffer(2, len, rate);
  for (let ch=0; ch<2; ch++){
    const data = ir.getChannelData(ch);
    for(let i=0;i<len;i++){
      const t = i/len;
      // noisy but decaying tail
      data[i] = (Math.random()*2-1) * Math.pow(1-t, decay) * 0.6;
    }
  }
  return ir;
}

function initAudio() {
  if (audio.started) return;
  audio.ctx = new (window.AudioContext || window.webkitAudioContext)({ latencyHint: 'interactive' });
  audio.master = audio.ctx.createGain();
  audio.master.gain.value = 0.8;
  audio.master.connect(audio.ctx.destination);

  audio.convolver = audio.ctx.createConvolver();
  audio.convolver.buffer = makeImpulseResponse(audio.ctx, 2.2, 3.0);
  audio.reverb = audio.ctx.createGain();
  audio.reverb.gain.value = 0.35;
  audio.convolver.connect(audio.reverb);
  audio.reverb.connect(audio.master);

  audio.started = true;
  toast('audio: started');
}

const scale = [1, 9/8, 5/4, 4/3, 3/2, 5/3, 15/8]; // simple just intonation major-ish
const baseHz = 196; // G3
function strikeBell(velocity=0.8, brightness=0.6, pan=0){
  if (!audio.started) return;
  const ctx = audio.ctx;
  const now = ctx.currentTime;
  const carrier = ctx.createOscillator();
  const mod = ctx.createOscillator();
  const modGain = ctx.createGain();
  const gain = ctx.createGain();
  const panner = (ctx.createStereoPanner) ? ctx.createStereoPanner() : null;

  // choose pitch from scale with slight random octave drifts
  const deg = scale[Math.floor(Math.random()*scale.length)];
  const oct = Math.random()<0.3 ? 2 : 1;
  const f0 = baseHz * deg * oct;
  const bright = clamp(brightness, 0, 1);

  // FM ratio and index for bell-ish
  mod.type = 'sine';
  mod.frequency.value = f0 * (1.999 + 0.2*Math.random()); // near 2:1
  modGain.gain.setValueAtTime( f0 * (2.0 + 6.0*bright), now );

  carrier.type = 'sine';
  carrier.frequency.value = f0;

  mod.connect(modGain);
  modGain.connect(carrier.frequency);

  // envelope
  gain.gain.setValueAtTime(0, now);
  gain.gain.linearRampToValueAtTime(velocity, now + 0.005);
  gain.gain.exponentialRampToValueAtTime(0.0001, now + 1.6 + 0.6*bright);

  if (panner) { panner.pan.value = pan; }

  // dry and wet
  const dry = ctx.createGain(); dry.gain.value = 0.55;
  const wet = ctx.createGain(); wet.gain.value = 0.8;
  if (panner) {
    carrier.connect(gain).connect(panner);
    panner.connect(dry).connect(audio.master);
    panner.connect(wet).connect(audio.convolver);
  } else {
    carrier.connect(gain);
    gain.connect(dry).connect(audio.master);
    gain.connect(wet).connect(audio.convolver);
  }

  carrier.start(now);
  mod.start(now);
  carrier.stop(now + 2.5);
  mod.stop(now + 2.5);

  // display pitch
  $('#pitchReadout').textContent = Math.round(f0) + ' Hz';
}

const chimes = {
  armed: true,
  strikeBurst(n){
    const brightness = Number($('#brightness').value);
    for(let i=0;i<n;i++){
      const pan = Math.random()*2-1;
      setTimeout(()=> strikeBell(0.65+Math.random()*0.3, brightness, pan), Math.random()*180);
    }
  }
};

// click to toggle chimes
on(document, 'pointerdown', () => {
  initAudio();
  const el = $('#chimeToggle');
  el.checked = !el.checked;
  toast('chimes: '+ (el.checked ? 'on' : 'off'));
});

/* -----------------------------
 * 6) Controls wiring + Stats
 * ----------------------------- */
function bindControls(){
  $('#complexity').addEventListener('input', e=> opts.complexity = Number(e.target.value));
  $('#flow').addEventListener('input', e=> opts.flow = Number(e.target.value));
  $('#glowToggle').addEventListener('change', e=> opts.glow = e.target.checked);
  $('#rainToggle').addEventListener('change', e=> opts.rain = e.target.checked);
  $('#hiDPIToggle').addEventListener('change', e=> { opts.hiDPI = e.target.checked; resize(); });

  $('#chimeToggle').addEventListener('change', e=> {
    if (e.target.checked) chimes.strikeBurst(2);
  });
  $('#reverbToggle').addEventListener('change', e=> {
    if (!audio.started) return;
    audio.reverb.gain.linearRampToValueAtTime(e.target.checked ? 0.35 : 0.0, audio.ctx.currentTime + 0.1);
  });

  $('#pauseBtn').addEventListener('click', ()=>{
    glPaused = true; overlayPaused = true; cancelAnimationFrame(rafId);
    $('#pauseBtn').disabled = true; $('#resumeBtn').disabled = false;
    toast('paused');
  });
  $('#resumeBtn').addEventListener('click', ()=>{
    if (gl) { glPaused = false; renderGL(); }
    overlayPaused = false; loopOverlay();
    $('#resumeBtn').disabled = true; $('#pauseBtn').disabled = false;
    toast('resumed');
  });

  $('#panicBtn').addEventListener('click', ()=>{
    if (!audio.started) return;
    audio.master.gain.cancelScheduledValues(audio.ctx.currentTime);
    audio.master.gain.setTargetAtTime(0.0001, audio.ctx.currentTime, 0.02);
    toast('üîá audio silenced');
  });

  $('#randomizeBtn').addEventListener('click', ()=>{
    $('#complexity').value = (Math.random()).toFixed(3);
    $('#flow').value = (Math.random()).toFixed(3);
    $('#breeze').value = (Math.random()).toFixed(3);
    $('#brightness').value = (Math.random()).toFixed(3);
    opts.complexity = Number($('#complexity').value);
    opts.flow = Number($('#flow').value);
    chimes.strikeBurst(3);
    toast('randomized ‚ö°');
  });

  $('#saveBtn').addEventListener('click', saveSnapshot);
  $('#shareBtn').addEventListener('click', shareLink);
}
bindControls();

/* FPS */
let frameCount=0, lastFPS=performance.now();
function fpsLoop(){
  frameCount++;
  const now = performance.now();
  if (now - lastFPS > 500){
    const fps = Math.round( (frameCount*1000) / (now-lastFPS) );
    $('#fpsReadout').textContent = 'fps: '+fps;
    frameCount=0; lastFPS=now;
  }
  requestAnimationFrame(fpsLoop);
}
fpsLoop();

/* Snapshot: compose GL + Overlay into one PNG */
function saveSnapshot(){
  const w = glCanvas.clientWidth, h = glCanvas.clientHeight;
  const tmp = document.createElement('canvas');
  tmp.width = w; tmp.height = h;
  const ctx = tmp.getContext('2d');
  // draw background (downsample from high-DPI)
  ctx.drawImage(glCanvas, 0, 0, glCanvas.width, glCanvas.height, 0, 0, w, h);
  ctx.drawImage(overlay, 0, 0, overlay.width, overlay.height, 0, 0, w, h);
  const url = tmp.toDataURL('image/png');
  const a = document.createElement('a');
  a.href = url;
  a.download = `MangoLab_${hash()}.png`;
  a.click();
}

/* Share */
async function shareLink(){
  if (navigator.share) {
    try {
      await navigator.share({ title: document.title, text: 'MangoLab ‚Äî single-file art+sound playground', url: location.href });
      toast('shared ‚úÖ');
    } catch(e){ toast('share canceled'); }
  } else {
    navigator.clipboard?.writeText(location.href);
    toast('link copied üìã');
  }
}

/* Stats toggle hides KPIs + hint with :has() trick */
$('#statsToggle').addEventListener('change', e=>{
  const on = e.target.checked;
  $('.kpis').style.display = on ? '' : 'none';
  $('#hint').style.display = on ? '' : 'none';
});

/* Kick everything off */
const ok = createGL();
if (ok) renderGL();
loopOverlay();

/* Accessibility shortcuts */
addEventListener('keydown', (e)=>{
  if (e.key === 'm') { $('#chimeToggle').checked = !$('#chimeToggle').checked; toast('chimes: '+($('#chimeToggle').checked?'on':'off')); }
  if (e.key === 'r') { $('#randomizeBtn').click(); }
  if (e.key === 'p') { $('#pauseBtn').disabled ? $('#resumeBtn').click() : $('#pauseBtn').click(); }
});

/* iOS audio unlock on first gesture */
on(document, 'touchstart', ()=> initAudio(), { once: true });
on(document, 'pointerdown', ()=> initAudio(), { once: true });

/* Initial friendly ping */
setTimeout(()=> toast('tip: press R to randomize'), 900);
</script>
</body>
</html>