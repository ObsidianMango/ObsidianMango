<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>MangoSuite — All-in-One</title>
<style>
  :root{
    --bg:#11122b;--fg:#eef0ff;--muted:#a9add6;--card:#1a1c3a;--ui:#23254a;
    --acc:#9aa7ff;--acc2:#68f2ff;--radius:14px;--shadow:0 10px 30px rgba(0,0,0,.35);
    --mono:ui-monospace,SFMono-Regular,Consolas,Menlo,monospace;
    --sans:Inter,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  }
  *{box-sizing:border-box} html,body{height:100%}
  body{
    margin:0;background:
      radial-gradient(1200px 800px at 100% -10%,rgba(152,189,255,.08),transparent),
      radial-gradient(1000px 700px at -10% 100%,rgba(104,242,255,.08),transparent),
      var(--bg);
    color:var(--fg);font-family:var(--sans);line-height:1.4;
  }
  .app{max-width:1100px;margin:0 auto;padding:18px 16px 24px}
  header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .title{font-weight:800;letter-spacing:.3px;font-size:20px;display:flex;align-items:center;gap:10px}
  .pill{background:linear-gradient(145deg,var(--ui),#1a1b36);padding:8px 12px;border-radius:999px;font-size:12px;color:var(--muted);border:1px solid #2a2c57}
  .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  @media (max-width:900px){.grid{grid-template-columns:repeat(3,1fr)}}
  @media (max-width:640px){.grid{grid-template-columns:repeat(2,1fr)}}
  .card{
    background:linear-gradient(180deg,rgba(255,255,255,.02),transparent 120px),var(--card);
    border:1px solid #2c2f64;border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;position:relative;min-height:120px
  }
  .card h3{margin:0 0 10px;font-size:15px;letter-spacing:.3px}
  .actions{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
  button,.btn{
    background:linear-gradient(180deg,var(--ui),#15173a);border:1px solid #35386d;color:var(--fg);
    padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:600;transition:transform .08s ease,opacity .2s ease;touch-action:manipulation
  }
  button:hover{transform:translateY(-1px)}
  .accent{background:linear-gradient(180deg,var(--acc),#6b79ff);color:#0b0d25;border:none}
  .accent2{background:linear-gradient(180deg,var(--acc2),#3bcff0);color:#04151b;border:none}
  .muted{opacity:.85}
  .kbd{font-family:var(--mono);font-size:12px;background:#121438;border:1px solid #2b2f66;border-radius:6px;padding:2px 6px}
  .tile{display:flex;flex-direction:column;gap:10px}
  .tile p{margin:0;color:var(--muted);font-size:13px}
  .row{display:flex;gap:10px;align-items:center}
  .stack{display:flex;flex-direction:column;gap:8px}
  .input, textarea{
    width:100%;background:#0f1130;border:1px solid #2b2f66;border-radius:10px;color:var(--fg);
    padding:10px;font-family:var(--sans)
  }
  textarea{min-height:120px;resize:vertical}
  .badge{font-size:11px;color:#0b132a;background:var(--acc);border-radius:999px;padding:4px 8px;font-weight:800}
  .badge2{font-size:11px;color:#0a1820;background:var(--acc2);border-radius:999px;padding:4px 8px;font-weight:800}
  .small{font-size:12px;color:var(--muted)}
  .log{max-height:160px;overflow:auto;border:1px solid #2b2f66;border-radius:10px;background:#0f1233;padding:8px;font-family:var(--mono);font-size:12px}
  .todo-item{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;border:1px solid #2b2f66;background:#0f1233}
  .todo-item.done{opacity:.6;text-decoration:line-through}
  .score{font-weight:900;font-size:26px;letter-spacing:.5px}
  .meters{display:flex;gap:10px}
  .meter{flex:1;height:10px;background:#101236;border:1px solid #2a2d5f;border-radius:999px;position:relative;overflow:hidden}
  .meter>span{position:absolute;left:0;top:0;height:100%;width:0%;background:linear-gradient(90deg,var(--acc),var(--acc2))}
  .swatch{width:26px;height:26px;border-radius:8px;border:1px solid #2b2f66;cursor:pointer}
  .swatches{display:grid;grid-template-columns:repeat(8,26px);gap:8px}
  .divider{height:1px;background:#2a2d5f;margin:10px 0}
  .diceBox{display:grid;place-items:center;height:220px;background:#0f1130;border:1px solid #2b2f66;border-radius:12px}
  canvas{display:block}
  footer{margin-top:18px;display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px}
  a{color:var(--acc2);text-decoration:none}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="title">🍋 MangoSuite <span class="pill" id="clock">—</span></div>
    <div class="row">
      <span class="pill">Theme</span>
      <div class="swatches" id="swatches" aria-label="Theme picker"></div>
    </div>
  </header>

  <section class="grid" id="launcher">
    <!-- D12: Canvas, true geometry, smooth roll -->
    <div class="card tile">
      <h3>🎲 D12 Roller</h3>
      <p>Tap <span class="kbd">R</span>, click Roll, or shake (after enabling). Real dodecahedron wireframe + face detection.</p>
      <div class="actions">
        <button class="accent" id="rollBtn">Roll</button>
        <button id="enableMotion" class="muted">Enable Shake</button>
        <span class="badge2" id="lastRoll">—</span>
      </div>
      <div class="diceBox"><canvas id="d12" width="360" height="200" aria-label="D12"></canvas></div>
      <div class="row small"><span>Shake: <span id="shakeStatus">Off</span></span><span style="margin-left:auto">Sum (last 10): <span id="sum10">0</span></span></div>
    </div>

    <!-- Ambient -->
    <div class="card tile">
      <h3>🌧️ Ambient Room</h3>
      <p>Pink-noise rain + natural wind-chime gusts. Calm ebbs, light breezes, occasional clusters.</p>
      <div class="actions">
        <button id="toggleRain" class="accent">Rain: Off</button>
        <button id="toggleChimes" class="accent2">Chimes: Off</button>
        <button id="pulse" class="muted">One-shot Chime</button>
      </div>
      <div class="meters">
        <div class="meter"><span id="rainMeter"></span></div>
        <div class="meter"><span id="chimeMeter"></span></div>
      </div>
      <div class="chips" style="margin-top:10px">
        <span class="pill">Long-press Rain to fade</span>
        <span class="pill">Offline (no assets)</span>
      </div>
    </div>

    <!-- Tasks -->
    <div class="card tile">
      <h3>✅ Taskmeister Lite</h3>
      <p>A tiny points-for-tasks tracker. Finish, earn, log. Persisted locally.</p>
      <div class="row">
        <input id="todoText" class="input" placeholder="Add a task… (Enter)" />
        <button id="clearDone" class="muted">Clear Done</button>
      </div>
      <div id="todoList" class="stack" style="margin-top:10px"></div>
      <div class="row" style="margin-top:6px">
        <div>Score: <span class="score" id="score">0</span></div>
        <button id="resetScore" class="muted" style="margin-left:auto">Reset</button>
      </div>
      <div class="divider"></div>
      <div class="log" id="log"></div>
    </div>

    <!-- Pad -->
    <div class="card tile">
      <h3>🗒️ Quick Pad</h3>
      <p>Scratchpad with autosave. <span class="kbd">Ctrl/Cmd+S</span> to snapshot.</p>
      <textarea id="pad" placeholder="Type notes, ideas, bars, jokes…"></textarea>
      <div class="actions">
        <button id="copyPad" class="accent2">Copy</button>
        <button id="snapshot" class="muted">Snapshot</button>
        <span class="small" id="savedAt">Saved: —</span>
      </div>
    </div>

    <!-- Wisdom -->
    <div class="card tile">
      <h3>🧠 Franklin×Twain×Mango</h3>
      <p>Tap to get wisdom: a Franklin maxim, a Twain quip, or a Mango maxim.</p>
      <div class="actions">
        <button id="wisdomBtn" class="accent">Give Wisdom</button>
        <button id="autoWis" class="muted">Auto (30s)</button>
      </div>
      <div class="divider"></div>
      <div class="stack">
        <div class="badge" id="wisType">—</div>
        <div class="input" id="wisdom" style="min-height:64px;display:flex;align-items:center"></div>
      </div>
    </div>

    <!-- Search -->
    <div class="card tile">
      <h3>🔎 Quick Search (Client-only)</h3>
      <p>Filter within your own notes + recent rolls + tasks.</p>
      <input id="search" class="input" placeholder="Search…" />
      <div id="searchOut" class="log" style="margin-top:8px"></div>
    </div>

    <!-- Themes -->
    <div class="card tile">
      <h3>🎨 Theme Forge (16)</h3>
      <p>One click recolor. Your choice persists. Hold to preview.</p>
      <div id="themeList" class="stack"></div>
    </div>

    <!-- Stats -->
    <div class="card tile">
      <h3>📈 Mini Stats</h3>
      <p>Session counters and little bragging rights.</p>
      <div class="row"><span class="badge2">Rolls</span><span id="statRolls" style="margin-left:auto">0</span></div>
      <div class="row"><span class="badge2">Tasks Done</span><span id="statDone" style="margin-left:auto">0</span></div>
      <div class="row"><span class="badge2">Pad Chars</span><span id="statChars" style="margin-left:auto">0</span></div>
      <div class="row"><span class="badge2">Wisdom Hits</span><span id="statWis" style="margin-left:auto">0</span></div>
      <div class="divider"></div>
      <div class="small">Easter egg: open DevTools → type <span class="kbd">mango()</span></div>
    </div>
  </section>

  <footer>
    <div>© <span id="year"></span> MangoSuite · All in one, zero deps</div>
    <div>Built for Steve aka 6-Slice · <a href="#" id="export">Export Data</a> · <a href="#" id="import">Import</a></div>
  </footer>
</div>

<script>
/* ---------- Helpers & State ---------- */
const $ = s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const store=(k,v)=>(localStorage.setItem(k,JSON.stringify(v)),v);
const load=(k,d)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch{return d}};
const fmtTime=d=>d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
const nowISO=()=>new Date().toISOString().replace('T',' ').slice(0,19);
$('#year').textContent=new Date().getFullYear();
setInterval(()=>$('#clock').textContent=fmtTime(new Date()),1000);

const STATE={
  rolls:load('ms_rolls',[]),tasks:load('ms_tasks',[]),score:load('ms_score',0),log:load('ms_log',[]),
  pad:load('ms_pad',''),stats:load('ms_stats',{rolls:0,done:0,chars:0,wis:0}),theme:load('ms_theme',null),
  wisdomTimer:null,themeHold:null
};

/* ---------- Themes (16) ---------- */
const THEMES=[
 {name:'Mango Pop',bg:'#1a120e',fg:'#ffeedd',ui:'#2a1a12',card:'#201713',acc:'#ffb347',acc2:'#ffd166'},
 {name:'Indigo Night',bg:'#11122b',fg:'#eef0ff',ui:'#23254a',card:'#1a1c3a',acc:'#9aa7ff',acc2:'#68f2ff'},
 {name:'Terminal',bg:'#000',fg:'#d6ffd6',ui:'#101010',card:'#0b0b0b',acc:'#00ff66',acc2:'#00ffaa'},
 {name:'Graphite',bg:'#141416',fg:'#ececf1',ui:'#222227',card:'#1b1b20',acc:'#9b87ff',acc2:'#63b3ff'},
 {name:'Evergreen',bg:'#0d2018',fg:'#e0ffee',ui:'#1a2d25',card:'#13241c',acc:'#6affb6',acc2:'#8fe3ff'},
 {name:'Solar Dawn',bg:'#1b1a17',fg:'#f6eddc',ui:'#2b2a23',card:'#222118',acc:'#ffcc66',acc2:'#ff9966'},
 {name:'Retro C64',bg:'#40318d',fg:'#e0dfe6',ui:'#2c1f7a',card:'#2a2370',acc:'#8ad3ff',acc2:'#c6ff8a'},
 {name:'Beach Glass',bg:'#0f1f24',fg:'#e7fbff',ui:'#1d3b43',card:'#122a30',acc:'#89ffd5',acc2:'#89c9ff'},
 {name:'Wine Dark',bg:'#1a0f14',fg:'#f3e6ef',ui:'#2a1821',card:'#21131a',acc:'#ff6f91',acc2:'#9bd3ff'},
 {name:'Desert',bg:'#1b140e',fg:'#faebd7',ui:'#2b2117',card:'#231b13',acc:'#f4a261',acc2:'#e9c46a'},
 {name:'Mint Chip',bg:'#0f1814',fg:'#eafff5',ui:'#1b2a23',card:'#13211a',acc:'#9af6c0',acc2:'#8ad3ff'},
 {name:'Royal',bg:'#111428',fg:'#e9ebff',ui:'#1b1f3f',card:'#161a34',acc:'#9aa7ff',acc2:'#68f2ff'},
 {name:'Charcoal',bg:'#101214',fg:'#f1f5f9',ui:'#1b1f22',card:'#15191c',acc:'#38bdf8',acc2:'#a78bfa'},
 {name:'Candy',bg:'#1b0b13',fg:'#ffedf4',ui:'#2a1520',card:'#21101a',acc:'#ff7ab6',acc2:'#7ae1ff'},
 {name:'Olive',bg:'#141a10',fg:'#f4ffe0',ui:'#222a18',card:'#1a2013',acc:'#c4ff5a',acc2:'#9bd3ff'},
 {name:'Steel',bg:'#0f1216',fg:'#e9eef5',ui:'#1a1f26',card:'#151a21',acc:'#86e1ff',acc2:'#b6ffa8'}
];
function applyTheme(t){const r=document.documentElement.style;
  r.setProperty('--bg',t.bg);r.setProperty('--fg',t.fg);r.setProperty('--ui',t.ui);r.setProperty('--card',t.card);
  r.setProperty('--acc',t.acc);r.setProperty('--acc2',t.acc2);store('ms_theme',t);
}
(function initThemes(){
  const sw=$('#swatches');
  THEMES.forEach(t=>{
    const d=document.createElement('button'); d.className='swatch'; d.title=t.name; d.style.background=t.acc;
    d.onpointerdown=()=>{STATE.themeHold=setTimeout(()=>applyTheme(t),250)};
    d.onpointerup=()=>{clearTimeout(STATE.themeHold);applyTheme(t)};
    d.onclick=()=>applyTheme(t); sw.appendChild(d);
  });
  const list=$('#themeList');
  THEMES.forEach(t=>{
    const row=document.createElement('div'); row.className='row';
    const b=document.createElement('div'); b.className='swatch'; b.style.background=t.acc;
    const name=document.createElement('div'); name.textContent=t.name; name.style.marginLeft='10px';
    const btn=document.createElement('button'); btn.textContent='Use'; btn.className='muted'; btn.style.marginLeft='auto';
    btn.onclick=()=>applyTheme(t); row.append(b,name,btn); list.appendChild(row);
  });
  applyTheme(STATE.theme||THEMES[1]);
})();

/* ---------- D12 (true geometry, canvas wireframe + face detection) ---------- */
const cx=$('#d12'); const ctx=cx.getContext('2d'); cx.width=cx.clientWidth*devicePixelRatio; cx.height=cx.clientHeight*devicePixelRatio; ctx.scale(devicePixelRatio,devicePixelRatio);
let W=cx.clientWidth, H=cx.clientHeight, scale=Math.min(W,H)*0.7, center=[W/2,H/2+10];

addEventListener('resize',()=>{cx.width=cx.clientWidth*devicePixelRatio; cx.height=cx.clientHeight*devicePixelRatio; ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0); W=cx.clientWidth;H=cx.clientHeight;scale=Math.min(W,H)*0.7;center=[W/2,H/2+10];});

/* Dodecahedron vertices & faces (φ = golden ratio) */
const φ=(1+Math.sqrt(5))/2, inv=1/φ;
const V=[]; // 20 vertices
[
  [+1,+1,+1],  [+1,+1,-1],  [+1,-1,+1],  [+1,-1,-1],
  [-1,+1,+1],  [-1,+1,-1],  [-1,-1,+1],  [-1,-1,-1],
  [0,+inv,+φ], [0,+inv,-φ], [0,-inv,+φ], [0,-inv,-φ],
  [+inv,+φ,0], [+inv,-φ,0], [-inv,+φ,0], [-inv,-φ,0],
  [+φ,0,+inv], [+φ,0,-inv], [-φ,0,+inv], [-φ,0,-inv]
].forEach(v=>V.push(v));

/* 12 faces (pentagons) index sets */
const F=[
  [0,8,10,2,16],   [0,16,17,1,12],
  [0,12,14,4,8],   [7,11,9,5,19],
  [7,15,13,3,11],  [7,19,18,6,15],
  [5,9,1,17,19],   [6,18,16,2,10],
  [4,14,12,1,9],   [3,13,17,16,2],
  [6,10,8,4,18],   [5,19,18,4,14]
];

/* Build edges from faces */
const E=new Set();
F.forEach(f=>{
  for(let i=0;i<5;i++){
    const a=f[i], b=f[(i+1)%5];
    E.add(a<b?`${a}-${b}`:`${b}-${a}`);
  }
});
const EDGES=[...E].map(s=>s.split('-').map(n=>+n));

/* Roll physics */
let rx=0, ry=0, rz=0, vx=0, vy=0, vz=0, spinning=false, lastReported=0;
function project([x,y,z]){
  const d=3.2, p=scale/(z+d);
  return [center[0]+x*p*70, center[1]-y*p*70, p];
}
function draw(){
  ctx.clearRect(0,0,W,H);
  // lighting-ish background plate
  const grd=ctx.createRadialGradient(center[0],center[1],10, center[0],center[1],Math.max(W,H));
  grd.addColorStop(0,'rgba(255,255,255,.04)'); grd.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle=grd;
  ctx.fillRect(0,0,W,H);

  // rotation matrices
  const sx=Math.sin(rx), cxr=Math.cos(rx);
  const sy=Math.sin(ry), cyr=Math.cos(ry);
  const sz=Math.sin(rz), czr=Math.cos(rz);
  const R = v=>{
    let [x,y,z]=v;
    // Rx
    [y,z]=[y*cxr - z*sx, y*sx + z*cxr];
    // Ry
    [x,z]=[x*cyr + z*sy, -x*sy + z*cyr];
    // Rz
    [x,y]=[x*czr - y*sz, x*sz + y*czr];
    return [x,y,z];
  };

  // transform verts
  const TV=V.map(R).map(project);

  // draw faces with painter's algorithm (back to front)
  const facesWithDepth=F.map((f,i)=>{
    let zavg=0; f.forEach(idx=>zavg+=TV[idx][2]); zavg/=f.length;
    return {i, z:zavg};
  }).sort((a,b)=>a.z-b.z);
  // fill faces with transparency for depth cue
  facesWithDepth.forEach(({i})=>{
    const f=F[i]; ctx.beginPath();
    f.forEach((idx,j)=>{ const [x,y]=TV[idx]; if(j===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
    ctx.closePath();
    ctx.fillStyle='rgba(152,189,255,.06)';
    ctx.fill();

    // draw number at face centroid (front faces only)
    // approximate "front" if average z (p) is larger than threshold
    const avg=f.reduce((acc,idx)=>[acc[0]+TV[idx][0],acc[1]+TV[idx][1],acc[2]+TV[idx][2]],[0,0,0]).map(v=>v/5);
    if(avg[2]>0.18){
      ctx.fillStyle='rgba(234,242,255,.9)'; ctx.font='800 20px Inter, system-ui'; ctx.textAlign='center'; ctx.textBaseline='middle';
      ctx.fillText(String((i+1)), avg[0], avg[1]);
    }
  });

  // edges
  ctx.lineWidth=1.2; ctx.strokeStyle='rgba(104,242,255,.55)';
  EDGES.forEach(([a,b])=>{
    const [x1,y1]=TV[a], [x2,y2]=TV[b];
    ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
  });

  // step physics
  if(spinning){
    rx+=vx; ry+=vy; rz+=vz;
    // damping
    vx*=0.985; vy*=0.985; vz*=0.985;
    if(Math.abs(vx)+Math.abs(vy)+Math.abs(vz)<0.001){
      spinning=false; reportFace();
    }
  }
  requestAnimationFrame(draw);
}
requestAnimationFrame(draw);

function randomInt(n){return (Math.random()*n|0)+1}
function doRoll(){
  spinning=true;
  vx=(Math.random()*0.4+0.25)*(Math.random()<.5?-1:1);
  vy=(Math.random()*0.4+0.25)*(Math.random()<.5?-1:1);
  vz=(Math.random()*0.4+0.25)*(Math.random()<.5?-1:1);
  pingMeter('#rainMeter'); // cute visual nudge
}
$('#rollBtn').onclick=doRoll;
document.addEventListener('keydown',e=>{ if(e.key.toLowerCase()==='r') doRoll(); });

/* Determine top/front-most face on stop (max average Z in camera space). */
function reportFace(){
  // rebuild normals in current rotation
  const Rv=v=>{
    const sx=Math.sin(rx), cxr=Math.cos(rx); const sy=Math.sin(ry), cyr=Math.cos(ry); const sz=Math.sin(rz), czr=Math.cos(rz);
    let [x,y,z]=v; [y,z]=[y*cxr - z*sx, y*sx + z*cxr]; [x,z]=[x*cyr + z*sy, -x*sy + z*cyr]; [x,y]=[x*czr - y*sz, x*sz + y*czr];
    return [x,y,z];
  };
  let best=-Infinity, idx=0;
  F.forEach((f,i)=>{
    const cz=f.map(j=>Rv(V[j])[2]).reduce((a,b)=>a+b,0)/5; // avg camera-Z
    if(cz>best){best=cz; idx=i;}
  });
  const val=(idx+1);
  lastReported=val;
  $('#lastRoll').textContent=val;
  STATE.rolls.push({v:val,t:Date.now()}); if(STATE.rolls.length>50) STATE.rolls.shift();
  store('ms_rolls',STATE.rolls);
  STATE.stats.rolls++; store('ms_stats',STATE.stats); $('#statRolls').textContent=STATE.stats.rolls;
  const last10=STATE.rolls.slice(-10).reduce((a,b)=>a+b.v,0); $('#sum10').textContent=String(last10);
}

/* Shake to roll */
let motionEnabled=false,lastShake=0;
$('#enableMotion').onclick=async()=>{
  try{
    if(typeof DeviceMotionEvent!=='undefined' && DeviceMotionEvent.requestPermission){
      const p=await DeviceMotionEvent.requestPermission(); if(p!=='granted') throw 'denied';
    }
    addEventListener('devicemotion',onMotion);
    motionEnabled=true; $('#shakeStatus').textContent='On'; $('#enableMotion').textContent='Shake Enabled';
  }catch{ alert('Motion permission denied or unsupported.'); }
};
function onMotion(e){
  const a=e.accelerationIncludingGravity||{}; const m=Math.abs(a.x||0)+Math.abs(a.y||0)+Math.abs(a.z||0);
  const t=Date.now(); if(m>50 && (t-lastShake)>900){ lastShake=t; doRoll(); }
}

/* ---------- Ambient Room (rain + natural chime gusts) ---------- */
let actx, rainNode, rainGain, chimeGain, windTimer=null, chimeBusy=false, windState='CALM';
function ac(){ if(!actx){actx=new (window.AudioContext||window.webkitAudioContext)();} return actx; }
function makePinkNoise(){
  const ctx=ac(); const buffer=ctx.createBuffer(1, ctx.sampleRate*2, ctx.sampleRate);
  const data=buffer.getChannelData(0); let b0=0,b1=0,b2=0;
  for(let i=0;i<data.length;i++){
    const white=Math.random()*2-1;
    b0=0.997*b0 + white*0.029; b1=0.985*b1 + white*0.032; b2=0.950*b2 + white*0.036;
    data[i]=(b0+b1+b2)/3;
  }
  const src=ctx.createBufferSource(); src.buffer=buffer; src.loop=true;
  rainGain=ctx.createGain(); rainGain.gain.value=0.0; src.connect(rainGain).connect(ctx.destination); src.start();
  return src;
}
function fadeTo(param,target,secs){const ctx=ac(); const now=ctx.currentTime; param.cancelScheduledValues(now); param.setTargetAtTime(target, now, Math.max(.001, secs/5));}
function toggleRain(){
  ac(); if(!rainNode) rainNode=makePinkNoise();
  const on=$('#toggleRain').dataset.on==='1';
  if(on){ fadeTo(rainGain.gain,0.0,0.8); $('#toggleRain').dataset.on='0'; $('#toggleRain').textContent='Rain: Off'; stopWind(); }
  else{ fadeTo(rainGain.gain,0.22,0.8); $('#toggleRain').dataset.on='1'; $('#toggleRain').textContent='Rain: On'; startWind(); }
}
$('#toggleRain').onclick=toggleRain;
$('#toggleRain').onpointerdown=e=>{e.preventDefault(); if(!rainNode){ac(); rainNode=makePinkNoise();} fadeTo(rainGain.gain,0.45,1.0);}
$('#toggleRain').onpointerup=()=>{ if($('#toggleRain').dataset.on!=='1') fadeTo(rainGain.gain,0.0,1.0); };

function chime(freq=784,time=0.9,amp=0.8){
  const ctx=ac(); if(!chimeGain){chimeGain=ctx.createGain(); chimeGain.gain.value=0.0; chimeGain.connect(ctx.destination);}
  const o=ctx.createOscillator(); o.type='sine'; o.frequency.value=freq;
  const g=ctx.createGain(); g.gain.value=0.0; o.connect(g).connect(chimeGain);
  const now=ctx.currentTime;
  chimeGain.gain.cancelScheduledValues(now); chimeGain.gain.linearRampToValueAtTime(amp, now+.01); chimeGain.gain.linearRampToValueAtTime(.0, now+time+.3);
  g.gain.setValueAtTime(0, now); g.gain.linearRampToValueAtTime(.6, now+.01); g.gain.exponentialRampToValueAtTime(.0001, now+time);
  o.start(now); o.stop(now+time+.05);
}
function pentatonic(base=392){
  const ratios=[1, 9/8, 5/4, 3/2, 5/3, 2]; return base*ratios[(Math.random()*ratios.length)|0]*(Math.random()<.25?2:1);
}
$('#toggleChimes').onclick=()=>{ if($('#toggleChimes').dataset.on==='1'){ $('#toggleChimes').dataset.on='0'; $('#toggleChimes').textContent='Chimes: Off'; stopWind(); } else { $('#toggleChimes').dataset.on='1'; $('#toggleChimes').textContent='Chimes: On'; startWind(); }};
$('#pulse').onclick=()=>{ chime(pentatonic(), .9, .9); pingMeter('#chimeMeter'); };

/* Wind machine: calm → (rise) → breeze burst (2–4 notes) → (fade) → calm. */
function startWind(){
  if(windTimer) return;
  const step=()=>{
    // stochastic next action
    if($('#toggleChimes').dataset.on!=='1' && $('#toggleRain').dataset.on!=='1') return;
    switch(windState){
      case 'CALM':
        if(Math.random()<0.25){ windState='RISE'; const tgt=0.25+Math.random()*0.25; fadeTo(rainGain?.gain||ac().createGain().gain, tgt, 2.5);}
        break;
      case 'RISE':
        gust(); windState='BREEZE';
        break;
      case 'BREEZE':
        if(Math.random()<0.5){ gust(); }
        if(Math.random()<0.3){ windState='FADE'; const tgt=($('#toggleRain').dataset.on==='1')?0.22:0.0; fadeTo(rainGain.gain, tgt, 2.0); }
        break;
      case 'FADE':
        windState='CALM';
        break;
    }
  };
  windTimer=setInterval(step, 1500);
}
function stopWind(){ if(!$('#toggleChimes') || !$('#toggleRain')) return;
  if($('#toggleChimes').dataset.on!=='1' && $('#toggleRain').dataset.on!=='1'){ clearInterval(windTimer); windTimer=null; }
}
function gust(){
  if(chimeBusy) return;
  chimeBusy=true;
  const n=2+(Math.random()*3|0); // 2–4 notes
  const baseAmp = $('#toggleRain').dataset.on==='1' ? 0.75 : 0.55;
  let i=0; const play=()=>{
    chime(pentatonic(), 0.8, baseAmp-0.1+Math.random()*0.2); pingMeter('#chimeMeter');
    i++; if(i<n){ setTimeout(play, 160+Math.random()*260); } else { chimeBusy=false; }
  };
  play();
}
function pingMeter(sel){ const el=$(sel); if(!el) return; el.style.width='100%'; el.style.transition='none'; requestAnimationFrame(()=>{ el.style.transition='width .6s ease'; el.style.width='0%'; }); }

/* ---------- Tasks ---------- */
const todoList=$('#todoList'), scoreEl=$('#score'), logEl=$('#log');
function renderTasks(){
  todoList.innerHTML='';
  STATE.tasks.forEach((t,i)=>{
    const row=document.createElement('div'); row.className='todo-item'+(t.done?' done':'');
    const cb=document.createElement('input'); cb.type='checkbox'; cb.checked=t.done;
    const text=document.createElement('div'); text.style.flex='1'; text.textContent=t.text;
    const pts=document.createElement('span'); pts.className='badge2'; pts.textContent=`+${t.pts}`;
    const del=document.createElement('button'); del.textContent='✕'; del.className='muted';
    cb.onchange=()=>toggleTask(i); del.onclick=()=>removeTask(i);
    row.append(cb,text,pts,del); todoList.appendChild(row);
  });
  scoreEl.textContent=STATE.score;
}
function addTask(text){
  const pts=Math.min(50,Math.max(5,Math.round(5+text.length/8)));
  STATE.tasks.push({text,done:false,pts}); store('ms_tasks',STATE.tasks); renderTasks();
}
function toggleTask(i){
  const t=STATE.tasks[i]; if(!t) return; t.done=!t.done;
  if(t.done){ STATE.score+=t.pts; STATE.stats.done++; log(`✅ +${t.pts} "${t.text}"`);}
  else{ STATE.score-=t.pts; log(`↩️ -${t.pts} "${t.text}"`);}
  store('ms_tasks',STATE.tasks); store('ms_score',STATE.score); store('ms_stats',STATE.stats);
  $('#statDone').textContent=STATE.stats.done; renderTasks();
}
function removeTask(i){ const t=STATE.tasks[i]; STATE.tasks.splice(i,1); store('ms_tasks',STATE.tasks); log(`🗑️ removed "${t?.text||'task'}"`); renderTasks(); }
function log(msg){ STATE.log.unshift(`[${nowISO()}] ${msg}`); if(STATE.log.length>100) STATE.log.pop(); store('ms_log',STATE.log); renderLog(); }
function renderLog(){ logEl.textContent=STATE.log.join('\n')||'—'; }
$('#todoText').addEventListener('keydown',e=>{ if(e.key==='Enter' && e.currentTarget.value.trim()){ addTask(e.currentTarget.value.trim()); e.currentTarget.value=''; }});
$('#clearDone').onclick=()=>{ STATE.tasks=STATE.tasks.filter(t=>!t.done); store('ms_tasks',STATE.tasks); renderTasks(); };
$('#resetScore').onclick=()=>{ if(confirm('Reset score to 0?')){ STATE.score=0; store('ms_score',0); renderTasks(); } };

/* ---------- Pad ---------- */
const pad=$('#pad'); const savedAt=$('#savedAt');
pad.value=STATE.pad; $('#statChars').textContent=String(STATE.pad.length);
function savePad(){ STATE.pad=pad.value; store('ms_pad',STATE.pad); savedAt.textContent='Saved: '+fmtTime(new Date()); $('#statChars').textContent=String(STATE.pad.length); }
pad.addEventListener('input',savePad);
document.addEventListener('keydown',e=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='s'){ e.preventDefault(); snapshotPad(); }});
$('#copyPad').onclick=async()=>{ await navigator.clipboard.writeText(pad.value||''); savedAt.textContent='Copied!'; setTimeout(savePad,900); };
$('#snapshot').onclick=snapshotPad; function snapshotPad(){ log('📝 snapshot '+(STATE.pad.length)+' chars'); }

/* ---------- Wisdom ---------- */
const FRANKLIN=["Well done is better than well said.","Lost time is never found again.","An ounce of prevention is worth a pound of cure.","Energy and persistence conquer all things."];
const TWAIN=["I didn’t have time to write a short letter, so I wrote a long one instead.","Whenever you find yourself on the side of the majority, it is time to pause and reflect.","Get your facts first, then you can distort them as you please.","The secret of getting ahead is getting started."];
const MANGO=["Build tiny, ship shiny, iterate daily.","Make the interface so obvious it feels telepathic.","If it’s not fun to use, it won’t be used.","Small tools, big ripples."];
function pick(a){return a[(Math.random()*a.length)|0]}
function wisdom(){ const bucket=Math.random()<.34?'Franklin':(Math.random()<.5?'Twain':'Mango'); let text=bucket==='Franklin'?pick(FRANKLIN):bucket==='Twain'?pick(TWAIN):pick(MANGO); $('#wisType').textContent=bucket; $('#wisdom').textContent=text; STATE.stats.wis++; store('ms_stats',STATE.stats); $('#statWis').textContent=STATE.stats.wis; }
$('#wisdomBtn').onclick=wisdom; $('#autoWis').onclick=()=>{ if(STATE.wisdomTimer){ clearInterval(STATE.wisdomTimer); STATE.wisdomTimer=null; $('#autoWis').textContent='Auto (30s)'; return; } wisdom(); STATE.wisdomTimer=setInterval(wisdom,30000); $('#autoWis').textContent='Stop Auto'; };

/* ---------- Search ---------- */
$('#search').addEventListener('input',e=>{
  const q=(e.target.value||'').toLowerCase(); const out=[];
  if(q){ (STATE.log||[]).forEach(l=>{ if(l.toLowerCase().includes(q)) out.push('LOG · '+l); });
    (STATE.tasks||[]).forEach(t=>{ if(t.text.toLowerCase().includes(q)) out.push((t.done?'[x] ':'[ ] ')+t.text); });
    (STATE.rolls||[]).slice(-30).forEach(r=>{ const s=('roll '+r.v+' @ '+new Date(r.t).toLocaleTimeString()); if(s.toLowerCase().includes(q)) out.push(s); });
    if((STATE.pad||'').toLowerCase().includes(q)) out.push('PAD · match inside notes');
  }
  $('#searchOut').textContent=out.join('\n')||'—';
});

/* ---------- Export/Import ---------- */
$('#export').onclick=()=>{
  const blob=new Blob([JSON.stringify({rolls:STATE.rolls,tasks:STATE.tasks,score:STATE.score,log:STATE.log,pad:STATE.pad,stats:STATE.stats,theme:STATE.theme},null,2)],{type:'application/json'});
  const a=Object.assign(document.createElement('a'),{href:URL.createObjectURL(blob),download:'mangosuite.json'}); document.body.appendChild(a); a.click(); a.remove();
};
$('#import').onclick=()=>{
  const inp=Object.assign(document.createElement('input'),{type:'file',accept:'.json,application/json'});
  inp.onchange=async()=>{ const f=inp.files[0]; if(!f) return; const text=await f.text(); const data=JSON.parse(text);
    Object.assign(STATE,{rolls:data.rolls||[],tasks:data.tasks||[],score:data.score||0,log:data.log||[],pad:data.pad||'',stats:data.stats||{rolls:0,done:0,chars:0,wis:0},theme:data.theme||THEMES[1]});
    store('ms_rolls',STATE.rolls); store('ms_tasks',STATE.tasks); store('ms_score',STATE.score); store('ms_log',STATE.log); store('ms_pad',STATE.pad); store('ms_stats',STATE.stats); store('ms_theme',STATE.theme);
    applyTheme(STATE.theme); renderTasks(); renderLog(); pad.value=STATE.pad; $('#statChars').textContent=String(STATE.pad.length); $('#statRolls').textContent=STATE.stats.rolls; $('#statDone').textContent=STATE.stats.done; $('#statWis').textContent=STATE.stats.wis; alert('Imported!');
  }; inp.click();
};

/* ---------- Init ---------- */
(function init(){
  renderTasks(); renderLog(); $('#statChars').textContent=String(STATE.pad.length);
  $('#statRolls').textContent=STATE.stats.rolls; $('#statDone').textContent=STATE.stats.done; $('#statWis').textContent=STATE.stats.wis;
  $('#savedAt').textContent='Saved: —'; $('#wisdom').textContent='—';
})();
window.mango=function(){ console.table({rolls:STATE.rolls.length,tasks:STATE.tasks.length,score:STATE.score,chars:(STATE.pad||'').length,theme:STATE.theme?.name||'—'}); return 'Have fun, Mango. 🍋'; };
</script>
</body>
</html>