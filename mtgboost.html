<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MTG Pocket Sim: v11 (Shop)</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #d4af37; /* Gold */
            --primary-dim: #8a7326;
            --bg: #121212;
            --surface: #1e1e24;
            --surface-2: #2a2a35;
            --text: #ffffff;
            --text-muted: #8b8b99;
            --danger: #eb5757;
            --success: #2ecc71;
            --link: #3498db;
            
            /* Mana Colors */
            --w: #fffbd5; --u: #aae0fa; --b: #cbc2bf; --r: #f9aa8f; --g: #9bd3ae;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            margin: 0;
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            user-select: none;
        }

        /* --- DYNAMIC BACKGROUND --- */
        #dynamic-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 0; pointer-events: none;
            opacity: 0.08; 
            background-repeat: repeat;
            background-position: center;
            background-size: 80px 80px;
            filter: grayscale(100%);
            transition: background-image 0.5s ease;
        }
        #bg-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 1; pointer-events: none;
            background: rgba(18, 18, 18, 0.92);
        }

        /* --- FLASH EFFECT --- */
        #flash-overlay {
            position: fixed; inset: 0; background: white; opacity: 0; pointer-events: none; z-index: 999;
            transition: opacity 0.5s ease-out;
        }

        /* --- APP CONTAINER --- */
        #app-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            z-index: 10;
        }

        .view {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 90px; 
            display: none;
            flex-direction: column;
            padding: 16px;
            overflow-y: auto;
            width: 100%;
        }
        
        .view.active { display: flex; animation: fadeIn 0.25s cubic-bezier(0.25, 1, 0.5, 1); }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- NAVIGATION --- */
        #nav-bar {
            height: 90px;
            background: var(--surface);
            display: flex;
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid #333;
            z-index: 100;
            padding-bottom: 25px;
            flex-shrink: 0;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.5);
        }

        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            font-size: 0.75rem; color: var(--text-muted);
            cursor: pointer; width: 33%; transition: all 0.2s;
            font-weight: 600;
        }
        .nav-item.active { color: var(--primary); transform: translateY(-2px); }
        .nav-icon { font-size: 1.7rem; margin-bottom: 4px; }

        /* --- UI ELEMENTS --- */
        h1, h2 { margin: 0 0 10px 0; letter-spacing: -0.5px; }
        .subtitle { color: var(--text-muted); font-size: 0.85rem; margin-bottom: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }

        .btn {
            background: linear-gradient(135deg, var(--primary), var(--primary-dim));
            color: #000; border: none;
            padding: 14px; border-radius: 12px; font-weight: 800; font-size: 1rem;
            cursor: pointer; width: 100%; text-align: center;
            box-shadow: 0 4px 15px rgba(212, 175, 55, 0.2);
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.96); }
        .btn.secondary { background: var(--surface-2); color: white; box-shadow: none; border: 1px solid #444; }
        .btn.danger { background: var(--danger); color: white; box-shadow: none; }
        .btn.commander { background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; box-shadow: 0 4px 15px rgba(155, 89, 182, 0.4); }
        .btn.shop { background: linear-gradient(135deg, var(--link), #2980b9); color: white; margin-top: 5px; } /* SHOP BUTTON */
        
        select, input {
            width: 100%; padding: 12px; background: var(--surface-2);
            border: 1px solid #444; color: white; border-radius: 10px; font-size: 1rem;
            margin-bottom: 8px; font-family: inherit;
        }

        /* --- PACK STAGE --- */
        #pack-stage {
            flex: 1; display: flex; flex-direction: column;
            justify-content: center; align-items: center; perspective: 1000px; width: 100%;
        }
        .pack-wrapper {
            width: 320px; height: 480px; position: relative;
            animation: float 6s ease-in-out infinite;
        }
        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        
        .pack-body {
            width: 100%; height: 100%; background: linear-gradient(135deg, #333, #000);
            border-radius: 22px; display: flex; flex-direction: column; align-items: center;
            justify-content: center; box-shadow: 0 30px 60px rgba(0,0,0,0.8);
            border: 1px solid #444; position: relative; overflow: hidden;
        }
        .pack-body::before {
            content: ""; position: absolute; inset: 0;
            background: linear-gradient(115deg, transparent 30%, rgba(255,255,255,0.1) 45%, rgba(255,255,255,0.1) 55%, transparent 70%);
            background-size: 200% 100%; animation: shimmer 5s infinite linear; pointer-events: none; z-index: 5;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        .pack-icon { width: 70%; height: 70%; opacity: 0.9; filter: drop-shadow(0 0 20px rgba(0,0,0,0.8)); object-fit: contain; z-index: 2; }
        .pack-title {
            position: absolute; bottom: 50px; font-size: 1.6rem; font-weight: 900;
            text-transform: uppercase; text-align: center; color: var(--primary);
            text-shadow: 0 4px 10px black; width: 100%; z-index: 6;
        }
        .pack-strip {
            position: absolute; top: 0; left: 0; width: 100%; height: 70px;
            background: repeating-linear-gradient(45deg, #1a1a1a, #1a1a1a 10px, #252525 10px, #252525 20px);
            z-index: 20; border-radius: 22px 22px 0 0; border-bottom: 2px dashed #555;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .tear-progress {
            position: absolute; left: 0; top: 0; bottom: 0; width: 0%;
            background: linear-gradient(90deg, var(--primary), #fff); pointer-events: none; opacity: 0.8;
        }

        .card-stack { width: 320px; height: 440px; position: relative; display: none; }
        .card {
            width: 100%; height: 100%; position: absolute; top: 0; left: 0;
            border-radius: 16px; background-size: cover; background-position: center;
            box-shadow: 0 10px 40px rgba(0,0,0,0.9); background-color: #222;
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1), opacity 0.3s ease; border: 1px solid #111;
        }
        .card.swiped { transform: translateX(140%) rotate(25deg); opacity: 0; }
        .card.foil::after {
            content: ""; position: absolute; inset: 0; border-radius: 16px;
            background: linear-gradient(125deg, rgba(255,255,255,0) 30%, rgba(255,255,255,0.4) 50%, rgba(255,255,255,0) 70%);
            mix-blend-mode: overlay; opacity: 0.6; animation: foilShine 4s infinite;
        }
        @keyframes foilShine { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }

        /* --- PRICE EXPLOSION --- */
        .price-pop {
            position: fixed; font-size: 2.5rem; font-weight: 900; color: var(--success);
            text-shadow: 0 2px 10px rgba(0,0,0,0.8); pointer-events: none; z-index: 2000;
            animation: popUp 1.2s ease-out forwards;
        }
        .price-pop.high-value { color: var(--primary); font-size: 3.5rem; text-shadow: 0 0 20px var(--primary); }
        @keyframes popUp {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            20% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -200%) scale(1); opacity: 0; }
        }

        /* --- SUMMARY --- */
        #summary-screen { text-align: center; display: none; flex-direction: column; align-items: center; justify-content: center; height: 100%; width: 100%; }
        .rare-pull-list { display: flex; gap: 10px; overflow-x: auto; max-width: 100%; padding: 10px; justify-content: center; margin-bottom: 20px; }
        .mini-card { width: 90px; height: 125px; border-radius: 8px; background-size: cover; flex-shrink: 0; border: 1px solid #555; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .stat-card {
            background: var(--surface); padding: 20px; border-radius: 16px;
            margin-bottom: 15px; text-align: center; border: 1px solid #333; position: relative;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2); width: 100%;
        }
        .stat-val { font-size: 2.2rem; font-weight: 800; color: var(--success); text-shadow: 0 0 20px rgba(39, 174, 96, 0.3); }

        /* --- COLLECTION & FILTERING --- */
        .binder-controls { display: flex; gap: 10px; margin-bottom: 15px; }
        #search-input, #deck-search-input { flex: 1; margin: 0; }
        .filter-toggle-btn {
            width: 48px; display: flex; align-items: center; justify-content: center;
            background: var(--surface-2); border: 1px solid #444; border-radius: 10px;
            font-size: 1.2rem; cursor: pointer;
        }
        .filter-toggle-btn.active { border-color: var(--primary); background: #333; color: var(--primary); }

        .filter-panel {
            background: var(--surface); border: 1px solid #333; border-radius: 12px;
            padding: 15px; margin-bottom: 15px; display: none; animation: slideDown 0.2s;
        }
        @keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        .filter-group { margin-bottom: 15px; }
        .filter-label { font-size: 0.75rem; color: #888; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; }
        .filter-chips { display: flex; flex-wrap: wrap; gap: 8px; }
        .chip {
            padding: 8px 16px; background: var(--surface-2); border: 1px solid #444;
            border-radius: 20px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; font-weight: 600;
        }
        .chip.active { background: var(--primary); color: black; border-color: var(--primary); box-shadow: 0 0 10px rgba(212, 175, 55, 0.4); }
        
        .chip[data-val="W"].active { background: var(--w); }
        .chip[data-val="U"].active { background: var(--u); }
        .chip[data-val="B"].active { background: var(--b); color: white; }
        .chip[data-val="R"].active { background: var(--r); }
        .chip[data-val="G"].active { background: var(--g); }

        #collection-grid, #deck-grid-view {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;
            padding-bottom: 20px;
        }
        .col-card {
            aspect-ratio: 2.5/3.5; background-size: cover; border-radius: 8px;
            position: relative; background-color: #222; cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3); border: 1px solid #333;
        }
        .col-count {
            position: absolute; top: -5px; right: -5px; background: var(--primary);
            color: black; font-size: 0.7rem; font-weight: bold;
            width: 22px; height: 22px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5); z-index: 2;
        }
        .col-price {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.85); font-size: 0.7rem; color: var(--success);
            text-align: center; border-radius: 0 0 8px 8px; padding: 4px 0; font-weight: 600;
        }
        
        .col-cmd {
            position: absolute; top: -5px; left: -5px; background: #9b59b6;
            color: white; font-size: 0.9rem; font-weight: bold;
            width: 24px; height: 24px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5); z-index: 2; border: 2px solid white;
        }

        /* --- DECK BUILDER --- */
        .deck-list-item {
            background: var(--surface); padding: 15px; border-radius: 12px;
            margin-bottom: 10px; border: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center; cursor: pointer;
        }
        .deck-list-item:active { background: var(--surface-2); }
        .deck-fmt-tag { font-size: 0.6rem; padding: 2px 6px; border-radius: 4px; background: #333; color: #aaa; margin-left: 5px; text-transform: uppercase; }
        .deck-val-tag { font-size: 0.85rem; color: var(--success); font-weight: bold; margin-right: 10px; background: rgba(46, 204, 113, 0.1); padding: 4px 8px; border-radius: 6px; }

        #deck-view-container { display: none; flex-direction: column; height: 100%; }
        
        .deck-card-row {
            display: flex; align-items: center; gap: 10px;
            background: var(--surface); margin-bottom: 8px; padding: 10px; border-radius: 10px;
            border: 1px solid #333;
        }
        .row-img { width: 35px; height: 49px; background-size: cover; border-radius: 4px; }
        .remove-btn {
            background: var(--danger); color: white; border: none; width: 30px; height: 30px;
            border-radius: 50%; font-weight: bold; font-size: 1.2rem; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }

        /* --- MODAL (General) --- */
        .modal-overlay {
            position: fixed; inset: 0; z-index: 500; background: rgba(0,0,0,0.95);
            backdrop-filter: blur(8px);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; animation: fadeIn 0.2s;
        }
        #modal-img { max-width: 90%; max-height: 55vh; border-radius: 18px; margin-bottom: 20px; box-shadow: 0 0 50px rgba(0,0,0,0.8); }
        .modal-details { width: 100%; max-width: 400px; text-align: center; color: white; }
        #deck-select-area { display: none; flex-direction: column; gap: 8px; margin-top: 15px; max-height: 200px; overflow-y: auto; }

        /* --- SETTINGS & NEW DECK MODAL --- */
        .settings-content {
            background: var(--surface); width: 100%; max-width: 400px;
            padding: 25px; border-radius: 20px; border: 1px solid #444;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8); text-align: center;
        }
        
        #toast {
            position: fixed; bottom: 120px; left: 50%; transform: translateX(-50%);
            background: #333; padding: 12px 24px; border-radius: 30px;
            font-size: 0.9rem; opacity: 0; pointer-events: none; transition: opacity 0.3s;
            z-index: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #555; font-weight: 600;
        }

        .settings-btn {
            position: absolute; top: 15px; right: 15px;
            background: rgba(255,255,255,0.1); border-radius: 50%; width: 40px; height: 40px;
            border: none; color: white; font-size: 1.4rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: background 0.2s;
        }
        .settings-btn:hover { background: var(--surface-2); }

        .warning-text { color: var(--danger); font-size: 0.75rem; margin-top: 20px; line-height: 1.4; border: 1px solid var(--danger); padding: 10px; border-radius: 8px; background: rgba(235, 87, 87, 0.1); }
    </style>
</head>
<body>

    <div id="dynamic-bg"></div>
    <div id="bg-overlay"></div>
    <div id="flash-overlay"></div>

    <div id="app-container">

        <div id="view-home" class="view active">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h1>Pack Simulator</h1>
                <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è</button>
            </div>
            
            <div class="stat-card">
                <div class="subtitle">Total Collection Value</div>
                <div class="stat-val" id="home-value">$0.00</div>
            </div>

            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <select id="set-select" onchange="updateSetInfo()">
                    <option disabled selected>Loading set list...</option>
                </select>
                <div id="loading-spinner" style="font-size:0.8rem; color:#888; display:none; align-self:center;">‚Üª</div>
                <button id="retry-btn" onclick="initSets()" style="display:none; width:auto; padding:10px;" class="btn secondary">‚Üª</button>
            </div>

            <div id="pack-stage">
                <div id="pack-wrapper" class="pack-wrapper" style="display:none;">
                    <div class="pack-strip" id="pack-strip">
                        <span style="font-size:0.7rem; color:#aaa; pointer-events:none; letter-spacing:2px; font-weight:bold;">SLIDE TO OPEN >>></span>
                        <div class="tear-progress" id="tear-line"></div>
                    </div>
                    <div class="pack-body">
                        <img id="pack-icon" class="pack-icon" src="" alt="">
                        <div id="pack-title" class="pack-title">MTG</div>
                    </div>
                </div>
                
                <div id="card-stack" class="card-stack"></div>

                <div id="summary-screen">
                    <h2 style="color:var(--primary); font-size:1.8rem; text-shadow:0 0 10px rgba(212,175,55,0.3);">PACK OPENED</h2>
                    <div class="subtitle">Highlights</div>
                    <div class="rare-pull-list" id="summary-rares"></div>
                    <div class="stat-card" style="width:100%; padding:15px; margin-bottom:10px;">
                        <div class="subtitle">Pack Value</div>
                        <div class="stat-val" style="font-size:1.4rem;" id="pack-value">$0.00</div>
                    </div>
                    <button class="btn" onclick="resetPack()">Open Another Pack</button>
                </div>
            </div>
        </div>

        <div id="view-collection" class="view">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h1>Binder</h1>
                <select id="sort-select" style="width: 110px; padding: 8px; font-size: 0.8rem;" onchange="renderCollection()">
                    <option value="value">Price: High</option>
                    <option value="recent">Recent</option>
                    <option value="name">Name</option>
                </select>
            </div>

            <div class="binder-controls">
                <input type="text" id="search-input" placeholder="Search cards..." onkeyup="renderCollection()">
                <div class="filter-toggle-btn" onclick="toggleFilterPanel('main')">‚ö°</div>
            </div>

            <div id="filter-panel-main" class="filter-panel"></div>
            <div id="collection-grid"></div>
        </div>

        <div id="view-decks" class="view">
            <h1>Deck Builder</h1>
            <div id="decks-main-list">
                <button class="btn secondary" onclick="openNewDeckModal()">+ New Deck</button>
                <div id="deck-list-container" style="margin-top:20px;"></div>
            </div>
            <div id="deck-view-container">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <button onclick="closeDeckView()" style="background:none; border:none; color:var(--text-muted); font-size:1rem; font-weight:600;">&lt; Back</button>
                    <div>
                        <h3 id="active-deck-name" style="margin:0; display:inline;">Deck</h3>
                        <span id="active-deck-format" class="deck-fmt-tag">STD</span>
                    </div>
                    <div id="active-deck-count" style="color:var(--primary); font-weight:bold;">0/60</div>
                </div>
                
                <div id="deck-controls" style="display:none; flex-direction:column; gap:10px; margin-bottom:15px;">
                    <div style="display:flex; gap:10px;">
                        <button id="btn-mode-grid" class="btn secondary" onclick="toggleDeckMode('grid')">Binder View</button>
                        <button id="btn-mode-list" class="btn secondary" onclick="toggleDeckMode('list')">List View</button>
                    </div>
                    
                    <div style="display:flex; gap:10px;">
                        <button class="btn secondary" style="padding:8px;" onclick="exportDeckToText()">üìã Export List</button>
                        <button class="btn secondary" style="padding:8px;" onclick="exportShoppingList()">üõí Shopping List</button>
                    </div>

                    <div class="binder-controls" id="deck-filter-controls" style="display:none;">
                        <input type="text" id="deck-search-input" placeholder="Search deck..." onkeyup="renderActiveDeck()">
                        <div class="filter-toggle-btn" onclick="toggleFilterPanel('deck')">‚ö°</div>
                    </div>
                    <div id="filter-panel-deck" class="filter-panel"></div>
                </div>
                
                <div id="active-deck-list" style="flex:1; overflow-y:auto;"></div>
                <div id="deck-grid-view" style="display:grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding-bottom:40px;"></div>
            </div>
        </div>
    </div>

    <div id="nav-bar">
        <div class="nav-item active" onclick="switchView('home')">
            <div class="nav-icon">üì¶</div>
            <div>Packs</div>
        </div>
        <div class="nav-item" onclick="switchView('collection')">
            <div class="nav-icon">üìö</div>
            <div>Binder</div>
        </div>
        <div class="nav-item" onclick="switchView('decks')">
            <div class="nav-icon">‚öîÔ∏è</div>
            <div>Decks</div>
        </div>
    </div>

    <div id="card-modal" class="modal-overlay">
        <img id="modal-img" src="">
        <div class="modal-details">
            <h2 id="modal-name">Card Name</h2>
            <div class="modal-price" id="modal-price">$0.00</div>
            
            <div style="margin-top:20px; display:flex; flex-direction:column; gap:10px;">
                <button class="btn shop" id="btn-buy-card" onclick="buyCard()">üõí Buy on TCGPlayer</button>
                
                <button class="btn" id="btn-modal-add">Add to Deck</button>
                <button class="btn commander" id="btn-set-commander" style="display:none;">üëë Set as Commander</button>
                <div id="deck-select-area"></div>
                <button class="btn secondary" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <div id="new-deck-modal" class="modal-overlay">
        <div class="settings-content">
            <h2 style="margin-bottom:15px;">Create New Deck</h2>
            <input type="text" id="new-deck-name" placeholder="Deck Name" style="margin-bottom:15px;">
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn" onclick="finalizeNewDeck('Standard')">Standard (60)</button>
                <button class="btn commander" onclick="finalizeNewDeck('Commander')">Commander (100)</button>
            </div>
            <button class="btn secondary" onclick="document.getElementById('new-deck-modal').style.display='none'">Cancel</button>
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay">
        <div class="settings-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2 style="margin:0;">Settings</h2>
                <button onclick="closeSettings()" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <button class="btn secondary" onclick="exportCollectionToText()" style="margin-bottom:15px;">Export Collection Text</button>
            <button class="btn danger" onclick="clearData()">Factory Reset (Delete All)</button>
            
            <p class="warning-text">
                ‚ö†Ô∏è <b>STORAGE WARNING:</b> The app may stop saving cards after 3,000 - 5,000 pulls due to browser limits. Use the Export feature often.<br><br>
                *Prices are simulated snapshots fetched from Scryfall.
            </p>
        </div>
    </div>

    <div id="toast">Message</div>

    <script>
        // --- DATA STORE ---
        const state = {
            sets: [],
            currentSet: null,
            pool: { common: [], uncommon: [], rare: [], mythic: [], land: [] },
            isLoaded: false,
            collection: JSON.parse(localStorage.getItem('mtgCollection_v2')) || {},
            decks: JSON.parse(localStorage.getItem('mtgDecks_v2')) || [],
            activeDeckId: null,
            deckViewMode: 'grid', 
            tempPackValue: 0,
            tempPackRares: [],
            modalCardId: null,
            filters: { color: [], rarity: [], type: [], set: [] }
        };

        const elements = {
            packWrapper: document.getElementById('pack-wrapper'),
            cardStack: document.getElementById('card-stack'),
            summary: document.getElementById('summary-screen'),
            summaryRares: document.getElementById('summary-rares'),
            packVal: document.getElementById('pack-value'),
            strip: document.getElementById('pack-strip'),
            tear: document.getElementById('tear-line'),
            setSelect: document.getElementById('set-select'),
            homeVal: document.getElementById('home-value'),
            toast: document.getElementById('toast'),
            modal: document.getElementById('card-modal'),
            settingsModal: document.getElementById('settings-modal'),
            deckSelectArea: document.getElementById('deck-select-area'),
            retryBtn: document.getElementById('retry-btn'),
            spinner: document.getElementById('loading-spinner'),
            filterPanelMain: document.getElementById('filter-panel-main'),
            filterPanelDeck: document.getElementById('filter-panel-deck'),
            dynamicBg: document.getElementById('dynamic-bg'),
            flashOverlay: document.getElementById('flash-overlay')
        };

        // --- ROBUST PRICE FORMATTER ---
        const fmtMoney = (n) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(n);
        const getCardPrice = (card) => {
            if(!card.prices) return 0;
            // aggressively find a price
            const p = card.foil ? card.prices.usd_foil : card.prices.usd;
            if(p) return parseFloat(p);
            // fallback if foil price missing but normal exists (or vice versa)
            return parseFloat(card.prices.usd || card.prices.usd_foil || card.prices.eur || 0);
        };

        const showToast = (msg) => {
            elements.toast.innerText = msg; elements.toast.style.opacity = 1;
            setTimeout(() => elements.toast.style.opacity = 0, 2000);
        };

        // --- FILTER HTML GENERATOR ---
        function generateFilterHTML(context) {
            return `
                <div class="filter-group"><div class="filter-label">Card Type</div><div class="filter-chips">
                    ${['Creature','Instant','Sorcery','Artifact','Enchantment','Planeswalker','Land'].map(t => `<div class="chip" data-ctx="${context}" data-cat="type" data-val="${t}" onclick="toggleFilter('${context}', 'type', '${t}')">${t}</div>`).join('')}
                </div></div>
                <div class="filter-group"><div class="filter-label">Colors</div><div class="filter-chips">
                    ${[{v:'W',l:'‚òÄÔ∏è White'},{v:'U',l:'üíß Blue'},{v:'B',l:'üíÄ Black'},{v:'R',l:'üî• Red'},{v:'G',l:'üå≥ Green'},{v:'M',l:'üåà Multi'},{v:'C',l:'üíé Colorless'}].map(c => `<div class="chip" data-ctx="${context}" data-cat="color" data-val="${c.v}" onclick="toggleFilter('${context}', 'color', '${c.v}')">${c.l}</div>`).join('')}
                </div></div>
                <div class="filter-group"><div class="filter-label">Rarity</div><div class="filter-chips">
                    ${['mythic','rare','uncommon','common'].map(r => `<div class="chip" data-ctx="${context}" data-cat="rarity" data-val="${r}" onclick="toggleFilter('${context}', 'rarity', '${r}')">${r}</div>`).join('')}
                </div></div>
                <div class="filter-group"><div class="filter-label">Expansion Set</div><div class="filter-chips" id="filter-sets-${context}"></div></div>
                <button class="btn secondary" style="padding:10px;" onclick="clearFilters('${context}')">Reset Filters</button>
            `;
        }

        // --- EXPORT LOGIC ---
        function generateTextExport(cards, isShopping = false) {
            const groups = {};
            const types = ['Creature', 'Instant', 'Sorcery', 'Enchantment', 'Artifact', 'Planeswalker', 'Land', 'Other'];
            let totalPrice = 0;

            cards.forEach(c => {
                let foundType = 'Other';
                for(let t of types) { if(c.type_line && c.type_line.includes(t)) { foundType = t; break; } }
                if(!groups[foundType]) groups[foundType] = [];
                groups[foundType].push(c);
                totalPrice += getCardPrice(c) * (c.qty || c.count);
            });

            let text = isShopping ? "SHOPPING LIST\n" : "DECK LIST\n";
            text += `Total Estimated Cost: ${fmtMoney(totalPrice)}\n`;
            
            types.forEach(t => {
                if(groups[t] && groups[t].length > 0) {
                    text += `\n== ${t.toUpperCase()} (${groups[t].reduce((a,b)=>a+(b.qty||b.count),0)}) ==\n`;
                    const rarityOrder = { 'mythic':0, 'rare':1, 'uncommon':2, 'common':3 };
                    groups[t].sort((a,b) => (rarityOrder[a.rarity] - rarityOrder[b.rarity]) || a.name.localeCompare(b.name));
                    groups[t].forEach(c => {
                        const qty = c.qty || c.count;
                        const price = getCardPrice(c);
                        const priceStr = price > 0 ? `($${price.toFixed(2)})` : '';
                        text += `${qty}x ${c.name} ${priceStr}\n`;
                    });
                }
            });
            return text.trim();
        }

        function exportDeckToText() {
            if(state.activeDeckId === null) return;
            const deck = state.decks[state.activeDeckId];
            const cards = getDeckCards(deck);
            const text = `Deck: ${deck.name} (${deck.format})\n` + generateTextExport(cards);
            copyTextToClipboard(text);
        }

        function exportShoppingList() {
            if(state.activeDeckId === null) return;
            const deck = state.decks[state.activeDeckId];
            const cards = getDeckCards(deck);
            // Shopping list usually implies buying cards you don't have, but here it's just a price list for the deck
            const text = `SHOPPING LIST: ${deck.name}\n` + generateTextExport(cards, true);
            copyTextToClipboard(text);
        }

        function exportCollectionToText() {
            const cards = Object.values(state.collection);
            const text = "MY COLLECTION\n" + generateTextExport(cards);
            copyTextToClipboard(text);
        }

        function copyTextToClipboard(text) {
            const el = document.createElement('textarea');
            el.value = text; document.body.appendChild(el); el.select();
            document.execCommand('copy'); document.body.removeChild(el);
            showToast("List copied to clipboard!");
        }

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            renderTotalValue(); initSets();
            elements.filterPanelMain.innerHTML = generateFilterHTML('main');
            elements.filterPanelDeck.innerHTML = generateFilterHTML('deck');
        });

        function openSettings() { elements.settingsModal.style.display = 'flex'; }
        function closeSettings() { elements.settingsModal.style.display = 'none'; }
        function clearData() { if(confirm("‚ö† WARNING: This will delete ALL cards and decks.")) { localStorage.clear(); location.reload(); } }

        async function initSets() {
            elements.spinner.style.display = 'block'; elements.retryBtn.style.display = 'none'; elements.setSelect.disabled = true;
            try {
                const res = await fetch('https://api.scryfall.com/sets'); const data = await res.json();
                const validTypes = ['core', 'expansion', 'masters', 'draft_innovation', 'commander', 'funny'];
                state.sets = data.data.filter(s => validTypes.includes(s.set_type) && s.card_count > 0);
                elements.setSelect.innerHTML = '<option value="" disabled selected>Select Expansion...</option>';
                state.sets.forEach(s => {
                    const year = s.released_at ? s.released_at.substring(0,4) : '????';
                    const opt = document.createElement('option'); opt.value = s.code; opt.innerText = `${s.name} (${year})`;
                    elements.setSelect.appendChild(opt);
                });
                elements.setSelect.disabled = false; elements.spinner.style.display = 'none';
            } catch(e) { elements.retryBtn.style.display = 'block'; elements.spinner.style.display = 'none'; }
        }

        async function updateSetInfo() {
            const code = elements.setSelect.value; const set = state.sets.find(s => s.code === code);
            if(!set) return;
            if(set.icon_svg_uri) elements.dynamicBg.style.backgroundImage = `url('${set.icon_svg_uri}')`;
            document.getElementById('pack-title').innerText = set.name; document.getElementById('pack-icon').src = set.icon_svg_uri;
            resetPack(); elements.packWrapper.style.opacity = '0.5'; showToast(`Loading ${set.name}...`); state.isLoaded = false;
            try {
                const url = `https://api.scryfall.com/cards/search?q=set:${code}%20unique:cards%20game:paper&order=rarity`;
                let allCards = []; let r = await fetch(url); let d = await r.json(); if(d.data) allCards = allCards.concat(d.data);
                if(d.has_more) { let r2 = await fetch(d.next_page); let d2 = await r2.json(); if(d2.data) allCards = allCards.concat(d2.data); }
                state.pool = { common: [], uncommon: [], rare: [], mythic: [], land: [] };
                allCards.forEach(c => {
                    let img = c.image_uris?.normal; if(!img && c.card_faces && c.card_faces[0].image_uris) img = c.card_faces[0].image_uris.normal;
                    let colors = c.colors; if(!colors && c.card_faces && c.card_faces[0].colors) colors = c.card_faces[0].colors;
                    if(img && c.rarity) {
                        const obj = { id: c.id, name: c.name, img: img, rarity: c.rarity, prices: c.prices, colors: colors || [], type_line: c.type_line, type: c.type_line || "Unknown", set: c.set, uri: c.scryfall_uri };
                        if(c.type_line && c.type_line.includes("Basic Land")) state.pool.land.push(obj); else if(state.pool[c.rarity]) state.pool[c.rarity].push(obj);
                    }
                });
                state.isLoaded = true; elements.packWrapper.style.opacity = '1'; showToast("Ready!");
            } catch(e) { showToast("Error loading cards"); }
        }

        let isDragging = false;
        const handleMove = (e) => {
            if(!isDragging) return; const rect = elements.strip.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            let pct = (clientX - rect.left) / rect.width * 100; if(pct > 100) pct = 100; if(pct < 0) pct = 0;
            elements.tear.style.width = pct + '%'; if(pct > 92) { openPack(); isDragging = false; }
        };
        const handleStart = () => isDragging = true; const handleEnd = () => { isDragging = false; elements.tear.style.width = '0%'; };
        elements.strip.addEventListener('mousedown', handleStart); window.addEventListener('mousemove', handleMove); window.addEventListener('mouseup', handleEnd);
        elements.strip.addEventListener('touchstart', handleStart); window.addEventListener('touchmove', handleMove); window.addEventListener('touchend', handleEnd);

        function resetPack() { elements.packWrapper.style.display = 'flex'; elements.cardStack.style.display = 'none'; elements.summary.style.display = 'none'; elements.strip.style.pointerEvents = 'auto'; elements.strip.style.opacity = 1; elements.tear.style.width = '0%'; }
        function openPack() {
            if(!state.isLoaded) return;
            const p = state.pool; const pick = arr => arr.length ? arr[Math.floor(Math.random()*arr.length)] : null;
            let pack = [];
            if(p.mythic.length && Math.random() < 0.13) pack.push({...pick(p.mythic)}); else if(p.rare.length) pack.push({...pick(p.rare)}); else if(p.uncommon.length) pack.push({...pick(p.uncommon)});
            for(let i=0; i<3; i++) { let c=pick(p.uncommon); if(c) pack.push({...c}); }
            let cCount = 10; if(Math.random() < 0.3) { cCount--; const pools = [p.common, p.uncommon, p.rare, p.mythic].flat(); if(pools.length) { let foil = {...pick(pools)}; foil.foil = true; pack.push(foil); } }
            for(let i=0; i<cCount; i++) { let c=pick(p.common); if(c) pack.push({...c}); }
            if(p.land.length) pack.push({...pick(p.land)});
            const stack = []; const rares = pack.filter(c=>['rare','mythic'].includes(c.rarity)); const uncs = pack.filter(c=>c.rarity==='uncommon' && !c.foil); const foils = pack.filter(c=>c.foil); const coms = pack.filter(c=>c.rarity==='common' && !c.foil); const lands = pack.filter(c=>c.type_line?.includes("Basic Land"));
            [...rares, ...uncs, ...foils, ...coms, ...lands].forEach(c => stack.push(c));
            elements.packWrapper.style.display = 'none'; elements.cardStack.style.display = 'block'; elements.cardStack.innerHTML = '';
            state.tempPackValue = 0; state.tempPackRares = [];
            stack.forEach((card, idx) => {
                const el = document.createElement('div'); el.className = `card ${card.foil ? 'foil' : ''}`; el.style.backgroundImage = `url(${card.img})`; el.style.zIndex = idx;
                el.onclick = (e) => {
                    saveCard(card); el.classList.add('swiped');
                    let val = getCardPrice(card);
                    state.tempPackValue += val;
                    if(val > 5 || ['rare','mythic'].includes(card.rarity)) state.tempPackRares.push(card);
                    showPriceExplosion(e.clientX, e.clientY, val, card.foil || val > 10);
                    if(idx === 0) setTimeout(showSummary, 500);
                };
                elements.cardStack.appendChild(el);
            });
        }

        function showPriceExplosion(x, y, val, isHighVal) {
            const el = document.createElement('div'); el.className = `price-pop ${isHighVal ? 'high-value' : ''}`;
            el.innerText = fmtMoney(val); el.style.left = x + 'px'; el.style.top = y + 'px';
            document.body.appendChild(el);
            if(isHighVal) { elements.flashOverlay.style.opacity = '0.4'; setTimeout(() => elements.flashOverlay.style.opacity = '0', 100); }
            setTimeout(() => document.body.removeChild(el), 1200);
        }

        function saveCard(card) {
            if(!state.collection[card.id]) state.collection[card.id] = {...card, count: 0, date: Date.now()};
            state.collection[card.id].count++;
            if(card.colors) state.collection[card.id].colors = card.colors;
            if(card.prices) state.collection[card.id].prices = card.prices;
            if(card.type) state.collection[card.id].type = card.type;
            if(card.type_line) state.collection[card.id].type_line = card.type_line;
            if(card.set) state.collection[card.id].set = card.set;
            if(card.uri) state.collection[card.id].uri = card.uri;
            state.collection[card.id].date = Date.now();
            localStorage.setItem('mtgCollection_v2', JSON.stringify(state.collection));
            renderTotalValue();
        }

        function showSummary() {
            elements.cardStack.style.display = 'none'; elements.summary.style.display = 'flex';
            elements.packVal.innerText = fmtMoney(state.tempPackValue); elements.summaryRares.innerHTML = '';
            if(!state.tempPackRares.length) elements.summaryRares.innerHTML = '<div style="color:#666;font-size:0.8rem">No big hits.</div>';
            state.tempPackRares.forEach(c => { const d = document.createElement('div'); d.className = 'mini-card'; d.style.backgroundImage = `url(${c.img})`; elements.summaryRares.appendChild(d); });
        }

        function renderTotalValue() {
            const vals = Object.values(state.collection); let total = 0;
            vals.forEach(c => { total += (getCardPrice(c) * c.count); });
            elements.homeVal.innerText = fmtMoney(total);
        }

        // --- FILTERING ---
        function toggleFilterPanel(context) {
            const panel = context === 'main' ? elements.filterPanelMain : elements.filterPanelDeck;
            if(panel.style.display === 'block') { panel.style.display = 'none'; } else {
                const source = context === 'main' ? Object.values(state.collection) : getDeckCards(state.decks[state.activeDeckId]);
                const uniqueSets = [...new Set(source.map(c => c.set).filter(Boolean))];
                const setContainer = document.getElementById(`filter-sets-${context}`);
                setContainer.innerHTML = '';
                uniqueSets.forEach(s => {
                    const isActive = state.filters.set.includes(s) ? 'active' : '';
                    setContainer.innerHTML += `<div class="chip ${isActive}" data-ctx="${context}" data-cat="set" data-val="${s}" onclick="toggleFilter('${context}', 'set', '${s}')">${s.toUpperCase()}</div>`;
                });
                panel.style.display = 'block';
            }
        }

        function toggleFilter(context, category, value) {
            const list = state.filters[category];
            const idx = list.indexOf(value);
            if(idx > -1) list.splice(idx, 1); else list.push(value);
            document.querySelectorAll(`.chip[data-ctx="${context}"][data-cat="${category}"][data-val="${value}"]`).forEach(el => el.classList.toggle('active'));
            if(context === 'main') renderCollection(); else renderActiveDeck();
        }

        function clearFilters(context) {
            state.filters = { color: [], rarity: [], type: [], set: [] };
            document.querySelectorAll(`.chip[data-ctx="${context}"]`).forEach(el => el.classList.remove('active'));
            if(context === 'main') renderCollection(); else renderActiveDeck();
        }

        function filterCards(cards, searchTerm) {
            return cards.filter(c => {
                if(searchTerm && !c.name.toLowerCase().includes(searchTerm)) return false;
                if(state.filters.color.length > 0) {
                    const cColors = c.colors || [];
                    if(state.filters.color.includes('C')) { if(cColors.length > 0) return false; }
                    else if(state.filters.color.includes('M')) { if(cColors.length < 2) return false; }
                    else { const hasMatch = state.filters.color.some(f => cColors.includes(f)); if(!hasMatch) return false; }
                }
                if(state.filters.rarity.length && !state.filters.rarity.includes(c.rarity)) return false;
                if(state.filters.type.length && !state.filters.type.some(t => c.type && c.type.includes(t))) return false;
                if(state.filters.set.length && (!c.set || !state.filters.set.includes(c.set))) return false;
                return true;
            });
        }

        function renderCollection() {
            const grid = document.getElementById('collection-grid'); grid.innerHTML = '';
            const cards = Object.values(state.collection);
            const sortMode = document.getElementById('sort-select').value;
            const search = document.getElementById('search-input').value.toLowerCase();
            const filtered = filterCards(cards, search);

            filtered.sort((a,b) => {
                if(sortMode === 'value') return getCardPrice(b) - getCardPrice(a);
                if(sortMode === 'recent') return b.date - a.date;
                return a.name.localeCompare(b.name);
            });

            if(filtered.length === 0) { grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:40px; color:#666;">No cards match.</div>'; return; }
            filtered.forEach(c => {
                const el = document.createElement('div'); el.className = 'col-card'; el.style.backgroundImage = `url(${c.img})`; el.onclick = () => openModal(c, 'binder');
                const count = document.createElement('div'); count.className = 'col-count'; count.innerText = c.count;
                const price = document.createElement('div'); price.className = 'col-price'; price.innerText = fmtMoney(getCardPrice(c));
                el.appendChild(count); el.appendChild(price); grid.appendChild(el);
            });
        }

        function switchView(viewName) {
            document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + viewName).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            if(viewName === 'collection') { clearFilters('main'); renderCollection(); }
            if(viewName === 'decks') renderDeckList();
        }

        // --- NEW DECK WIZARD ---
        function openNewDeckModal() { document.getElementById('new-deck-modal').style.display = 'flex'; }
        function finalizeNewDeck(format) {
            const name = document.getElementById('new-deck-name').value;
            if(!name) { showToast("Enter a name!"); return; }
            state.decks.push({ name: name, format: format, cards: {} });
            localStorage.setItem('mtgDecks_v2', JSON.stringify(state.decks));
            document.getElementById('new-deck-modal').style.display = 'none';
            document.getElementById('new-deck-name').value = '';
            renderDeckList();
        }

        // --- DECK LOGIC ---
        function openModal(card, source = 'binder') {
            state.modalCardId = card.id;
            elements.modal.style.display = 'flex';
            document.getElementById('modal-img').src = card.img;
            document.getElementById('modal-name').innerText = card.name;
            document.getElementById('modal-price').innerText = fmtMoney(getCardPrice(card));
            
            const btnAdd = document.getElementById('btn-modal-add');
            const btnCmd = document.getElementById('btn-set-commander');
            elements.deckSelectArea.style.display = 'none'; 
            
            if(source === 'deck' && state.activeDeckId !== null) {
                btnAdd.style.display = 'inline-block';
                btnAdd.innerText = "Remove from Deck"; 
                btnAdd.className = "btn danger";
                btnAdd.onclick = () => removeFromDeck();
                
                const deck = state.decks[state.activeDeckId];
                if(deck.format === 'Commander' && card.type && card.type.includes('Legendary') && card.type.includes('Creature')) {
                    btnCmd.style.display = 'inline-block';
                    btnCmd.onclick = () => setCommander();
                } else { btnCmd.style.display = 'none'; }
            } else {
                btnAdd.style.display = 'inline-block';
                btnAdd.innerText = "Add to Deck"; 
                btnAdd.className = "btn";
                btnAdd.onclick = () => handleDeckAdd();
                btnCmd.style.display = 'none';
            }
        }
        function closeModal() { elements.modal.style.display = 'none'; }

        // --- SHOPPING FEATURE ---
        function buyCard() {
            // Find current card by ID
            let card = state.collection[state.modalCardId];
            if(!card && state.activeDeckId !== null) {
                // Try finding it in the pool logic or similar, but typically it should be in collection
                // If not, we might be viewing it from a deck list (if we implemented sharing)
                // For now, it relies on collection state
            }
            
            if(card) {
                let url = card.uri || `https://scryfall.com/search?q=${encodeURIComponent(card.name)}`;
                // Redirect to TCGPlayer via Scryfall if possible, or Scryfall directly
                window.open(url, '_blank');
            }
        }

        function handleDeckAdd() {
            if(state.decks.length === 0) { showToast("Create a Deck first!"); return; }
            if(state.decks.length === 1) { addToDeck(0); return; }
            document.getElementById('btn-modal-add').style.display = 'none';
            elements.deckSelectArea.innerHTML = ''; elements.deckSelectArea.style.display = 'flex';
            state.decks.forEach((deck, idx) => {
                const btn = document.createElement('button'); btn.className = 'btn secondary'; btn.innerText = deck.name;
                btn.onclick = () => addToDeck(idx); elements.deckSelectArea.appendChild(btn);
            });
        }

        function addToDeck(idx) {
            const deck = state.decks[idx]; if(!deck.cards[state.modalCardId]) deck.cards[state.modalCardId] = 0;
            deck.cards[state.modalCardId]++; localStorage.setItem('mtgDecks_v2', JSON.stringify(state.decks));
            showToast(`Added to ${deck.name}`); closeModal();
        }

        function removeFromDeck() {
            if(state.activeDeckId === null) return;
            const deck = state.decks[state.activeDeckId];
            if(deck.cards[state.modalCardId]) {
                deck.cards[state.modalCardId]--; if(deck.cards[state.modalCardId] <= 0) delete deck.cards[state.modalCardId];
                if(deck.commander === state.modalCardId) deck.commander = null; 
                localStorage.setItem('mtgDecks_v2', JSON.stringify(state.decks));
                showToast("Removed from Deck"); closeModal(); renderActiveDeck();
            }
        }

        function setCommander() {
            if(state.activeDeckId === null) return;
            const deck = state.decks[state.activeDeckId];
            deck.commander = state.modalCardId;
            localStorage.setItem('mtgDecks_v2', JSON.stringify(state.decks));
            showToast("Commander Set! üëë"); closeModal(); renderActiveDeck();
        }
        
        function renderDeckList() {
            const list = document.getElementById('deck-list-container');
            const main = document.getElementById('decks-main-list');
            const view = document.getElementById('deck-view-container');
            main.style.display = 'block'; view.style.display = 'none'; list.innerHTML = ''; state.activeDeckId = null;
            if(state.decks.length === 0) { list.innerHTML = '<div style="text-align:center; color:#666;">No decks.</div>'; return; }
            state.decks.forEach((deck, idx) => {
                const deckCards = getDeckCards(deck);
                let deckVal = 0;
                deckCards.forEach(c => { deckVal += getCardPrice(c) * c.qty; });
                const count = deckCards.reduce((acc, c) => acc + c.qty, 0);
                const el = document.createElement('div'); el.className = 'deck-list-item';
                const fmt = deck.format === 'Commander' ? 'CMD' : 'STD';
                el.innerHTML = `<div onclick="openDeck(${idx}, 'grid')" style="flex:1;"><div style="font-weight:bold; font-size:1rem">${deck.name}<span class="deck-fmt-tag">${fmt}</span></div><div style="font-size:0.8rem; color:#888;">${count} cards</div></div><div style="display:flex; align-items:center;"><span class="deck-val-tag">${fmtMoney(deckVal)}</span><button class="btn secondary" style="width:auto; padding:8px 12px; margin:0; margin-right:5px;" onclick="openDeck(${idx}, 'list')">Edit</button><button class="btn danger" style="width:auto; padding:8px 12px; margin:0;" onclick="deleteDeck(${idx})">X</button></div>`;
                list.appendChild(el);
            });
        }

        function deleteDeck(idx) { if(confirm("Delete this deck?")) { state.decks.splice(idx, 1); localStorage.setItem('mtgDecks_v2', JSON.stringify(state.decks)); renderDeckList(); } }

        function openDeck(idx, mode) {
            state.activeDeckId = idx; state.deckViewMode = mode;
            clearFilters('deck'); 
            document.getElementById('decks-main-list').style.display = 'none';
            document.getElementById('deck-view-container').style.display = 'flex';
            renderActiveDeck();
        }
        function closeDeckView() { state.activeDeckId = null; renderDeckList(); }

        function getDeckCards(deck) {
            const cards = [];
            Object.keys(deck.cards).forEach(id => {
                const qty = deck.cards[id]; const cardInfo = state.collection[id];
                if(cardInfo) cards.push({...cardInfo, qty: qty});
            });
            return cards;
        }

        function renderActiveDeck() {
            const deck = state.decks[state.activeDeckId];
            document.getElementById('active-deck-name').innerText = deck.name;
            document.getElementById('active-deck-format').innerText = deck.format === 'Commander' ? 'CMD' : 'STD';
            const listView = document.getElementById('active-deck-list');
            const gridView = document.getElementById('deck-grid-view');
            const controls = document.getElementById('deck-controls');
            const filterControls = document.getElementById('deck-filter-controls');

            controls.style.display = 'flex'; 
            document.getElementById('btn-mode-grid').className = state.deckViewMode === 'grid' ? 'btn' : 'btn secondary';
            document.getElementById('btn-mode-list').className = state.deckViewMode === 'list' ? 'btn' : 'btn secondary';

            let deckCards = getDeckCards(deck);
            const total = deckCards.reduce((acc, c) => acc + c.qty, 0);
            document.getElementById('active-deck-count').innerText = `${total} cards`;

            const search = document.getElementById('deck-search-input').value.toLowerCase();
            deckCards = filterCards(deckCards, search);

            if(deck.commander) {
                const cmdIndex = deckCards.findIndex(c => c.id === deck.commander);
                if(cmdIndex > -1) { const cmd = deckCards.splice(cmdIndex, 1)[0]; deckCards.unshift(cmd); }
            }

            if(state.deckViewMode === 'list') {
                filterControls.style.display = 'none'; gridView.style.display = 'none'; listView.style.display = 'block'; listView.innerHTML = '';
                deckCards.forEach(c => {
                    const isCmd = c.id === deck.commander ? 'üëë ' : '';
                    const row = document.createElement('div'); row.className = 'deck-card-row';
                    row.innerHTML = `<div class="row-img" style="background-image:url(${c.img})"></div><div style="flex:1; font-size:0.9rem;">${isCmd}${c.name}</div><div style="font-weight:bold; color:var(--primary); margin-right:10px;">x${c.qty}</div><button class="remove-btn" onclick="quickRemove('${c.id}')">-</button>`;
                    listView.appendChild(row);
                });
            } else {
                filterControls.style.display = 'flex'; listView.style.display = 'none'; gridView.style.display = 'grid'; gridView.innerHTML = '';
                deckCards.forEach(c => {
                    const el = document.createElement('div'); el.className = 'col-card'; el.style.backgroundImage = `url(${c.img})`;
                    el.onclick = () => openModal(c, 'deck'); 
                    const count = document.createElement('div'); count.className = 'col-count'; count.innerText = c.qty;
                    el.appendChild(count);
                    if(c.id === deck.commander) { const badge = document.createElement('div'); badge.className = 'col-cmd'; badge.innerText = 'üëë'; el.appendChild(badge); }
                    gridView.appendChild(el);
                });
            }
        }

        function toggleDeckMode(mode) { state.deckViewMode = mode; renderActiveDeck(); }
        function quickRemove(id) { state.modalCardId = id; removeFromDeck(); }
    </script>
</body>
</html>
