<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mozart's Musical Dice Game (K. 516f)</title>
    <style>
        :root {
            --bg-color: #fdf6e3;
            --text-color: #2c2c2c;
            --accent-color: #d33682;
            --box-bg: #eee8d5;
            --border: #b58900;
        }

        body {
            font-family: "Garamond", "Times New Roman", serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            text-align: center;
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            font-style: italic;
            margin-bottom: 2rem;
            opacity: 0.8;
        }

        .instructions {
            background: rgba(255,255,255,0.5);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 1.1rem;
            line-height: 1.5;
        }

        /* Grid for the 16 Bars */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .measure-box {
            background: var(--box-bg);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: transform 0.2s;
        }

        .measure-box.active {
            background: #ffe082;
            transform: scale(1.1);
            border-color: var(--accent-color);
        }

        .measure-box label {
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .measure-box input {
            width: 50px;
            height: 40px;
            font-size: 1.5rem;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: sans-serif;
        }

        .measure-id-display {
            font-size: 0.8rem;
            margin-top: 5px;
            color: var(--accent-color);
            height: 1rem;
        }

        /* Controls */
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            font-size: 1.2rem;
            cursor: pointer;
            background-color: var(--text-color);
            color: var(--bg-color);
            border: none;
            border-radius: 4px;
            font-family: serif;
            transition: background 0.3s;
        }

        button:hover {
            background-color: var(--accent-color);
        }

        button.secondary {
            background-color: transparent;
            border: 2px solid var(--text-color);
            color: var(--text-color);
        }

        button.secondary:hover {
            background-color: var(--text-color);
            color: var(--bg-color);
        }

        .status {
            font-size: 1.2rem;
            height: 2rem;
            font-weight: bold;
        }

        .footer {
            margin-top: 50px;
            font-size: 0.9rem;
            opacity: 0.7;
            border-top: 1px solid #ccc;
            padding-top: 20px;
        }
    </style>
</head>
<body>

    <h1>Musikalisches WÃ¼rfelspiel</h1>
    <div class="subtitle">Mozart's Musical Dice Game (K. 516f)</div>

    <div class="instructions">
        <strong>How to play:</strong> Roll two dice for each of the 16 bars. 
        Enter the <strong>SUM</strong> (2-12) into the boxes below. 
        Then press "Play Composition" to hear your unique Minuet.
    </div>

    <div class="grid-container" id="grid">
        </div>

    <div class="controls">
        <button onclick="playMusic()">â–¶ Play Composition</button>
        <button class="secondary" onclick="randomizeAll()">ðŸŽ² Randomize All</button>
        <button class="secondary" onclick="clearAll()">â†º Clear</button>
    </div>

    <div class="status" id="status">Ready</div>

    <div class="footer">
        <p>This simulation uses the exact lookup table from Mozart's manuscript. <br>
        Audio is synthesized in real-time using the Web Audio API.</p>
    </div>

<script>
    // --- 1. The Data (Mozart's K 516f Table) ---
    // Rows = Dice Sum (2-12), Columns = Bar Index (1-16)
    // Value = The specific measure fragment ID
    const mozartTable = {
        2: [96, 22, 141, 41, 105, 122, 11, 30, 70, 121, 26, 9, 112, 49, 109, 14],
        3: [32, 6, 128, 63, 146, 46, 134, 81, 117, 39, 126, 56, 174, 18, 116, 83],
        4: [69, 95, 158, 13, 153, 55, 110, 24, 66, 139, 15, 132, 73, 58, 145, 79],
        5: [40, 17, 113, 85, 161, 2, 159, 100, 90, 176, 7, 34, 67, 160, 52, 170],
        6: [148, 74, 163, 45, 80, 97, 36, 107, 25, 143, 64, 125, 76, 136, 1, 93],
        7: [104, 157, 27, 167, 154, 68, 118, 91, 138, 71, 150, 29, 101, 162, 23, 151],
        8: [152, 60, 171, 53, 99, 133, 21, 127, 16, 155, 57, 175, 43, 168, 89, 172],
        9: [119, 84, 114, 50, 140, 86, 169, 94, 120, 88, 48, 166, 51, 115, 72, 111],
        10: [98, 142, 42, 156, 75, 129, 62, 123, 65, 77, 19, 82, 137, 38, 149, 8],
        11: [3, 87, 165, 61, 135, 47, 147, 33, 102, 4, 31, 164, 144, 59, 173, 78],
        12: [54, 130, 10, 103, 28, 37, 106, 5, 35, 20, 108, 92, 12, 124, 44, 131]
    };

    // --- 2. UI Generation ---
    const grid = document.getElementById('grid');
    const statusDiv = document.getElementById('status');
    const inputs = [];

    for (let i = 0; i < 16; i++) {
        const box = document.createElement('div');
        box.className = 'measure-box';
        box.id = `box-${i}`;
        
        const label = document.createElement('label');
        label.innerText = `Bar ${i + 1}`;
        
        const input = document.createElement('input');
        input.type = 'number';
        input.min = 2;
        input.max = 12;
        input.placeholder = "?";
        input.onchange = () => updateMeasureId(i);
        
        const idDisplay = document.createElement('div');
        idDisplay.className = 'measure-id-display';
        idDisplay.id = `display-${i}`;

        box.appendChild(label);
        box.appendChild(input);
        box.appendChild(idDisplay);
        grid.appendChild(box);
        inputs.push(input);
    }

    function updateMeasureId(index) {
        const val = parseInt(inputs[index].value);
        const display = document.getElementById(`display-${index}`);
        if (val >= 2 && val <= 12) {
            const measureId = mozartTable[val][index];
            display.innerText = `M. ${measureId}`;
        } else {
            display.innerText = '';
        }
    }

    function randomizeAll() {
        inputs.forEach((input, index) => {
            // Simulate 2 dice roll
            const d1 = Math.floor(Math.random() * 6) + 1;
            const d2 = Math.floor(Math.random() * 6) + 1;
            input.value = d1 + d2;
            updateMeasureId(index);
        });
        statusDiv.innerText = "Values Randomized!";
    }

    function clearAll() {
        inputs.forEach((input, index) => {
            input.value = '';
            updateMeasureId(index);
        });
        statusDiv.innerText = "Cleared";
    }

    // --- 3. Audio Engine (Web Audio API) ---
    // Note: Since we can't embed 176 mp3s, we use a synth.
    // We map the Measure ID to a procedural melody that fits the harmonic structure.
    
    let audioCtx;
    let isPlaying = false;

    // Frequencies for C Major / G Major range
    const notes = {
        'G3': 196.00, 'A3': 220.00, 'B3': 246.94,
        'C4': 261.63, 'D4': 293.66, 'E4': 329.63, 'F4': 349.23, 'F#4': 369.99, 'G4': 392.00,
        'A4': 440.00, 'B4': 493.88, 'C5': 523.25, 'D5': 587.33, 'E5': 659.25, 'F5': 698.46, 'G5': 783.99
    };

    // Harmonic Structure of a Minuet in C
    // 1-8: C Maj -> G Maj
    // 9-16: G Maj -> C Maj
    // We use the Bar Index to determine the allowed notes (Chord tones + passing notes)
    // We use the Measure ID (from the table) to determine the rhythm/pattern.
    
    function getHarmony(barIndex) {
        // Simple Minuet harmony map
        // 0=C, 1=F, 2=G, 3=C, 4=C, 5=G, 6=G, 7=C (End of A section)
        const harmonyMap = ['C', 'F', 'G', 'C', 'C', 'G', 'G', 'C', 
                            'G', 'C', 'G', 'C', 'F', 'G', 'G', 'C']; 
        return harmonyMap[barIndex];
    }

    function generateMelody(measureId, barIndex) {
        const chord = getHarmony(barIndex);
        const seed = measureId; // Use the Mozart ID as a seed for the pattern
        
        let pattern = [];
        const beatLength = 0.5; // seconds
        
        // Pseudo-random generator based on measureId
        const patternType = seed % 4; 
        
        // Define base triads
        let base = [];
        if (chord === 'C') base = ['C4', 'E4', 'G4', 'C5', 'E5'];
        if (chord === 'G') base = ['G3', 'B3', 'D4', 'G4', 'B4'];
        if (chord === 'F') base = ['F4', 'A4', 'C5', 'F5'];

        // Procedural generation based on Mozart's ID
        if (patternType === 0) {
            // Arpeggio Up
            pattern.push({note: base[0], time: 0, dur: 0.5});
            pattern.push({note: base[1], time: 0.5, dur: 0.5});
            pattern.push({note: base[2], time: 1.0, dur: 0.5});
        } else if (patternType === 1) {
            // Step down
            pattern.push({note: base[2] || 'C5', time: 0, dur: 1.0});
            pattern.push({note: base[1] || 'G4', time: 1.0, dur: 0.5});
        } else if (patternType === 2) {
            // Alberti-ish
            pattern.push({note: base[0], time: 0, dur: 0.5});
            pattern.push({note: base[2] || 'G4', time: 0.5, dur: 0.5});
            pattern.push({note: base[1] || 'E4', time: 1.0, dur: 0.5});
        } else {
            // Long note trill feel
            pattern.push({note: base[1], time: 0, dur: 1.2});
            pattern.push({note: base[0], time: 1.2, dur: 0.3});
        }
        
        // Add a "Bass" note on beat 1 for fullness
        pattern.push({note: base[0], time: 0, dur: 1.5, type: 'bass'});

        return pattern;
    }

    function playTone(freq, startTime, duration, type='lead') {
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();

        osc.type = type === 'bass' ? 'triangle' : 'sine';
        if(type === 'lead') osc.type = 'triangle'; // Harpsichord-ish

        osc.frequency.value = freq;
        
        // Envelope
        gainNode.gain.setValueAtTime(0, startTime);
        gainNode.gain.linearRampToValueAtTime(type === 'bass' ? 0.3 : 0.2, startTime + 0.05);
        gainNode.gain.exponentialRampToValueAtTime(0.001, startTime + duration);

        osc.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        osc.start(startTime);
        osc.stop(startTime + duration);
    }

    async function playMusic() {
        if (isPlaying) return;
        
        // Validate inputs
        const currentSelection = [];
        for(let i=0; i<16; i++) {
            const val = parseInt(inputs[i].value);
            if (!val || val < 2 || val > 12) {
                alert(`Please enter a valid dice sum (2-12) for Bar ${i+1}`);
                return;
            }
            currentSelection.push(mozartTable[val][i]);
        }

        // Init Audio
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') await audioCtx.resume();

        isPlaying = true;
        statusDiv.innerText = "Playing...";
        
        let now = audioCtx.currentTime;
        const barDuration = 1.5; // 3 beats at 0.5s each

        for (let i = 0; i < 16; i++) {
            // Visual highlight
            setTimeout(() => {
                document.querySelectorAll('.measure-box').forEach(b => b.classList.remove('active'));
                document.getElementById(`box-${i}`).classList.add('active');
            }, (i * barDuration) * 1000);

            // Audio scheduling
            const measureId = currentSelection[i];
            const notesToPlay = generateMelody(measureId, i);
            
            notesToPlay.forEach(n => {
                if(notes[n.note]) {
                    playTone(notes[n.note], now + n.time, n.dur, n.type);
                }
            });

            now += barDuration;
        }

        // Cleanup
        setTimeout(() => {
            document.querySelectorAll('.measure-box').forEach(b => b.classList.remove('active'));
            statusDiv.innerText = "Finished";
            isPlaying = false;
        }, 16 * barDuration * 1000);
    }

    // Initialize with random values on load for demo
    randomizeAll();

</script>
</body>
</html>
