<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Realistic Four-Legged Crab Walker</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: #87CEEB;
      touch-action: none; /* Prevent default touch actions */
    }
    canvas { display: block; }
  </style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<script>
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  // Crab properties
  const crab = {
    x: canvas.width / 2,
    y: canvas.height / 2,
    size: 50,
    speed: 4,
    angle: 0,       // Direction the crab is facing
    legOffset: 0,   // For leg animation phase
    moving: false
  };

  // Leg configuration for four legs (2 per side)
  // Each leg has: side (-1: left, 1: right), vertical offset, phase offset for animation
  const legs = [
    { side: -1, offsetY: -crab.size * 0.4, phase: 0 },      // Front left
    { side: -1, offsetY:  crab.size * 0.4, phase: Math.PI },  // Back left
    { side:  1, offsetY: -crab.size * 0.4, phase: Math.PI },  // Front right
    { side:  1, offsetY:  crab.size * 0.4, phase: 0 }         // Back right
  ];

  // Keyboard input
  const keys = { ArrowLeft: false, ArrowRight: false, ArrowUp: false, ArrowDown: false,
                 a: false, d: false, w: false, s: false };

  document.addEventListener("keydown", e => {
    if (keys.hasOwnProperty(e.key)) keys[e.key] = true;
  });
  document.addEventListener("keyup", e => {
    if (keys.hasOwnProperty(e.key)) keys[e.key] = false;
  });

  // Touch control variables
  let touchStartX = 0, touchStartY = 0;
  let touchDX = 0, touchDY = 0;
  let touchActive = false;

  canvas.addEventListener("touchstart", e => {
    const touch = e.touches[0];
    touchStartX = touch.clientX;
    touchStartY = touch.clientY;
    touchActive = true;
  });

  canvas.addEventListener("touchmove", e => {
    if (!touchActive) return;
    const touch = e.touches[0];
    touchDX = touch.clientX - touchStartX;
    touchDY = touch.clientY - touchStartY;
    const dist = Math.sqrt(touchDX*touchDX + touchDY*touchDY);
    if (dist > 0) {
      crab.angle = Math.atan2(touchDY, touchDX);
      crab.moving = true;
    }
  });

  canvas.addEventListener("touchend", () => {
    touchActive = false;
    touchDX = 0;
    touchDY = 0;
    crab.moving = false;
  });

  // Update crab position and leg animation
  function update() {
    let dx = 0, dy = 0;
    crab.moving = false; // Reset each frame

    // Keyboard control
    if (keys.ArrowLeft || keys.a) { dx = -1; crab.angle = Math.PI; crab.moving = true; }
    if (keys.ArrowRight || keys.d) { dx = 1; crab.angle = 0; crab.moving = true; }
    if (keys.ArrowUp || keys.w) { dy = -1; crab.moving = true; }
    if (keys.ArrowDown || keys.s) { dy = 1; crab.moving = true; }

    // Touch control (overrides keyboard if active)
    if (touchActive) {
      const tLen = Math.sqrt(touchDX*touchDX + touchDY*touchDY);
      if (tLen > 0) {
        dx = touchDX / tLen;
        dy = touchDY / tLen;
        crab.angle = Math.atan2(touchDY, touchDX);
        crab.moving = true;
      }
    }

    // Normalize diagonal movement
    if (dx !== 0 || dy !== 0) {
      const len = Math.sqrt(dx*dx + dy*dy);
      dx /= len;
      dy /= len;
    }

    // Update position and leg animation
    if (crab.moving) {
      crab.x += dx * crab.speed;
      crab.y += dy * crab.speed;
      crab.legOffset += 0.2;
      if (crab.legOffset > Math.PI * 2) crab.legOffset -= Math.PI * 2;
    }
  }

  // Draw a two-segment leg at a given base point
  function drawLeg(baseX, baseY, side, phase) {
    ctx.save();
    ctx.translate(baseX, baseY);

    // Calculate oscillation for the two segments
    const amp = 0.5; // amplitude in radians
    const angle1 = amp * Math.sin(crab.legOffset + phase);
    const angle2 = amp * Math.sin(crab.legOffset + phase + 0.5);

    // First segment
    const L1 = crab.size * 0.6;
    ctx.rotate(angle1);
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.lineTo(L1, 0);
    ctx.stroke();

    // Second segment
    ctx.translate(L1, 0);
    ctx.rotate(angle2);
    const L2 = crab.size * 0.5;
    ctx.beginPath();
    ctx.moveTo(0, 0);
    ctx.lineTo(L2, 0);
    ctx.stroke();
    ctx.restore();
  }

  // Draw the crab body and legs
  function drawCrab() {
    ctx.save();
    ctx.translate(crab.x, crab.y);
    ctx.rotate(crab.angle);

    // Draw crab body
    ctx.fillStyle = "red";
    ctx.beginPath();
    ctx.ellipse(0, 0, crab.size, crab.size * 0.6, 0, 0, Math.PI * 2);
    ctx.fill();

    // Draw legs (for each leg defined in the legs array)
    ctx.strokeStyle = "red";
    ctx.lineWidth = 5;
    legs.forEach(leg => {
      // Leg base relative to crab's center
      const baseX = leg.side * crab.size * 0.8;
      const baseY = leg.offsetY;
      drawLeg(baseX, baseY, leg.side, leg.phase);
    });

    // Draw eyes
    ctx.fillStyle = "white";
    ctx.beginPath();
    ctx.arc(-15, -20, 8, 0, Math.PI * 2);
    ctx.arc(15, -20, 8, 0, Math.PI * 2);
    ctx.fill();

    // Draw pupils
    ctx.fillStyle = "black";
    ctx.beginPath();
    ctx.arc(-15, -20, 4, 0, Math.PI * 2);
    ctx.arc(15, -20, 4, 0, Math.PI * 2);
    ctx.fill();

    ctx.restore();
  }

  function gameLoop() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    update();
    drawCrab();
    requestAnimationFrame(gameLoop);
  }

  gameLoop();
</script>
</body>
</html>