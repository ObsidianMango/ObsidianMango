<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refined Crab Walker</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #87CEEB;
            touch-action: none;
        }
        canvas { display: block; }
    </style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // Crab properties
    const crab = {
        x: canvas.width / 2,
        y: canvas.height / 2,
        speed: 3,
        angle: 0,
        legCycle: 0,
        moving: false,
        bodySize: 50
    };

    // Define 6 double-jointed legs (3 per side)
    const legs = [
        { side: -1, offsetY: -25, phase: 0 },
        { side: -1, offsetY:  0, phase: Math.PI },
        { side: -1, offsetY: 25, phase: 0 },
        { side:  1, offsetY: -25, phase: Math.PI },
        { side:  1, offsetY:  0, phase: 0 },
        { side:  1, offsetY: 25, phase: Math.PI }
    ];

    // Define 2 claw arms at the front
    const claws = [
        { side: -1, offsetX: 30, offsetY: -20, phase: 0 },
        { side:  1, offsetX: 30, offsetY: -20, phase: Math.PI }
    ];

    // Input states
    const keys = { ArrowLeft: false, ArrowRight: false, ArrowUp: false, ArrowDown: false, a: false, d: false, w: false, s: false };
    let touchActive = false, touchDX = 0, touchDY = 0;

    document.addEventListener("keydown", e => { if (keys.hasOwnProperty(e.key)) keys[e.key] = true; });
    document.addEventListener("keyup", e => { if (keys.hasOwnProperty(e.key)) keys[e.key] = false; });

    // Touch controls
    canvas.addEventListener("touchstart", e => { touchActive = true; });
    canvas.addEventListener("touchmove", e => {
        const touch = e.touches[0];
        touchDX = touch.clientX - crab.x;
        touchDY = touch.clientY - crab.y;
        crab.angle = Math.atan2(touchDY, touchDX);
        crab.moving = true;
    });
    canvas.addEventListener("touchend", () => { touchActive = false; crab.moving = false; });

    // Update function
    function update() {
        let dx = 0, dy = 0;
        crab.moving = false;

        // Keyboard movement
        if (keys.ArrowLeft || keys.a) { dx = -1; crab.angle = Math.PI; crab.moving = true; }
        if (keys.ArrowRight || keys.d) { dx = 1; crab.angle = 0; crab.moving = true; }
        if (keys.ArrowUp || keys.w) { dy = -1; crab.moving = true; }
        if (keys.ArrowDown || keys.s) { dy = 1; crab.moving = true; }

        // Normalize movement
        if (dx !== 0 || dy !== 0) {
            const len = Math.sqrt(dx * dx + dy * dy);
            dx /= len;
            dy /= len;
        }

        // Touch movement overrides keyboard
        if (touchActive) {
            const len = Math.sqrt(touchDX * touchDX + touchDY * touchDY);
            dx = touchDX / len;
            dy = touchDY / len;
            crab.moving = true;
        }

        // Move crab
        if (crab.moving) {
            crab.x += dx * crab.speed;
            crab.y += dy * crab.speed;
            crab.legCycle += 0.15;
            if (crab.legCycle > Math.PI * 2) crab.legCycle -= Math.PI * 2;
        }
    }

    // Draw function
    function drawCrab() {
        ctx.save();
        ctx.translate(crab.x, crab.y);
        ctx.rotate(crab.angle);

        // Draw body
        ctx.fillStyle = "red";
        ctx.beginPath();
        ctx.ellipse(0, 0, crab.bodySize, crab.bodySize * 0.6, 0, 0, Math.PI * 2);
        ctx.fill();

        // Draw eyes
        ctx.fillStyle = "white";
        ctx.beginPath();
        ctx.arc(-15, -20, 6, 0, Math.PI * 2);
        ctx.arc(15, -20, 6, 0, Math.PI * 2);
        ctx.fill();

        ctx.fillStyle = "black";
        ctx.beginPath();
        ctx.arc(-15, -20, 3, 0, Math.PI * 2);
        ctx.arc(15, -20, 3, 0, Math.PI * 2);
        ctx.fill();

        // Draw legs
        ctx.strokeStyle = "red";
        ctx.lineWidth = 4;
        legs.forEach(leg => drawLeg(leg));

        // Draw claws
        claws.forEach(claw => drawClaw(claw));

        ctx.restore();
    }

    // Function to draw a double-jointed leg
    function drawLeg(leg) {
        ctx.save();
        const baseX = leg.side * 40;
        const baseY = leg.offsetY;
        ctx.translate(baseX, baseY);

        const phaseOffset = Math.sin(crab.legCycle + leg.phase) * 5;

        // First segment
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(leg.side * 20, phaseOffset);
        ctx.stroke();

        // Second segment
        ctx.translate(leg.side * 20, phaseOffset);
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(leg.side * 15, -phaseOffset);
        ctx.stroke();

        ctx.restore();
    }

    // Function to draw claw arms with subtle movement
    function drawClaw(claw) {
        ctx.save();
        ctx.translate(claw.offsetX, claw.offsetY);

        const clawSwing = Math.sin(crab.legCycle + claw.phase) * 3;

        // First segment
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(20, clawSwing);
        ctx.stroke();

        // Second segment (claw tip)
        ctx.translate(20, clawSwing);
        ctx.beginPath();
        ctx.moveTo(0, 0);
        ctx.lineTo(15, -clawSwing);
        ctx.stroke();

        ctx.fillStyle = "red";
        ctx.beginPath();
        ctx.arc(15, 0, 3, 0, Math.PI * 2);
        ctx.fill();

        ctx.restore();
    }

    function gameLoop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        update();
        drawCrab();
        requestAnimationFrame(gameLoop);
    }
    gameLoop();
</script>
</body>
</html>