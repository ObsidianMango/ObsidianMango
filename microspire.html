<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Slay the Micro Spire: Ascension</title>
    <style>
        /* --- THEME & LAYOUT --- */
        :root {
            --bg: #0f0f13;
            --panel: rgba(20, 20, 25, 0.95);
            --red: #ff4d4d;
            --blue: #4da6ff;
            --gold: #ffd700;
            --green: #2ecc71;
            --card-shadow: 0 5px 15px rgba(0,0,0,0.6);
        }
        body { margin: 0; background: var(--bg); color: #eee; font-family: 'Verdana', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; user-select: none; }
        
        /* --- TOP HUD --- */
        #top-bar { display: flex; justify-content: space-between; padding: 8px 15px; background: #000; border-bottom: 1px solid #333; font-size: 0.9rem; z-index: 20; }
        .hud-item { display: flex; align-items: center; gap: 6px; }
        #relic-bar { display: flex; gap: 5px; margin-left: 10px; }
        .relic-icon { width: 24px; height: 24px; background: #333; border-radius: 50%; display: flex; justify-content: center; align-items: center; border: 1px solid #666; font-size: 0.8rem; cursor: help; }

        /* --- BATTLE ARENA --- */
        #arena { flex: 1; display: flex; justify-content: space-between; align-items: center; padding: 0 10%; position: relative; background: radial-gradient(circle at center, #1a1a24 0%, #000 100%); }
        
        .unit { position: relative; width: 120px; text-align: center; transition: transform 0.1s; }
        .sprite { font-size: 5rem; filter: drop-shadow(0 0 10px rgba(0,0,0,0.5)); transition: transform 0.2s; display: inline-block; }
        /* CSS Trick to flip enemies facing right */
        .mirror-face { transform: scaleX(-1); }
        
        .shake-hit { animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both; }
        .attack-anim { animation: lunge 0.2s forwards; }
        
        @keyframes shake { 10%, 90% { transform: translate3d(-2px, 0, 0); } 20%, 80% { transform: translate3d(4px, 0, 0); } }
        @keyframes lunge { 0% { transform: translateX(0); } 50% { transform: translateX(30px); } 100% { transform: translateX(0); } }

        /* BARS & INTENTS */
        .bar-wrap { background: #333; height: 14px; border: 2px solid #111; border-radius: 10px; margin-top: 10px; position: relative; overflow: hidden; }
        .hp-fill { background: var(--red); height: 100%; width: 100%; transition: width 0.3s ease-out; }
        .block-overlay { position: absolute; top: -25px; left: -10px; background: var(--blue); color: white; font-weight: bold; padding: 2px 8px; border-radius: 10px; border: 2px solid #fff; font-size: 0.9rem; display: none; box-shadow: 0 0 5px var(--blue); }
        
        .intent-wrap { position: absolute; top: -50px; left: 50%; transform: translateX(-50%); text-align: center; }
        .intent-val { font-size: 1.2rem; font-weight: bold; color: #fff; text-shadow: 0 0 5px #000; }
        .status-row { display: flex; justify-content: center; gap: 3px; margin-top: 5px; flex-wrap: wrap; }
        .status-icon { font-size: 0.7rem; padding: 2px 5px; border-radius: 4px; background: rgba(0,0,0,0.6); border: 1px solid #555; }

        /* --- CARDS --- */
        #hand-area { height: 220px; position: relative; display: flex; justify-content: center; align-items: flex-end; padding-bottom: 20px; overflow: visible; z-index: 100; }
        
        .card {
            width: 110px; height: 160px;
            background: linear-gradient(145deg, #34495e, #2c3e50);
            border: 2px solid #7f8c8d;
            border-radius: 8px;
            margin: 0 -15px; /* Fan effect */
            display: flex; flex-direction: column; align-items: center;
            position: relative;
            cursor: pointer;
            box-shadow: var(--card-shadow);
            transition: transform 0.2s, z-index 0.2s, margin 0.2s;
            color: white;
            user-select: none;
            transform-origin: bottom center;
        }

        .card:hover { transform: translateY(-60px) scale(1.15) !important; z-index: 200; margin: 0 5px; border-color: var(--gold); }
        .card-cost { position: absolute; top: -8px; left: -8px; width: 24px; height: 24px; background: var(--blue); border-radius: 50%; font-weight: bold; display: flex; justify-content: center; align-items: center; border: 2px solid white; z-index: 2; }
        .card-title { font-size: 0.75rem; font-weight: bold; margin-top: 20px; text-align: center; color: var(--gold); }
        .card-art { font-size: 2.5rem; margin: 5px 0; }
        .card-desc { font-size: 0.65rem; text-align: center; padding: 2px 4px; line-height: 1.2; color: #ddd; }
        
        .card.attack { border-color: #c0392b; background: linear-gradient(145deg, #5a3030, #381f1f); }
        .card.skill { border-color: #2980b9; background: linear-gradient(145deg, #30455a, #1f2d38); }
        .card.power { border-color: #8e44ad; background: linear-gradient(145deg, #4a305a, #2f1f38); }
        .card.upgraded .card-title { color: var(--green); text-shadow: 0 0 5px var(--green); }
        .card.upgraded .card-title::after { content: "+"; }

        /* --- FLOATING NUMBERS --- */
        .floater { position: absolute; font-weight: 900; font-size: 2rem; animation: floatUp 0.8s forwards; pointer-events: none; -webkit-text-stroke: 1px black; z-index: 999; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-80px) scale(1.5); } }

        /* --- OVERLAYS (Map, Rewards) --- */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.92); z-index: 500; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .overlay h1 { font-size: 2.5rem; color: var(--gold); margin-bottom: 20px; text-transform: uppercase; letter-spacing: 2px; }
        
        .choice-container { display: flex; gap: 30px; margin-top: 20px; }
        .choice-btn { 
            background: #222; border: 2px solid #555; padding: 20px; width: 140px; 
            border-radius: 10px; cursor: pointer; transition: all 0.2s; text-align: center; 
        }
        .choice-btn:hover { border-color: var(--gold); transform: translateY(-5px); background: #333; }
        .choice-icon { font-size: 3rem; margin-bottom: 10px; display: block; }
        .choice-label { font-weight: bold; color: white; display: block; }

        button.btn-main { background: var(--blue); border: none; padding: 12px 30px; font-size: 1.2rem; color: white; border-radius: 5px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 0 #1e6096; margin-top: 20px; }
        button.btn-main:active { transform: translateY(4px); box-shadow: none; }

        /* --- END TURN BUTTON --- */
        #end-turn-con { position: absolute; bottom: 240px; right: 20px; z-index: 101; }
        #end-btn { background: var(--red); box-shadow: 0 4px 0 #922b21; padding: 10px 20px; font-size: 1rem; }
    </style>
</head>
<body>

    <div id="top-bar">
        <div style="display:flex; gap:15px;">
            <div class="hud-item">‚ù§Ô∏è <span id="hp-val">80/80</span></div>
            <div class="hud-item">üí∞ <span id="gold-val">99</span></div>
            <div class="hud-item">ü¶∂ <span id="floor-val">1</span></div>
        </div>
        <div id="relic-bar"></div>
    </div>

    <div id="arena">
        <div id="player" class="unit">
            <div id="player-block" class="block-overlay">0</div>
            <span class="sprite">üõ°Ô∏è</span>
            <div class="bar-wrap"><div id="player-hp-bar" class="hp-fill"></div></div>
            <div id="player-status" class="status-row"></div>
        </div>

        <div id="enemy" class="unit">
            <div class="intent-wrap">
                <div id="enemy-intent-icon" style="font-size:2rem;"></div>
                <div id="enemy-intent-val" class="intent-val"></div>
            </div>
            <div id="enemy-block" class="block-overlay">0</div>
            <span id="enemy-sprite" class="sprite"></span>
            <div style="font-weight:bold; margin-top:5px;" id="enemy-name"></div>
            <div class="bar-wrap"><div id="enemy-hp-bar" class="hp-fill"></div></div>
            <div style="font-size:0.8rem;" id="enemy-hp-txt"></div>
            <div id="enemy-status" class="status-row"></div>
        </div>
    </div>

    <div id="end-turn-con">
        <button id="end-btn" class="btn-main" onclick="endTurn()">End Turn</button>
    </div>

    <div id="hand-area"></div>

    <div id="path-screen" class="overlay">
        <h1>Choose Your Path</h1>
        <div id="path-choices" class="choice-container"></div>
    </div>

    <div id="reward-screen" class="overlay">
        <h1>Victory!</h1>
        <div style="color:#aaa; margin-bottom:10px;">Choose a card to add to your deck:</div>
        <div id="reward-cards" class="choice-container" style="gap:10px;"></div>
        <button class="btn-main" style="background:#555; box-shadow:0 4px 0 #333; margin-top:30px;" onclick="nextFloor()">Skip</button>
    </div>

    <div id="event-screen" class="overlay">
        <h1>Mystery Room</h1>
        <div id="event-text" style="text-align:center; max-width:300px; margin-bottom:20px;"></div>
        <div id="event-opts" class="choice-container"></div>
    </div>

    <div id="rest-screen" class="overlay">
        <h1>Rest Site</h1>
        <div class="choice-container">
            <div class="choice-btn" onclick="restAction('heal')">
                <span class="choice-icon">‚ù§Ô∏è</span>
                <span class="choice-label">Rest</span>
                <small>Heal 30% HP</small>
            </div>
            <div class="choice-btn" onclick="restAction('smith')">
                <span class="choice-icon">üî•</span>
                <span class="choice-label">Smith</span>
                <small>Upgrade a Card</small>
            </div>
        </div>
    </div>

    <div id="smith-screen" class="overlay">
        <h2>Select Card to Upgrade</h2>
        <div id="smith-list" class="choice-container" style="flex-wrap:wrap;"></div>
    </div>

    <script>
        // --- GAME DATA ---
        const CARDS = {
            strike: { name: "Strike", type: "attack", cost: 1, val: 6, desc: "Deal !V! damage.", img: "üó°Ô∏è" },
            defend: { name: "Defend", type: "skill", cost: 1, val: 5, desc: "Gain !V! Block.", img: "üõ°Ô∏è" },
            bash:   { name: "Bash", type: "attack", cost: 2, val: 8, magic: 2, desc: "Deal !V! dmg.\nApply 2 Vuln.", img: "üî®" },
            pommel: { name: "Pommel", type: "attack", cost: 1, val: 9, magic: 1, desc: "Deal !V! dmg.\nDraw 1 card.", img: "ü§ú" },
            shrug:  { name: "Shrug It", type: "skill", cost: 1, val: 8, magic: 1, desc: "Gain !V! Block.\nDraw 1 card.", img: "ü§∑" },
            anger:  { name: "Anger", type: "attack", cost: 0, val: 6, desc: "Deal !V! dmg.\nAdd copy to discard.", img: "üò°" },
            blade:  { name: "Heavy Blade", type: "attack", cost: 2, val: 14, magic: 3, desc: "Deal !V! dmg.\nStr affects this 3x.", img: "üó°Ô∏è" },
            limit:  { name: "Limit Break", type: "skill", cost: 1, desc: "Double your Strength.", img: "üí™" },
            offer:  { name: "Offering", type: "skill", cost: 0, desc: "Lose 6 HP. Gain 2 Energy.\nDraw 3 cards.", img: "ü©∏" },
            pummel: { name: "Pummel", type: "attack", cost: 1, val: 2, magic: 4, desc: "Deal !V! dmg 4 times.", img: "ü•ä" },
            inflame:{ name: "Inflame", type: "power", cost: 1, val: 2, desc: "Gain !V! Strength.", img: "üî•" }
        };

        const ENEMIES = [
            { name: "Louse", hp: 14, intentPattern: ['atk','buff'], dmg: 6, img: "üêû", mirror: true },
            { name: "Cultist", hp: 50, intentPattern: ['buff','atk'], dmg: 6, img: "üê¶", mirror: false }, // Faces left natively
            { name: "Jaw Worm", hp: 44, intentPattern: ['atk','block','buff'], dmg: 12, img: "üêõ", mirror: true },
            { name: "Gremlin", hp: 25, intentPattern: ['atk','vuln'], dmg: 5, img: "üëπ", mirror: false },
            { name: "Slaver", hp: 48, intentPattern: ['atk','weak'], dmg: 13, img: "üë∫", mirror: false },
            { name: "Champ", hp: 160, intentPattern: ['buff','atk','atk','block'], dmg: 18, img: "üëë", mirror: false } // Boss
        ];

        const RELICS = [
            { id: 'blood', name: "Burning Blood", icon: "ü©∏", desc: "Heal 6 HP after combat." },
            { id: 'vajra', name: "Vajra", icon: "üíé", desc: "Start combat with 1 Strength." },
            { id: 'anchor', name: "Anchor", icon: "‚öì", desc: "Start combat with 10 Block." },
            { id: 'bag', name: "Bag of Prep", icon: "üéí", desc: "Draw 2 extra cards turn 1." }
        ];

        // --- STATE ---
        let game = {
            floor: 1, hp: 80, maxHp: 80, gold: 99,
            deck: [], relics: [],
            pathType: null // 'combat', 'elite', 'event'
        };

        let combat = {
            turn: 0, energy: 3, maxEnergy: 3,
            hand: [], discard: [], drawPile: [], exhaust: [],
            player: { block: 0, status: { str: 0, weak: 0, vuln: 0 } },
            enemy: { def: null, hp: 0, maxHp: 0, block: 0, intent: {}, status: { str: 0, weak: 0, vuln: 0 } }
        };

        // --- INIT ---
        function initGame() {
            game.deck = [
                { id: 'strike', up: false }, { id: 'strike', up: false }, { id: 'strike', up: false }, { id: 'strike', up: false }, { id: 'strike', up: false },
                { id: 'defend', up: false }, { id: 'defend', up: false }, { id: 'defend', up: false }, { id: 'defend', up: false },
                { id: 'bash', up: false }
            ];
            game.relics.push('blood'); // Starter relic
            renderRelics();
            showPathScreen();
            updateStats();
        }

        // --- MAP & PATHING ---
        function showPathScreen() {
            document.getElementById('path-screen').style.display = 'flex';
            const con = document.getElementById('path-choices');
            con.innerHTML = '';

            // Generate 2 random choices based on floor
            let opts = [];
            if(game.floor % 10 === 0) {
                opts = [{ type: 'boss', label: "The Boss", icon: "üëë" }];
            } else {
                let types = ['combat', 'combat', 'event', 'rest'];
                if(game.floor > 5) types.push('elite');
                
                // Pick 2 distinct options
                let t1 = types[Math.floor(Math.random()*types.length)];
                let t2 = types[Math.floor(Math.random()*types.length)];
                while(t1 === t2) t2 = types[Math.floor(Math.random()*types.length)];
                
                opts = [
                    { type: t1, label: getLabel(t1), icon: getIcon(t1) },
                    { type: t2, label: getLabel(t2), icon: getIcon(t2) }
                ];
            }

            opts.forEach(opt => {
                let btn = document.createElement('div');
                btn.className = 'choice-btn';
                btn.innerHTML = `<span class="choice-icon">${opt.icon}</span><span class="choice-label">${opt.label}</span>`;
                btn.onclick = () => {
                    document.getElementById('path-screen').style.display = 'none';
                    resolvePath(opt.type);
                };
                con.appendChild(btn);
            });
            
            document.getElementById('floor-val').innerText = game.floor;
        }

        function getLabel(t) { return t==='combat'?"Enemy":t==='elite'?"Elite":t==='event'?"Unknown":"Rest Site"; }
        function getIcon(t) { return t==='combat'?"‚öîÔ∏è":t==='elite'?"üíÄ":t==='event'?"?":"üî•"; }

        function resolvePath(type) {
            game.pathType = type;
            if(type === 'combat') startCombat(false);
            else if(type === 'elite') startCombat(true);
            else if(type === 'boss') startCombat(false, true);
            else if(type === 'rest') document.getElementById('rest-screen').style.display = 'flex';
            else if(type === 'event') triggerEvent();
        }

        // --- COMBAT ENGINE ---
        function startCombat(isElite, isBoss=false) {
            // Relic Triggers
            combat.player.status = { str: 0, weak: 0, vuln: 0 };
            if(hasRelic('vajra')) combat.player.status.str = 1;
            combat.player.block = hasRelic('anchor') ? 10 : 0;
            
            // Enemy Setup
            let pool = isBoss ? [ENEMIES[5]] : ENEMIES.slice(0, 5);
            let template = pool[Math.floor(Math.random() * pool.length)];
            
            // Stats
            combat.enemy.def = template;
            combat.enemy.maxHp = Math.floor(template.hp * (1 + (game.floor * 0.1))); // Scaling
            if(isElite) combat.enemy.maxHp = Math.floor(combat.enemy.maxHp * 1.5);
            combat.enemy.hp = combat.enemy.maxHp;
            combat.enemy.block = 0;
            combat.enemy.status = { str: 0, weak: 0, vuln: 0 };
            
            // Deck
            combat.drawPile = [...game.deck];
            shuffle(combat.drawPile);
            combat.discard = [];
            combat.hand = [];
            combat.turn = 0;

            // UI
            let sprite = document.getElementById('enemy-sprite');
            sprite.innerText = template.img;
            sprite.className = "sprite " + (template.mirror ? "mirror-face" : "");
            
            updateEnemyUI();
            startTurn();
        }

        function startTurn() {
            combat.turn++;
            combat.energy = combat.energy = 3;
            // Retain block logic omitted for simplicity, reset block
            if(combat.turn > 1) combat.player.block = 0; 
            
            // Enemy Intent
            decideEnemyIntent();

            // Draw
            let drawCount = 5;
            if(combat.turn === 1 && hasRelic('bag')) drawCount += 2;
            drawCards(drawCount);
            
            updateUI();
        }

        function drawCards(n) {
            for(let i=0; i<n; i++) {
                if(combat.drawPile.length === 0) {
                    if(combat.discard.length === 0) break;
                    combat.drawPile = [...combat.discard];
                    combat.discard = [];
                    shuffle(combat.drawPile);
                }
                combat.hand.push(combat.drawPile.pop());
            }
        }

        function playCard(index) {
            let cardData = combat.hand[index];
            let base = CARDS[cardData.id];
            
            if(combat.energy < base.cost) return shakeScreen(); // Not enough energy
            
            // Pay cost
            combat.energy -= base.cost;
            
            // Calc Values
            let up = cardData.up;
            let val = base.val + (up ? 3 : 0);
            let magic = (base.magic || 0) + (up ? 1 : 0);

            // Execute Effects
            if(cardData.id === 'offer') {
                game.hp -= 6;
                combat.energy += 2;
                drawCards(3);
                shakeScreen();
            }
            else if(cardData.id === 'limit') {
                combat.player.status.str *= 2;
                createFloater("DOUBLED!", "gold", 200, 300);
            }
            else if(base.type === 'attack') {
                let multiplier = 1;
                if(cardData.id === 'blade') multiplier = 3; // Heavy Blade scaling
                
                let dmg = val + (combat.player.status.str * multiplier);
                
                if(combat.player.status.weak > 0) dmg = Math.floor(dmg * 0.75);
                if(combat.enemy.status.vuln > 0) dmg = Math.floor(dmg * 1.5);

                let hits = cardData.id === 'pummel' ? 4 : 1;
                
                // Animation loop for multi-hits
                let hitInterval = setInterval(() => {
                    dealDamage(dmg);
                    hits--;
                    if(hits <= 0) clearInterval(hitInterval);
                }, 150);
                
                if(cardData.id === 'bash') applyStatus('enemy', 'vuln', 2);
                if(cardData.id === 'anger') combat.discard.push({id:'anger', up: up});
                if(cardData.id === 'pommel') drawCards(1);
            }
            else if(base.type === 'skill') {
                combat.player.block += val;
                if(cardData.id === 'shrug') drawCards(1);
            }
            else if(base.type === 'power') {
                if(cardData.id === 'inflame') combat.player.status.str += val;
            }

            // Clean up
            combat.discard.push(combat.hand.splice(index, 1)[0]);
            updateUI();
            checkWin();
        }

        function dealDamage(amt) {
            let blocked = Math.min(combat.enemy.block, amt);
            combat.enemy.block -= blocked;
            let hull = amt - blocked;
            
            if(hull > 0) {
                combat.enemy.hp -= hull;
                createFloater(hull, "#ff4d4d", window.innerWidth * 0.7, window.innerHeight * 0.4);
                document.getElementById('enemy-sprite').classList.add('shake-hit');
                setTimeout(()=>document.getElementById('enemy-sprite').classList.remove('shake-hit'), 300);
            } else {
                createFloater("Blocked", "#4da6ff", window.innerWidth * 0.7, window.innerHeight * 0.4);
            }
            updateEnemyUI();
        }

        function endTurn() {
            // Player discards hand
            combat.discard = [...combat.discard, ...combat.hand];
            combat.hand = [];
            updateUI(); // Clear hand visually

            // Enemy Phase
            setTimeout(resolveEnemy, 500);
        }

        function resolveEnemy() {
            let move = combat.enemy.intent;
            
            if(move.type === 'atk') {
                let dmg = move.val + combat.enemy.status.str;
                if(combat.enemy.status.weak > 0) dmg = Math.floor(dmg * 0.75);
                if(combat.player.status.vuln > 0) dmg = Math.floor(dmg * 1.5);
                
                let blocked = Math.min(combat.player.block, dmg);
                combat.player.block -= blocked;
                let hull = dmg - blocked;
                
                if(hull > 0) {
                    game.hp -= hull;
                    createFloater(hull, "red", 100, window.innerHeight - 200);
                    shakeScreen();
                } else {
                    createFloater("Blocked", "blue", 100, window.innerHeight - 200);
                }
            }
            else if(move.type === 'buff') combat.enemy.status.str += 2;
            else if(move.type === 'block') combat.enemy.block += 10;
            else if(move.type === 'vuln') combat.player.status.vuln += 2;
            else if(move.type === 'weak') combat.player.status.weak += 2;

            if(game.hp <= 0) {
                alert("You Died.");
                location.reload();
            } else {
                // Decay statuses
                ['vuln','weak'].forEach(s => {
                    if(combat.player.status[s]>0) combat.player.status[s]--;
                    if(combat.enemy.status[s]>0) combat.enemy.status[s]--;
                });
                startTurn();
            }
        }

        // --- ENEMY AI ---
        function decideEnemyIntent() {
            // Simple loop pattern based on enemy definition
            let opts = combat.enemy.def.intentPattern;
            let type = opts[combat.turn % opts.length];
            let dmg = combat.enemy.def.dmg + Math.floor(game.floor/2);

            if(type === 'atk') combat.enemy.intent = { type: 'atk', val: dmg, icon: "‚öîÔ∏è" };
            else if(type === 'buff') combat.enemy.intent = { type: 'buff', val: 0, icon: "üí™" };
            else if(type === 'vuln') combat.enemy.intent = { type: 'vuln', val: 0, icon: "üíî" };
            else if(type === 'weak') combat.enemy.intent = { type: 'weak', val: 0, icon: "üìâ" };
            else if(type === 'block') combat.enemy.intent = { type: 'block', val: 0, icon: "üõ°Ô∏è" };
        }

        // --- EVENTS & REWARDS ---
        function checkWin() {
            if(combat.enemy.hp <= 0) {
                if(hasRelic('blood')) game.hp = Math.min(game.maxHp, game.hp + 6);
                
                // Show Rewards
                let screen = document.getElementById('reward-screen');
                let con = document.getElementById('reward-cards');
                con.innerHTML = "";
                
                // 3 Random Cards
                let keys = Object.keys(CARDS);
                for(let i=0; i<3; i++) {
                    let k = keys[Math.floor(Math.random()*keys.length)];
                    let c = createCardHTML({id:k, up:false}, true);
                    c.onclick = () => {
                        game.deck.push({id:k, up:false});
                        nextFloor();
                    }
                    con.appendChild(c);
                }
                screen.style.display = 'flex';
            }
        }

        function triggerEvent() {
            // Simple random event
            let ev = document.getElementById('event-screen');
            let txt = document.getElementById('event-text');
            let opts = document.getElementById('event-opts');
            opts.innerHTML = "";
            ev.style.display = 'flex';

            let roll = Math.random();
            if(roll < 0.5) {
                txt.innerText = "You find a glowing shrine. Do you pray?";
                createEventBtn("Pray (Heal Full)", () => { game.hp = game.maxHp; nextFloor(); });
                createEventBtn("Desecrate (Gain Gold)", () => { game.gold += 50; nextFloor(); });
            } else {
                txt.innerText = "A merchant offers a random Relic for 50 Gold.";
                if(game.gold >= 50) {
                    createEventBtn("Buy Relic (-50g)", () => { 
                        game.gold -= 50; 
                        addRandomRelic(); 
                        nextFloor(); 
                    });
                }
                createEventBtn("Leave", () => nextFloor());
            }
        }

        function createEventBtn(txt, fn) {
            let b = document.createElement('div');
            b.className = 'choice-btn';
            b.innerText = txt;
            b.onclick = fn;
            document.getElementById('event-opts').appendChild(b);
        }

        function nextFloor() {
            document.querySelectorAll('.overlay').forEach(el => el.style.display = 'none');
            game.floor++;
            showPathScreen();
            updateStats();
        }

        function restAction(action) {
            if(action === 'heal') {
                game.hp = Math.min(game.maxHp, Math.floor(game.hp + (game.maxHp*0.3)));
                nextFloor();
            } else {
                // Smith
                document.getElementById('rest-screen').style.display = 'none';
                let s = document.getElementById('smith-screen');
                let l = document.getElementById('smith-list');
                l.innerHTML = "";
                game.deck.forEach(c => {
                    if(!c.up) {
                        let el = createCardHTML(c, true);
                        el.onclick = () => { c.up = true; nextFloor(); };
                        l.appendChild(el);
                    }
                });
                s.style.display = 'flex';
            }
        }

        // --- RENDERING & UTILS ---
        function updateUI() {
            updateStats();
            
            // Hand
            let area = document.getElementById('hand-area');
            area.innerHTML = "";
            combat.hand.forEach((c, i) => {
                let el = createCardHTML(c);
                el.onclick = () => playCard(i);
                // Fan rotation
                let rot = (i - (combat.hand.length-1)/2) * 5;
                let y = Math.abs(rot) * 2;
                el.style.transform = `rotate(${rot}deg) translateY(${y}px)`;
                
                if(combat.energy < CARDS[c.id].cost) el.style.filter = "grayscale(1) brightness(0.6)";
                
                area.appendChild(el);
            });

            updateEnemyUI();
        }

        function createCardHTML(data, simple=false) {
            let base = CARDS[data.id];
            let div = document.createElement('div');
            div.className = `card ${base.type} ${data.up?'upgraded':''}`;
            if(simple) div.style.transform = "none";
            
            let val = base.val + (data.up?3:0);
            let desc = base.desc.replace("!V!", `<span style="color:#ffd700">${val}</span>`);
            
            div.innerHTML = `
                <div class="card-cost">${base.cost}</div>
                <div class="card-art">${base.img}</div>
                <div class="card-title">${base.name}</div>
                <div class="card-desc">${desc}</div>
            `;
            return div;
        }

        function updateEnemyUI() {
            let e = combat.enemy;
            document.getElementById('enemy-hp-bar').style.width = (e.hp/e.maxHp*100) + "%";
            document.getElementById('enemy-hp-txt').innerText = `${e.hp}/${e.maxHp}`;
            document.getElementById('enemy-name').innerText = e.def.name;
            
            // Intent
            let move = e.intent;
            document.getElementById('enemy-intent-icon').innerText = move.icon || "";
            document.getElementById('enemy-intent-val').innerText = move.type === 'atk' ? (move.val + e.status.str) : "";
            
            // Block
            let b = document.getElementById('enemy-block');
            b.innerText = e.block;
            b.style.display = e.block > 0 ? 'block' : 'none';

            renderStatus('enemy-status', e.status);
            
            // Player Block
            let pb = document.getElementById('player-block');
            pb.innerText = combat.player.block;
            pb.style.display = combat.player.block > 0 ? 'block' : 'none';
            
            renderStatus('player-status', combat.player.status);
        }

        function renderStatus(id, s) {
            let el = document.getElementById(id);
            el.innerHTML = "";
            if(s.str > 0) el.innerHTML += `<div class="status-icon" style="color:var(--red)">üí™ ${s.str}</div>`;
            if(s.weak > 0) el.innerHTML += `<div class="status-icon" style="color:var(--gold)">üìâ ${s.weak}</div>`;
            if(s.vuln > 0) el.innerHTML += `<div class="status-icon" style="color:purple">üíî ${s.vuln}</div>`;
        }

        function updateStats() {
            document.getElementById('hp-val').innerText = `${game.hp}/${game.maxHp}`;
            document.getElementById('player-hp-bar').style.width = (game.hp/game.maxHp*100) + "%";
            document.getElementById('gold-val').innerText = game.gold;
        }

        function createFloater(txt, color, x, y) {
            let d = document.createElement('div');
            d.className = 'floater';
            d.innerText = txt;
            d.style.color = color;
            d.style.left = x + 'px';
            d.style.top = y + 'px';
            document.body.appendChild(d);
            setTimeout(() => d.remove(), 800);
        }

        function shakeScreen() {
            document.body.style.transform = "translate(5px, 5px)";
            setTimeout(() => document.body.style.transform = "translate(-5px, -5px)", 50);
            setTimeout(() => document.body.style.transform = "none", 100);
        }

        function addRandomRelic() {
            let unowned = RELICS.filter(r => !game.relics.includes(r.id));
            if(unowned.length > 0) {
                game.relics.push(unowned[Math.floor(Math.random()*unowned.length)].id);
                renderRelics();
            }
        }
        
        function hasRelic(id) { return game.relics.includes(id); }

        function renderRelics() {
            let bar = document.getElementById('relic-bar');
            bar.innerHTML = "";
            game.relics.forEach(rid => {
                let r = RELICS.find(x => x.id === rid);
                let el = document.createElement('div');
                el.className = 'relic-icon';
                el.innerText = r.icon;
                el.title = r.name + "\n" + r.desc;
                bar.appendChild(el);
            });
        }

        function applyStatus(target, type, amt) {
            if(target === 'enemy') combat.enemy.status[type] += amt;
            else combat.player.status[type] += amt;
        }

        function shuffle(a) { for(let i=a.length-1;i>0;i--){let j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];} }

        // Start
        initGame();

    </script>
</body>
</html>
