<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1.0, user-scalable=no"
/>
<title>⏱️ Turn Tracker</title>
<style>
  :root {
    --bg: #040608;
    --panel-soft: #171b24;
    --border-soft: #262a36;
    --text-main: #f7f7f7;
    --muted: #a0a8c0;
    --accent: #5ee0ff;
    --stat-color: #5ee0ff;
  }

  * {
    box-sizing: border-box;
  }

  html,
  body {
    margin: 0;
    padding: 0;
    height: 100%;
    background: radial-gradient(circle at top, #14182a 0, #050608 55%);
    color: var(--text-main);
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    -webkit-tap-highlight-color: transparent;
  }

  body {
    display: flex;
    justify-content: center;
  }

  .app {
    position: relative;
    width: 100%;
    max-width: 520px;
    height: 100vh;
    display: flex;
    flex-direction: column;
    padding: 12px 12px 22px;
  }

  /* TOP: TURN TRACKER + ROUND/TURN COUNTERS */

  #topBar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    height: 128px;
    flex-shrink: 0;
  }

  #roundInfo {
    flex: 1;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: flex-start;
    padding-left: 4px;
  }

  #roundText {
    font-size: 18px;
    font-weight: 600;
    color: var(--muted);
  }

  #turnCountText {
    margin-top: 2px;
    font-size: 15px;
    color: #6d738a;
  }

  #turnTracker {
    position: relative;
    width: 128px;
    height: 128px;
    border-radius: 50%;
    background: radial-gradient(circle at center, #181b27 0, #090b11 60%),
      radial-gradient(
        circle at 20% 20%,
        rgba(124, 255, 59, 0.16),
        transparent 55%
      );
    border: 1px solid var(--border-soft);
    box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.6), 0 14px 30px rgba(0, 0, 0, 0.9);
    flex-shrink: 0;
    cursor: pointer;
  }
  
  #turnTracker:active {
      transform: scale(0.98);
  }

  .turn-orb {
    position: absolute;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    opacity: 0.18;
    box-shadow: 0 0 5px rgba(0, 0, 0, 0.9);
    transition: opacity 0.16s ease, transform 0.16s ease,
      box-shadow 0.16s ease;
  }

  .orb0 { top: 16%; left: 50%; background: #f8f5e6; }
  .orb1 { top: 40%; left: 88%; background: #3aa3ff; }
  .orb2 { top: 84%; left: 68%; background: #1b1b24; }
  .orb3 { top: 84%; left: 32%; background: #ff5a40; }
  .orb4 { top: 40%; left: 12%; background: #2fd166; }
  .orb5 { top: 50%; left: 50%; background: #b38cff; }

  .turn-orb.active {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1.2);
    box-shadow: 0 0 8px rgba(255, 255, 255, 0.9),
      0 0 20px rgba(94, 224, 255, 0.8);
  }

  .turn-orb.disabled {
    opacity: 0.05;
    box-shadow: none;
  }

  #topRightTap {
    flex: 1;
    height: 100%;
  }

  #turnText {
    font-size: 16px;
    text-transform: uppercase;
    letter-spacing: 0.16em;
    color: var(--muted);
    padding: 8px 20px;
    border-radius: 999px;
    background: rgba(8, 10, 18, 0.9);
    border: 1px solid rgba(38, 42, 54, 0.9);
    align-self: center;
    margin-bottom: 20px;
    transition: border-color 0.3s ease;
  }

  /* MAIN: STATS BUTTON (Takes up remaining space) */

  #statsButton {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 0 0 20px 0;
  }

  #statsWrapper {
    width: 100%;
    height: 100%;
    max-height: 400px;
    border-radius: 24px;
    background: radial-gradient(
        circle at 20% 0,
        rgba(94, 224, 255, 0.18) 0,
        transparent 55%
      ),
      radial-gradient(circle at top, #141826 0, #05070c 60%);
    border: 1px solid var(--border-soft);
    box-shadow: 0 0 0 1px rgba(94, 224, 255, 0.05),
      0 20px 35px rgba(0, 0, 0, 0.85);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    cursor: pointer;
    transition: transform 0.1s ease;
  }

  #statsWrapper:active {
    transform: scale(0.98);
  }

  #statsLabel {
    font-size: 14px;
    font-weight: 600;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.2em;
    margin-bottom: 12px;
  }

  #avgTimeDisplay {
    font-size: 42px;
    font-weight: 800;
    color: var(--text-main);
    letter-spacing: 0.05em;
    text-shadow: 0 0 20px rgba(94, 224, 255, 0.3);
  }
  
  #statsHint {
      margin-top: 12px;
      font-size: 12px;
      color: var(--muted);
      opacity: 0.6;
  }

  /* PLAYER CONFIG */

  #playerConfig {
    position: fixed;
    inset: 0;
    background: rgba(1, 2, 5, 0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 20;
  }

  #playerConfig.open {
    display: flex;
  }

  .config-inner {
    width: 100%;
    max-width: 420px;
    border-radius: 16px;
    background: #090b11;
    border: 1px solid var(--border-soft);
    box-shadow: 0 18px 35px rgba(0, 0, 0, 0.9);
    padding: 10px 14px 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .config-header {
    font-size: 15px;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--muted);
  }

  .player-count-row {
    display: flex;
    gap: 6px;
    margin: 4px 0;
  }

  .count-btn {
    flex: 1;
    padding: 6px 0;
    border-radius: 999px;
    border: 1px solid var(--border-soft);
    background: #121421;
    color: var(--muted);
    font-size: 14px;
  }

  .count-btn.active {
    border-color: var(--accent);
    color: var(--text-main);
    background: radial-gradient(circle at top, #22273b 0, #121421 80%);
  }

  #nameFields {
    margin-top: 4px;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .name-row {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .name-row label {
    min-width: 64px;
    font-size: 13px;
    color: var(--muted);
  }

  .name-row input {
    flex: 1;
    padding: 8px 10px;
    border-radius: 8px;
    border: 1px solid var(--border-soft);
    background: #11141f;
    color: var(--text-main);
    font-size: 14px;
  }

  .config-footer {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-top: 6px;
  }

  .config-btn {
    padding: 8px 16px;
    border-radius: 999px;
    font-size: 14px;
    border: 1px solid var(--border-soft);
    background: #141722;
    color: var(--muted);
  }

  #configSave {
    border-color: var(--accent);
    color: var(--text-main);
    background: radial-gradient(circle at top, #22273b 0, #11131f 80%);
  }
  
  /* STATS PANEL */

  #statsPanel {
    position: fixed;
    inset: 0;
    background: rgba(1, 2, 5, 0.95);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 30;
  }

  #statsPanel.open {
    display: flex;
  }

  .stats-inner {
    width: 100%;
    max-width: 480px;
    max-height: 85vh;
    border-radius: 16px;
    background: #090b11;
    border: 1px solid var(--border-soft);
    box-shadow: 0 18px 35px rgba(0, 0, 0, 0.9);
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    overflow-y: auto;
  }

  .stats-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .stats-title {
    font-size: 18px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--stat-color);
  }

  .stats-close {
    border: none;
    background: transparent;
    color: var(--muted);
    font-size: 24px;
    padding: 0 8px;
  }

  .stats-section-title {
    font-size: 13px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--muted);
    border-bottom: 1px solid var(--border-soft);
    padding-bottom: 6px;
    margin-top: 14px;
  }

  #statsSummary, #turnDistribution {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .stat-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    border-bottom: 1px dashed #1d202e;
    font-size: 15px;
  }

  .stat-label {
    color: var(--muted);
  }

  .stat-value {
    color: var(--text-main);
    font-weight: 600;
  }

  /* Bar Chart for Distribution */

  .distribution-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 6px 0;
  }

  .player-name-short {
    width: 60px;
    flex-shrink: 0;
    font-size: 13px;
    color: var(--muted);
    text-overflow: ellipsis;
    overflow: hidden;
    white-space: nowrap;
    text-align: right;
  }

  .bar-container {
    flex-grow: 1;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .time-bar {
    height: 14px;
    background: var(--stat-color);
    border-radius: 4px;
    transition: width 0.5s ease-out;
    box-shadow: 0 0 5px rgba(94, 224, 255, 0.4);
  }

  .bar-time {
    font-size: 13px;
    color: var(--text-main);
    font-weight: 500;
    min-width: 40px;
    text-align: left;
  }
  
  /* Log Viewer */
  #turnLogList {
    max-height: 200px;
    overflow-y: auto;
    border-radius: 8px;
    background: #10121a;
    padding: 10px;
    border: 1px solid var(--border-soft);
  }

  .log-entry {
    font-size: 13px;
    padding: 4px 0;
    border-bottom: 1px dotted #232736;
    color: var(--muted);
  }
  
  .log-entry:last-child {
      border-bottom: none;
  }

  .log-entry strong {
      color: #e0e6f5;
  }
</style>
</head>
<body>
<div class="app">
  <header id="topBar">
    <div id="roundInfo">
      <div id="roundText">Round 1</div>
      <div id="turnCountText">Turn 1</div>
    </div>
    <div id="turnTracker">
      <div class="turn-orb orb0" data-index="0"></div>
      <div class="turn-orb orb1" data-index="1"></div>
      <div class="turn-orb orb2" data-index="2"></div>
      <div class="turn-orb orb3" data-index="3"></div>
      <div class="turn-orb orb4" data-index="4"></div>
      <div class="turn-orb orb5" data-index="5"></div>
    </div>
    <div id="topRightTap"></div>
  </header>

  <div id="turnText">Player 1</div>

  <main id="statsButton">
    <div id="statsWrapper">
      <div id="statsLabel">Average Turn Time</div>
      <div id="avgTimeDisplay">--:--</div>
      <div id="statsHint">Tap for details</div>
    </div>
  </main>
</div>

<div id="playerConfig">
  <div class="config-inner">
    <div class="config-header">Players & Names</div>
    <div class="player-count-row">
      <button class="count-btn" data-count="1">1</button>
      <button class="count-btn" data-count="2">2</button>
      <button class="count-btn" data-count="3">3</button>
      <button class="count-btn" data-count="4">4</button>
      <button class="count-btn" data-count="5">5</button>
      <button class="count-btn" data-count="6">6</button>
    </div>
    <div id="nameFields">
      <div class="name-row" data-index="0">
        <label>Player 1</label>
        <input id="nameInput0" type="text" placeholder="Player 1" />
      </div>
      <div class="name-row" data-index="1">
        <label>Player 2</label>
        <input id="nameInput1" type="text" placeholder="Player 2" />
      </div>
      <div class="name-row" data-index="2">
        <label>Player 3</label>
        <input id="nameInput2" type="text" placeholder="Player 3" />
      </div>
      <div class="name-row" data-index="3">
        <label>Player 4</label>
        <input id="nameInput3" type="text" placeholder="Player 4" />
      </div>
      <div class="name-row" data-index="4">
        <label>Player 5</label>
        <input id="nameInput4" type="text" placeholder="Player 5" />
      </div>
      <div class="name-row" data-index="5">
        <label>Player 6</label>
        <input id="nameInput5" type="text" placeholder="Player 6" />
      </div>
    </div>
    <div class="config-footer">
      <button id="configCancel" class="config-btn">Cancel</button>
      <button id="configSave" class="config-btn">Save</button>
    </div>
  </div>
</div>

<div id="statsPanel">
  <div class="stats-inner">
    <div class="stats-header">
      <div class="stats-title">Game Statistics</div>
      <button class="stats-close" id="statsCloseBtn">✕</button>
    </div>

    <div class="stats-section-title">Summary</div>
    <div id="statsSummary">
      <div class="stat-item">
        <span class="stat-label">Total Turns</span>
        <span class="stat-value" id="statTotalTurns">0</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Game Duration</span>
        <span class="stat-value" id="statTotalDuration">00:00</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Overall Avg Turn</span>
        <span class="stat-value" id="statOverallAvg">--:--</span>
      </div>
      <div class="stat-item">
        <span class="stat-label">Longest Turn</span>
        <span class="stat-value" id="statLongestTurn">--:--</span>
      </div>
    </div>
    
    <div class="stats-section-title">Avg Turn Time by Player</div>
    <div id="turnDistribution">
      </div>
    
    <div class="stats-section-title">Turn Log</div>
    <div id="turnLogList">
        <div class="log-entry">Log empty. Complete a few turns to see data.</div>
    </div>
  </div>
</div>

<script>
  // --- STATE VARIABLES ---
  
  let numPlayers = 4;
  let currentPlayer = 0;
  let players = [];
  
  // Turn tracking and timing
  let roundNumber = 1;
  let turnTotal = 1;
  let currentTurnStartTime = Date.now();
  let gameStartTime = Date.now();
  
  /**
   * turnLog: array of objects representing a COMPLETED turn.
   * { round: number, turn: number, playerIndex: number, durationMs: number }
   */
  let turnLog = [];
  
  // --- DOM ELEMENTS ---
  
  const turnText = document.getElementById("turnText");
  const turnOrbs = Array.from(document.querySelectorAll(".turn-orb"));
  const roundInfo = document.getElementById("roundInfo");
  const roundTextEl = document.getElementById("roundText");
  const turnCountTextEl = document.getElementById("turnCountText");
  const turnTracker = document.getElementById("turnTracker");
  const topRightTap = document.getElementById("topRightTap");

  // Stats Elements
  const statsWrapper = document.getElementById("statsWrapper");
  const avgTimeDisplay = document.getElementById("avgTimeDisplay");
  const statsPanel = document.getElementById("statsPanel");
  const statsCloseBtn = document.getElementById("statsCloseBtn");
  const statTotalTurnsEl = document.getElementById("statTotalTurns");
  const statTotalDurationEl = document.getElementById("statTotalDuration");
  const statOverallAvgEl = document.getElementById("statOverallAvg");
  const statLongestTurnEl = document.getElementById("statLongestTurn");
  const turnDistributionEl = document.getElementById("turnDistribution");
  const turnLogListEl = document.getElementById("turnLogList");
  
  const playerColors = [
    '#f8f5e6', // white
    '#3aa3ff', // blue
    '#1b1b24', // black
    '#ff5a40', // red
    '#2fd166', // green
    '#b38cff'  // purple
  ];
  
  const playerConfig = document.getElementById("playerConfig");
  const countButtons = Array.from(document.querySelectorAll(".count-btn"));
  const nameRows = Array.from(document.querySelectorAll(".name-row"));
  const nameInputs = Array.from(document.querySelectorAll("#nameFields input"));
  const configCancel = document.getElementById("configCancel");
  const configSave = document.getElementById("configSave");
  let configSelectedCount = 4;
  
  // --- UTILITY FUNCTIONS ---
  
  function defaultName(index) {
    return `Player ${index + 1}`;
  }
  
  function formatTime(ms) {
    if (ms == null) return '--:--';
    const totalSeconds = Math.round(ms / 1000);
    const minutes = Math.floor(totalSeconds / 60);
    const seconds = totalSeconds % 60;
    return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  }
  
  function getPlayerColor(index) {
    if (index == null || index < 0 || index >= playerColors.length) {
      return null;
    }
    return playerColors[index];
  }
  
  // --- RENDER FUNCTIONS ---
  
  function updateTurnDisplay() {
    const p = players[currentPlayer];
    const name = p && p.name ? p.name : defaultName(currentPlayer);
    turnText.textContent = name;
  }
  
  function updateTurnOrbs() {
    turnOrbs.forEach((orb, idx) => {
      orb.classList.remove("active", "disabled");
      if (idx >= numPlayers) orb.classList.add("disabled");
      if (idx === currentPlayer) orb.classList.add("active");
    });
    // Set color indicator for the current player
    const orb = turnOrbs[currentPlayer];
    if (orb) {
      turnText.style.borderColor = orb.style.background;
    }
  }
  
  function updateRoundTurnDisplay() {
    roundTextEl.textContent = `Round ${roundNumber}`;
    turnCountTextEl.textContent = `Turn ${turnTotal}`;
  }
  
  // --- STATS LOGIC ---
  
  function calculateAndDisplayStats() {
    const completedTurns = turnLog.length;
    statTotalTurnsEl.textContent = completedTurns;
    
    // Total Game Duration
    const gameDuration = Date.now() - gameStartTime;
    statTotalDurationEl.textContent = formatTime(gameDuration);
    
    if (completedTurns === 0) {
      avgTimeDisplay.textContent = statOverallAvgEl.textContent = '--:--';
      statLongestTurnEl.textContent = '--:--';
      turnDistributionEl.innerHTML = '<div style="color:var(--muted); font-size:13px;">No data yet.</div>';
      turnLogListEl.innerHTML = '<div class="log-entry">Log empty. Complete a few turns to see data.</div>';
      return;
    }
    
    // 1. Calculate Summary Stats
    const totalTurnDuration = turnLog.reduce((sum, log) => sum + log.durationMs, 0);
    const overallAvgTime = totalTurnDuration / completedTurns;
    let longestTurnTime = 0;
    
    turnLog.forEach(log => {
      if (log.durationMs > longestTurnTime) {
        longestTurnTime = log.durationMs;
      }
    });
    
    avgTimeDisplay.textContent = formatTime(overallAvgTime);
    statOverallAvgEl.textContent = formatTime(overallAvgTime);
    statLongestTurnEl.textContent = formatTime(longestTurnTime);

    // 2. Calculate Player-Specific Stats
    const playerStats = players.map((p, index) => ({
      name: p.name || defaultName(index),
      index: index,
      totalDuration: 0,
      turnCount: 0,
      color: getPlayerColor(index) || 'gray'
    }));
    
    turnLog.forEach(log => {
      const stat = playerStats[log.playerIndex];
      if (stat) {
        stat.totalDuration += log.durationMs;
        stat.turnCount += 1;
      }
    });

    let maxPlayerTime = 0;
    playerStats.forEach(stat => {
        if (stat.turnCount > 0) {
            stat.avgTimeMs = stat.totalDuration / stat.turnCount;
            if (stat.avgTimeMs > maxPlayerTime) {
                maxPlayerTime = stat.avgTimeMs;
            }
        } else {
            stat.avgTimeMs = 0;
        }
    });

    // 3. Render Distribution Bar Chart
    turnDistributionEl.innerHTML = '';
    
    playerStats.forEach(stat => {
        if (stat.turnCount === 0) return;

        const row = document.createElement('div');
        row.className = 'distribution-row';

        const nameEl = document.createElement('div');
        nameEl.className = 'player-name-short';
        nameEl.textContent = stat.name;
        
        const barContainer = document.createElement('div');
        barContainer.className = 'bar-container';

        const barEl = document.createElement('div');
        barEl.className = 'time-bar';
        
        const barWidth = maxPlayerTime > 0 ? (stat.avgTimeMs / maxPlayerTime) * 100 : 0;
        barEl.style.width = `${Math.max(2, barWidth)}%`; 
        barEl.style.background = stat.color;

        const timeEl = document.createElement('div');
        timeEl.className = 'bar-time';
        timeEl.textContent = formatTime(stat.avgTimeMs);
        
        barContainer.appendChild(barEl);
        barContainer.appendChild(timeEl);
        
        row.appendChild(nameEl);
        row.appendChild(barContainer);
        turnDistributionEl.appendChild(row);
    });
    
    // 4. Render Turn Log
    turnLogListEl.innerHTML = '';
    // Show last 50 turns
    turnLog.slice(-50).reverse().forEach((log, index) => { 
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        const playerName = players[log.playerIndex].name || defaultName(log.playerIndex);
        entry.innerHTML = `Round ${log.round}, Turn ${log.turn}: <strong>${playerName}</strong> took <strong>${formatTime(log.durationMs)}</strong>.`;
        turnLogListEl.appendChild(entry);
    });
  }

  function openStatsPanel() {
    calculateAndDisplayStats();
    statsPanel.classList.add("open");
  }

  function closeStatsPanel() {
    statsPanel.classList.remove("open");
  }

  // --- TURN NAVIGATION ---

  function nextTurn() {
    if (numPlayers <= 0) return;
    
    // 1. Log the COMPLETED turn
    const turnEndTime = Date.now();
    const durationMs = turnEndTime - currentTurnStartTime;

    turnLog.push({
        round: roundNumber,
        turn: turnTotal,
        playerIndex: currentPlayer,
        durationMs: durationMs
    });
    
    // 2. Advance state
    currentPlayer++;
    if (currentPlayer >= numPlayers) {
      currentPlayer = 0;
      roundNumber++;
    }
    turnTotal++;

    // 3. Reset Timer
    currentTurnStartTime = Date.now();
    
    // 4. Update display
    updateTurnOrbs();
    updateTurnDisplay();
    updateRoundTurnDisplay();
    calculateAndDisplayStats();
  }

  function previousTurn() {
    if (turnLog.length === 0) return; // Cannot undo before game start
    
    // 1. Get the last completed turn
    const lastTurn = turnLog.pop();

    // 2. Restore game state to what it was
    turnTotal = lastTurn.turn;
    roundNumber = lastTurn.round;
    currentPlayer = lastTurn.playerIndex;

    // 3. SMART RESTORE TIMER
    // Instead of resetting the timer to 0, we subtract the time they 
    // already spent from the current time. This makes the timer act
    // as if it has been running since the start of that original turn.
    currentTurnStartTime = Date.now() - lastTurn.durationMs;
    
    // 4. Update display
    updateTurnOrbs();
    updateTurnDisplay();
    updateRoundTurnDisplay();
    calculateAndDisplayStats();
  }
  
  // --- CONFIG FUNCTIONS ---
  
  function initPlayers(count) {
    numPlayers = Math.min(Math.max(count, 1), 6);
    const newPlayers = [];
    for (let i = 0; i < numPlayers; i++) {
      const existing = players[i];
      newPlayers.push({
        name: existing ? existing.name : defaultName(i)
      });
    }
    players = newPlayers;
    if (currentPlayer >= numPlayers) currentPlayer = numPlayers - 1;
    updateTurnDisplay();
    updateTurnOrbs();
    calculateAndDisplayStats();
  }

  function setConfigCount(count) {
    configSelectedCount = count;
    countButtons.forEach(btn => {
      const c = parseInt(btn.getAttribute("data-count"), 10);
      btn.classList.toggle("active", c === count);
    });
    nameRows.forEach((row, idx) => {
      row.style.display = idx < count ? "flex" : "none";
    });
  }

  function openPlayerConfig() {
    setConfigCount(numPlayers);
    for (let i = 0; i < 6; i++) {
      const p = players[i];
      nameInputs[i].value = p && p.name ? p.name : defaultName(i);
    }
    playerConfig.classList.add("open");
  }

  function closePlayerConfig() {
    playerConfig.classList.remove("open");
  }

  // --- EVENT LISTENERS ---
  
  turnTracker.addEventListener("pointerdown", nextTurn);
  topRightTap.addEventListener("pointerdown", nextTurn);
  roundInfo.addEventListener("pointerdown", previousTurn);
  turnText.addEventListener("pointerdown", openPlayerConfig);
  
  statsWrapper.addEventListener("pointerdown", openStatsPanel);
  statsCloseBtn.addEventListener("pointerdown", closeStatsPanel);
  statsPanel.addEventListener("click", e => {
      if (e.target === statsPanel) closeStatsPanel();
  });

  countButtons.forEach(btn => {
    btn.addEventListener("pointerdown", () => {
      const count = parseInt(btn.getAttribute("data-count"), 10);
      setConfigCount(count);
    });
  });

  configCancel.addEventListener("pointerdown", closePlayerConfig);

  configSave.addEventListener("pointerdown", () => {
    const newPlayers = [];
    for (let i = 0; i < configSelectedCount; i++) {
      const rawName = nameInputs[i].value.trim();
      newPlayers.push({
        name: rawName || defaultName(i)
      });
    }
    players = newPlayers;
    numPlayers = configSelectedCount;
    // Reset game on config save
    if (currentPlayer >= numPlayers) currentPlayer = 0;
    roundNumber = 1;
    turnTotal = 1;
    turnLog = [];
    currentTurnStartTime = Date.now();
    gameStartTime = Date.now();
    
    updateTurnOrbs();
    updateTurnDisplay();
    updateRoundTurnDisplay();
    calculateAndDisplayStats();
    closePlayerConfig();
  });
  
  // --- INIT ---

  for (let i = 0; i < 4; i++) {
    players.push({ name: defaultName(i) });
  }
  initPlayers(4);
</script>
</body>
</html>
