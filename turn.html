<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
<title>Turn Tracker Pro</title>
<style>
  :root {
    --bg: #040608;
    --panel: #0e111a;
    --border: #262a36;
    --text: #e0e6f5;
    --muted: #757b93;
    --accent: #5ee0ff;
    --accent-glow: rgba(94, 224, 255, 0.5);
    --paused: #ffaf40;
  }

  * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  html, body {
    margin: 0; padding: 0;
    height: 100%;
    background: radial-gradient(circle at top, #14182a 0, #050608 60%);
    color: var(--text);
    font-family: system-ui, -apple-system, sans-serif;
    overflow: hidden;
    user-select: none;
  }

  body { display: flex; justify-content: center; }

  .app {
    position: relative;
    width: 100%;
    max-width: 500px;
    height: 100vh;
    display: flex;
    flex-direction: column;
    padding: 20px;
    z-index: 1;
  }

  /* TOP BAR */
  #topBar {
    display: flex; align-items: center; justify-content: space-between;
    height: 130px; flex-shrink: 0;
  }

  #roundInfo {
    flex: 1; display: flex; flex-direction: column; justify-content: center;
    cursor: pointer; padding: 10px 0;
  }
  #roundText { font-size: 20px; font-weight: 700; color: var(--muted); }
  #turnCountText { font-size: 14px; color: #555b70; margin-top: 4px; }

  /* PENTAGRAM */
  #turnTracker {
    position: relative; width: 110px; height: 110px; border-radius: 50%;
    background: radial-gradient(circle, #1a1e2e 0%, #050608 70%);
    border: 1px solid var(--border);
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
    flex-shrink: 0; cursor: pointer; transition: transform 0.1s;
  }
  #turnTracker:active { transform: scale(0.96); }

  .turn-orb {
    position: absolute; width: 16px; height: 16px; border-radius: 50%;
    transform: translate(-50%, -50%); opacity: 0.2;
    transition: 0.3s; box-shadow: 0 0 10px rgba(0,0,0,0.8);
  }
  .orb0 { top: 16%; left: 50%; background: #f8f5e6; }
  .orb1 { top: 40%; left: 88%; background: #3aa3ff; }
  .orb2 { top: 84%; left: 68%; background: #94a3b8; } 
  .orb3 { top: 84%; left: 32%; background: #ff5a40; }
  .orb4 { top: 40%; left: 12%; background: #2fd166; }
  .orb5 { top: 50%; left: 50%; background: #b38cff; }
  
  .turn-orb.active { opacity: 1; transform: translate(-50%, -50%) scale(1.4); z-index: 2; box-shadow: 0 0 15px currentColor; }
  .turn-orb.disabled { opacity: 0; }

  #topRightTap { flex: 1; height: 100%; }

  /* PLAYER NAME */
  #turnText {
    font-size: 18px; text-transform: uppercase; letter-spacing: 0.2em;
    color: var(--muted); padding: 15px; text-align: center;
    margin-bottom: 10px; transition: color 0.3s;
    border: 1px solid transparent; border-radius: 999px;
    text-shadow: 0 2px 4px rgba(0,0,0,0.9);
  }
  #turnText:active { background: rgba(255,255,255,0.05); border-color: var(--border); }

  /* TIMER BTN */
  #mainControl { flex: 1; display: flex; justify-content: center; align-items: flex-start; }

  #timerBtn {
    width: 100%; max-height: 340px; aspect-ratio: 1 / 0.85;
    border-radius: 30px;
    background: linear-gradient(180deg, rgba(94, 224, 255, 0.05) 0%, rgba(0,0,0,0) 100%);
    border: 1px solid var(--border);
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    position: relative; overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  }
  #timerBtn:active { transform: scale(0.99); background: rgba(255,255,255,0.03); }

  #timerLabel { font-size: 13px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.2em; color: var(--muted); margin-bottom: 8px; }
  #timerDisplay { font-size: 56px; font-weight: 800; color: var(--text); font-variant-numeric: tabular-nums; text-shadow: 0 0 30px var(--accent-glow); z-index: 2; }
  #timerSubtext { margin-top: 8px; font-size: 13px; color: #4a5060; }

  /* PAUSED STATE */
  body.is-paused #timerBtn { border-color: var(--paused); box-shadow: 0 0 20px rgba(255, 175, 64, 0.15); }
  body.is-paused #timerDisplay { color: var(--paused); text-shadow: none; opacity: 0.8; }
  body.is-paused #timerLabel { color: var(--paused); }
  #pauseOverlayIcon { position: absolute; font-size: 100px; opacity: 0; color: var(--paused); pointer-events: none; z-index: 1; }
  body.is-paused #pauseOverlayIcon { opacity: 0.1; }

  /* FOOTER */
  #footerBar { height: 70px; display: flex; justify-content: center; gap: 20px; margin-top: auto; align-items: center; }
  .icon-btn {
    width: 50px; height: 50px; border-radius: 50%; border: 1px solid var(--border);
    background: #0e111a; color: var(--muted); font-size: 20px;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
    z-index: 10;
  }
  .icon-btn:active { transform: scale(0.9); border-color: var(--accent); color: var(--text); }

  /* OVERLAYS */
  .overlay {
    position: fixed; inset: 0; background: rgba(0, 0, 0, 0.9);
    backdrop-filter: blur(5px);
    display: none; align-items: center; justify-content: center;
    z-index: 9999; opacity: 0; transition: opacity 0.2s;
  }
  .overlay.open { display: flex; opacity: 1; }

  .panel {
    width: 90%; max-width: 400px; max-height: 85vh;
    background: #0b0d14; border: 1px solid var(--border); border-radius: 20px;
    padding: 20px; display: flex; flex-direction: column; gap: 15px;
    box-shadow: 0 20px 60px #000; overflow-y: auto;
  }

  .panel-header {
    display: flex; justify-content: space-between; align-items: center;
    font-size: 16px; font-weight: 700; text-transform: uppercase; color: var(--muted);
    border-bottom: 1px solid var(--border); padding-bottom: 10px;
  }
  .close-btn { background: none; border: none; color: var(--text); font-size: 24px; padding: 5px 10px; cursor: pointer; }

  /* CONFIG UI */
  .row-group { display: flex; gap: 5px; }
  .toggle-btn {
    flex: 1; padding: 12px; background: #161924; border: 1px solid var(--border);
    color: var(--muted); border-radius: 8px; font-size: 14px; cursor: pointer;
  }
  .toggle-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(94, 224, 255, 0.1); }
  
  .name-row { margin-bottom: 8px; }
  .name-row input {
    width: 100%; padding: 12px; background: #1a1d29; border: 1px solid var(--border);
    border-radius: 8px; color: #fff; font-size: 16px; outline: none;
  }
  .name-row input:focus { border-color: var(--accent); }

  #resetGameBtn {
    margin-top: 10px; padding: 15px; background: #2a1414; border: 1px solid #4a2020;
    color: #ff5a5a; border-radius: 8px; font-weight: 700; cursor: pointer;
  }

  /* STATS UI */
  .stat-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #222; font-size: 14px; }
  .stat-val { font-weight: 700; color: var(--text); }
  
  .chart-row { display: flex; align-items: center; gap: 10px; margin: 8px 0; }
  .chart-label { width: 70px; font-size: 12px; text-align: right; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .chart-bar-bg { flex: 1; height: 8px; background: #161924; border-radius: 5px; overflow: hidden; }
  .chart-bar-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.5s; }
  .chart-time { width: 45px; font-size: 12px; text-align: right; color: #fff; }

  .log-container {
    margin-top: 15px; max-height: 150px; overflow-y: auto;
    background: #08090e; border: 1px solid var(--border); border-radius: 8px; padding: 10px;
  }
  .log-entry { font-size: 12px; color: var(--muted); margin-bottom: 4px; border-bottom: 1px dotted #222; padding-bottom: 2px; }
</style>
</head>
<body>

<div class="app">
  <header id="topBar">
    <div id="roundInfo">
      <div id="roundText">Round 1</div>
      <div id="turnCountText">Turn 1</div>
    </div>
    
    <div id="turnTracker">
      <div class="turn-orb orb0" data-index="0"></div>
      <div class="turn-orb orb1" data-index="1"></div>
      <div class="turn-orb orb2" data-index="2"></div>
      <div class="turn-orb orb3" data-index="3"></div>
      <div class="turn-orb orb4" data-index="4"></div>
      <div class="turn-orb orb5" data-index="5"></div>
    </div>
    
    <div id="topRightTap"></div>
  </header>

  <div id="turnText">Player 1</div>

  <main id="mainControl">
    <div id="timerBtn">
      <div id="pauseOverlayIcon">‚è∏</div>
      <div id="timerLabel">Current Turn</div>
      <div id="timerDisplay">00:00</div>
      <div id="timerSubtext">Tap to Pause / Resume</div>
    </div>
  </main>

  <footer id="footerBar">
    <button class="icon-btn" id="btnStats">üìä</button>
    <button class="icon-btn" id="btnConfig">‚öôÔ∏è</button>
  </footer>
</div>

<div id="statsOverlay" class="overlay">
  <div class="panel">
    <div class="panel-header">
      <span>Game Stats</span>
      <button class="close-btn" onclick="closeOverlays()">‚úï</button>
    </div>
    
    <div id="statsSummary">
      <div class="stat-row"><span style="color:var(--muted)">Total Time</span> <span class="stat-val" id="stTotalTime">00:00</span></div>
      <div class="stat-row"><span style="color:var(--muted)">Total Turns</span> <span class="stat-val" id="stTotalTurns">0</span></div>
      <div class="stat-row"><span style="color:var(--muted)">Longest Turn</span> <span class="stat-val" id="stLongest">--:--</span></div>
      <div class="stat-row"><span style="color:var(--muted)">Avg Turn</span> <span class="stat-val" id="stAvg">--:--</span></div>
    </div>

    <div style="margin-top:15px; font-size:12px; text-transform:uppercase; color:var(--muted); font-weight:700;">Average Time / Player</div>
    <div id="distChart"></div>

    <div class="log-container" id="turnLog"></div>
  </div>
</div>

<div id="configOverlay" class="overlay">
  <div class="panel">
    <div class="panel-header">
      <span>Setup</span>
      <button class="close-btn" onclick="closeOverlays()">‚úï</button>
    </div>

    <div style="font-size:13px; color:var(--muted); margin-bottom:5px;">PLAYER COUNT</div>
    <div class="row-group" id="countGroup">
      <button class="toggle-btn" data-n="2">2</button>
      <button class="toggle-btn" data-n="3">3</button>
      <button class="toggle-btn active" data-n="4">4</button>
      <button class="toggle-btn" data-n="5">5</button>
      <button class="toggle-btn" data-n="6">6</button>
    </div>

    <div style="font-size:13px; color:var(--muted); margin:15px 0 5px;">PLAYER NAMES</div>
    <div id="nameInputs"></div>

    <button class="toggle-btn" onclick="closeOverlays()" style="margin-top:10px; border-color:var(--accent); color:var(--accent); font-weight:700;">Save & Close</button>
    
    <hr style="border:0; border-top:1px dashed var(--border); width:100%; margin:15px 0;">
    <button id="resetGameBtn">‚ö†Ô∏è Reset Game Data</button>
  </div>
</div>

<script>
window.addEventListener('DOMContentLoaded', () => {

  // --- VARIABLES ---
  const STORAGE_KEY = 'turnTracker_v1';
  
  let numPlayers = 4;
  let currentPlayer = 0; 
  let round = 1;
  let turnCount = 1;
  let players = ["Player 1", "Player 2", "Player 3", "Player 4", "Player 5", "Player 6"];

  let turnStartTime = 0;
  let pauseStartTime = 0;
  let totalPausedTime = 0; 
  let isPaused = false;
  let timerInterval = null;

  let logs = []; 
  let gameStartTime = Date.now();

  const colors = ['#f8f5e6', '#3aa3ff', '#94a3b8', '#ff5a40', '#2fd166', '#b38cff'];

  // --- ELEMENTS ---
  const ui = {
    round: document.getElementById('roundText'),
    turnCount: document.getElementById('turnCountText'),
    turnText: document.getElementById('turnText'),
    orbs: document.querySelectorAll('.turn-orb'),
    timer: document.getElementById('timerDisplay'),
    timerBtn: document.getElementById('timerBtn'),
    distChart: document.getElementById('distChart'),
    turnLog: document.getElementById('turnLog'),
    nameInputs: document.getElementById('nameInputs'),
    overlays: {
      stats: document.getElementById('statsOverlay'),
      config: document.getElementById('configOverlay')
    }
  };

  // --- INITIALIZATION ---
  function init() {
    if(!loadState()) {
      // New Game
      turnStartTime = Date.now();
      gameStartTime = Date.now();
    }
    startTimer();
    renderNamesConfig();
    updateUI();
  }

  // --- SAVE / LOAD SYSTEM ---
  function saveState() {
    const state = {
      numPlayers, currentPlayer, round, turnCount, players,
      logs, gameStartTime,
      // We must save the "Base" turn start time to persist accuracy
      turnStartTime, 
      totalPausedTime,
      isPaused,
      savedAt: Date.now()
    };
    
    // If paused, we need to artificially adjust totalPausedTime so when we reload, the time doesn't jump
    if(isPaused) {
       // We don't save pauseStartTime because the time spent closed counts as "paused" time essentially
       // Logic: If closed while paused, the elapsed time should be frozen.
    }
    
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function loadState() {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return false;
    
    try {
      const s = JSON.parse(raw);
      // Basic validation
      if (!s.players) return false;

      numPlayers = s.numPlayers;
      currentPlayer = s.currentPlayer;
      round = s.round;
      turnCount = s.turnCount;
      players = s.players;
      logs = s.logs;
      gameStartTime = s.gameStartTime;
      turnStartTime = s.turnStartTime;
      totalPausedTime = s.totalPausedTime;
      isPaused = s.isPaused;
      
      // If we loaded a paused game, we need to add the time the app was closed to the "paused" time
      // so the timer doesn't jump forward.
      if (isPaused) {
        const now = Date.now();
        const timeClosed = now - s.savedAt;
        totalPausedTime += timeClosed;
        pauseStartTime = now; // Reset pause start to now
        document.body.classList.add('is-paused');
      }

      // Update toggle buttons for config
      document.querySelectorAll('#countGroup .toggle-btn').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.dataset.n) === numPlayers);
      });

      return true;
    } catch(e) {
      console.error("Save file corrupt");
      return false;
    }
  }

  function clearState() {
    localStorage.removeItem(STORAGE_KEY);
  }

  // --- TIMER ---
  function startTimer() {
    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(() => {
      if (isPaused) return;
      const now = Date.now();
      const elapsed = now - turnStartTime - totalPausedTime;
      ui.timer.textContent = formatTime(elapsed);
    }, 100);
  }

  function togglePause() {
    if (isPaused) {
      isPaused = false;
      const now = Date.now();
      totalPausedTime += (now - pauseStartTime);
      document.body.classList.remove('is-paused');
    } else {
      isPaused = true;
      pauseStartTime = Date.now();
      document.body.classList.add('is-paused');
    }
    saveState();
  }

  function formatTime(ms) {
    if (ms < 0) ms = 0;
    const totalSec = Math.floor(ms / 1000);
    const m = Math.floor(totalSec / 60).toString().padStart(2, '0');
    const s = (totalSec % 60).toString().padStart(2, '0');
    return `${m}:${s}`;
  }

  // --- LOGIC ---
  function nextTurn() {
    if (isPaused) togglePause(); 

    const now = Date.now();
    const duration = now - turnStartTime - totalPausedTime;
    
    logs.push({
      round: round,
      turn: turnCount,
      playerIdx: currentPlayer,
      duration: duration
    });

    currentPlayer++;
    if (currentPlayer >= numPlayers) {
      currentPlayer = 0;
      round++;
    }
    turnCount++;

    turnStartTime = Date.now();
    totalPausedTime = 0;
    
    updateUI();
    updateStats();
    saveState();
  }

  function prevTurn() {
    if (logs.length === 0) return;

    const lastLog = logs.pop();
    
    round = lastLog.round;
    turnCount = lastLog.turn;
    currentPlayer = lastLog.playerIdx;

    const now = Date.now();
    turnStartTime = now - lastLog.duration;
    
    isPaused = false;
    totalPausedTime = 0;
    pauseStartTime = 0;
    document.body.classList.remove('is-paused');

    updateUI();
    updateStats();
    saveState();
  }

  function resetGame() {
    if (!confirm("Start a new game? Stats will be cleared.")) return;
    clearState();
    round = 1;
    turnCount = 1;
    currentPlayer = 0;
    logs = [];
    gameStartTime = Date.now();
    turnStartTime = Date.now();
    totalPausedTime = 0;
    isPaused = false;
    document.body.classList.remove('is-paused');
    
    updateUI();
    updateStats();
    closeOverlays();
  }

  // --- UI UPDATER ---
  function updateUI() {
    ui.round.textContent = `Round ${round}`;
    ui.turnCount.textContent = `Turn ${turnCount}`;
    
    const pName = players[currentPlayer] || `Player ${currentPlayer+1}`;
    ui.turnText.textContent = pName;
    const pColor = colors[currentPlayer] || '#fff';
    ui.turnText.style.color = pColor;
    
    ui.orbs.forEach((orb, i) => {
      orb.classList.toggle('active', i === currentPlayer);
      orb.classList.toggle('disabled', i >= numPlayers);
      if(i === currentPlayer) orb.style.color = pColor;
    });
  }

  function updateStats() {
    document.getElementById('stTotalTurns').textContent = logs.length;
    document.getElementById('stTotalTime').textContent = formatTime(Date.now() - gameStartTime);
    
    if (logs.length === 0) {
      ui.distChart.innerHTML = '<div style="color:var(--muted); font-size:12px; text-align:center; padding:10px;">Play a round to see data</div>';
      ui.turnLog.innerHTML = '';
      return;
    }

    const totalLogTime = logs.reduce((acc, l) => acc + l.duration, 0);
    const avg = totalLogTime / logs.length;
    document.getElementById('stAvg').textContent = formatTime(avg);
    
    const max = Math.max(...logs.map(l => l.duration));
    document.getElementById('stLongest').textContent = formatTime(max);

    // Distribution
    const activePlayers = players.slice(0, numPlayers);
    const pStats = activePlayers.map((name, i) => {
      const pLogs = logs.filter(l => l.playerIdx === i);
      const total = pLogs.reduce((acc, l) => acc + l.duration, 0);
      const avg = pLogs.length ? total / pLogs.length : 0;
      return { name, avg, color: colors[i] };
    });

    const maxAvg = Math.max(...pStats.map(s => s.avg), 1); 

    ui.distChart.innerHTML = pStats.map(s => `
      <div class="chart-row">
        <div class="chart-label">${s.name}</div>
        <div class="chart-bar-bg">
          <div class="chart-bar-fill" style="width:${(s.avg / maxAvg)*100}%; background:${s.color}"></div>
        </div>
        <div class="chart-time">${formatTime(s.avg)}</div>
      </div>
    `).join('');

    ui.turnLog.innerHTML = logs.slice().reverse().map(l => `
      <div class="log-entry">
        R${l.round} T${l.turn}: <strong style="color:${colors[l.playerIdx]}">${players[l.playerIdx]}</strong> - ${formatTime(l.duration)}
      </div>
    `).join('');
  }

  function renderNamesConfig() {
    ui.nameInputs.innerHTML = '';
    for(let i=0; i<6; i++) {
      const row = document.createElement('div');
      row.className = 'name-row';
      row.style.display = i < numPlayers ? 'block' : 'none';
      
      const input = document.createElement('input');
      input.type = 'text';
      input.value = players[i];
      input.placeholder = `Player ${i+1}`;
      input.oninput = (e) => { 
        players[i] = e.target.value || `Player ${i+1}`; 
        updateUI(); 
        saveState(); // Save names on type
      };
      
      row.appendChild(input);
      ui.nameInputs.appendChild(row);
    }
  }

  // --- EVENTS ---
  document.getElementById('turnTracker').addEventListener('pointerdown', nextTurn);
  document.getElementById('topRightTap').addEventListener('pointerdown', nextTurn);
  document.getElementById('roundInfo').addEventListener('pointerdown', prevTurn);
  ui.timerBtn.addEventListener('click', togglePause);
  
  window.closeOverlays = function() {
    Object.values(ui.overlays).forEach(el => el.classList.remove('open'));
  }
  
  document.getElementById('btnStats').addEventListener('click', () => {
    updateStats();
    ui.overlays.stats.classList.add('open');
  });

  document.getElementById('btnConfig').addEventListener('click', () => {
    renderNamesConfig();
    ui.overlays.config.classList.add('open');
  });
  
  ui.turnText.addEventListener('click', () => {
    renderNamesConfig();
    ui.overlays.config.classList.add('open');
  });

  document.getElementById('resetGameBtn').addEventListener('click', resetGame);

  document.querySelectorAll('#countGroup .toggle-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('#countGroup .toggle-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      numPlayers = parseInt(btn.dataset.n);
      if (currentPlayer >= numPlayers) currentPlayer = 0;
      renderNamesConfig();
      updateUI();
      updateStats();
      saveState();
    });
  });

  init();

});
</script>
</body>
</html>
