<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1.0, user-scalable=no"
/>
<title>‚è≥ Turn Tracker Pro</title>
<style>
  :root {
    --bg: #040608;
    --panel: #0e111a;
    --border: #262a36;
    --text: #e0e6f5;
    --muted: #757b93;
    --accent: #5ee0ff;
    --accent-glow: rgba(94, 224, 255, 0.5);
    --paused: #ffaf40;
  }

  * { box-sizing: border-box; }

  html, body {
    margin: 0; padding: 0;
    height: 100%;
    background: radial-gradient(circle at top, #14182a 0, #050608 60%);
    color: var(--text);
    font-family: system-ui, -apple-system, sans-serif;
    overflow: hidden;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
  }

  body { display: flex; justify-content: center; }

  .app {
    position: relative;
    width: 100%;
    max-width: 500px;
    height: 100vh;
    display: flex;
    flex-direction: column;
    padding: 20px;
  }

  /* --- TOP: NAVIGATION & ROUNDS --- */

  #topBar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 140px;
    flex-shrink: 0;
  }

  #roundInfo {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    cursor: pointer;
  }
  #roundInfo:active { opacity: 0.7; }

  #roundText { font-size: 20px; font-weight: 700; color: var(--muted); }
  #turnCountText { font-size: 14px; color: #555b70; margin-top: 4px; }

  /* PENTAGRAM TRACKER */
  #turnTracker {
    position: relative;
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: radial-gradient(circle, #1a1e2e 0%, #050608 70%);
    border: 1px solid var(--border);
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
    flex-shrink: 0;
    cursor: pointer;
    transition: transform 0.1s;
  }
  #turnTracker:active { transform: scale(0.96); }

  .turn-orb {
    position: absolute;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    opacity: 0.2;
    transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    box-shadow: 0 0 10px rgba(0,0,0,0.8);
  }

  /* Orb Positions */
  .orb0 { top: 16%; left: 50%; background: #f8f5e6; }
  .orb1 { top: 40%; left: 88%; background: #3aa3ff; }
  .orb2 { top: 84%; left: 68%; background: #1b1b24; }
  .orb3 { top: 84%; left: 32%; background: #ff5a40; }
  .orb4 { top: 40%; left: 12%; background: #2fd166; }
  .orb5 { top: 50%; left: 50%; background: #b38cff; }

  .turn-orb.active {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1.4);
    box-shadow: 0 0 15px currentColor;
    z-index: 2;
  }
  .turn-orb.disabled { opacity: 0; }

  #topRightTap { flex: 1; height: 100%; }

  /* --- MIDDLE: PLAYER NAME --- */

  #turnText {
    font-size: 18px;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    color: var(--muted);
    padding: 10px 0;
    text-align: center;
    margin-bottom: 20px;
    transition: color 0.3s;
  }

  /* --- MAIN: TIMER / PAUSE / STATS --- */

  #mainControl {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: flex-start;
  }

  #timerBtn {
    width: 100%;
    max-height: 360px;
    aspect-ratio: 1 / 0.8;
    border-radius: 30px;
    background: linear-gradient(180deg, rgba(94, 224, 255, 0.05) 0%, rgba(0,0,0,0) 100%);
    border: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    position: relative;
    overflow: hidden;
    transition: all 0.2s ease;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
  }

  #timerBtn:active { transform: scale(0.98); background: rgba(255,255,255,0.03); }

  #timerLabel {
    font-size: 14px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    color: var(--muted);
    margin-bottom: 10px;
  }

  #timerDisplay {
    font-size: 56px;
    font-weight: 800;
    color: var(--text);
    font-variant-numeric: tabular-nums;
    text-shadow: 0 0 30px var(--accent-glow);
    z-index: 2;
  }

  #timerSubtext {
    margin-top: 10px;
    font-size: 13px;
    color: #4a5060;
  }

  /* PAUSE STATE */
  body.is-paused #timerBtn {
    border-color: var(--paused);
    box-shadow: 0 0 20px rgba(255, 175, 64, 0.15);
  }
  body.is-paused #timerDisplay { color: var(--paused); text-shadow: none; opacity: 0.8; }
  body.is-paused #timerLabel { color: var(--paused); }
  
  #pauseOverlayIcon {
    position: absolute;
    font-size: 120px;
    opacity: 0;
    color: var(--paused);
    transition: opacity 0.3s;
    pointer-events: none;
    z-index: 1;
  }
  body.is-paused #pauseOverlayIcon { opacity: 0.1; }

  /* --- FOOTER: BUTTONS --- */

  #footerBar {
    height: 60px;
    display: flex;
    justify-content: center;
    gap: 20px;
    margin-top: auto;
  }

  .icon-btn {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    border: 1px solid var(--border);
    background: #0e111a;
    color: var(--muted);
    font-size: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 10px rgba(0,0,0,0.5);
  }
  .icon-btn:active { transform: scale(0.9); border-color: var(--accent); color: var(--text); }

  /* --- OVERLAYS --- */

  .overlay {
    position: fixed; inset: 0;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(8px);
    display: none;
    align-items: center; justify-content: center;
    z-index: 100;
    opacity: 0;
    transition: opacity 0.2s;
  }
  .overlay.open { display: flex; opacity: 1; }

  .panel {
    width: 90%; max-width: 400px; max-height: 80vh;
    background: #0b0d14;
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 20px;
    display: flex; flex-direction: column; gap: 15px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.8);
    overflow-y: auto;
  }

  .panel-header {
    display: flex; justify-content: space-between; align-items: center;
    font-size: 16px; font-weight: 700; text-transform: uppercase; color: var(--muted);
    border-bottom: 1px solid var(--border); padding-bottom: 10px;
  }

  .close-btn { background: none; border: none; color: var(--muted); font-size: 24px; padding: 0 10px; }

  /* Config Styles */
  .row-group { display: flex; gap: 5px; }
  .toggle-btn {
    flex: 1; padding: 10px; background: #161924; border: 1px solid var(--border);
    color: var(--muted); border-radius: 8px; font-size: 14px;
  }
  .toggle-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(94, 224, 255, 0.1); }
  
  input[type="text"] {
    width: 100%; padding: 10px; background: #161924; border: 1px solid var(--border);
    border-radius: 8px; color: var(--text); font-size: 14px; margin-bottom: 5px;
  }

  #resetGameBtn {
    margin-top: 10px; padding: 12px; background: #2a1414; border: 1px solid #4a2020;
    color: #ff5a5a; border-radius: 8px; font-weight: 600;
  }

  /* Stats Styles */
  .stat-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px dashed #222; font-size: 14px; }
  .stat-val { font-weight: 700; color: var(--text); }
  
  .chart-row { display: flex; align-items: center; gap: 10px; margin: 8px 0; }
  .chart-label { width: 70px; font-size: 12px; text-align: right; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .chart-bar-bg { flex: 1; height: 10px; background: #161924; border-radius: 5px; overflow: hidden; }
  .chart-bar-fill { height: 100%; background: var(--accent); width: 0%; transition: width 0.5s; }
  .chart-time { width: 45px; font-size: 12px; text-align: right; color: #fff; }

  .log-container {
    margin-top: 15px; max-height: 150px; overflow-y: auto;
    background: #08090e; border: 1px solid var(--border); border-radius: 8px; padding: 10px;
  }
  .log-entry { font-size: 12px; color: var(--muted); margin-bottom: 4px; border-bottom: 1px dotted #222; padding-bottom: 2px; }
  .log-entry strong { color: var(--text); }
</style>
</head>
<body>

<div class="app">
  <header id="topBar">
    <div id="roundInfo">
      <div id="roundText">Round 1</div>
      <div id="turnCountText">Turn 1</div>
    </div>
    
    <div id="turnTracker">
      <div class="turn-orb orb0" data-index="0"></div>
      <div class="turn-orb orb1" data-index="1"></div>
      <div class="turn-orb orb2" data-index="2"></div>
      <div class="turn-orb orb3" data-index="3"></div>
      <div class="turn-orb orb4" data-index="4"></div>
      <div class="turn-orb orb5" data-index="5"></div>
    </div>
    
    <div id="topRightTap"></div>
  </header>

  <div id="turnText">Player 1</div>

  <main id="mainControl">
    <div id="timerBtn">
      <div id="pauseOverlayIcon">‚è∏</div>
      <div id="timerLabel">Current Turn</div>
      <div id="timerDisplay">00:00</div>
      <div id="timerSubtext">Tap to Pause / Resume</div>
    </div>
  </main>

  <footer id="footerBar">
    <button class="icon-btn" id="btnStats">üìä</button>
    <button class="icon-btn" id="btnConfig">‚öôÔ∏è</button>
  </footer>
</div>

<div id="statsOverlay" class="overlay">
  <div class="panel">
    <div class="panel-header">
      <span>Game Stats</span>
      <button class="close-btn">‚úï</button>
    </div>
    
    <div id="statsSummary">
      <div class="stat-row"><span style="color:var(--muted)">Total Time</span> <span class="stat-val" id="stTotalTime">00:00</span></div>
      <div class="stat-row"><span style="color:var(--muted)">Total Turns</span> <span class="stat-val" id="stTotalTurns">0</span></div>
      <div class="stat-row"><span style="color:var(--muted)">Longest Turn</span> <span class="stat-val" id="stLongest">--:--</span></div>
      <div class="stat-row"><span style="color:var(--muted)">Avg Turn</span> <span class="stat-val" id="stAvg">--:--</span></div>
    </div>

    <div style="margin-top:10px; font-size:12px; text-transform:uppercase; color:var(--muted); font-weight:700;">Average Time / Player</div>
    <div id="distChart"></div>

    <div class="log-container" id="turnLog"></div>
  </div>
</div>

<div id="configOverlay" class="overlay">
  <div class="panel">
    <div class="panel-header">
      <span>Setup</span>
      <button class="close-btn">‚úï</button>
    </div>

    <div style="font-size:13px; color:var(--muted); margin-bottom:5px;">PLAYER COUNT</div>
    <div class="row-group" id="countGroup">
      <button class="toggle-btn" data-n="2">2</button>
      <button class="toggle-btn" data-n="3">3</button>
      <button class="toggle-btn active" data-n="4">4</button>
      <button class="toggle-btn" data-n="5">5</button>
      <button class="toggle-btn" data-n="6">6</button>
    </div>

    <div style="font-size:13px; color:var(--muted); margin:15px 0 5px;">NAMES</div>
    <div id="nameInputs"></div>

    <button id="btnSaveConfig" class="toggle-btn" style="margin-top:10px; border-color:var(--accent); color:var(--accent);">Save Changes</button>
    
    <hr style="border:0; border-top:1px dashed var(--border); width:100%; margin:15px 0;">
    <button id="resetGameBtn">‚ö†Ô∏è Reset Game Data</button>
  </div>
</div>

<script>
// --- CORE STATE ---
let numPlayers = 4;
let currentPlayer = 0; // 0-indexed
let round = 1;
let turnCount = 1;
let players = ["Player 1", "Player 2", "Player 3", "Player 4"];

// Time State
let turnStartTime = 0;
let pauseStartTime = 0;
let totalPausedTime = 0; // Accumulated pause time for THIS turn
let isPaused = false;
let timerInterval = null;

// Data Log
// { round, turn, playerIdx, duration }
let logs = []; 
let gameStartTime = Date.now();

// --- DOM ---
const ui = {
  round: document.getElementById('roundText'),
  turnCount: document.getElementById('turnCountText'),
  turnText: document.getElementById('turnText'),
  orbs: document.querySelectorAll('.turn-orb'),
  timer: document.getElementById('timerDisplay'),
  timerBtn: document.getElementById('timerBtn'),
  distChart: document.getElementById('distChart'),
  turnLog: document.getElementById('turnLog'),
  nameInputs: document.getElementById('nameInputs'),
  overlays: {
    stats: document.getElementById('statsOverlay'),
    config: document.getElementById('configOverlay')
  }
};

const colors = ['#f8f5e6', '#3aa3ff', '#1b1b24', '#ff5a40', '#2fd166', '#b38cff'];

// --- INIT ---
function init() {
  turnStartTime = Date.now();
  startTimer();
  renderNamesConfig();
  updateUI();
}

// --- TIMER LOGIC ---
function startTimer() {
  if (timerInterval) clearInterval(timerInterval);
  timerInterval = setInterval(() => {
    if (isPaused) return;
    const now = Date.now();
    const elapsed = now - turnStartTime - totalPausedTime;
    ui.timer.textContent = formatTime(elapsed);
  }, 100);
}

function togglePause() {
  if (isPaused) {
    // RESUME
    isPaused = false;
    const now = Date.now();
    totalPausedTime += (now - pauseStartTime);
    document.body.classList.remove('is-paused');
  } else {
    // PAUSE
    isPaused = true;
    pauseStartTime = Date.now();
    document.body.classList.add('is-paused');
  }
}

// --- GAME FLOW ---
function nextTurn() {
  if (isPaused) togglePause(); // Auto-resume on next turn

  // 1. Log Previous Turn
  const now = Date.now();
  const duration = now - turnStartTime - totalPausedTime;
  
  logs.push({
    round: round,
    turn: turnCount,
    playerIdx: currentPlayer,
    duration: duration
  });

  // 2. Advance State
  currentPlayer++;
  if (currentPlayer >= numPlayers) {
    currentPlayer = 0;
    round++;
  }
  turnCount++;

  // 3. Reset Timer for New Turn
  turnStartTime = Date.now();
  totalPausedTime = 0;
  
  updateUI();
  updateStats();
}

function prevTurn() {
  if (logs.length === 0) return;

  // 1. Recover Last Turn
  const lastLog = logs.pop();
  
  // 2. Restore State
  round = lastLog.round;
  turnCount = lastLog.turn;
  currentPlayer = lastLog.playerIdx;

  // 3. HARD RESET / RESTORE TIMER
  // We ignore any pauses that happened during the turn we just cancelled (the one we are going back FROM)
  // We simply restore the net duration of the turn we are going back TO.
  const now = Date.now();
  turnStartTime = now - lastLog.duration;
  
  // CRITICAL FIX: Reset pause state completely.
  // We do not want to inherit pause calculations from the future.
  isPaused = false;
  totalPausedTime = 0;
  pauseStartTime = 0;
  document.body.classList.remove('is-paused');

  updateUI();
  updateStats();
}

function resetGame() {
  if (!confirm("Start a new game? All stats will be lost.")) return;
  round = 1;
  turnCount = 1;
  currentPlayer = 0;
  logs = [];
  gameStartTime = Date.now();
  turnStartTime = Date.now();
  totalPausedTime = 0;
  isPaused = false;
  document.body.classList.remove('is-paused');
  updateUI();
  updateStats();
  closeOverlays();
}

// --- UI UPDATES ---
function updateUI() {
  ui.round.textContent = `Round ${round}`;
  ui.turnCount.textContent = `Turn ${turnCount}`;
  
  // Player Name & Color
  const pName = players[currentPlayer] || `Player ${currentPlayer+1}`;
  ui.turnText.textContent = pName;
  const pColor = colors[currentPlayer] || '#fff';
  ui.turnText.style.color = pColor;
  
  // Orbs
  ui.orbs.forEach((orb, i) => {
    orb.classList.toggle('active', i === currentPlayer);
    orb.classList.toggle('disabled', i >= numPlayers);
    if(i === currentPlayer) orb.style.color = pColor;
  });
}

function formatTime(ms) {
  const totalSec = Math.floor(ms / 1000);
  const m = Math.floor(totalSec / 60).toString().padStart(2, '0');
  const s = (totalSec % 60).toString().padStart(2, '0');
  return `${m}:${s}`;
}

// --- STATS ENGINE ---
function updateStats() {
  // Summary
  document.getElementById('stTotalTurns').textContent = logs.length;
  document.getElementById('stTotalTime').textContent = formatTime(Date.now() - gameStartTime);
  
  if (logs.length === 0) {
    ui.distChart.innerHTML = '<div style="color:var(--muted); font-size:12px; text-align:center; padding:10px;">Play a round to see data</div>';
    ui.turnLog.innerHTML = '';
    return;
  }

  const totalLogTime = logs.reduce((acc, l) => acc + l.duration, 0);
  const avg = totalLogTime / logs.length;
  document.getElementById('stAvg').textContent = formatTime(avg);
  
  const max = Math.max(...logs.map(l => l.duration));
  document.getElementById('stLongest').textContent = formatTime(max);

  // Distribution
  const pStats = players.slice(0, numPlayers).map((name, i) => {
    const pLogs = logs.filter(l => l.playerIdx === i);
    const total = pLogs.reduce((acc, l) => acc + l.duration, 0);
    const avg = pLogs.length ? total / pLogs.length : 0;
    return { name, avg, color: colors[i] };
  });

  const maxAvg = Math.max(...pStats.map(s => s.avg), 1); // Avoid div/0

  ui.distChart.innerHTML = pStats.map(s => `
    <div class="chart-row">
      <div class="chart-label">${s.name}</div>
      <div class="chart-bar-bg">
        <div class="chart-bar-fill" style="width:${(s.avg / maxAvg)*100}%; background:${s.color}"></div>
      </div>
      <div class="chart-time">${formatTime(s.avg)}</div>
    </div>
  `).join('');

  // Log List
  ui.turnLog.innerHTML = logs.slice().reverse().map(l => `
    <div class="log-entry">
      R${l.round} T${l.turn}: <strong style="color:${colors[l.playerIdx]}">${players[l.playerIdx]}</strong> - ${formatTime(l.duration)}
    </div>
  `).join('');
}

// --- CONFIG & HANDLERS ---
function renderNamesConfig() {
  ui.nameInputs.innerHTML = '';
  for(let i=0; i<6; i++) {
    const row = document.createElement('div');
    row.style.display = i < numPlayers ? 'block' : 'none';
    const input = document.createElement('input');
    input.type = 'text';
    input.value = players[i] || `Player ${i+1}`;
    input.placeholder = `Player ${i+1}`;
    input.onchange = (e) => { players[i] = e.target.value; updateUI(); };
    row.appendChild(input);
    ui.nameInputs.appendChild(row);
  }
}

// Events
document.getElementById('turnTracker').addEventListener('pointerdown', nextTurn);
document.getElementById('topRightTap').addEventListener('pointerdown', nextTurn);
document.getElementById('roundInfo').addEventListener('pointerdown', prevTurn);
document.getElementById('timerBtn').addEventListener('click', togglePause);

// Overlay Controls
function closeOverlays() {
  Object.values(ui.overlays).forEach(el => el.classList.remove('open'));
}
document.querySelectorAll('.close-btn').forEach(btn => btn.onclick = closeOverlays);

document.getElementById('btnStats').onclick = () => { updateStats(); ui.overlays.stats.classList.add('open'); };
document.getElementById('btnConfig').onclick = () => { renderNamesConfig(); ui.overlays.config.classList.add('open'); };
document.getElementById('btnSaveConfig').onclick = closeOverlays;
document.getElementById('resetGameBtn').onclick = resetGame;

// Count Toggles
document.querySelectorAll('#countGroup .toggle-btn').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('#countGroup .toggle-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    numPlayers = parseInt(btn.dataset.n);
    // Reset player to 0 if out of bounds
    if (currentPlayer >= numPlayers) currentPlayer = 0;
    renderNamesConfig();
    updateUI();
  };
});

init();

</script>
</body>
</html>

