<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta
  name="viewport"
  content="width=device-width, initial-scale=1.0, user-scalable=no"
/>
<title>Mothman Simple Tracker</title>
<style>
  :root {
    --bg: #040608;
    --panel-soft: #171b24;
    --border-soft: #262a36;
    --text-main: #f7f7f7;
    --muted: #a0a8c0;
    --accent: #5ee0ff;
    --heal: #6dff9f;
    --dmg: #ff5a5a;
    --life: #b1ff6a;
    --rad-glow: #7cff3b;
  }

  * {
    box-sizing: border-box;
  }

  html,
  body {
    margin: 0;
    padding: 0;
    height: 100%;
    background: radial-gradient(circle at top, #14182a 0, #050608 55%);
    color: var(--text-main);
    font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    -webkit-tap-highlight-color: transparent;
  }

  body {
    display: flex;
    justify-content: center;
  }

  .app {
    position: relative;
    width: 100%;
    max-width: 520px;
    height: 100vh;
    display: flex;
    flex-direction: column;
    padding: 12px 12px 22px;
  }

  /* TOP: TURN TRACKER */

  #topBar {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 6px;
    margin-bottom: 10px;
  }

  #turnTracker {
    position: relative;
    width: 128px;
    height: 128px;
    border-radius: 50%;
    background:
      radial-gradient(circle at center, #181b27 0, #090b11 60%),
      radial-gradient(circle at 20% 20%, rgba(124, 255, 59, 0.16), transparent 55%);
    border: 1px solid var(--border-soft);
    box-shadow:
      0 0 0 1px rgba(0, 0, 0, 0.6),
      0 14px 30px rgba(0, 0, 0, 0.9);
  }

  .turn-orb {
    position: absolute;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    transform: translate(-50%, -50%);
    opacity: 0.18;
    box-shadow: 0 0 5px rgba(0, 0, 0, 0.9);
    transition:
      opacity 0.16s ease,
      transform 0.16s ease,
      box-shadow 0.16s ease;
  }

  /* Centered ring around middle orb */
  .orb0 { top: 16%; left: 50%; background: #f8f5e6; }   /* white - top */
  .orb1 { top: 40%; left: 88%; background: #3aa3ff; }   /* blue - upper right */
  .orb2 { top: 84%; left: 68%; background: #1b1b24; }   /* black - lower right */
  .orb3 { top: 84%; left: 32%; background: #ff5a40; }   /* red - lower left */
  .orb4 { top: 40%; left: 12%; background: #2fd166; }   /* green - upper left */
  .orb5 { top: 50%; left: 50%; background: #b38cff; }   /* center */

  .turn-orb.active {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1.2);
    box-shadow:
      0 0 8px rgba(255, 255, 255, 0.9),
      0 0 20px rgba(94, 224, 255, 0.8);
  }

  .turn-orb.disabled {
    opacity: 0.05;
    box-shadow: none;
  }

  #turnText {
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.16em;
    color: var(--muted);
    padding: 5px 14px;
    border-radius: 999px;
    background: rgba(8, 10, 18, 0.9);
    border: 1px solid rgba(38, 42, 54, 0.9);
  }

  #turnText:active {
    transform: scale(0.97);
    opacity: 0.9;
  }

  /* MIDDLE: LIFE DISPLAY */

  #lifeArea {
    flex: 0.9;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  #lifeWrapper {
    position: relative;
    width: 100%;
    max-width: 360px;
    aspect-ratio: 4 / 3;
    border-radius: 24px;
    background:
      radial-gradient(circle at 20% 0, rgba(124, 255, 59, 0.18) 0, transparent 55%),
      radial-gradient(circle at top, #141826 0, #05070c 60%);
    border: 1px solid var(--border-soft);
    box-shadow:
      0 0 0 1px rgba(94, 224, 255, 0.05),
      0 20px 35px rgba(0, 0, 0, 0.85);
    overflow: hidden;
  }

  #lifeHintRow {
    position: absolute;
    top: 8px;
    left: 0;
    width: 100%;
    padding: 0 14px;
    display: flex;
    justify-content: space-between;
    font-size: 10px;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--muted);
    opacity: 0.8;
    pointer-events: none;
  }

  .life-label {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.14em;
    color: var(--muted);
    opacity: 0.65;
    pointer-events: none;
  }

  #lifeLabelLeft { left: 10px; }
  #lifeLabelRight { right: 10px; text-align: right; }

  #life {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 112px;
    font-weight: 800;
    color: var(--life);
    text-shadow:
      0 0 14px rgba(177, 255, 106, 0.7),
      0 0 30px rgba(124, 255, 59, 0.4);
    transition:
      transform 0.17s ease,
      color 0.17s ease,
      text-shadow 0.17s ease;
    pointer-events: none;
    animation: lifeGlow 4s ease-in-out infinite;
  }

  .life-zone {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 50%;
  }

  #lifeLeftZone { left: 0; }
  #lifeRightZone { right: 0; }

  .life-heal {
    color: var(--heal) !important;
    transform: translate(-50%, -50%) scale(1.08) !important;
    text-shadow:
      0 0 16px rgba(109, 255, 159, 0.9),
      0 0 36px rgba(109, 255, 159, 0.7) !important;
  }

  .life-dmg {
    color: var(--dmg) !important;
    transform: translate(-50%, -50%) scale(0.93) !important;
    text-shadow:
      0 0 16px rgba(255, 90, 90, 0.9),
      0 0 36px rgba(255, 90, 90, 0.7) !important;
  }

  #flash {
    position: fixed;
    inset: 0;
    pointer-events: none;
    background: transparent;
    opacity: 0;
    transition: opacity 0.18s ease;
    mix-blend-mode: screen;
  }

  #flash.flash-heal {
    background: radial-gradient(circle at center, rgba(109, 255, 159, 0.25), transparent 60%);
    opacity: 1;
  }

  #flash.flash-dmg {
    background: radial-gradient(circle at center, rgba(255, 90, 90, 0.3), transparent 65%);
    opacity: 1;
  }

  /* RAD COUNTER (SELF) */

  #radControl {
    position: absolute;
    bottom: 14px;
    left: 50%;
    transform: translateX(-50%);
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 4px 12px;
    border-radius: 999px;
    border: 1px solid rgba(80, 120, 80, 0.8);
    background:
      radial-gradient(circle at 20% 0, rgba(140, 180, 140, 0.18), transparent 55%),
      radial-gradient(circle at bottom, #131b15 0, #050806 70%);
    box-shadow:
      0 0 6px rgba(40, 70, 44, 0.8),
      0 0 14px rgba(10, 20, 10, 0.9);
    font-size: 11px;
    color: var(--muted);
    transition:
      box-shadow 0.2s ease,
      border-color 0.2s ease,
      background 0.2s ease,
      transform 0.2s ease;
  }

  #radControl.rad-active {
    border-color: var(--rad-glow);
    background:
      radial-gradient(circle at 25% 0, rgba(210, 255, 210, 0.32), transparent 55%),
      radial-gradient(circle at bottom, #182c1d 0, #050806 70%);
    box-shadow:
      0 0 14px rgba(124, 255, 59, 0.65),
      0 0 32px rgba(54, 132, 63, 0.85);
    animation: radPulse 2.4s ease-in-out infinite;
  }

  #radControl.rad-flash {
    box-shadow:
      0 0 18px rgba(190, 255, 150, 0.95),
      0 0 40px rgba(124, 255, 59, 0.9);
  }

  #radLabel {
    text-transform: uppercase;
    letter-spacing: 0.18em;
    font-size: 9px;
  }

  #radDisplay {
    min-width: 26px;
    text-align: center;
    color: var(--life);
    font-weight: 700;
    text-shadow:
      0 0 6px rgba(177, 255, 106, 0.6),
      0 0 14px rgba(124, 255, 59, 0.5);
    transition: text-shadow 0.2s ease;
  }

  #radDisplay.rad-text-flash {
    text-shadow:
      0 0 10px rgba(230, 255, 200, 0.95),
      0 0 26px rgba(170, 255, 120, 0.9);
  }

  /* BOTTOM: NOTES */

  #notesPanel {
    margin-top: 10px;
    padding: 10px 10px 8px;
    border-radius: 16px;
    background: linear-gradient(180deg, #111522, #080910);
    border: 1px solid var(--border-soft);
    box-shadow: 0 10px 26px rgba(0, 0, 0, 0.75);
  }

  .notes-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
  }

  .notes-title {
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--muted);
  }

  #addNoteBtn {
    padding: 4px 10px;
    border-radius: 999px;
    border: 1px solid var(--accent);
    background: radial-gradient(circle at top, #22273b 0, #12141e 70%);
    color: var(--text-main);
    font-size: 11px;
    font-weight: 600;
  }

  #addNoteBtn:active {
    transform: scale(0.96);
    opacity: 0.9;
  }

  /* Inline note composer under header */

  #noteComposer {
    display: none;
    margin-bottom: 6px;
    gap: 6px;
    align-items: center;
    flex-wrap: wrap;
  }

  #noteComposer.active {
    display: flex;
  }

  #noteInput {
    flex: 1 1 45%;
    min-width: 140px;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid var(--border-soft);
    background: #11141f;
    color: var(--text-main);
    font-size: 13px;
  }

  #noteInput::placeholder {
    color: #6d738a;
  }

  #noteTarget {
    flex: 0 0 34%;
    min-width: 120px;
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid var(--border-soft);
    background: #11141f;
    color: var(--muted);
    font-size: 12px;
    appearance: none;
  }

  .note-compose-btn {
    padding: 5px 9px;
    border-radius: 999px;
    border: 1px solid var(--border-soft);
    background: #141722;
    color: var(--muted);
    font-size: 11px;
  }

  #noteSave {
    border-color: var(--accent);
    color: var(--text-main);
    background: radial-gradient(circle at top, #22273b 0, #11131f 80%);
  }

  .note-compose-btn:active {
    transform: scale(0.96);
    opacity: 0.9;
  }

  #notesList {
    max-height: 210px;
    overflow-y: auto;
    padding-right: 4px;
    display: flex;
    flex-direction: column;
    gap: 7px;
  }

  .note-chip {
    display: flex;
    align-items: flex-start;
    gap: 8px;
    padding: 7px 9px;
    border-radius: 10px;
    background: #171a26;
    border: 1px solid #262a36;
    border-left-width: 3px;
    border-left-style: solid;
    border-left-color: #262a36;
    font-size: 12px;
    color: var(--muted);
  }

  .note-dot {
    width: 9px;
    height: 9px;
    border-radius: 999px;
    background: var(--accent);
    box-shadow: 0 0 6px rgba(94, 224, 255, 0.7);
    margin-top: 3px;
    flex-shrink: 0;
  }

  .note-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .note-targetLabel {
    font-size: 11px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.11em;
  }

  .note-text {
    flex: 1;
    white-space: pre-wrap;
    word-wrap: break-word;
    color: var(--text-main);
    font-size: 13px;
  }

  .note-remove {
    border: none;
    background: transparent;
    color: #707793;
    font-size: 13px;
    padding: 0;
    flex-shrink: 0;
  }

  .note-remove:active {
    transform: scale(0.9);
    opacity: 0.7;
  }

  #footerSpacer {
    flex-shrink: 0;
    height: 12px;
  }

  /* PLAYER CONFIG */

  #playerConfig {
    position: fixed;
    inset: 0;
    background: rgba(1, 2, 5, 0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 20;
  }

  #playerConfig.open {
    display: flex;
  }

  .config-inner {
    width: 100%;
    max-width: 420px;
    border-radius: 16px;
    background: #090b11;
    border: 1px solid var(--border-soft);
    box-shadow: 0 18px 35px rgba(0, 0, 0, 0.9);
    padding: 10px 14px 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .config-header {
    font-size: 13px;
    font-weight: 600;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--muted);
  }

  .player-count-row {
    display: flex;
    gap: 6px;
    margin: 4px 0;
  }

  .count-btn {
    flex: 1;
    padding: 6px 0;
    border-radius: 999px;
    border: 1px solid var(--border-soft);
    background: #121421;
    color: var(--muted);
    font-size: 12px;
  }

  .count-btn.active {
    border-color: var(--accent);
    color: var(--text-main);
    background: radial-gradient(circle at top, #22273b 0, #121421 80%);
  }

  #nameFields {
    margin-top: 4px;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .name-row {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .name-row label {
    min-width: 64px;
    font-size: 11px;
    color: var(--muted);
  }

  .name-row input {
    flex: 1;
    padding: 4px 6px;
    border-radius: 8px;
    border: 1px solid var(--border-soft);
    background: #11141f;
    color: var(--text-main);
    font-size: 12px;
  }

  .config-footer {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    margin-top: 6px;
  }

  .config-btn {
    padding: 5px 12px;
    border-radius: 999px;
    font-size: 12px;
    border: 1px solid var(--border-soft);
    background: #141722;
    color: var(--muted);
  }

  #configSave {
    border-color: var(--accent);
    color: var(--text-main);
    background: radial-gradient(circle at top, #22273b 0, #11131f 80%);
  }

  .config-btn:active {
    transform: scale(0.97);
    opacity: 0.9;
  }

  #notesList::-webkit-scrollbar {
    width: 4px;
  }
  #notesList::-webkit-scrollbar-thumb {
    background: #2b3040;
    border-radius: 999px;
  }

  /* ANIMATIONS */

  @keyframes lifeGlow {
    0% {
      text-shadow:
        0 0 8px rgba(177, 255, 106, 0.5),
        0 0 20px rgba(124, 255, 59, 0.3);
      transform: translate(-50%, -50%) scale(1);
    }
    50% {
      text-shadow:
        0 0 16px rgba(210, 255, 170, 0.9),
        0 0 34px rgba(150, 255, 120, 0.7);
      transform: translate(-50%, -50%) scale(1.03);
    }
    100% {
      text-shadow:
        0 0 8px rgba(177, 255, 106, 0.5),
        0 0 20px rgba(124, 255, 59, 0.3);
      transform: translate(-50%, -50%) scale(1);
    }
  }

  @keyframes radPulse {
    0% {
      transform: translateX(-50%) scale(1);
      box-shadow:
        0 0 10px rgba(124, 255, 59, 0.5),
        0 0 26px rgba(54, 132, 63, 0.7);
    }
    50% {
      transform: translateX(-50%) scale(1.06);
      box-shadow:
        0 0 18px rgba(190, 255, 150, 0.95),
        0 0 40px rgba(124, 255, 59, 0.9);
    }
    100% {
      transform: translateX(-50%) scale(1);
      box-shadow:
        0 0 10px rgba(124, 255, 59, 0.5),
        0 0 26px rgba(54, 132, 63, 0.7);
    }
  }
</style>
</head>
<body>
<div class="app">
  <header id="topBar">
    <div id="turnTracker">
      <div class="turn-orb orb0" data-index="0"></div>
      <div class="turn-orb orb1" data-index="1"></div>
      <div class="turn-orb orb2" data-index="2"></div>
      <div class="turn-orb orb3" data-index="3"></div>
      <div class="turn-orb orb4" data-index="4"></div>
      <div class="turn-orb orb5" data-index="5"></div>
    </div>
    <div id="turnText">Player 1</div>
  </header>

  <main id="lifeArea">
    <div id="lifeWrapper">
      <div id="lifeHintRow">
        <span>Tap left = -1</span>
        <span>Tap right = +1</span>
      </div>
      <div id="lifeLabelLeft" class="life-label">Damage</div>
      <div id="lifeLabelRight" class="life-label">Heal</div>

      <div id="life">40</div>

      <div id="lifeLeftZone" class="life-zone"></div>
      <div id="lifeRightZone" class="life-zone"></div>

      <div id="radControl">
        <span id="radLabel">RAD</span>
        <div id="radDisplay">0</div>
      </div>
    </div>
  </main>

  <section id="notesPanel">
    <div class="notes-header">
      <div class="notes-title">Board Notes / Triggers</div>
      <button id="addNoteBtn">+ Note</button>
    </div>

    <div id="noteComposer">
      <input
        id="noteInput"
        type="text"
        placeholder="Ex: Mothman – give 1 rad on attack"
        autocomplete="off"
      />
      <select id="noteTarget">
        <!-- options filled via JS -->
      </select>
      <button id="noteSave" class="note-compose-btn">Save</button>
      <button id="noteCancel" class="note-compose-btn">✕</button>
    </div>

    <div id="notesList"></div>
  </section>

  <div id="footerSpacer"></div>
</div>

<div id="playerConfig">
  <div class="config-inner">
    <div class="config-header">Players & Names</div>
    <div class="player-count-row">
      <button class="count-btn" data-count="1">1</button>
      <button class="count-btn" data-count="2">2</button>
      <button class="count-btn" data-count="3">3</button>
      <button class="count-btn" data-count="4">4</button>
      <button class="count-btn" data-count="5">5</button>
      <button class="count-btn" data-count="6">6</button>
    </div>
    <div id="nameFields">
      <div class="name-row" data-index="0">
        <label>Player 1</label>
        <input id="nameInput0" type="text" placeholder="Player 1" />
      </div>
      <div class="name-row" data-index="1">
        <label>Player 2</label>
        <input id="nameInput1" type="text" placeholder="Player 2" />
      </div>
      <div class="name-row" data-index="2">
        <label>Player 3</label>
        <input id="nameInput2" type="text" placeholder="Player 3" />
      </div>
      <div class="name-row" data-index="3">
        <label>Player 4</label>
        <input id="nameInput3" type="text" placeholder="Player 4" />
      </div>
      <div class="name-row" data-index="4">
        <label>Player 5</label>
        <input id="nameInput4" type="text" placeholder="Player 5" />
      </div>
      <div class="name-row" data-index="5">
        <label>Player 6</label>
        <input id="nameInput5" type="text" placeholder="Player 6" />
      </div>
    </div>
    <div class="config-footer">
      <button id="configCancel" class="config-btn">Cancel</button>
      <button id="configSave" class="config-btn">Save</button>
    </div>
  </div>
</div>

<div id="flash"></div>

<script>
  const DEFAULT_LIFE = 40;

  let life = DEFAULT_LIFE;
  let rad = 0; // self rad counter

  let numPlayers = 4;
  let currentPlayer = 0;
  let players = [];
  /**
   * notes: array of
   * { text: string, target: 'none'|'self'|'player', playerIndex: number|null }
   */
  let notes = [];

  const playerColors = [
    '#f8f5e6', // orb0 - white
    '#3aa3ff', // orb1 - blue
    '#1b1b24', // orb2 - black
    '#ff5a40', // orb3 - red
    '#2fd166', // orb4 - green
    '#b38cff'  // orb5 - center/purple
  ];

  const lifeEl = document.getElementById("life");
  const lifeLeftZone = document.getElementById("lifeLeftZone");
  const lifeRightZone = document.getElementById("lifeRightZone");
  const flashEl = document.getElementById("flash");

  const radControl = document.getElementById("radControl");
  const radDisplay = document.getElementById("radDisplay");

  const turnTracker = document.getElementById("turnTracker");
  const turnText = document.getElementById("turnText");
  const turnOrbs = Array.from(document.querySelectorAll(".turn-orb"));

  const addNoteBtn = document.getElementById("addNoteBtn");
  const notesListEl = document.getElementById("notesList");

  const noteComposer = document.getElementById("noteComposer");
  const noteInput = document.getElementById("noteInput");
  const noteTarget = document.getElementById("noteTarget");
  const noteSave = document.getElementById("noteSave");
  const noteCancel = document.getElementById("noteCancel");

  const playerConfig = document.getElementById("playerConfig");
  const countButtons = Array.from(document.querySelectorAll(".count-btn"));
  const nameRows = Array.from(document.querySelectorAll(".name-row"));
  const nameInputs = [
    document.getElementById("nameInput0"),
    document.getElementById("nameInput1"),
    document.getElementById("nameInput2"),
    document.getElementById("nameInput3"),
    document.getElementById("nameInput4"),
    document.getElementById("nameInput5")
  ];
  const configCancel = document.getElementById("configCancel");
  const configSave = document.getElementById("configSave");
  let configSelectedCount = 4;

  function defaultName(index) {
    return `Player ${index + 1}`;
  }

  function initPlayers(count) {
    numPlayers = Math.min(Math.max(count, 1), 6);
    const newPlayers = [];
    for (let i = 0; i < numPlayers; i++) {
      const existing = players[i];
      newPlayers.push({
        name: existing ? existing.name : defaultName(i)
      });
    }
    players = newPlayers;
    if (currentPlayer >= numPlayers) currentPlayer = numPlayers - 1;
    updateTurnDisplay();
    updateTurnOrbs();
    refreshNoteTargetOptions();
  }

  function updateTurnDisplay() {
    const p = players[currentPlayer];
    const name = p && p.name ? p.name : defaultName(currentPlayer);
    turnText.textContent = name;
  }

  function updateTurnOrbs() {
    turnOrbs.forEach((orb, idx) => {
      orb.classList.remove("active", "disabled");
      if (idx >= numPlayers) orb.classList.add("disabled");
      if (idx === currentPlayer) orb.classList.add("active");
    });
  }

  function updateLifeDisplay(type) {
    lifeEl.textContent = life;

    lifeEl.classList.remove("life-heal", "life-dmg");
    void lifeEl.offsetWidth;

    flashEl.classList.remove("flash-heal", "flash-dmg");
    void flashEl.offsetWidth;

    if (type === "heal") {
      lifeEl.classList.add("life-heal");
      flashEl.classList.add("flash-heal");
    } else if (type === "dmg") {
      lifeEl.classList.add("life-dmg");
      flashEl.classList.add("flash-dmg");
    }

    if (type === "heal" || type === "dmg") {
      setTimeout(() => {
        flashEl.classList.remove("flash-heal", "flash-dmg");
      }, 200);
    }
  }

  function changeLife(delta) {
    life = Math.max(0, life + delta);
    const type = delta > 0 ? "heal" : delta < 0 ? "dmg" : null;
    updateLifeDisplay(type);
  }

  function updateRadDisplay() {
    radDisplay.textContent = rad;
  }

  function refreshRadState() {
    updateRadDisplay();
    if (rad > 0) {
      radControl.classList.add("rad-active");
    } else {
      radControl.classList.remove("rad-active");
    }
  }

  function changeRad(delta) {
    rad = Math.max(0, rad + delta);
    refreshRadState();

    radControl.classList.remove("rad-flash");
    radDisplay.classList.remove("rad-text-flash");
    void radControl.offsetWidth;
    void radDisplay.offsetWidth;
    radControl.classList.add("rad-flash");
    radDisplay.classList.add("rad-text-flash");
    setTimeout(() => {
      radControl.classList.remove("rad-flash");
      radDisplay.classList.remove("rad-text-flash");
    }, 200);
  }

  function getPlayerColor(index) {
    if (index == null || index < 0 || index >= playerColors.length) {
      return null;
    }
    return playerColors[index];
  }

  function renderNotes() {
    notesListEl.innerHTML = "";
    if (!notes.length) {
      const empty = document.createElement("div");
      empty.textContent =
        'No notes yet – add reminders like "Self: gain 1 rad on upkeep" or "Attack P2 next turn".';
      empty.style.fontSize = "11px";
      empty.style.color = "var(--muted)";
      notesListEl.appendChild(empty);
      return;
    }

    notes.forEach((note, idx) => {
      const n = typeof note === "string" ? { text: note, target: "none", playerIndex: null } : note;
      const chip = document.createElement("div");
      chip.className = "note-chip";

      const dot = document.createElement("div");
      dot.className = "note-dot";

      const body = document.createElement("div");
      body.className = "note-body";

      const targetLabel = document.createElement("div");
      targetLabel.className = "note-targetLabel";

      let labelText = "";
      let color = null;

      if (n.target === "self") {
        labelText = "Self";
        color = "#b1ff6a";
      } else if (n.target === "player" && typeof n.playerIndex === "number") {
        const idxSafe = n.playerIndex;
        const p = players[idxSafe];
        const playerName = p && p.name ? p.name : defaultName(idxSafe);
        labelText = `Target: ${playerName}`;
        color = getPlayerColor(idxSafe) || "#5ee0ff";
      } else {
        labelText = "Board";
        color = "#5ee0ff";
      }

      targetLabel.textContent = labelText;

      const span = document.createElement("div");
      span.className = "note-text";
      span.textContent = n.text;

      const removeBtn = document.createElement("button");
      removeBtn.className = "note-remove";
      removeBtn.textContent = "✕";
      removeBtn.addEventListener("click", () => {
        notes.splice(idx, 1);
        renderNotes();
      });

      if (color) {
        dot.style.background = color;
        dot.style.boxShadow = `0 0 8px ${color}80`;
        chip.style.borderLeftColor = color;
      }

      body.appendChild(targetLabel);
      body.appendChild(span);

      chip.appendChild(dot);
      chip.appendChild(body);
      chip.appendChild(removeBtn);

      notesListEl.appendChild(chip);
    });
  }

  function refreshNoteTargetOptions() {
    if (!noteTarget) return;
    noteTarget.innerHTML = "";

    const optBoard = document.createElement("option");
    optBoard.value = "none";
    optBoard.textContent = "Board / General";
    noteTarget.appendChild(optBoard);

    const optSelf = document.createElement("option");
    optSelf.value = "self";
    optSelf.textContent = "Self";
    noteTarget.appendChild(optSelf);

    for (let i = 0; i < numPlayers; i++) {
      const p = players[i];
      const opt = document.createElement("option");
      opt.value = `player-${i}`;
      opt.textContent = p && p.name ? p.name : defaultName(i);
      noteTarget.appendChild(opt);
    }

    noteTarget.value = "none";
  }

  function openNoteComposer() {
    noteComposer.classList.add("active");
    noteInput.value = "";
    refreshNoteTargetOptions();
    setTimeout(() => {
      noteInput.focus();
    }, 30);
  }

  function closeNoteComposer() {
    noteComposer.classList.remove("active");
    noteInput.value = "";
  }

  function saveNoteFromComposer() {
    const text = noteInput.value.trim();
    if (!text) {
      closeNoteComposer();
      return;
    }

    const targetVal = noteTarget.value;
    const noteObj = {
      text,
      target: "none",
      playerIndex: null
    };

    if (targetVal === "self") {
      noteObj.target = "self";
    } else if (targetVal && targetVal.startsWith("player-")) {
      const idx = parseInt(targetVal.split("-")[1], 10);
      noteObj.target = "player";
      noteObj.playerIndex = isNaN(idx) ? null : idx;
    } else {
      noteObj.target = "none";
    }

    notes.push(noteObj);
    renderNotes();
    closeNoteComposer();
  }

  function setConfigCount(count) {
    configSelectedCount = count;
    countButtons.forEach(btn => {
      const c = parseInt(btn.getAttribute("data-count"), 10);
      btn.classList.toggle("active", c === count);
    });
    nameRows.forEach((row, idx) => {
      row.style.display = idx < count ? "flex" : "none";
    });
  }

  function openPlayerConfig() {
    setConfigCount(numPlayers);
    for (let i = 0; i < 6; i++) {
      const p = players[i];
      nameInputs[i].value = p && p.name ? p.name : defaultName(i);
    }
    playerConfig.classList.add("open");
  }

  function closePlayerConfig() {
    playerConfig.classList.remove("open");
  }

  /* EVENTS */

  ["pointerdown"].forEach(evt => {
    lifeLeftZone.addEventListener(evt, () => changeLife(-1));
    lifeRightZone.addEventListener(evt, () => changeLife(1));
  });

  // rad pill: left half = -1, right half = +1
  radControl.addEventListener("pointerdown", e => {
    const rect = radControl.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const half = rect.width / 2;
    if (x < half) {
      changeRad(-1);
    } else {
      changeRad(1);
    }
  });

  turnTracker.addEventListener("pointerdown", () => {
    currentPlayer = (currentPlayer + 1) % numPlayers;
    updateTurnOrbs();
    updateTurnDisplay();
  });

  turnText.addEventListener("pointerdown", openPlayerConfig);

  countButtons.forEach(btn => {
    btn.addEventListener("pointerdown", () => {
      const count = parseInt(btn.getAttribute("data-count"), 10);
      setConfigCount(count);
    });
  });

  configCancel.addEventListener("pointerdown", closePlayerConfig);

  configSave.addEventListener("pointerdown", () => {
    const newPlayers = [];
    for (let i = 0; i < configSelectedCount; i++) {
      const rawName = nameInputs[i].value.trim();
      newPlayers.push({
        name: rawName || defaultName(i)
      });
    }
    players = newPlayers;
    numPlayers = configSelectedCount;
    if (currentPlayer >= numPlayers) currentPlayer = numPlayers - 1;
    updateTurnOrbs();
    updateTurnDisplay();
    refreshNoteTargetOptions();
    closePlayerConfig();
  });

  playerConfig.addEventListener("click", e => {
    if (e.target === playerConfig) closePlayerConfig();
  });

  addNoteBtn.addEventListener("click", openNoteComposer);
  noteSave.addEventListener("click", saveNoteFromComposer);
  noteCancel.addEventListener("click", closeNoteComposer);

  noteInput.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      e.preventDefault();
      saveNoteFromComposer();
    } else if (e.key === "Escape") {
      e.preventDefault();
      closeNoteComposer();
    }
  });

  /* INIT */

  life = DEFAULT_LIFE;
  lifeEl.textContent = life;
  rad = 0;
  refreshRadState();

  players = [];
  for (let i = 0; i < 4; i++) {
    players.push({ name: defaultName(i) });
  }
  initPlayers(4);
  renderNotes();
</script>
</body>
</html>