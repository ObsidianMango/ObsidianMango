<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mothman Arc Simulator</title>
    <style>
        :root {
            --card-w: 90px;
            --card-h: 126px;
            --sidebar-w: 90px;
            --bg-dark: #0a0a0a;
            --accent: #b4ff00; /* Rad Green */
            --glass: rgba(20, 20, 20, 0.6);
        }

        * { box-sizing: border-box; user-select: none; -webkit-user-select: none; font-family: 'Segoe UI', sans-serif; touch-action: manipulation; }

        body {
            margin: 0;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            color: #eee;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- UI HEADER --- */
        #ui-header {
            height: 50px;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            z-index: 100;
        }

        .mana-pool {
            display: flex; gap: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            color: #ccc;
        }
        .mana-pool span { padding: 2px 6px; border-radius: 4px; background: #222; border: 1px solid #444; }

        button {
            background: #333; border: 1px solid #555; color: #fff;
            padding: 6px 12px; border-radius: 4px; cursor: pointer;
        }
        button:active { background: var(--accent); color: #000; }

        /* --- PLAYMAT (Grid) --- */
        #playmat {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr var(--sidebar-w);
            grid-template-rows: 1fr 1fr 1fr; /* Creatures, Artifacts, Lands */
            position: relative;
            overflow: hidden;
        }

        .zone {
            position: relative;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            padding: 10px;
            overflow-x: auto;
            gap: 5px;
        }
        .zone::before {
            content: attr(data-label);
            position: absolute; top: 2px; left: 5px;
            font-size: 0.6rem; color: #444; text-transform: uppercase; font-weight: bold;
            pointer-events: none;
        }
        
        #zone-creatures { grid-column: 1; grid-row: 1; }
        #zone-artifacts { grid-column: 1; grid-row: 2; }
        #zone-lands     { grid-column: 1; grid-row: 3; border-bottom: none; }

        /* Sidebar */
        .sidebar-cell {
            border-left: 1px solid rgba(255,255,255,0.1);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            background: rgba(0,0,0,0.2);
            position: relative;
        }
        #zone-commander { grid-column: 2; grid-row: 1; }
        #zone-graveyard { grid-column: 2; grid-row: 2; }
        #zone-library   { grid-column: 2; grid-row: 3; border-bottom: none; }

        /* --- CARD STYLES --- */
        .card {
            width: var(--card-w);
            height: var(--card-h);
            border-radius: 6px;
            background: #222;
            background-size: cover;
            background-position: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            position: relative;
            flex-shrink: 0;
            transition: transform 0.2s;
        }

        .tapped {
            transform: rotate(90deg);
            filter: brightness(0.6);
        }

        .counter-badge {
            position: absolute; top: -8px; right: -8px;
            background: var(--accent); color: #000;
            width: 24px; height: 24px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-weight: bold; font-size: 0.8rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.8);
            z-index: 10;
            border: 1px solid #fff;
        }

        /* --- HAND (ARC LAYOUT) --- */
        #hand-wrapper {
            position: fixed;
            bottom: 0; left: 0; width: 100%;
            height: 120px; /* Collapsed height */
            z-index: 500;
            transition: height 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            perspective: 1000px;
            pointer-events: none; /* Let clicks pass through empty space */
        }

        #hand-wrapper.expanded {
            height: 350px; /* Expanded view */
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(10px);
        }

        #hand-arc {
            position: absolute;
            bottom: -50px; left: 50%;
            width: 0; height: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: auto; /* Re-enable clicks on cards */
            transition: transform 0.3s;
        }

        #hand-wrapper.expanded #hand-arc {
            bottom: 100px; /* Lift up */
            transform: scale(1.2); /* Zoom in */
        }

        .hand-card {
            position: absolute;
            transform-origin: bottom center;
            width: 100px; height: 140px;
            border-radius: 8px;
            background-size: cover;
            background-position: center;
            box-shadow: -2px 0 10px rgba(0,0,0,0.5);
            border: 1px solid #444;
            transition: transform 0.2s, z-index 0s;
            cursor: pointer;
        }

        .hand-card:hover {
            z-index: 1000 !important;
            transform: translateY(-80px) scale(1.5) !important;
            box-shadow: 0 0 20px var(--accent);
        }

        /* --- INSPECTOR MODAL --- */
        #inspector {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            z-index: 2000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #insp-card {
            width: 260px; height: 362px;
            border-radius: 14px;
            background-size: cover;
            background-position: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            margin-bottom: 30px;
            transition: transform 0.3s;
        }

        #insp-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            width: 280px;
        }

        .action-btn {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 15px;
            border-radius: 12px;
            font-size: 1rem;
            display: flex; justify-content: center; align-items: center;
            gap: 8px;
        }
        .action-btn:active { background: var(--accent); color: black; border-color: var(--accent); }

        .counter-ctrl {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 5px;
            grid-column: span 2;
        }
        .c-btn {
            width: 40px; height: 40px;
            background: #333; border: none; color: white;
            border-radius: 8px; font-weight: bold; font-size: 1.2rem;
        }
        .c-display { font-weight: bold; font-size: 1.1rem; }

        /* Close Tip */
        .tap-tip {
            position: absolute; bottom: 30px;
            color: rgba(255,255,255,0.4);
            font-size: 0.8rem;
        }

    </style>
</head>
<body>

    <div id="ui-header">
        <div class="mana-pool">
            POOL: 
            <span style="color:#f0f8ff">U:<b id="m-u">0</b></span>
            <span style="color:#e0e0e0">B:<b id="m-b">0</b></span>
            <span style="color:#90ee90">G:<b id="m-g">0</b></span>
            <span style="color:#ccc">C:<b id="m-c">0</b></span>
        </div>
        <button onclick="untapAll()">Untap All</button>
    </div>

    <div id="playmat">
        <div id="zone-creatures" class="zone" data-label="Creatures"></div>
        <div id="zone-artifacts" class="zone" data-label="Artifacts / Enchantments"></div>
        <div id="zone-lands" class="zone" data-label="Lands"></div>

        <div id="zone-commander" class="sidebar-cell"></div>
        <div id="zone-graveyard" class="sidebar-cell">
            <div style="font-size:0.7rem; color:#666">GRAVE</div>
            <div id="gy-count" style="font-size:1.5rem; color:#fff; font-weight:bold">0</div>
        </div>
        <div id="zone-library" class="sidebar-cell" onclick="drawCard()">
            <div style="width:60px; height:84px; background:url('https://m.media-amazon.com/images/I/71jKdIXo-tL._AC_UF894,1000_QL80_.jpg'); background-size:cover; border-radius:4px; box-shadow:2px 2px 0 #333;"></div>
            <div id="lib-count" style="position:absolute; bottom:5px; background:#000; padding:2px 6px; border-radius:4px; font-size:0.7rem;">99</div>
        </div>
    </div>

    <div id="hand-wrapper" onclick="toggleHandView(event)">
        <div id="hand-arc">
            </div>
    </div>

    <div id="inspector" onclick="closeInspector(event)">
        <div id="insp-card">
            <div id="insp-badge" class="counter-badge" style="display:none; transform: scale(1.5); top:-10px; right:-10px;">0</div>
        </div>
        
        <div id="insp-controls">
            <button class="action-btn" onclick="act('tap')">
                <span id="btn-tap-text">Tap</span>
            </button>
            <button class="action-btn" style="border-color:#ff4444; color:#ffaaaa" onclick="act('grave')">
                Destroy
            </button>
            
            <div class="counter-ctrl">
                <button class="c-btn" onclick="act('sub')">-</button>
                <span class="c-display" id="insp-count-val">0 Counters</span>
                <button class="c-btn" style="color:var(--accent)" onclick="act('add')">+</button>
            </div>
        </div>
        <div class="tap-tip">Tap anywhere to close</div>
    </div>

<script>
    // --- FULL DECK LIST ---
    const rawDeck = [
        { qty: 1, name: "The Wise Mothman", type: "Creature", category: "Commander", setCode: 'pip' },
        { qty: 1, name: "Bruvac the Grandiloquent", type: "Creature" },
        { qty: 1, name: "The Mindskinner", type: "Creature" },
        { qty: 1, name: "Fetid Gargantua", type: "Creature" },
        { qty: 1, name: "Expanding Ooze", type: "Creature" },
        { qty: 1, name: "Ultimecia, Time Sorceress", type: "Creature" },
        { qty: 1, name: "Danny Pink", type: "Creature" },
        { qty: 1, name: "Zellix, Sanity Flayer", type: "Creature" },
        { qty: 1, name: "Syr Konrad, the Grim", type: "Creature" },
        { qty: 1, name: "Consuming Aberration", type: "Creature" },
        { qty: 1, name: "Eternal Witness", type: "Creature", setCode: '2x2', cn: '368' },
        { qty: 1, name: "Thrummingbird", type: "Creature", setCode: 'one', cn: '288' },
        { qty: 1, name: "Evolution Sage", type: "Creature" },
        { qty: 1, name: "Flux Channeler", type: "Creature" },
        { qty: 1, name: "Rishkar, Peema Renegade", type: "Creature" },
        { qty: 1, name: "Bloatfly Swarm", type: "Creature", setCode: 'pip' },
        { qty: 1, name: "Corpsejack Menace", type: "Creature", setCode: 'pip' },
        { qty: 1, name: "Glowing One", type: "Creature", setCode: 'pip' },
        { qty: 1, name: "Harold and Bob, First Numens", type: "Creature", setCode: 'pip' },
        { qty: 1, name: "Lily Bowen, Raging Grandma", type: "Creature", setCode: 'pip' },
        { qty: 1, name: "Rampaging Yao Guai", type: "Creature", setCode: 'pip' },
        { qty: 1, name: "The Master, Transcendent", type: "Creature", setCode: 'pip' },
        { qty: 1, name: "Tireless Tracker", type: "Creature", setCode: 'pip' },
        { qty: 1, name: "Vexing Radgull", type: "Creature", setCode: 'pip' },
        { qty: 1, name: "Watchful Radstag", type: "Creature", setCode: 'pip' },
        { qty: 1, name: "Winding Constrictor", type: "Creature", setCode: 'pip' },
        { qty: 1, name: "Maximum Overdrive", type: "Instant" },
        { qty: 1, name: "Origin of Metalbending", type: "Instant" },
        { qty: 1, name: "Brain Freeze", type: "Instant", setCode: 'slc', cn: '2' }, 
        { qty: 1, name: "Narset's Reversal", type: "Instant" },
        { qty: 1, name: "Golgari Charm", type: "Instant", setCode: 'rtr' },
        { qty: 1, name: "Biomass Mutation", type: "Instant", setCode: 'pip' },
        { qty: 1, name: "Inspiring Call", type: "Instant", setCode: 'pip' },
        { qty: 1, name: "Mutational Advantage", type: "Instant", setCode: 'pip' },
        { qty: 1, name: "Putrefy", type: "Instant", setCode: 'pip' },
        { qty: 1, name: "Radstorm", type: "Instant", setCode: 'pip' },
        { qty: 1, name: "Grasping Tentacles", type: "Sorcery" },
        { qty: 1, name: "Eerie Ultimatum", type: "Sorcery", setCode: 'slc', cn: '5' },
        { qty: 1, name: "Nature's Lore", type: "Sorcery", setCode: 'afc', cn: '164' },
        { qty: 1, name: "Victimize", type: "Sorcery" },
        { qty: 1, name: "Casualties of War", type: "Sorcery", setCode: 'pip' },
        { qty: 1, name: "Cultivate", type: "Sorcery", setCode: 'pip' },
        { qty: 1, name: "Farseek", type: "Sorcery", setCode: 'pip' },
        { qty: 1, name: "Mesmeric Orb", type: "Artifact", setCode: 'brr', cn: '31' },
        { qty: 1, name: "Codex Shredder", type: "Artifact", setCode: 'sld' },
        { qty: 1, name: "Mindcrank", type: "Artifact", setCode: 'sld' },
        { qty: 1, name: "Arcane Signet", type: "Artifact", setCode: 'pip' },
        { qty: 1, name: "Contagion Clasp", type: "Artifact", setCode: 'pip' },
        { qty: 1, name: "Power Fist", type: "Artifact", setCode: 'pip' },
        { qty: 1, name: "Recon Craft Theta", type: "Artifact", setCode: 'pip' },
        { qty: 1, name: "Sol Ring", type: "Artifact", setCode: 'pip' },
        { qty: 1, name: "Talisman of Curiosity", type: "Artifact", setCode: 'pip' },
        { qty: 1, name: "Talisman of Dominance", type: "Artifact", setCode: 'pip' },
        { qty: 1, name: "Dictate of Erebos", type: "Enchantment" },
        { qty: 1, name: "Bloodchief Ascension", type: "Enchantment" },
        { qty: 1, name: "Fertile Ground", type: "Enchantment", setCode: 'sld', cn: '1846' },
        { qty: 1, name: "Branching Evolution", type: "Enchantment", setCode: 'pip' },
        { qty: 1, name: "Fraying Sanity", type: "Enchantment", setCode: 'pip' },
        { qty: 1, name: "Guardian Project", type: "Enchantment", setCode: 'pip' },
        { qty: 1, name: "Hardened Scales", type: "Enchantment", setCode: 'pip' },
        { qty: 1, name: "Inexorable Tide", type: "Enchantment", setCode: 'pip' },
        { qty: 1, name: "Struggle for Project Purity", type: "Enchantment", setCode: 'pip' },
        { qty: 1, name: "Takenuma, Abandoned Mire", type: "Land" },
        { qty: 1, name: "Rejuvenating Springs", type: "Land" },
        { qty: 1, name: "Vesuva", type: "Land" },
        { qty: 1, name: "Ash Barrens", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Command Tower", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Darkwater Catacombs", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Drowned Catacomb", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Evolving Wilds", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Exotic Orchard", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Fetid Pools", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Hinterland Harbor", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Mariposa Military Base", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Nesting Grounds", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Opulent Palace", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Overflowing Basin", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Path of Ancestry", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Sunken Hollow", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Tainted Isle", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Tainted Wood", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Temple of Deceit", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Temple of Malady", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Viridescent Bog", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Woodland Cemetery", type: "Land", setCode: 'pip' },
        { qty: 5, name: "Island", type: "Land", setCode: 'pip' },
        { qty: 5, name: "Swamp", type: "Land", setCode: 'pip' },
        { qty: 5, name: "Forest", type: "Land", setCode: 'pip' },
    ];

    // --- GAME STATE ---
    let library = [], hand = [], grave = [];
    let activeCard = null; // Card currently being inspected
    let mana = {u:0, b:0, g:0, c:0};
    const imgCache = {};

    function init() {
        // Build Deck
        rawDeck.forEach(entry => {
            if(entry.category === 'Commander') {
                createCard(entry, 'zone-commander');
            } else {
                for(let i=0; i<entry.qty; i++) {
                    library.push({...entry, id: Math.random().toString(36).substr(2,9), counters:0, tapped:false});
                }
            }
        });
        
        // Shuffle
        library.sort(() => Math.random() - 0.5);
        updateCounts();

        // Draw 7
        for(let i=0; i<7; i++) drawCard();
    }

    // --- CARD RENDERING ---
    async function createCard(data, zoneId) {
        const el = document.createElement('div');
        el.className = zoneId === 'hand-arc' ? 'hand-card' : 'card';
        el.id = data.id || 'cmd-mothman';
        
        // Basic Metadata
        el.dataset.type = data.type;
        el.dataset.name = data.name;
        el.dataset.tapped = 'false';
        el.dataset.counters = 0;

        // Image Fetch
        const url = await getImgUrl(data);
        el.style.backgroundImage = `url('${url}')`;

        // Counter Badge
        const badge = document.createElement('div');
        badge.className = 'counter-badge';
        badge.style.display = 'none';
        badge.innerText = '0';
        el.appendChild(badge);

        // Click Logic
        el.onclick = (e) => {
            e.stopPropagation(); // Don't trigger background clicks
            handleCardClick(el, data, zoneId);
        };

        // Append
        if (zoneId === 'hand-arc') {
            document.getElementById('hand-arc').appendChild(el);
            arrangeHand();
        } else {
            document.getElementById(zoneId).appendChild(el);
        }
        return el;
    }

    async function getImgUrl(data) {
        const key = data.name + (data.setCode||'');
        if(imgCache[key]) return imgCache[key];
        
        let api = `https://api.scryfall.com/cards/named?fuzzy=${encodeURIComponent(data.name)}`;
        if(data.setCode) api += `&set=${data.setCode}`;
        if(data.cn) api = `https://api.scryfall.com/cards/${data.setCode}/${data.cn}`;

        try {
            const res = await fetch(api);
            const json = await res.json();
            const img = json.image_uris ? json.image_uris.normal : json.card_faces[0].image_uris.normal;
            
            // Mana Logic (Simple Inference)
            if(data.type.includes('Land')) {
                if(data.name.includes('Island') || data.name.includes('Water')) el.dataset.mana = 'u';
                else if(data.name.includes('Swamp') || data.name.includes('Bog')) el.dataset.mana = 'b';
                else if(data.name.includes('Forest')) el.dataset.mana = 'g';
                else el.dataset.mana = 'c';
            }
            
            imgCache[key] = img;
            return img;
        } catch { return 'https://via.placeholder.com/200'; }
    }

    // --- HAND LOGIC (ARC) ---
    function arrangeHand() {
        const container = document.getElementById('hand-arc');
        const cards = Array.from(container.children);
        const total = cards.length;
        const arcAngle = 40; // Total spread in degrees
        
        cards.forEach((card, i) => {
            const angle = (i - (total-1)/2) * (arcAngle / Math.max(total, 1));
            const yOffset = Math.abs(angle) * 2; // Curve down at edges
            // We use CSS var for the base transform so hover can override cleanly if needed
            card.style.transform = `rotate(${angle}deg) translateY(${yOffset}px)`;
            card.dataset.baseTransform = `rotate(${angle}deg) translateY(${yOffset}px)`;
            card.style.zIndex = i;
        });
    }

    function toggleHandView(e) {
        // Only toggle if clicking empty space (not a card)
        if(e.target.id === 'hand-wrapper' || e.target.id === 'hand-arc') {
            document.getElementById('hand-wrapper').classList.toggle('expanded');
        }
    }

    // --- INTERACTION ---
    function handleCardClick(el, data, currentZone) {
        // 1. Hand -> Cast
        if (currentZone === 'hand-arc' || currentZone === 'zone-commander') {
            castCard(el, data);
            return;
        }

        // 2. Battlefield -> INSPECT
        openInspector(el);
    }

    function castCard(el, data) {
        // Determine Target Zone
        let zone = 'zone-artifacts';
        if(data.type.includes('Land')) zone = 'zone-lands';
        else if(data.type.includes('Creature')) zone = 'zone-creatures';

        // Remove from hand, add to board
        el.remove();
        if(currentZone = 'hand-arc') arrangeHand();

        // Re-create on board
        const newEl = el.cloneNode(true);
        newEl.className = 'card';
        newEl.style.transform = 'none'; // Remove arc transform
        newEl.onclick = (e) => { e.stopPropagation(); openInspector(newEl); };
        
        document.getElementById(zone).appendChild(newEl);

        // Auto-Mana (if Land)
        if(data.type.includes('Land')) {
            // Check inferred mana
            // (Simple logic: just assume color based on name for now)
        }
    }

    function drawCard() {
        if(library.length===0) return;
        const card = library.pop();
        createCard(card, 'hand-arc');
        updateCounts();
    }

    function updateCounts() {
        document.getElementById('lib-count').innerText = library.length;
        document.getElementById('gy-count').innerText = grave.length;
    }

    // --- INSPECTOR ---
    function openInspector(el) {
        activeCard = el;
        const modal = document.getElementById('inspector');
        const view = document.getElementById('insp-card');
        const btnTap = document.getElementById('btn-tap-text');
        
        // Copy visual
        view.style.backgroundImage = el.style.backgroundImage;
        
        // Sync State
        const isTapped = el.dataset.tapped === 'true';
        view.style.transform = isTapped ? 'rotate(90deg)' : 'none';
        btnTap.innerText = isTapped ? 'Untap' : 'Tap';

        // Sync Counters
        const count = parseInt(el.dataset.counters || 0);
        document.getElementById('insp-count-val').innerText = count;
        const badge = document.getElementById('insp-badge');
        if(count > 0) {
            badge.style.display = 'flex';
            badge.innerText = count;
        } else {
            badge.style.display = 'none';
        }

        modal.style.display = 'flex';
    }

    function closeInspector(e) {
        if(e.target.id === 'inspector') {
            document.getElementById('inspector').style.display = 'none';
            activeCard = null;
        }
    }

    function act(action) {
        if(!activeCard) return;

        if (action === 'tap') {
            const isTapped = activeCard.dataset.tapped === 'true';
            
            // Toggle
            if(isTapped) {
                activeCard.classList.remove('tapped');
                activeCard.dataset.tapped = 'false';
                document.getElementById('insp-card').style.transform = 'none';
                document.getElementById('btn-tap-text').innerText = 'Tap';
            } else {
                activeCard.classList.add('tapped');
                activeCard.dataset.tapped = 'true';
                document.getElementById('insp-card').style.transform = 'rotate(90deg)';
                document.getElementById('btn-tap-text').innerText = 'Untap';
                
                // Add Mana logic (Goldfish)
                // Just add 1 Colorless for demo, or infer from name
                const name = activeCard.dataset.name || "";
                if(name.includes('Island')) addMana('u');
                else if(name.includes('Swamp')) addMana('b');
                else if(name.includes('Forest')) addMana('g');
                else addMana('c');
            }
        }
        
        if (action === 'add' || action === 'sub') {
            let c = parseInt(activeCard.dataset.counters || 0);
            if(action === 'add') c++;
            else if (action === 'sub') c = Math.max(0, c-1);
            
            activeCard.dataset.counters = c;
            
            // Update Board Badge
            const badge = activeCard.querySelector('.counter-badge');
            if(c > 0) {
                badge.style.display = 'flex';
                badge.innerText = c;
            } else {
                badge.style.display = 'none';
            }

            // Update Inspector UI
            document.getElementById('insp-count-val').innerText = c;
            const inspBadge = document.getElementById('insp-badge');
            if(c > 0) {
                inspBadge.style.display = 'flex';
                inspBadge.innerText = c;
            } else {
                inspBadge.style.display = 'none';
            }
        }

        if (action === 'grave') {
            activeCard.remove();
            grave.push('card');
            updateCounts();
            document.getElementById('inspector').style.display = 'none';
        }
    }

    function addMana(type) {
        mana[type] = (mana[type]||0) + 1;
        document.getElementById(`m-${type}`).innerText = mana[type];
    }

    function untapAll() {
        document.querySelectorAll('.tapped').forEach(el => {
            el.classList.remove('tapped');
            el.dataset.tapped = 'false';
        });
        mana = {u:0, b:0, g:0, c:0};
        ['u','b','g','c'].forEach(k => document.getElementById(`m-${k}`).innerText = 0);
    }

    init();

</script>
</body>
</html>
