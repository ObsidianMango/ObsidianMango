<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mothman Goldfish Sim</title>
    <style>
        :root {
            --card-w: 140px; /* Base size, adjusted via media queries */
            --card-h: 196px;
            --bg-dark: #121212;
            --accent: #4caf50; /* Mutant Green */
        }

        * { box-sizing: border-box; }

        body {
            margin: 0;
            background-color: var(--bg-dark);
            background-image: radial-gradient(circle at 50% 30%, #1e251e 0%, #0a0a0a 100%);
            color: #eee;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- UI TOP BAR --- */
        #ui-bar {
            height: 50px;
            background: rgba(20, 20, 20, 0.95);
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            padding: 0 10px;
            gap: 10px;
            z-index: 1000;
        }

        .btn {
            background: #333;
            border: 1px solid #555;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.85rem;
            cursor: pointer;
            white-space: nowrap;
        }
        .btn:active { background: var(--accent); border-color: var(--accent); }
        
        .stat-display { font-weight: bold; font-size: 0.9rem; color: #aaa; margin-left: auto; }
        .stat-val { color: var(--accent); }

        /* --- LAYOUT --- */
        #game-area {
            flex: 1;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Battlefield (Scrollable) */
        #battlefield {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            overflow-x: hidden;
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 8px;
            -webkit-overflow-scrolling: touch; /* Smooth scroll on iOS */
            padding-bottom: 160px; /* Space so hand doesn't cover bottom cards */
        }

        /* Hand (Fixed Bottom) */
        #hand-container {
            height: 160px;
            background: linear-gradient(to top, rgba(0,0,0,0.95) 60%, transparent);
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            z-index: 500;
            display: flex;
            align-items: flex-end;
            padding: 10px;
            overflow-x: auto; /* Horizontal scroll */
            gap: 5px;
            /* Hide Scrollbar but keep functionality */
            scrollbar-width: none; 
        }
        #hand-container::-webkit-scrollbar { display: none; }

        /* COMMAND ZONE (Floating) */
        #command-zone {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 100px;
            height: 140px;
            border: 2px dashed var(--accent);
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0.8;
            z-index: 10;
            transition: 0.3s;
        }
        #command-zone::after { content: 'Commander'; position: absolute; top: -20px; font-size: 0.7rem; color: var(--accent); }
        #command-zone.empty { border-color: #444; }

        /* --- CARD STYLING --- */
        .card {
            width: var(--card-w);
            height: var(--card-h);
            border-radius: 8px;
            background-color: #222;
            background-size: cover;
            background-position: center;
            position: relative;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            flex-shrink: 0; /* Don't squish in hand */
            border: 1px solid #000;
        }

        /* Hover/Active Effects */
        .card:active { transform: scale(0.95); }

        /* Tapped State */
        .tapped {
            transform: rotate(90deg);
            filter: brightness(0.7);
        }

        /* Hand Logic */
        #hand-container .card {
            width: 110px; /* Slightly smaller in hand */
            height: 154px;
            box-shadow: -2px 0 5px rgba(0,0,0,0.5);
            transform-origin: bottom center;
        }
        
        #hand-container .card:hover {
            transform: translateY(-20px) scale(1.1);
            z-index: 600;
            box-shadow: 0 0 15px var(--accent);
        }

        /* Loading Skeleton */
        .card.loading { background: #333; display: flex; align-items: center; justify-content: center; }
        .card.loading::after { content: '...'; color: #666; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        /* LIBRARY & GRAVEYARD PILES */
        .pile {
            position: absolute;
            width: 90px;
            height: 126px;
            border-radius: 6px;
            bottom: 170px; /* Above hand */
            right: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            cursor: pointer;
            z-index: 100;
        }

        #library {
            background: #222 url('https://upload.wikimedia.org/wikipedia/en/a/a4/Magic_the_gathering-card_back.jpg') center/cover;
            border: 1px solid #555;
            right: 10px;
        }
        
        #graveyard {
            background: rgba(0,0,0,0.5);
            border: 2px dashed #666;
            right: 110px;
            color: #aaa;
        }

        /* Count badge */
        .badge {
            position: absolute;
            top: -10px; right: -10px;
            background: var(--accent);
            color: black;
            border-radius: 50%;
            width: 24px; height: 24px;
            display: flex; justify-content: center; align-items: center;
            font-size: 0.75rem;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }

        /* --- MOBILE ADJUSTMENTS --- */
        @media (max-width: 768px) {
            :root {
                --card-w: 100px;
                --card-h: 140px;
            }
            #battlefield {
                padding-top: 160px; /* Push down below commander zone */
            }
            #command-zone {
                top: 10px; left: 50%;
                transform: translateX(-50%);
                width: 90px; height: 126px;
            }
        }
    </style>
</head>
<body>

    <div id="ui-bar">
        <div style="font-weight: bold; color: var(--accent);">MOTHMAN</div>
        <button class="btn" onclick="startTurn()">Untap All</button>
        <button class="btn" onclick="shuffleAndReset()">New Game</button>
        <div class="stat-display">Life: <span class="stat-val" id="life-total">40</span></div>
    </div>

    <div id="game-area">
        
        <div id="command-zone" onclick="castCommander()">
            </div>

        <div id="battlefield"></div>

        <div id="graveyard" class="pile" onclick="alert('Graveyard contains destroyed cards.')">
            GY
            <div id="gy-count" class="badge" style="background:#555; color:white">0</div>
        </div>
        
        <div id="library" class="pile" onclick="drawCard()">
            <div id="lib-count" class="badge">99</div>
        </div>

        <div id="hand-container"></div>
    </div>

<script>
    // --- DECK DATA ---
    const rawDeckData = [
        { qty: 1, name: "The Wise Mothman", type: "Creature", category: "Commander", setCode: 'pip' },
        { qty: 1, name: "Bruvac the Grandiloquent", type: "Creature" },
        { qty: 1, name: "The Mindskinner", type: "Creature" },
        { qty: 1, name: "Fetid Gargantua", type: "Creature" },
        { qty: 1, name: "Expanding Ooze", type: "Creature" },
        { qty: 1, name: "Ultimecia, Time Sorceress", type: "Creature" },
        { qty: 1, name: "Danny Pink", type: "Creature" },
        { qty: 1, name: "Zellix, Sanity Flayer", type: "Creature" },
        { qty: 1, name: "Syr Konrad, the Grim", type: "Creature" },
        { qty: 1, name: "Consuming Aberration", type: "Creature" },
        { qty: 1, name: "Eternal Witness", type: "Creature", setCode: '2x2', cn: '368' },
        { qty: 1, name: "Thrummingbird", type: "Creature", setCode: 'one', cn: '288' },
        { qty: 1, name: "Evolution Sage", type: "Creature" },
        { qty: 1, name: "Flux Channeler", type: "Creature" },
        { qty: 1, name: "Rishkar, Peema Renegade", type: "Creature" },
        { qty: 1, name: "Bloatfly Swarm", type: "Creature", setCode: 'pip' },
        { qty: 1, name: "Corpsejack Menace", type: "Creature", setCode: 'pip' },
        { qty: 1, name: "Glowing One", type: "Creature", setCode: 'pip' },
        { qty: 1, name: "Harold and Bob, First Numens", type: "Creature", setCode: 'pip' },
        { qty: 1, name: "Lily Bowen, Raging Grandma", type: "Creature", setCode: 'pip' },
        { qty: 1, name: "Rampaging Yao Guai", type: "Creature", setCode: 'pip' },
        { qty: 1, name: "The Master, Transcendent", type: "Creature", setCode: 'pip' },
        { qty: 1, name: "Tireless Tracker", type: "Creature", setCode: 'pip' },
        { qty: 1, name: "Vexing Radgull", type: "Creature", setCode: 'pip' },
        { qty: 1, name: "Watchful Radstag", type: "Creature", setCode: 'pip' },
        { qty: 1, name: "Winding Constrictor", type: "Creature", setCode: 'pip' },
        { qty: 1, name: "Maximum Overdrive", type: "Instant" },
        { qty: 1, name: "Origin of Metalbending", type: "Instant" },
        { qty: 1, name: "Brain Freeze", type: "Instant", setCode: 'slc', cn: '2' }, 
        { qty: 1, name: "Narset's Reversal", type: "Instant" },
        { qty: 1, name: "Golgari Charm", type: "Instant", setCode: 'rtr' },
        { qty: 1, name: "Biomass Mutation", type: "Instant", setCode: 'pip' },
        { qty: 1, name: "Inspiring Call", type: "Instant", setCode: 'pip' },
        { qty: 1, name: "Mutational Advantage", type: "Instant", setCode: 'pip' },
        { qty: 1, name: "Putrefy", type: "Instant", setCode: 'pip' },
        { qty: 1, name: "Radstorm", type: "Instant", setCode: 'pip' },
        { qty: 1, name: "Grasping Tentacles", type: "Sorcery" },
        { qty: 1, name: "Eerie Ultimatum", type: "Sorcery", setCode: 'slc', cn: '5' },
        { qty: 1, name: "Nature's Lore", type: "Sorcery", setCode: 'afc', cn: '164' },
        { qty: 1, name: "Victimize", type: "Sorcery" },
        { qty: 1, name: "Casualties of War", type: "Sorcery", setCode: 'pip' },
        { qty: 1, name: "Cultivate", type: "Sorcery", setCode: 'pip' },
        { qty: 1, name: "Farseek", type: "Sorcery", setCode: 'pip' },
        { qty: 1, name: "Mesmeric Orb", type: "Artifact", setCode: 'brr', cn: '31' },
        { qty: 1, name: "Codex Shredder", type: "Artifact", setCode: 'sld' },
        { qty: 1, name: "Mindcrank", type: "Artifact", setCode: 'sld' },
        { qty: 1, name: "Arcane Signet", type: "Artifact", setCode: 'pip' },
        { qty: 1, name: "Contagion Clasp", type: "Artifact", setCode: 'pip' },
        { qty: 1, name: "Power Fist", type: "Artifact", setCode: 'pip' },
        { qty: 1, name: "Recon Craft Theta", type: "Artifact", setCode: 'pip' },
        { qty: 1, name: "Sol Ring", type: "Artifact", setCode: 'pip' },
        { qty: 1, name: "Talisman of Curiosity", type: "Artifact", setCode: 'pip' },
        { qty: 1, name: "Talisman of Dominance", type: "Artifact", setCode: 'pip' },
        { qty: 1, name: "Dictate of Erebos", type: "Enchantment" },
        { qty: 1, name: "Bloodchief Ascension", type: "Enchantment" },
        { qty: 1, name: "Fertile Ground", type: "Enchantment", setCode: 'sld', cn: '1846' },
        { qty: 1, name: "Branching Evolution", type: "Enchantment", setCode: 'pip' },
        { qty: 1, name: "Fraying Sanity", type: "Enchantment", setCode: 'pip' },
        { qty: 1, name: "Guardian Project", type: "Enchantment", setCode: 'pip' },
        { qty: 1, name: "Hardened Scales", type: "Enchantment", setCode: 'pip' },
        { qty: 1, name: "Inexorable Tide", type: "Enchantment", setCode: 'pip' },
        { qty: 1, name: "Struggle for Project Purity", type: "Enchantment", setCode: 'pip' },
        { qty: 1, name: "Takenuma, Abandoned Mire", type: "Land" },
        { qty: 1, name: "Rejuvenating Springs", type: "Land" },
        { qty: 1, name: "Vesuva", type: "Land" },
        { qty: 1, name: "Ash Barrens", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Command Tower", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Darkwater Catacombs", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Drowned Catacomb", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Evolving Wilds", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Exotic Orchard", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Fetid Pools", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Hinterland Harbor", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Mariposa Military Base", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Nesting Grounds", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Opulent Palace", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Overflowing Basin", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Path of Ancestry", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Sunken Hollow", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Tainted Isle", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Tainted Wood", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Temple of Deceit", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Temple of Malady", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Viridescent Bog", type: "Land", setCode: 'pip' },
        { qty: 1, name: "Woodland Cemetery", type: "Land", setCode: 'pip' },
        { qty: 5, name: "Island", type: "Land", setCode: 'pip' },
        { qty: 5, name: "Swamp", type: "Land", setCode: 'pip' },
        { qty: 5, name: "Forest", type: "Land", setCode: 'pip' },
    ];

    // --- STATE ---
    let library = [];
    let graveyard = [];
    let commander = null;
    let cardCache = {}; // Cache image URLs to prevent re-fetching

    // --- ELEMENTS ---
    const handContainer = document.getElementById('hand-container');
    const battlefield = document.getElementById('battlefield');
    const commandZone = document.getElementById('command-zone');
    const libCountEl = document.getElementById('lib-count');
    const gyCountEl = document.getElementById('gy-count');

    // --- INITIALIZATION ---
    function init() {
        processDeck();
        shuffleAndReset();
    }

    // Expand "Qty: 5" into 5 individual objects and separate Commander
    function processDeck() {
        library = [];
        commander = null;

        rawDeckData.forEach(entry => {
            // Is this the commander?
            if (entry.category === "Commander") {
                commander = { ...entry, id: 'cmd-' + Math.random().toString(36).substr(2, 9) };
                return;
            }

            // Add copies to library
            for (let i = 0; i < entry.qty; i++) {
                library.push({
                    ...entry,
                    id: Math.random().toString(36).substr(2, 9)
                });
            }
        });
    }

    function shuffleAndReset() {
        // Clear board
        handContainer.innerHTML = '';
        battlefield.innerHTML = '';
        commandZone.innerHTML = '';
        graveyard = [];
        
        // Reset Library
        processDeck(); // Re-populate library
        
        // Fisher-Yates Shuffle
        for (let i = library.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [library[i], library[j]] = [library[j], library[i]];
        }

        updateCounts();

        // Load Commander
        createCardElement(commander, commandZone, 'commander');

        // Draw Opening Hand (7)
        for(let i=0; i<7; i++) drawCard();
    }

    function updateCounts() {
        libCountEl.innerText = library.length;
        gyCountEl.innerText = graveyard.length;
    }

    // --- CARD LOGIC ---
    function drawCard() {
        if (library.length === 0) return alert("Empty Library!");
        const cardData = library.pop();
        updateCounts();
        createCardElement(cardData, handContainer, 'hand');
    }

    function castCommander() {
        if (!commandZone.querySelector('.card')) return;
        const cardEl = commandZone.querySelector('.card');
        
        // Move to battlefield
        moveCardToZone(cardEl, battlefield);
        commandZone.classList.add('empty');
    }

    async function fetchCardImage(cardData) {
        // Check cache
        const cacheKey = `${cardData.name}-${cardData.setCode || 'default'}-${cardData.cn || ''}`;
        if (cardCache[cacheKey]) return cardCache[cacheKey];

        // Construct API URL
        let url;
        if (cardData.setCode && cardData.cn) {
            url = `https://api.scryfall.com/cards/${cardData.setCode}/${cardData.cn}`;
        } else if (cardData.setCode) {
            url = `https://api.scryfall.com/cards/named?exact=${encodeURIComponent(cardData.name)}&set=${cardData.setCode}`;
        } else {
            url = `https://api.scryfall.com/cards/named?fuzzy=${encodeURIComponent(cardData.name)}`;
        }

        try {
            const res = await fetch(url);
            const json = await res.json();
            
            let imgUrl = '';
            if (json.image_uris) imgUrl = json.image_uris.normal;
            else if (json.card_faces) imgUrl = json.card_faces[0].image_uris.normal;
            else imgUrl = 'https://via.placeholder.com/200x280?text=No+Img';

            cardCache[cacheKey] = imgUrl;
            return imgUrl;
        } catch (e) {
            console.error("Fetch failed", e);
            return 'https://via.placeholder.com/200x280?text=Error';
        }
    }

    async function createCardElement(data, container, zone) {
        const el = document.createElement('div');
        el.className = 'card loading';
        el.id = data.id;
        
        // Attach logic
        attachCardEvents(el, zone);
        container.appendChild(el);

        // Load Image
        const imgUrl = await fetchCardImage(data);
        el.style.backgroundImage = `url('${imgUrl}')`;
        el.classList.remove('loading');
    }

    function attachCardEvents(el, zone) {
        // Click Logic
        el.onclick = () => {
            if (el.parentElement === handContainer) {
                // Play from Hand
                moveCardToZone(el, battlefield);
            } else if (el.parentElement === battlefield) {
                // Tap/Untap
                el.classList.toggle('tapped');
            }
        };

        // Right Click / Long Press to Destroy
        el.oncontextmenu = (e) => {
            e.preventDefault();
            if (el.parentElement === battlefield) {
                destroyCard(el);
            }
        };
    }

    function moveCardToZone(el, newContainer) {
        // Animation helper
        el.style.transition = 'none'; // reset
        
        // If moving to battlefield, reset style from hand (width/height are css handled, but transforms need clearing)
        el.style.transform = ''; 
        
        // Re-append to new parent
        newContainer.appendChild(el);
        
        // Scroll battlefield to bottom to see new card if overflow
        if (newContainer === battlefield) {
            newContainer.scrollTop = newContainer.scrollHeight;
        }
    }

    function destroyCard(el) {
        graveyard.push(el.id); // minimal tracking
        updateCounts();
        el.remove();
    }

    // --- GAMEPLAY TOOLS ---
    function startTurn() {
        // Untap all cards in battlefield
        const tapped = battlefield.querySelectorAll('.tapped');
        tapped.forEach(c => c.classList.remove('tapped'));
        
        // Untap commander if active
        const cmd = battlefield.querySelector(`[id^="cmd-"]`);
        if(cmd) cmd.classList.remove('tapped');

        // Draw
        drawCard();
    }

    // Prevent Zoom on double tap on iOS
    document.addEventListener('dblclick', function(event) {
        event.preventDefault();
    }, { passive: false });

    // Start
    init();

</script>
</body>
</html>
