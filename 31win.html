<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Windows 3.1 Style Interface</title>
<style>
  /* Desktop styling */
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    overflow: hidden;
    background-color: #C0C0C0;
    font-family: sans-serif;
  }
  #desktop {
    position: relative;
    width: 100%;
    height: 100%;
    background-color: #C0C0C0;
    background-repeat: no-repeat;
    background-position: center;
    background-size: cover;
  }
  /* Default window styling */
  .window {
    position: absolute;
    top: 50px;
    left: 50px;
    width: 600px;  /* Default non-folder window size */
    height: 400px;
    border: 2px solid #FFFFFF;
    box-shadow: inset -1px -1px 0 #808080, inset 1px 1px 0 #808080;
    background-color: #C0C0C0;
    z-index: 10;
  }
  /* For main Program Manager, align icons at the bottom */
  #programManager .icon-grid {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
  }
  /* Title Bar and control buttons */
  .title-bar {
    height: 20px;
    background-color: #000080;
    color: #FFFFFF;
    display: flex;
    align-items: center;
    cursor: move;
    font-size: 14px;
  }
  .control-button {
    width: 20px;
    height: 20px;
    background-color: #808080;
    color: #FFFFFF;
    text-align: center;
    line-height: 20px;
    border: 1px solid #FFFFFF;
    cursor: pointer;
    user-select: none;
    margin: 0 2px;
  }
  .close-button { margin-left: 2px; }
  .window-title {
    flex: 1;
    padding-left: 5px;
    user-select: none;
    pointer-events: none;
  }
  .minimized-icon.selected .app-label {
  background-color: blue;
  color: white;
}
  .window-controls { display: flex; }
  /* Menu bar */
  .window-menu-bar {
    display: flex;
    background-color: #C0C0C0;
    border-bottom: 1px solid #808080;
    font-size: 14px;
    user-select: none;
  }
  .menu-item {
    position: relative;
    padding: 2px 8px;
    cursor: pointer;
  }
  .menu-item:hover {
    background-color: #000080;
    color: #FFFFFF;
  }
  .menu-dropdown {
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    background-color: #C0C0C0;
    border: 1px solid #000;
    min-width: 80px;
    z-index: 999;
  }
  .menu-option {
    padding: 2px 10px;
    white-space: nowrap;
    cursor: pointer;
  }
  .menu-option:hover {
    background-color: #000080;
    color: #FFFFFF;
  }
  /* Window content area */
  .window-content {
    position: absolute;
    top: 40px; /* 20px title + 20px menu */
    left: 0;
    right: 0;
    bottom: 0;
    overflow: auto;
    box-sizing: border-box;
  }
  /* Icon grid */
  .icon-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    padding: 10px;
  }
  /* App icons (64x64 px) */
  .app-icon {
    width: 64px;
    text-align: center;
    cursor: pointer;
    position: relative;
  }
  .app-icon img {
    display: block;
    margin: 0 auto;
    width: 64px;
    height: 64px;
  }
  .app-label {
    font-size: 12px;
    margin-top: 4px;
  }
  .app-icon.selected .app-label {
    background-color: blue;
    color: #fff;
  }
  /* Minimized icon styling mimics regular icon style */
  .minimized-icon {
    width: 64px;
    text-align: center;
    position: absolute;
    cursor: pointer;
  }
  .minimized-icon img {
    display: block;
    margin: 0 auto;
    width: 64px;
    height: 64px;
  }
  .minimized-icon .app-label {
    font-size: 12px;
    margin-top: 1px;
  }
  /* Resizing handle */
  .resize-handle {
    position: absolute;
    right: 0;
    bottom: 0;
    width: 10px;
    height: 10px;
    cursor: se-resize;
    background: #808080;
  }
  /* Clock display styling */
  .clock-display {
    display: flex;
    justify-content: center;
    align-items: center;
    width: 100%;
    height: 100%;
  }
  /* Canvas fills container */
  #clockCanvas {
    width: 100%;
    height: 100%;
  }
  /* Settings form styling */
  .settings-form {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    height: 100%;
    gap: 10px;
  }
  /* Styling for the additional Default Pattern dropdown */
  .settings-form select {
    padding: 4px;
  }
</style>
</head>
<body>
<div id="desktop">
  <!-- Main Program Manager Window -->
  <div class="window" id="programManager" data-icon="https://64.media.tumblr.com/4e8ee615b0b86a16a7a2e5708911a63f/6305d7b1627aeb19-85/s540x810/d45ca67116210b60a6d2a268e4a6ed0c5be6404b.png">
    <div class="title-bar" onmousedown="beginDrag(event, this.parentNode)">
      <div class="control-button close-button" onclick="closeWindow(this)">–</div>
      <div class="window-title">Program Manager</div>
      <div class="window-controls">
        <div class="control-button minimize-button" onclick="minimizeWindow(this)">▼</div>
        <div class="control-button maximize-button" onclick="maximizeWindow(this)">▲</div>
      </div>
    </div>
    <div class="window-menu-bar">
      <div class="menu-item" onclick="toggleMenu(event)">File
        <div class="menu-dropdown">
          <div class="menu-option" onclick="menuFileClose(this)">Close</div>
        </div>
      </div>
      <div class="menu-item" onclick="toggleMenu(event)">Edit
        <div class="menu-dropdown">
          <div class="menu-option">Nothing here</div>
        </div>
      </div>
      <div class="menu-item" onclick="toggleMenu(event)">Window
        <div class="menu-dropdown">
          <div class="menu-option" onclick="setWindowSize(this, 375, 667)">iPhone ratio</div>
          <div class="menu-option" onclick="setWindowSize(this, 600, 400)">600 wide</div>
          <div class="menu-option" onclick="setWindowSize(this, 800, 600)">800x600</div>
          <div class="menu-option" onclick="setWindowSize(this, 1280, 720)">720p ratio</div>
        </div>
      </div>
      <div class="menu-item" onclick="toggleMenu(event)">Help
        <div class="menu-dropdown">
          <div class="menu-option" onclick="openLink('https://obsidianmango.github.io/ObsidianMango/help')">Sorry cant help ya</div>
        </div>
      </div>
    </div>
    <div class="window-content" onclick="bringWindowToFront(this.parentNode)">
      <div class="icon-grid">
        <!-- Main window icons aligned at bottom -->
        <div class="app-icon" onclick="selectIcon(event)" ondblclick="openFolder('Accessories', this)" onmousedown="potentialDragIcon(event, this)">
          <img src="https://64.media.tumblr.com/3a2f98f31a64bf6281edd83409d1a1a5/ae3ba98da871ee36-6f/s540x810/bdf8149c98dd459cf6103e2b8697d308d2c99711.png" alt="Accessories">
          <div class="app-label">Accessories</div>
        </div>
        <div class="app-icon" onclick="selectIcon(event)" ondblclick="openFolder('Games', this)" onmousedown="potentialDragIcon(event, this)">
          <img src="https://64.media.tumblr.com/ddb8339fed22dd22ae60bf4de93e76d6/aff3bc935c322e16-83/s540x810/2fbc086890cabe090144c0b46eb96c5be8cdada5.png" alt="Games">
          <div class="app-label">Games</div>
        </div>
        <div class="app-icon" onclick="selectIcon(event)" ondblclick="openFolder('Main', this)" onmousedown="potentialDragIcon(event, this)">
          <img src="https://64.media.tumblr.com/1fc8aa6e5a5cd66a549449d32f33fce2/2a93c2106eb16e03-b4/s540x810/43a208e0a9f676ce838bce955ee569f44ce06385.png" alt="Main">
          <div class="app-label">Main</div>
        </div>
        
        <!-- Clock and Settings -->
        <div class="app-icon" onclick="selectIcon(event)" ondblclick="openClockApp(this)" onmousedown="potentialDragIcon(event, this)">
          <img src="https://64.media.tumblr.com/4cb363f6e2d485ee1a868cc7619b87de/1b3db655df3bb95c-2d/s540x810/f2c75433928622a8c9de34cfa33adead433b04ee.png" alt="Clock">
          <div class="app-label">Clock</div>
        </div>
        <div class="app-icon" onclick="selectIcon(event)" ondblclick="openSettingsApp(this)" onmousedown="potentialDragIcon(event, this)">
          <img src="https://64.media.tumblr.com/1716d0f268777aa2e9b2f14f89a990ff/a7aa35d81b0fc9e1-ec/s540x810/9fd1ba9a01b5af7d8c7e276163dfa66d80af5b02.png" alt="Settings">
          <div class="app-label">Settings</div>
        </div>
      </div>
    </div>
    <div class="resize-handle" onmousedown="beginResize(event, this.parentNode)"></div>
  </div>
</div>

<script>
/* Global variables for window dragging/resizing */
let zIndexCounter = 10;
let isDragging = false;
let dragOffsetX = 0;
let dragOffsetY = 0;
let resizeWindowEl = null;
let resizeOffsetX = 0;
let resizeOffsetY = 0;

/* Global variable for potential icon dragging */
let potentialDrag = null;
const DRAG_THRESHOLD = 5; // pixels

/* Global variable for clock mode */
let clockMode = 'digital';
let clockInterval = null;
let clockCanvasInterval = null;

/* Bring window to front */
function bringWindowToFront(windowEl) {
  windowEl.style.zIndex = ++zIndexCounter;
}

/* Window dragging */
function beginDrag(e, windowEl) {
  e = e || window.event;
  isDragging = true;
  windowEl.style.zIndex = ++zIndexCounter;
  dragOffsetX = e.clientX - windowEl.offsetLeft;
  dragOffsetY = e.clientY - windowEl.offsetTop;
  document.onmousemove = (ev) => doDrag(ev, windowEl);
  document.onmouseup = stopDrag;
}
function doDrag(e, windowEl) {
  if (!isDragging) return;
  windowEl.style.left = (e.clientX - dragOffsetX) + 'px';
  windowEl.style.top = (e.clientY - dragOffsetY) + 'px';
}
function stopDrag() {
  isDragging = false;
  document.onmousemove = null;
  document.onmouseup = null;
}

/* Potential icon dragging */
function potentialDragIcon(e, iconEl) {
  e = e || window.event;
  potentialDrag = {
    icon: iconEl,
    startX: e.clientX,
    startY: e.clientY,
    initialLeft: iconEl.offsetLeft,
    initialTop: iconEl.offsetTop
  };
  document.addEventListener('mousemove', potentialDragMouseMove);
  document.addEventListener('mouseup', potentialDragMouseUp);
}
function potentialDragMouseMove(e) {
  if (!potentialDrag) return;
  let dx = e.clientX - potentialDrag.startX;
  let dy = e.clientY - potentialDrag.startY;
  if (Math.sqrt(dx * dx + dy * dy) > DRAG_THRESHOLD) {
    potentialDrag.icon.style.position = "absolute";
    potentialDrag.icon.style.left = (potentialDrag.initialLeft + dx) + "px";
    potentialDrag.icon.style.top = (potentialDrag.initialTop + dy) + "px";
  }
}
function potentialDragMouseUp(e) {
  document.removeEventListener('mousemove', potentialDragMouseMove);
  document.removeEventListener('mouseup', potentialDragMouseUp);
  potentialDrag = null;
}

/* Icon selection */
function selectIcon(e) {
  let icons = document.querySelectorAll('.app-icon');
  icons.forEach(icon => icon.classList.remove('selected'));
  e.currentTarget.classList.add('selected');
}

/* Window resizing */
function beginResize(e, windowEl) {
  e = e || window.event;
  e.stopPropagation();
  resizeWindowEl = windowEl;
  resizeOffsetX = windowEl.offsetWidth - e.clientX;
  resizeOffsetY = windowEl.offsetHeight - e.clientY;
  document.onmousemove = doResize;
  document.onmouseup = stopResize;
}
function doResize(e) {
  if (!resizeWindowEl) return;
  resizeWindowEl.style.width = (e.clientX + resizeOffsetX) + 'px';
  resizeWindowEl.style.height = (e.clientY + resizeOffsetY) + 'px';
  if (resizeWindowEl.id === "clockWindow") adjustClockFont(resizeWindowEl);
}
function stopResize() {
  resizeWindowEl = null;
  document.onmousemove = null;
  document.onmouseup = null;
}

/* Control buttons */
function closeWindow(buttonEl) {
  const win = buttonEl.closest('.window');
  // When closing Program Manager, load a specific background image.
  if (win.id === "programManager") {
    document.getElementById("desktop").style.backgroundImage =
      "url('https://upload.wikimedia.org/wikipedia/commons/f/f8/Windows_3.1_BSoD_%28fixed%29.png')";
  }
  win.remove();
}
function minimizeWindow(buttonEl) {
  const win = buttonEl.closest('.window');
  minimizeToDesktopIcon(win);
}
function maximizeWindow(buttonEl) {
  const win = buttonEl.closest('.window');
  if (!win.dataset.maximized) {
    win.dataset.prevLeft = win.style.left;
    win.dataset.prevTop = win.style.top;
    win.dataset.prevWidth = win.style.width;
    win.dataset.prevHeight = win.style.height;
    win.style.left = '0px';
    win.style.top = '0px';
    win.style.width = '100%';
    win.style.height = '100%';
    win.dataset.maximized = 'true';
  } else {
    win.style.left = win.dataset.prevLeft;
    win.style.top = win.dataset.prevTop;
    win.style.width = win.dataset.prevWidth;
    win.style.height = win.dataset.prevHeight;
    delete win.dataset.maximized;
  }
}
function minimizeToDesktopIcon(windowEl) {
  windowEl.style.display = 'none';
  const desktop = document.getElementById('desktop');
  const icon = document.createElement('div');
  icon.className = 'minimized-icon';
  icon.style.left = windowEl.style.left;
  icon.style.top = windowEl.style.top;
  let titleText = windowEl.querySelector('.window-title').textContent;
  if (windowEl.dataset.icon) {
    icon.innerHTML = `<img src="${windowEl.dataset.icon}" alt="${titleText}"><div class="app-label">${titleText}</div>`;
  } else {
    icon.innerHTML = `<img src="https://via.placeholder.com/64?text=${titleText.charAt(0)}" alt="${titleText}"><div class="app-label">${titleText}</div>`;
  }
  desktop.appendChild(icon);
  icon.onmousedown = (e) => potentialDragIcon(e, icon);
  icon.ondblclick = () => {
    windowEl.style.display = 'block';
    windowEl.style.zIndex = ++zIndexCounter;
    icon.remove();
  };
  icon.onclick = function(e) {
  // Remove "selected" class from all minimized icons
  document.querySelectorAll('.minimized-icon').forEach(el => el.classList.remove('selected'));
  // Add "selected" class to this icon
  icon.classList.add('selected');
  e.stopPropagation();
};
}

/* Menu handling */
function toggleMenu(event) {
  event.stopPropagation();
  let menuDropdown = event.currentTarget.querySelector('.menu-dropdown');
  if (menuDropdown) {
    menuDropdown.style.display = (menuDropdown.style.display === 'block') ? 'none' : 'block';
  }
}
document.addEventListener('click', () => {
  document.querySelectorAll('.menu-dropdown').forEach(d => d.style.display = 'none');
});
function menuFileClose(el) {
  el.closest('.window').remove();
}
function setWindowSize(el, w, h) {
  const win = el.closest('.window');
  win.style.width = w + 'px';
  win.style.height = h + 'px';
}
function openLink(url) {
  window.open(url, '_blank');
}

/* Create a new window.
   Parameters:
     title, innerHtml, iconURL (optional), customWidth (optional), customHeight (optional)
   For non-folder windows, default size is 600x400.
   For folder windows (opened via openFolder), default size is 500x300.
*/
function createWindow(title, innerHtml, iconURL, customWidth, customHeight) {
  const desktop = document.getElementById('desktop');
  const newWin = document.createElement('div');
  newWin.className = 'window';
  newWin.style.left = '100px';
  newWin.style.top = '100px';
  newWin.style.zIndex = ++zIndexCounter;
  // Default size for non-folder windows:
  newWin.style.width = "600px";
  newWin.style.height = "400px";
  // For folder windows (not Clock, Settings, Program Manager), default size is 500x300.
  if(title !== "Clock" && title !== "Settings" && title !== "Program Manager") {
    newWin.style.width = (customWidth !== undefined) ? customWidth + "px" : "550px";
    newWin.style.height = (customHeight !== undefined) ? customHeight + "px" : "700px";
  } else {
    if(customWidth) newWin.style.width = customWidth + "px";
    if(customHeight) newWin.style.height = customHeight + "px";
  }
  if (iconURL) newWin.dataset.icon = iconURL;
  if (title === "Clock") newWin.id = "clockWindow";
  
  // For Clock window, override Edit menu with "Toggle Mode"
  let editMenu;
  if (title === "Clock") {
    editMenu = `<div class="menu-item" onclick="toggleMenu(event)">Edit
                  <div class="menu-dropdown">
                    <div class="menu-option" onclick="toggleClockMode(event)">Toggle Mode</div>
                  </div>
                </div>`;
  } else {
    editMenu = `<div class="menu-item" onclick="toggleMenu(event)">Edit
                  <div class="menu-dropdown">
                    <div class="menu-option">Nothing here</div>
                  </div>
                </div>`;
  }
  
  newWin.innerHTML = `
    <div class="title-bar" onmousedown="beginDrag(event, this.parentNode)">
      <div class="control-button close-button" onclick="closeWindow(this)">–</div>
      <div class="window-title">${title}</div>
      <div class="window-controls">
        <div class="control-button minimize-button" onclick="minimizeWindow(this)">▼</div>
        <div class="control-button maximize-button" onclick="maximizeWindow(this)">▲</div>
      </div>
    </div>
    <div class="window-menu-bar">
      <div class="menu-item" onclick="toggleMenu(event)">File
        <div class="menu-dropdown">
          <div class="menu-option" onclick="menuFileClose(this)">Close</div>
        </div>
      </div>
      ${editMenu}
      <div class="menu-item" onclick="toggleMenu(event)">Window
        <div class="menu-dropdown">
          <div class="menu-option" onclick="setWindowSize(this, 375, 667)">iPhone ratio</div>
          <div class="menu-option" onclick="setWindowSize(this, 600, 400)">600 wide</div>
          <div class="menu-option" onclick="setWindowSize(this, 800, 600)">800x600</div>
          <div class="menu-option" onclick="setWindowSize(this, 1280, 720)">720p ratio</div>
        </div>
      </div>
      <div class="menu-item" onclick="toggleMenu(event)">Help
        <div class="menu-dropdown">
          <div class="menu-option" onclick="openLink('https://obsidianmango.github.io/ObsidianMango/help')">Sorry cant help ya</div>
        </div>
      </div>
    </div>
    <div class="window-content" onclick="bringWindowToFront(this.parentNode)">
      ${innerHtml}
    </div>
    <div class="resize-handle" onmousedown="beginResize(event, this.parentNode)"></div>
  `;
  desktop.appendChild(newWin);
  
  // For Clock window, toggle UI on double-click of content area
  if (title === "Clock") {
    let contentArea = newWin.querySelector('.window-content');
    contentArea.ondblclick = function(e) {
      toggleClockUI(newWin);
    };
  }
  
  return newWin;
}
  
/* Toggle Clock UI: hide or show title and menu bar */
function toggleClockUI(clockWin) {
  let titleBar = clockWin.querySelector('.title-bar');
  let menuBar = clockWin.querySelector('.window-menu-bar');
  let contentArea = clockWin.querySelector('.window-content');
  if (titleBar.style.display === "none") {
    titleBar.style.display = "flex";
    menuBar.style.display = "flex";
    contentArea.style.top = "40px";
  } else {
    titleBar.style.display = "none";
    menuBar.style.display = "none";
    contentArea.style.top = "0px";
  }
}
  
/* Clock App functions */
function openClockApp() {
  let iconURL = "";
  if (arguments.length && arguments[0] instanceof HTMLElement) {
    let img = arguments[0].querySelector("img");
    if (img) iconURL = img.src;
  }
  // Optionally, custom sizes for Clock can be passed.
  let customWidth = (arguments.length > 1) ? arguments[1] : null;
  let customHeight = (arguments.length > 2) ? arguments[2] : null;
  const clockHtml = `<div id="clockDisplay" class="clock-display">--:--:--</div>`;
  createWindow('Clock', clockHtml, iconURL, customWidth, customHeight);
  if (clockInterval) clearInterval(clockInterval);
  clockMode = 'digital';
  clockInterval = setInterval(updateClock, 1000);
}
function updateClock() {
  const clockWin = document.getElementById('clockWindow');
  if (!clockWin) return;
  if (clockMode === 'digital') {
    const clockDisplay = clockWin.querySelector('#clockDisplay');
    if (clockDisplay) {
      let now = new Date();
      clockDisplay.textContent = now.toLocaleTimeString();
      adjustClockFont(clockWin);
    }
  } else {
    let canvas = clockWin.querySelector('#clockCanvas');
    if (canvas) drawAnalogClock(canvas);
  }
}
function adjustClockFont(clockWin) {
  const clockDisplay = clockWin.querySelector('#clockDisplay');
  if (clockDisplay) {
    let container = clockWin.querySelector('.window-content');
    let size = Math.min(container.clientWidth, container.clientHeight) * 0.3;
    clockDisplay.style.fontSize = size + "px";
  }
}
function toggleClockMode(event) {
  event.stopPropagation();
  const clockWin = document.getElementById('clockWindow');
  if (!clockWin) return;
  const contentArea = clockWin.querySelector('.window-content');
  if (clockMode === 'digital') {
    clockMode = 'analog';
    contentArea.innerHTML = `<canvas id="clockCanvas"></canvas>`;
    clearInterval(clockInterval);
    drawAnalogClock(document.getElementById('clockCanvas'));
    clockCanvasInterval = setInterval(updateClock, 1000);
  } else {
    clockMode = 'digital';
    clearInterval(clockCanvasInterval);
    contentArea.innerHTML = `<div id="clockDisplay" class="clock-display">--:--:--</div>`;
    updateClock();
    clockInterval = setInterval(updateClock, 1000);
  }
}
/* Analog clock drawing */
function drawAnalogClock(canvas) {
  if (!canvas.getContext) return;
  const ctx = canvas.getContext("2d");
  canvas.width = canvas.offsetWidth;
  canvas.height = canvas.offsetHeight;
  const radius = Math.min(canvas.width, canvas.height) / 2;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.translate(canvas.width / 2, canvas.height / 2);
  ctx.beginPath();
  ctx.arc(0, 0, radius * 0.9, 0, 2 * Math.PI);
  ctx.fillStyle = "#fff";
  ctx.fill();
  ctx.strokeStyle = "#000";
  ctx.lineWidth = radius * 0.05;
  ctx.stroke();
  ctx.font = radius * 0.15 + "px sans-serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  for (let num = 1; num <= 12; num++) {
    let ang = num * Math.PI / 6;
    ctx.rotate(ang);
    ctx.translate(0, -radius * 0.75);
    ctx.rotate(-ang);
    ctx.fillText(num.toString(), 0, 0);
    ctx.rotate(ang);
    ctx.translate(0, radius * 0.75);
    ctx.rotate(-ang);
  }
  let now = new Date();
  let hour = now.getHours() % 12;
  let minute = now.getMinutes();
  let second = now.getSeconds();
  let hourAng = (hour * Math.PI / 6) + (minute * Math.PI / (6 * 60)) + (second * Math.PI / (360 * 60));
  drawHand(ctx, hourAng, radius * 0.5, radius * 0.07);
  let minuteAng = (minute * Math.PI / 30) + (second * Math.PI / (30 * 60));
  drawHand(ctx, minuteAng, radius * 0.8, radius * 0.07);
  let secondAng = second * Math.PI / 30;
  drawHand(ctx, secondAng, radius * 0.9, radius * 0.02, "#FF0000");
  ctx.translate(-canvas.width / 2, -canvas.height / 2);
}
function drawHand(ctx, pos, length, width, color = "#000") {
  ctx.beginPath();
  ctx.lineWidth = width;
  ctx.lineCap = "round";
  ctx.strokeStyle = color;
  ctx.moveTo(0, 0);
  ctx.rotate(pos);
  ctx.lineTo(0, -length);
  ctx.stroke();
  ctx.rotate(-pos);
}

/* Settings App */
function openSettingsApp() {
  let iconURL = "";
  if (arguments.length && arguments[0] instanceof HTMLElement) {
    let img = arguments[0].querySelector("img");
    if (img) iconURL = img.src;
  }
  const settingsHtml = `
    <form class="settings-form">
      <div>
        <label for="bgImage">Background Image URL:</label>
        <input type="text" id="bgImage" placeholder="Enter an image URL" />
      </div>
      <div>
        <label for="bgMode">Background Mode:</label>
        <select id="bgMode">
          <option value="stretch">Stretch</option>
          <option value="tile">Tile</option>
          <option value="center">Center</option>
        </select>
      </div>
      <div>
        <label for="defaultPattern">Default Pattern:</label>
        <select id="defaultPattern">
          <option value="none">None</option>
          <option value="patternBlue">Blue Pattern</option>
          <option value="patternGray">Gray Pattern</option>
          <option value="patternGreen">Green Pattern</option>
          <option value="patternRed">Red Pattern</option>
        </select>
      </div>
      <button type="button" onclick="applySettings()">Apply</button>
    </form>
  `;
  createWindow('Settings', settingsHtml, iconURL);
}
function applySettings() {
  const bgUrl = document.getElementById('bgImage').value.trim();
  const bgMode = document.getElementById('bgMode').value;
  const defaultPattern = document.getElementById('defaultPattern').value;
  const desktop = document.getElementById('desktop');
  
  let finalBg = "";
  // Prioritize custom image URL
  if(bgUrl !== "") {
    finalBg = `url('${bgUrl}')`;
  } else if(defaultPattern !== "none") {
    // Map default patterns to URLs (you can replace these URLs with your own images)
    const patternMap = {
      patternBlue: "https://img.freepik.com/free-vector/hand-drawn-digital-camo-pattern-illustration_23-2149290100.jpg",
      patternGray: "https://img.freepik.com/free-vector/hand-drawn-flat-design-digital-camo-pattern_23-2149272450.jpg",
      patternGreen: "http://cs.gettysburg.edu/~duncjo01/archive/patterns/windows/Windows%203.1/ImageHandler-16.png",
      patternRed: "https://64.media.tumblr.com/ca508e440fa27648bd8b77b57c964705/50072f7016dd2f1d-c0/s540x810/830ce0555b5802771a38859df5bce7b69523982e.png"
    };
    finalBg = `url('${patternMap[defaultPattern]}')`;
  } else {
    finalBg = "none";
  }
  
  desktop.style.backgroundImage = finalBg;
  
  // Apply background mode
  if(bgMode === 'tile'){
    desktop.style.backgroundRepeat = 'repeat';
    desktop.style.backgroundSize = 'auto';
  } else if(bgMode === 'stretch'){
    desktop.style.backgroundRepeat = 'no-repeat';
    desktop.style.backgroundSize = 'cover';
  } else if(bgMode === 'center'){
    desktop.style.backgroundRepeat = 'no-repeat';
    desktop.style.backgroundPosition = 'center';
    desktop.style.backgroundSize = 'auto';
  }
}
  
/* Folder and App functions */
function openFolder(folderName, iconEl, customWidth, customHeight) {
  let iconURL = "";
  if (iconEl) {
    let img = iconEl.querySelector("img");
    if (img) iconURL = img.src;
  }
  let contentHtml = "";
  if (folderName === 'Accessories') {
    contentHtml = `
<div class="icon-grid">
   <div class="app-icon" onclick="selectIcon(event)" ondblclick="openApp('TM8K','https://obsidianmango.github.io/ObsidianMango/tm8k.html', this)" onmousedown="potentialDragIcon(event, this)">
          <img src="https://64.media.tumblr.com/0a08eeab5e33e86d669773a4b10568cf/ec0e9944f83e1c71-ca/s540x810/1b4536d1b8c5ae2eb3e3e40b4d9076f486bcd999.png" alt="TM8K">
          <div class="app-label">TM8K</div>
        </div>
        <div class="app-icon" onclick="selectIcon(event)" ondblclick="openApp('D20','https://obsidianmango.github.io/ObsidianMango/d20v2.html', this)" onmousedown="potentialDragIcon(event, this)">
          <img src="https://64.media.tumblr.com/da4f429cfbaef0a636cdcd91a380bf51/72bfadade19b5016-af/s540x810/ca929efd7ceb803f8afa7ed0cf795d40ad85c0bc.png" alt="D20">
          <div class="app-label">D20</div>
        </div>
        <div class="app-icon" onclick="selectIcon(event)" ondblclick="openApp('Art','https://obsidianmango.github.io/ObsidianMango/art.html', this)" onmousedown="potentialDragIcon(event, this)">
          <img src="https://64.media.tumblr.com/c98bf3520ef34e85968215d4e6a8d263/fdc6c7af1442736b-18/s540x810/4dd55fdfeaca3a1d4067ae4a76e40e5dd868f6c1.png" alt="Art">
          <div class="app-label">Met Art</div>
        </div>
        <div class="app-icon" onclick="selectIcon(event)" ondblclick="openApp('deemu','https://obsidianmango.github.io/ObsidianMango/deemu/deemu.html', this)" onmousedown="potentialDragIcon(event, this)">
          <img src="https://64.media.tumblr.com/6b96b0019593914f98b990f2d316bc40/62ad79e9a79d7f0c-90/s540x810/c12134753b7609f1ec83ad0393470d5ee64ccb9d.png" alt="deemu">
          <div class="app-label">Demos</div>
        </div>
        <div class="app-icon" onclick="selectIcon(event)" ondblclick="openApp('History','https://obsidianmango.github.io/ObsidianMango/es.html', this)" onmousedown="potentialDragIcon(event, this)">
          <img src="https://64.media.tumblr.com/88dcb597aeeba374bbc2c7b000db331d/012460aae14156cc-31/s540x810/929612591f0d2170ef1ff21a2ed516044849d62c.gifv" alt="History">
          <div class="app-label">History</div>
        </div>
        <div class="app-icon" onclick="selectIcon(event)" ondblclick="openApp('Bibliomance','https://obsidianmango.github.io/ObsidianMango/biblioma.html', this)" onmousedown="potentialDragIcon(event, this)">
          <img src="https://obsidianmango.github.io/ObsidianMango/bilbiomancy/logo.png" alt="Bibliomance">
          <div class="app-label">Bibliomance</div>
        </div>
        <div class="app-icon" onclick="selectIcon(event)" ondblclick="openApp('Boozy','https://obsidianmango.github.io/ObsidianMango/boozy.html', this)" onmousedown="potentialDragIcon(event, this)">
          <img src="https://64.media.tumblr.com/b2853070bfffa081e7bf17b1127d14ff/65031f0327a8dcd2-db/s540x810/70599274475943ff722a545ab60a5c0840c9148c.png" alt="Boozy">
          <div class="app-label">Boozy</div>
        </div>
           <div class="app-icon" onclick="selectIcon(event)" ondblclick="openApp('Movies','https://obsidianmango.github.io/ObsidianMango/mov.html', this)" onmousedown="potentialDragIcon(event, this)">
          <img src="https://64.media.tumblr.com/dfcc62188383cdf5ccde66bde2159a02/917a0b5910538b4e-7a/s540x810/17938103c0f162308675f6f28e3373bce8259e48.png" alt="Movies">
          <div class="app-label">Movies</div>
          </div>
        <div class="app-icon" onclick="selectIcon(event)" ondblclick="openApp('Magick8','https://obsidianmango.github.io/ObsidianMango/magick8.html', this)" onmousedown="potentialDragIcon(event, this)">
          <img src="https://64.media.tumblr.com/2bc38069340bc8f97ff0b28165c1a800/0d0851ba5df612f4-cd/s540x810/9a0e7dec4cf47c596a8d85ac6a522d253e7b4de1.png" alt="Magick8">
          <div class="app-label">8Ball</div>
        
        </div>
</div>
    `;
  } else if (folderName === 'Games') {
    contentHtml = `
      <div class="icon-grid">
        <div class="app-icon" onclick="selectIcon(event)" ondblclick="openApp('MangoWarz','https://obsidianmango.github.io/ObsidianMango/mangowarz.html', this)" onmousedown="potentialDragIcon(event, this)">
          <img src="https://64.media.tumblr.com/1b0333ce6e930471020a676c04f71411/deb2d3c4404a23f5-b4/s540x810/58ac35fdfe24bfc174890c618f53d9c16ccb8a52.png" alt="MangoWarz">
          <div class="app-label">MangoWarz</div>
        </div>
        <div class="app-icon" onclick="selectIcon(event)" ondblclick="openApp('BurgBoom','https://obsidianmango.github.io/ObsidianMango/burgerboom/game.html', this)" onmousedown="potentialDragIcon(event, this)">
          <img src="https://64.media.tumblr.com/6f2f004a6c1646179afbd886d2063f87/8ef425fdcb0a0325-1b/s540x810/4876a053e1793d00e17cb0376c00be4fecbbcc38.png" alt="BurgBoom">
          <div class="app-label">BurgBoom</div>
        </div>
        <div class="app-icon" onclick="selectIcon(event)" ondblclick="openApp('Carptunnel','https://obsidianmango.github.io/ObsidianMango/clickgame.html', this)" onmousedown="potentialDragIcon(event, this)">
          <img src="https://64.media.tumblr.com/ee635663de99bfaca5182e9d6f6bdb6f/09cd73b3ed6392ac-15/s540x810/3d3bf3ead010f5fe354eef901f8e011477180c07.png" alt="Carptunnel">
          <div class="app-label">Carptunnel</div>
        </div>
        <div class="app-icon" onclick="selectIcon(event)" ondblclick="openApp('SLOTS','https://obsidianmango.github.io/ObsidianMango/slot.html', this)" onmousedown="potentialDragIcon(event, this)">
          <img src="https://64.media.tumblr.com/c0d5cea1d318de3c382c9da611f937f5/22addad21e5b766b-dd/s540x810/a957e56da3b900eb2cf3fcabe4c05aa486d2fa72.png" alt="SLOTS">
          <div class="app-label">SLOTS</div>
        </div>
        <div class="app-icon" onclick="selectIcon(event)" ondblclick="openApp('EBArena','https://obsidianmango.github.io/ObsidianMango/eba.html', this)" onmousedown="potentialDragIcon(event, this)">
          <img src="https://64.media.tumblr.com/ccdea0434a6f2002ddbee10ff57592f5/d726769e20fd9bd0-a6/s540x810/9d9a0238cb7fa68bdc64a931f377489c2fd63b03.gifv" alt="EBArena">
          <div class="app-label">EBArena</div>
        </div>
        <div class="app-icon" onclick="selectIcon(event)" ondblclick="openApp('MCQ','https://obsidianmango.github.io/ObsidianMango/MCQ.html', this)" onmousedown="potentialDragIcon(event, this)">
          <img src="https://64.media.tumblr.com/850c6a84fff00142bc287c4be7f557a6/e6b583110e64e275-9a/s540x810/06f95b310bd75cccf8b02c5ab9d1cddf48099fe3.gifv" alt="MCQ">
          <div class="app-label">MCQ</div>
        </div>
        <div class="app-icon" onclick="selectIcon(event)" ondblclick="openApp('WSearch','https://obsidianmango.github.io/ObsidianMango/word.html', this)" onmousedown="potentialDragIcon(event, this)">
          <img src="https://64.media.tumblr.com/f17e65f649ec0df0f76ace9fb87a234f/100a984139b94771-3b/s540x810/27da6bc1824eda99c185db7c027776db5a76f99a.png" alt="WSearch">
          <div class="app-label">WSearch</div>
        </div>
        <div class="app-icon" onclick="selectIcon(event)" ondblclick="openApp('FrogNom','https://obsidianmango.github.io/ObsidianMango/frog.html', this)" onmousedown="potentialDragIcon(event, this)">
          <img src="https://64.media.tumblr.com/2f56473b57bc50a12854f379cf58f86a/26a3268c069ed552-4f/s540x810/81a6af2b52bc24998f666ba1636714548bc938ef.gifv" alt="FrogNom">
          <div class="app-label">FrogNom</div>
        </div>
        <div class="app-icon" onclick="selectIcon(event)" ondblclick="openApp('15Puzzle','https://obsidianmango.github.io/ObsidianMango/15p.html', this)" onmousedown="potentialDragIcon(event, this)">
          <img src="https://64.media.tumblr.com/fdeb688d5a8dd59ab3d07f946119443e/3d9beda43813c13b-b7/s540x810/f9f3fb8e6f3809bcb26bfb87e05703240f53e19d.png" alt="15Puzzle">
          <div class="app-label">15Puzzle</div>
        </div>
        <div class="app-icon" onclick="selectIcon(event)" ondblclick="openApp('BlkBrkr','https://obsidianmango.github.io/ObsidianMango/tile.html', this)" onmousedown="potentialDragIcon(event, this)">
          <img src="https://64.media.tumblr.com/1c7267003f9903706306b90b8b24baff/dc3af50aa3d9ef8a-bb/s540x810/f21aec84940f768a77bcc60e4f86956a433a63c0.png" alt="BlkBrkr">
          <div class="app-label">BlkBrkr</div>
        </div>
        <div class="app-icon" onclick="selectIcon(event)" ondblclick="openApp('Cuber','https://obsidianmango.github.io/ObsidianMango/cuber.html', this)" onmousedown="potentialDragIcon(event, this)">
          <img src="https://64.media.tumblr.com/e82e4f4b9de9c1f9db05cd33eb160291/a08066bf01c4a9e8-dd/s540x810/1699e67a6ec50ec282466a567871ceafc135a304.png" alt="Cuber">
          <div class="app-label">Cuber</div>
        </div>
        <div class="app-icon" onclick="selectIcon(event)" ondblclick="openApp('BounceBall','https://obsidianmango.github.io/ObsidianMango/bounce.html', this)" onmousedown="potentialDragIcon(event, this)">
            <img src="https://64.media.tumblr.com/248b71f8e92ffe91449627d9e7b81415/bc70dc16d3965b96-d6/s540x810/ca9acca5b39eb9aed24c8b067f22f3f0362b7819.png" alt="BounceBall">
            <div class="app-label">BounceBall</div>
        </div>
      </div>
    `;
  } else if (folderName === 'Main') {
    contentHtml = `
      <div class="icon-grid">
        <div class="app-icon" onclick="selectIcon(event)" ondblclick="openApp('Calculator','https://obsidianmango.github.io/ObsidianMango/calc.html', this)" onmousedown="potentialDragIcon(event, this)">
          <img src="https://64.media.tumblr.com/45903fa4bf8dc8ec74973a4ce0b14f13/922dc695586878f9-8b/s540x810/8dfaae647f5260b06b09058215712307dbedfbd9.png" alt="Calculator">
          <div class="app-label">Calculator</div>
        </div>
        <div class="app-icon" onclick="selectIcon(event)" ondblclick="openApp('Calendar','https://obsidianmango.github.io/ObsidianMango/cal.html', this)" onmousedown="potentialDragIcon(event, this)">
          <img src="https://64.media.tumblr.com/2355bfcfae7d3158507e902509b283f2/8e9f01d7a20fb988-08/s540x810/9abe6b74d7d7f32af00a8540ea67b940fc8f1966.png" alt="Calendar">
          <div class="app-label">Calendar</div>
        </div>
           <div class="app-icon" onclick="selectIcon(event)" ondblclick="openApp('Write','https://obsidianmango.github.io/ObsidianMango/note.html', this)" onmousedown="potentialDragIcon(event, this)">
          <img src="https://64.media.tumblr.com/73f34eb6543708c5b237fd739b389a55/a76707adad47a36a-a6/s540x810/d5ca09678f2f10b2fa2f553a2c28a650fe3732b4.png" alt="Calendar">
          <div class="app-label">Write</div>
        </div>
      </div>
    `;
  } else {
    contentHtml = `<div style="padding:10px;"><p>This is the ${folderName} folder. Customize as needed.</p></div>`;
  }
  // For folder windows, default size is 500x300 if no custom sizes provided.
  let defaultWidth = (customWidth !== undefined) ? customWidth : 500;
  let defaultHeight = (customHeight !== undefined) ? customHeight : 300;
  createWindow(folderName, contentHtml, iconURL, defaultWidth, defaultHeight);
}
function openApp(appName, url, iconEl, customWidth, customHeight) {
  let iconURL = "";
  if (iconEl) {
    let img = iconEl.querySelector("img");
    if (img) iconURL = img.src;
  }
  const iframeHtml = `<iframe src="${url}" style="width:100%; height:100%; border:none;"></iframe>`;
  createWindow(appName, iframeHtml, iconURL, customWidth, customHeight);
}
function initTouchSupport() {
  document.addEventListener("touchstart", touchHandler, {passive: false});
  document.addEventListener("touchmove", touchHandler, {passive: false});
  document.addEventListener("touchend", touchHandler, {passive: false});
  document.addEventListener("touchcancel", touchHandler, {passive: false});
}

function touchHandler(event) {
  var touches = event.changedTouches,
      first = touches[0],
      type = "";
  
  switch(event.type) {
    case "touchstart":
      type = "mousedown";
      // Mark that no movement has happened yet.
      first.target.__touchMoved = false;
      break;
    case "touchmove":
      type = "mousemove";
      first.target.__touchMoved = true;
      break;
    case "touchend":
      type = "mouseup";
      break;
    default:
      return;
  }
  
  // Create and dispatch the simulated mouse event.
  var simulatedEvent = new MouseEvent(type, {
    bubbles: true,
    cancelable: true,
    view: window,
    clientX: first.clientX,
    clientY: first.clientY
  });
  first.target.dispatchEvent(simulatedEvent);
  
  if (event.type === "touchend") {
    // Get current time and compare with last tap time on this target.
    var currentTime = new Date().getTime();
    var lastTap = first.target.__lastTap || 0;
    var tapGap = currentTime - lastTap;
    
    if (tapGap < 300 && !first.target.__touchMoved) {
      // Dispatch a simulated dblclick event.
      var dblClickEvent = new MouseEvent("dblclick", {
        bubbles: true,
        cancelable: true,
        view: window,
        clientX: first.clientX,
        clientY: first.clientY
      });
      first.target.dispatchEvent(dblClickEvent);
      first.target.__lastTap = 0; // Reset after double tap.
    } else {
      // If not a double tap and no movement, dispatch a click event.
      if (!first.target.__touchMoved) {
        var clickEvent = new MouseEvent("click", {
          bubbles: true,
          cancelable: true,
          view: window,
          clientX: first.clientX,
          clientY: first.clientY
        });
        first.target.dispatchEvent(clickEvent);
      }
      first.target.__lastTap = currentTime;
    }
  }
  
  event.preventDefault();
}

// Initialize touch support
initTouchSupport();
</script>
</body>
</html>
