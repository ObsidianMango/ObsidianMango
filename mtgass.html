<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Prosper Engine iPad</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <style>
        body { background: #0c0c0e; color: #e2e8f0; height: 100vh; width: 100vw; overflow: hidden; position: fixed; font-family: sans-serif; }
        .zone { border: 2px solid #27272a; border-radius: 12px; min-height: 80px; display: flex; flex-wrap: wrap; gap: 8px; padding: 10px; overflow-y: auto; background: rgba(255,255,255,0.02); }
        .drop-active { border-color: #f97316; background: rgba(249, 115, 22, 0.1); }

        /* iPad Specific Card Sizing */
        .card-container { 
            width: 85px; 
            touch-action: none; 
            position: relative; 
            z-index: 10;
            transition: transform 0.2s;
        }
        
        /* Tap to Zoom (iPad workaround for no hover) */
        .card-container.selected { 
            transform: scale(2.2) translateY(-40px) !important; 
            z-index: 9999 !important; 
        }

        .card-img { width: 100%; border-radius: 6px; pointer-events: none; border: 1px solid #444; }
        .tapped { transform: rotate(90deg); margin: 0 15px; }

        /* Fixed Controls for Touch */
        .control-panel { 
            position: absolute; bottom: -12px; left: 50%; transform: translateX(-50%); 
            display: flex; gap: 4px; background: #000; padding: 4px 8px; border-radius: 8px; 
            border: 1px solid #f97316; visibility: hidden; 
        }
        .selected .control-panel { visibility: visible; }
        .btn-ctrl { color: white; font-size: 12px; font-weight: bold; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 4px; }
        
        .counter-badge { position: absolute; top: -10px; right: -10px; background: #ef4444; color: white; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; border: 2px solid #000; }
    </style>
</head>
<body class="flex flex-col">

    <header class="p-3 bg-zinc-900 border-b border-zinc-800 flex justify-between items-center z-50">
        <div class="flex items-center gap-4">
            <h1 class="text-orange-500 font-black text-lg">PROSPER</h1>
            <div class="flex items-center bg-black rounded-lg px-3 py-1 border border-zinc-700">
                <button onclick="adjStat('life', -1)" class="text-red-500 font-bold text-xl px-2">-</button>
                <span id="life-display" class="font-mono text-xl px-2">40</span>
                <button onclick="adjStat('life', 1)" class="text-green-500 font-bold text-xl px-2">+</button>
            </div>
            <div class="flex items-center bg-amber-900/20 rounded-lg px-3 py-1 border border-amber-600/50">
                <button onclick="adjStat('treasures', -1)" class="text-amber-500 font-bold px-2">-</button>
                <span id="treasures-display" class="font-mono text-xl px-2 text-amber-400">0</span>
                <button onclick="adjStat('treasures', 1)" class="text-amber-500 font-bold px-2">+</button>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="openBinder()" class="bg-zinc-800 px-4 py-2 rounded text-xs font-bold uppercase">Library</button>
            <button onclick="drawRandom()" class="bg-orange-600 px-4 py-2 rounded text-xs font-bold uppercase">Draw</button>
        </div>
    </header>

    <main class="flex-grow p-2 grid grid-cols-6 grid-rows-4 gap-2 overflow-hidden">
        <div class="col-span-5 row-span-3 flex flex-col gap-2">
            <div id="zone-field" class="zone flex-grow" data-label="Battlefield"></div>
            <div id="zone-lands" class="zone h-1/4" data-label="Lands"></div>
        </div>

        <div class="col-span-1 row-span-4 flex flex-col gap-2">
            <div id="zone-exile" class="zone flex-grow border-orange-500/30" data-label="Exile"></div>
            <div id="zone-grave" class="zone h-1/4" data-label="Grave"></div>
            <div id="zone-commander" class="zone h-24" data-label="CMD"></div>
        </div>

        <div class="col-span-5 row-span-1">
            <div id="zone-hand" class="zone h-full border-none justify-center items-center -space-x-8"></div>
        </div>
    </main>

    <div id="binder-modal" class="fixed inset-0 bg-black/95 z-[9999] hidden p-6 overflow-y-auto">
        <div class="flex justify-between items-center mb-6">
            <input type="text" id="binder-search" oninput="renderBinder()" placeholder="Search..." class="bg-zinc-900 border border-zinc-700 px-4 py-3 rounded-lg w-full mr-4">
            <button onclick="closeBinder()" class="text-4xl">&times;</button>
        </div>
        <div id="binder-grid" class="grid grid-cols-3 md:grid-cols-6 gap-4"></div>
    </div>

    <script>
        const fullDeck = [
            { qty: 1, name: "Prosper, Tome-Bound", category: "Commander" },
            { qty: 1, name: "Dockside Extortionist" }, { qty: 1, name: "Professional Face-Breaker" },
            { qty: 1, name: "Xorn" }, { qty: 1, name: "Academy Manufactor" },
            { qty: 1, name: "Grim Hireling" }, { qty: 1, name: "Mayhem Devil" },
            { qty: 1, name: "Marionette Master" }, { qty: 1, name: "Birgi, God of Storytelling" },
            { qty: 1, name: "Etali, Primal Storm" }, { qty: 1, name: "Dauthi Voidwalker" },
            { qty: 1, name: "Ragavan, Nimble Pilferer" }, { qty: 1, name: "Author of Shadows" },
            { qty: 1, name: "Gonti, Lord of Luxury" }, { qty: 1, name: "Dire Fleet Hoarder" },
            { qty: 1, name: "Kalain, Reclusive Painter" }, { qty: 1, name: "Magda, Brazen Outlaw" },
            { qty: 1, name: "Loyal Apprentice" }, { qty: 1, name: "Goldspan Dragon" },
            { qty: 1, name: "Valakut Exploration" }, { qty: 1, name: "Stolen Strategy" },
            { qty: 1, name: "Wild-Magic Sorcerer" }, { qty: 1, name: "Dream Devourer" },
            { qty: 1, name: "Storm-Kiln Artist" }, { qty: 1, name: "Tectonic Giant" },
            { qty: 1, name: "Laelia, the Blade Reforged" }, { qty: 1, name: "Orcish Bowmasters" },
            { qty: 1, name: "Opposition Agent" }, { qty: 1, name: "Atsushi, the Blazing Sky" },
            { qty: 1, name: "Jeska's Will" }, { qty: 1, name: "Light Up the Stage" },
            { qty: 1, name: "Chaos Warp" }, { qty: 1, name: "Bedevil" },
            { qty: 1, name: "Terminate" }, { qty: 1, name: "Vandalblast" },
            { qty: 1, name: "Toxic Deluge" }, { qty: 1, name: "Deadly Rollick" },
            { qty: 1, name: "Deflecting Swat" }, { qty: 1, name: "Tibalt's Trickery" },
            { qty: 1, name: "Feed the Swarm" }, { qty: 1, name: "Night's Whisper" },
            { qty: 1, name: "Commune with Lava" }, { qty: 1, name: "You Find Some Prisoners" },
            { qty: 1, name: "Reckless Impulse" }, { qty: 1, name: "Wrenn's Resolve" },
            { qty: 1, name: "Damnation" }, { qty: 1, name: "Blasphemous Act" },
            { qty: 1, name: "Rakdos Charm" }, { qty: 1, name: "Invert Polarity" },
            { qty: 1, name: "Mizzix's Mastery" }, { qty: 1, name: "Brass's Bounty" },
            { qty: 1, name: "Sol Ring" }, { qty: 1, name: "Arcane Signet" },
            { qty: 1, name: "Rakdos Signet" }, { qty: 1, name: "Talisman of Indulgence" },
            { qty: 1, name: "Bucknard's Everfull Purse" }, { qty: 1, name: "Lightning Greaves" },
            { qty: 1, name: "Swiftfoot Boots" }, { qty: 1, name: "Sensei's Divining Top" },
            { qty: 1, name: "Skullclamp" }, { qty: 1, name: "Bolas's Citadel" },
            { qty: 1, name: "Aetherflux Reservoir" }, { qty: 1, name: "Shadowspear" },
            { qty: 1, name: "Revel in Riches" }, { qty: 1, name: "Black Market Connections" },
            { qty: 1, name: "Command Tower" }, { qty: 1, name: "Luxury Suite" },
            { qty: 1, name: "Graven Cairns" }, { qty: 1, name: "Dragonskull Summit" },
            { qty: 1, name: "Mount Doom" }, { qty: 1, name: "Bloodstained Mire" },
            { qty: 1, name: "Badlands" }, { qty: 1, name: "Blood Crypt" },
            { qty: 1, name: "Urborg, Tomb of Yawgmoth" }, { qty: 1, name: "Cabal Coffers" },
            { qty: 1, name: "Ancient Tomb" }, { qty: 1, name: "Bojuka Bog" },
            { qty: 1, name: "Reliquary Tower" }, { qty: 11, name: "Mountain" }, { qty: 11, name: "Swamp" }
        ];

        let library = [];
        let state = { life: 40, treasures: 0, hand: [], field: [], lands: [], exile: [], grave: [], commander: [] };

        async function init() {
            let id = 0;
            fullDeck.forEach(c => {
                for(let i=0; i<c.qty; i++) {
                    library.push({ ...c, id: `c-${id++}`, tapped: false, counters: 0, 
                    img: `https://api.scryfall.com/cards/named?exact=${encodeURIComponent(c.name)}&format=image` });
                }
            });
            const cmdIdx = library.findIndex(c => c.category === "Commander");
            state.commander.push(library.splice(cmdIdx, 1)[0]);
            render();
            setupInteract();
        }

        function setupInteract() {
            interact('.card-container').draggable({
                inertia: false,
                autoScroll: true,
                listeners: {
                    move(event) {
                        const t = event.target;
                        const x = (parseFloat(t.getAttribute('data-x')) || 0) + event.dx;
                        const y = (parseFloat(t.getAttribute('data-y')) || 0) + event.dy;
                        t.style.transform = `translate(${x}px, ${y}px)`;
                        t.setAttribute('data-x', x); t.setAttribute('data-y', y);
                        t.classList.remove('selected'); // Close zoom while dragging
                    },
                    end(event) {
                        event.target.style.transform = '';
                        event.target.setAttribute('data-x', 0); event.target.setAttribute('data-y', 0);
                    }
                }
            }).on('tap', function(event) {
                const isSelected = event.currentTarget.classList.contains('selected');
                document.querySelectorAll('.card-container').forEach(c => c.classList.remove('selected'));
                if(!isSelected) event.currentTarget.classList.add('selected');
            });

            interact('.zone').dropzone({
                accept: '.card-container',
                ondrop: (e) => moveCard(e.relatedTarget.id, e.target.id.replace('zone-', ''))
            });
        }

        function moveCard(id, to) {
            let card;
            ['hand','field','lands','exile','grave','commander'].forEach(z => {
                const i = state[z].findIndex(c => c.id === id);
                if(i !== -1) card = state[z].splice(i,1)[0];
            });
            if(!card) { const i = library.findIndex(c => c.id === id); if(i !== -1) card = library.splice(i,1)[0]; }
            if(card) { state[to].push(card); render(); }
        }

        function toggleTap(id, e) {
            e.stopPropagation();
            ['field','lands','exile','commander'].forEach(z => {
                const c = state[z].find(x => x.id === id);
                if(c) c.tapped = !c.tapped;
            });
            render();
        }

        function modCounter(id, n, e) {
            e.stopPropagation();
            ['field','lands','exile'].forEach(z => {
                const c = state[z].find(x => x.id === id);
                if(c) c.counters = Math.max(0, c.counters + n);
            });
            render();
        }

        function adjStat(stat, n) { state[stat] = Math.max(0, state[stat] + n); render(); }
        function drawRandom() { if(library.length) { state.hand.push(library.splice(Math.floor(Math.random()*library.length),1)[0]); render(); } }
        function openBinder() { document.getElementById('binder-modal').classList.remove('hidden'); renderBinder(); }
        function closeBinder() { document.getElementById('binder-modal').classList.add('hidden'); }
        function renderBinder() {
            const q = document.getElementById('binder-search').value.toLowerCase();
            document.getElementById('binder-grid').innerHTML = library.filter(c => c.name.toLowerCase().includes(q))
                .map(c => `<img src="${c.img}" class="rounded-lg w-full" onclick="moveCard('${c.id}', 'hand'); closeBinder()">`).join('');
        }

        function render() {
            document.getElementById('life-display').innerText = state.life;
            document.getElementById('treasures-display').innerText = state.treasures;
            ['hand','field','lands','exile','grave','commander'].forEach(z => {
                document.getElementById(`zone-${z}`).innerHTML = state[z].map(c => `
                    <div class="card-container ${c.tapped ? 'tapped' : ''}" id="${c.id}">
                        <img src="${c.img}" class="card-img">
                        <div class="control-panel">
                            <button class="btn-ctrl bg-blue-600" onclick="toggleTap('${c.id}', event)">T</button>
                            <button class="btn-ctrl bg-green-600" onclick="modCounter('${c.id}', 1, event)">+</button>
                            <button class="btn-ctrl bg-red-600" onclick="modCounter('${c.id}', -1, event)">-</button>
                        </div>
                        ${c.counters > 0 ? `<div class="counter-badge">${c.counters}</div>` : ''}
                    </div>
                `).join('');
            });
        }
        init();
    </script>
</body>
</html>
