<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Prosper Engine - iPad Debugged</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
    <style>
        body { background: #0c0c0e; color: #e2e8f0; height: 100vh; width: 100vw; overflow: hidden; position: fixed; display: grid; grid-template-rows: auto 1fr auto; }
        
        /* Zones with internal scrolling only */
        .zone { border: 1px solid #27272a; border-radius: 8px; background: rgba(255,255,255,0.02); display: flex; flex-wrap: wrap; gap: 10px; padding: 12px; overflow-y: auto; align-content: flex-start; }
        .drop-active { border-color: #f97316; background: rgba(249, 115, 22, 0.1); }

        /* Card Container Logic */
        .card-container { width: 80px; touch-action: none; position: relative; z-index: 10; transition: transform 0.2s; }
        
        /* Zoom Logic for iPad */
        .card-container.selected { transform: scale(2.4) !important; z-index: 9999 !important; }
        .zone-hand .card-container.selected { transform: scale(2.4) translateY(-60px) !important; }

        .card-img { width: 100%; border-radius: 6px; pointer-events: none; border: 1px solid #444; display: block; }
        
        /* Rotation Logic */
        .tapped { transform: rotate(90deg); margin: 10px 18px; }

        /* Responsive Controls */
        .control-panel { 
            position: absolute; bottom: -15px; left: 50%; transform: translateX(-50%); 
            display: flex; gap: 4px; background: #000; padding: 4px; border-radius: 6px; 
            border: 1px solid #f97316; visibility: hidden; pointer-events: auto;
        }
        .selected .control-panel { visibility: visible; }
        
        /* Shift controls when tapped so they don't go off-screen */
        .tapped.selected .control-panel { 
            transform: rotate(-90deg) translate(40px, 30px); 
            bottom: auto; left: auto;
        }

        .btn-ctrl { color: white; font-size: 14px; font-weight: bold; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 4px; background: #18181b; border: 1px solid #3f3f46; }
        
        .counter-badge { position: absolute; top: -12px; right: -12px; background: #ef4444; color: white; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; border: 2px solid #000; }
        
        h3 { font-size: 9px; text-transform: uppercase; color: #52525b; font-weight: 800; margin-bottom: 2px; letter-spacing: 0.05em; }
    </style>
</head>
<body>

    <header class="p-3 bg-zinc-900 border-b border-zinc-800 flex justify-between items-center">
        <div class="flex items-center gap-4">
            <h1 class="text-orange-500 font-black">PROSPER</h1>
            <div class="flex bg-black rounded border border-zinc-700 p-1 gap-2 items-center">
                <button onclick="adjStat('life', -1)" class="text-red-500 w-8 text-xl">-</button>
                <span id="life-display" class="font-mono text-xl w-8 text-center">40</span>
                <button onclick="adjStat('life', 1)" class="text-green-500 w-8 text-xl">+</button>
            </div>
            <div class="flex bg-amber-900/20 rounded border border-amber-600/50 p-1 gap-2 items-center">
                <button onclick="adjStat('treasures', -1)" class="text-amber-500 w-8">-</button>
                <span id="treasures-display" class="font-mono text-xl w-8 text-center text-amber-400">0</span>
                <button onclick="adjStat('treasures', 1)" class="text-amber-500 w-8">+</button>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="spawnToken('Tiefling')" class="bg-red-900 px-3 py-1 rounded text-[10px] font-bold">TIEFLING</button>
            <button onclick="openBinder()" class="bg-zinc-800 px-3 py-1 rounded text-[10px] font-bold">BINDER</button>
            <button onclick="drawRandom()" class="bg-orange-600 px-3 py-1 rounded text-[10px] font-bold">DRAW</button>
        </div>
    </header>

    <main class="grid grid-cols-6 gap-3 p-3 overflow-hidden">
        <div class="col-span-5 flex flex-col gap-3 overflow-hidden">
            <div class="flex-grow flex flex-col overflow-hidden">
                <h3>Battlefield</h3>
                <div id="zone-field" class="zone flex-grow"></div>
            </div>
            <div class="h-1/3 flex flex-col overflow-hidden">
                <h3>Lands</h3>
                <div id="zone-lands" class="zone flex-grow"></div>
            </div>
        </div>
        <div class="col-span-1 flex flex-col gap-3 overflow-hidden">
            <div class="flex-grow flex flex-col overflow-hidden">
                <h3>Exile</h3>
                <div id="zone-exile" class="zone flex-grow border-orange-500/20"></div>
            </div>
            <div class="h-1/4 flex flex-col overflow-hidden">
                <h3>Grave</h3>
                <div id="zone-grave" class="zone flex-grow"></div>
            </div>
            <div class="h-24 flex flex-col overflow-hidden">
                <h3>CMD</h3>
                <div id="zone-commander" class="zone flex-grow"></div>
            </div>
        </div>
    </main>

    <footer class="p-3 bg-zinc-950 border-t border-zinc-800">
        <h3>Hand</h3>
        <div id="zone-hand" class="zone h-28 border-none justify-center items-center -space-x-8 overflow-visible"></div>
    </footer>

    <div id="binder-modal" class="fixed inset-0 bg-black/95 z-[9999] hidden p-6">
        <div class="flex justify-between mb-4">
            <input type="text" id="binder-search" oninput="renderBinder()" placeholder="Search Library..." class="bg-zinc-900 border border-zinc-700 px-4 py-2 rounded-lg w-full mr-4 text-white">
            <button onclick="closeBinder()" class="text-3xl">&times;</button>
        </div>
        <div id="binder-grid" class="grid grid-cols-3 md:grid-cols-6 lg:grid-cols-8 gap-4 overflow-y-auto max-h-[80vh]"></div>
    </div>

    <script>
        // FULL 100-CARD DECK LIST
        const fullDeck = [
            { qty: 1, name: "Prosper, Tome-Bound", category: "Commander" },
            { qty: 1, name: "Dockside Extortionist" }, { qty: 1, name: "Professional Face-Breaker" },
            { qty: 1, name: "Xorn" }, { qty: 1, name: "Academy Manufactor" },
            { qty: 1, name: "Grim Hireling" }, { qty: 1, name: "Mayhem Devil" },
            { qty: 1, name: "Marionette Master" }, { qty: 1, name: "Birgi, God of Storytelling" },
            { qty: 1, name: "Etali, Primal Storm" }, { qty: 1, name: "Dauthi Voidwalker" },
            { qty: 1, name: "Ragavan, Nimble Pilferer" }, { qty: 1, name: "Author of Shadows" },
            { qty: 1, name: "Gonti, Lord of Luxury" }, { qty: 1, name: "Dire Fleet Hoarder" },
            { qty: 1, name: "Kalain, Reclusive Painter" }, { qty: 1, name: "Magda, Brazen Outlaw" },
            { qty: 1, name: "Loyal Apprentice" }, { qty: 1, name: "Goldspan Dragon" },
            { qty: 1, name: "Valakut Exploration" }, { qty: 1, name: "Stolen Strategy" },
            { qty: 1, name: "Wild-Magic Sorcerer" }, { qty: 1, name: "Dream Devourer" },
            { qty: 1, name: "Storm-Kiln Artist" }, { qty: 1, name: "Tectonic Giant" },
            { qty: 1, name: "Laelia, the Blade Reforged" }, { qty: 1, name: "Orcish Bowmasters" },
            { qty: 1, name: "Opposition Agent" }, { qty: 1, name: "Atsushi, the Blazing Sky" },
            { qty: 1, name: "Jeska's Will" }, { qty: 1, name: "Light Up the Stage" },
            { qty: 1, name: "Chaos Warp" }, { qty: 1, name: "Bedevil" },
            { qty: 1, name: "Terminate" }, { qty: 1, name: "Vandalblast" },
            { qty: 1, name: "Toxic Deluge" }, { qty: 1, name: "Deadly Rollick" },
            { qty: 1, name: "Deflecting Swat" }, { qty: 1, name: "Tibalt's Trickery" },
            { qty: 1, name: "Feed the Swarm" }, { qty: 1, name: "Night's Whisper" },
            { qty: 1, name: "Commune with Lava" }, { qty: 1, name: "You Find Some Prisoners" },
            { qty: 1, name: "Reckless Impulse" }, { qty: 1, name: "Wrenn's Resolve" },
            { qty: 1, name: "Damnation" }, { qty: 1, name: "Blasphemous Act" },
            { qty: 1, name: "Rakdos Charm" }, { qty: 1, name: "Invert Polarity" },
            { qty: 1, name: "Mizzix's Mastery" }, { qty: 1, name: "Brass's Bounty" },
            { qty: 1, name: "Sol Ring" }, { qty: 1, name: "Arcane Signet" },
            { qty: 1, name: "Rakdos Signet" }, { qty: 1, name: "Talisman of Indulgence" },
            { qty: 1, name: "Bucknard's Everfull Purse" }, { qty: 1, name: "Lightning Greaves" },
            { qty: 1, name: "Swiftfoot Boots" }, { qty: 1, name: "Sensei's Divining Top" },
            { qty: 1, name: "Skullclamp" }, { qty: 1, name: "Bolas's Citadel" },
            { qty: 1, name: "Aetherflux Reservoir" }, { qty: 1, name: "Shadowspear" },
            { qty: 1, name: "Revel in Riches" }, { qty: 1, name: "Black Market Connections" },
            { qty: 1, name: "Command Tower" }, { qty: 1, name: "Luxury Suite" },
            { qty: 1, name: "Graven Cairns" }, { qty: 1, name: "Dragonskull Summit" },
            { qty: 1, name: "Mount Doom" }, { qty: 1, name: "Bloodstained Mire" },
            { qty: 1, name: "Badlands" }, { qty: 1, name: "Blood Crypt" },
            { qty: 1, name: "Urborg, Tomb of Yawgmoth" }, { qty: 1, name: "Cabal Coffers" },
            { qty: 1, name: "Ancient Tomb" }, { qty: 1, name: "Bojuka Bog" },
            { qty: 1, name: "Reliquary Tower" }, { qty: 11, name: "Mountain" }, { qty: 11, name: "Swamp" }
        ];

        let library = [];
        let state = { life: 40, treasures: 0, hand: [], field: [], lands: [], exile: [], grave: [], commander: [] };

        function init() {
            let id = 0;
            fullDeck.forEach(c => {
                for(let i=0; i<c.qty; i++) {
                    library.push({ ...c, id: `c-${id++}`, tapped: false, counters: 0, 
                    img: `https://api.scryfall.com/cards/named?exact=${encodeURIComponent(c.name)}&format=image` });
                }
            });
            const cmdIdx = library.findIndex(c => c.category === "Commander");
            state.commander.push(library.splice(cmdIdx, 1)[0]);
            render();
            setupInteract();
        }

        function setupInteract() {
            interact('.card-container').draggable({
                listeners: {
                    move(event) {
                        const t = event.target;
                        const x = (parseFloat(t.getAttribute('data-x')) || 0) + event.dx;
                        const y = (parseFloat(t.getAttribute('data-y')) || 0) + event.dy;
                        t.style.transform = `translate(${x}px, ${y}px)`;
                        t.setAttribute('data-x', x); t.setAttribute('data-y', y);
                        t.classList.remove('selected');
                    },
                    end(event) {
                        event.target.style.transform = '';
                        event.target.setAttribute('data-x', 0); event.target.setAttribute('data-y', 0);
                    }
                }
            }).on('tap', function(event) {
                const isSelected = event.currentTarget.classList.contains('selected');
                document.querySelectorAll('.card-container').forEach(c => c.classList.remove('selected'));
                if(!isSelected) event.currentTarget.classList.add('selected');
            });

            interact('.zone').dropzone({
                accept: '.card-container',
                ondrop: (e) => moveCard(e.relatedTarget.id, e.target.id.replace('zone-', ''))
            });
        }

        function moveCard(id, to) {
            let card;
            ['hand','field','lands','exile','grave','commander'].forEach(z => {
                const i = state[z].findIndex(c => c.id === id);
                if(i !== -1) card = state[z].splice(i,1)[0];
            });
            if(!card) { const i = library.findIndex(c => c.id === id); if(i !== -1) card = library.splice(i,1)[0]; }
            if(card) { state[to].push(card); render(); }
        }

        function spawnToken(type) {
            state.field.push({ id: `t-${Date.now()}`, name: type, tapped: false, counters: 0, isToken: true,
                img: `https://api.scryfall.com/cards/named?exact=${type}&format=image&type=token` });
            render();
        }

        function toggleTap(id, e) {
            e.stopPropagation();
            ['field','lands','exile','commander'].forEach(z => {
                const c = state[z].find(x => x.id === id);
                if(c) c.tapped = !c.tapped;
            });
            render();
        }

        function modCounter(id, n, e) {
            e.stopPropagation();
            ['field','lands','exile'].forEach(z => {
                const c = state[z].find(x => x.id === id);
                if(c) c.counters = Math.max(0, c.counters + n);
            });
            render();
        }

        function deleteCard(id, e) {
            e.stopPropagation();
            ['field','lands','exile','hand'].forEach(z => {
                const i = state[z].findIndex(c => c.id === id);
                if(i !== -1) {
                    const c = state[z].splice(i, 1)[0];
                    if(!c.isToken) state.grave.push(c);
                }
            });
            render();
        }

        function adjStat(stat, n) { state[stat] = Math.max(0, state[stat] + n); render(); }
        function drawRandom() { if(library.length) { state.hand.push(library.splice(Math.floor(Math.random()*library.length),1)[0]); render(); } }
        function openBinder() { document.getElementById('binder-modal').classList.remove('hidden'); renderBinder(); }
        function closeBinder() { document.getElementById('binder-modal').classList.add('hidden'); }
        function renderBinder() {
            const q = document.getElementById('binder-search').value.toLowerCase();
            document.getElementById('binder-grid').innerHTML = library.filter(c => c.name.toLowerCase().includes(q))
                .map(c => `<img src="${c.img}" class="rounded w-full" onclick="moveCard('${c.id}', 'hand'); closeBinder()">`).join('');
        }

        function render() {
            document.getElementById('life-display').innerText = state.life;
            document.getElementById('treasures-display').innerText = state.treasures;
            ['hand','field','lands','exile','grave','commander'].forEach(z => {
                document.getElementById(`zone-${z}`).innerHTML = state[z].map(c => `
                    <div class="card-container ${c.tapped ? 'tapped' : ''}" id="${c.id}">
                        <img src="${c.img}" class="card-img">
                        <div class="control-panel">
                            <button class="btn-ctrl" onclick="toggleTap('${c.id}', event)">Tap</button>
                            <button class="btn-ctrl" onclick="modCounter('${c.id}', 1, event)">+</button>
                            <button class="btn-ctrl" onclick="modCounter('${c.id}', -1, event)">-</button>
                            <button class="btn-ctrl bg-red-900" onclick="deleteCard('${c.id}', event)">X</button>
                        </div>
                        ${c.counters > 0 ? `<div class="counter-badge">${c.counters}</div>` : ''}
                    </div>
                `).join('');
            });
        }
        init();
    </script>
</body>
</html>
