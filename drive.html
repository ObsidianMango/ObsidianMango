<!DOCTYPE html>
<html>
<head>
    <title>3D Driving Simulator with Buildings</title>
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    
    <style>
        /* Sky blue background for a realistic horizon when tilted */
        body, html { height: 100%; margin: 0; padding: 0; overflow: hidden; background: #87CEEB; font-family: sans-serif; }
        #map { height: 100%; width: 100%; }
        
        /* The Car - Styled to look like a white sedan from above */
        #car {
            position: absolute; top: 65%; left: 50%;
            width: 34px; height: 64px;
            background-color: #f8f9fa;
            transform: translate(-50%, -50%);
            z-index: 2; border-radius: 8px;
            box-shadow: 0 15px 25px rgba(0,0,0,0.6);
            border: 1px solid #ccc;
        }
        /* Windshield */
        #car::before {
            content: ''; position: absolute; top: 12px; left: 4px; right: 4px; height: 14px;
            background: #333; border-radius: 4px 4px 0 0;
        }
        /* Back Window */
        #car::after {
            content: ''; position: absolute; bottom: 8px; left: 6px; right: 6px; height: 8px;
            background: #333; border-radius: 0 0 3px 3px;
        }

        /* Bottom Speedometer Overlay */
        #speedo-container {
            position: absolute; bottom: 30px; left: 50%;
            transform: translateX(-50%); z-index: 5;
            background: rgba(0, 0, 0, 0.85);
            padding: 10px 20px;
            border: 1px solid #444;
            text-align: center;
            border-radius: 5px;
        }
        #speedo-text {
            color: #00ff00; /* Bright green text */
            font-size: 22px; font-weight: bold;
            font-family: monospace;
            letter-spacing: 1px;
        }

        /* Top Left Controls */
        #controls-overlay {
            position: absolute; top: 20px; left: 20px; z-index: 5;
            background: rgba(0, 0, 0, 0.7); color: white;
            padding: 15px; border-radius: 5px; border: 1px solid #555;
            font-size: 14px;
        }
    </style>
</head>
<body>

    <div id="controls-overlay">
        <b>Controls:</b> W/A/S/D or Arrow Keys<br>
        <i>Driving through 3D buildings</i>
    </div>

    <div id="map"></div>
    <div id="car"></div>

    <div id="speedo-container">
        <div id="speedo-text"><span id="kmh">0</span> km/h / <span id="mph">0</span> mph</div>
    </div>

    <script>
        // Constants for real-world math
        const METERS_PER_DEGREE_LAT = 111320; 
        const MPH_TO_METERS_PER_FRAME = 0.00745; // Assuming ~60fps

        // Car Physics State (Starting in Downtown Red Bank, NJ)
        let car = {
            lat: 40.3505,  
            lng: -74.0665,
            speedMph: 0,
            heading: 0, 
        };

        // Tuning parameters for realistic handling
        const physics = {
            maxSpeed: 110,      
            accel: 0.35,        
            brakeForce: 0.8,    
            friction: 0.985,    
            maxSteer: 3.5       
        };

        let keys = { w: false, a: false, s: false, d: false, ArrowUp: false, ArrowLeft: false, ArrowDown: false, ArrowRight: false };

        // Initialize MapLibre
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    // Free Esri Satellite Imagery
                    'esri-satellite': {
                        type: 'raster',
                        tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'],
                        tileSize: 256,
                        attribution: '&copy; Esri'
                    }
                },
                layers: [{ id: 'satellite', type: 'raster', source: 'esri-satellite', minzoom: 0, maxzoom: 19 }]
            },
            center: [car.lng, car.lat],
            zoom: 18.5,
            pitch: 75, // Steep 3D pitch to see the buildings
            bearing: car.heading,
            interactive: false
        });

        window.addEventListener('keydown', (e) => { keys[e.key] = true; });
        window.addEventListener('keyup', (e) => { keys[e.key] = false; });

        map.on('load', () => {
            // Load free 3D Building Data from OpenFreeMap
            map.addSource('openfreemap', {
                url: 'https://tiles.openfreemap.org/planet',
                type: 'vector'
            });

            // Add the 3D building extrusion layer
            map.addLayer({
                'id': '3d-buildings',
                'source': 'openfreemap',
                'source-layer': 'building',
                'type': 'fill-extrusion',
                'minzoom': 14,
                'paint': {
                    'fill-extrusion-color': '#e0e0e0', // Light grey so they stand out against satellite
                    'fill-extrusion-height': ['get', 'render_height'],
                    'fill-extrusion-base': ['case', ['>=', ['get', 'render_min_height'], 0], ['get', 'render_min_height'], 0],
                    'fill-extrusion-opacity': 0.85 // Slightly transparent
                }
            });

            requestAnimationFrame(gameLoop);
        });

        function gameLoop() {
            // 1. Gas and Brakes
            if (keys.w || keys.ArrowUp) {
                car.speedMph += physics.accel;
            } else if (keys.s || keys.ArrowDown) {
                car.speedMph -= physics.brakeForce;
            } else {
                car.speedMph *= physics.friction; 
            }

            // Cap speeds
            if (car.speedMph > physics.maxSpeed) car.speedMph = physics.maxSpeed;
            if (car.speedMph < -25) car.speedMph = -25; 
            if (Math.abs(car.speedMph) < 0.1) car.speedMph = 0; 

            // 2. Realistic Steering
            let turnEffectiveness = Math.min(Math.abs(car.speedMph) / 15, 1); 
            let steerDir = car.speedMph >= 0 ? 1 : -1; 

            if (keys.a || keys.ArrowLeft) car.heading -= physics.maxSteer * turnEffectiveness * steerDir;
            if (keys.d || keys.ArrowRight) car.heading += physics.maxSteer * turnEffectiveness * steerDir;

            // 3. Move the Car 
            let metersTraveled = car.speedMph * MPH_TO_METERS_PER_FRAME;
            let rad = car.heading * (Math.PI / 180);
            
            let dLat = (metersTraveled * Math.cos(rad)) / METERS_PER_DEGREE_LAT;
            let dLng = (metersTraveled * Math.sin(rad)) / (METERS_PER_DEGREE_LAT * Math.cos(car.lat * (Math.PI / 180)));

            car.lat += dLat;
            car.lng += dLng;

            // 4. Update Map Camera
            map.jumpTo({
                center: [car.lng, car.lat],
                bearing: car.heading
            });

            // 5. Update Speedometer UI
            let displayMph = Math.abs(Math.floor(car.speedMph));
            let displayKmh = Math.abs(Math.floor(car.speedMph * 1.60934));
            
            document.getElementById('mph').innerText = displayMph;
            document.getElementById('kmh').innerText = displayKmh;

            requestAnimationFrame(gameLoop);
        }
    </script>
</body>
</html>
