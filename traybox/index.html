<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MTG STL Viewer</title>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <style>
        :root {
            --bg: #121212;
            --card: #1e1e1e;
            --text: #e0e0e0;
            --accent: #bb86fc;
            --border: #333;
        }

        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            padding-bottom: 120px; /* Space for color dock */
        }
        
        /* Sticky Navigation */
        .nav {
            position: sticky; 
            top: 0; 
            background: rgba(18,18,18,0.95); 
            z-index: 100;
            display: flex; 
            justify-content: center; 
            padding: 15px; 
            gap: 20px;
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(10px);
        }

        .nav-btn {
            background: none; 
            border: none; 
            color: #888; 
            font-size: 1.1rem; 
            font-weight: 600;
            padding: 8px 16px; 
            cursor: pointer;
            transition: 0.2s;
        }

        .nav-btn.active { 
            color: var(--accent); 
            border-bottom: 2px solid var(--accent); 
        }

        /* Responsive Grid */
        .grid {
            display: none; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 20px;
            padding: 20px; 
            max-width: 1200px; 
            margin: 0 auto;
        }

        .grid.active { 
            display: grid; 
        }

        /* File Card */
        .card { 
            background: var(--card); 
            border-radius: 12px; 
            overflow: hidden; 
            border: 1px solid var(--border); 
            display: flex;
            flex-direction: column;
        }
        
        .view-box {
            height: 280px; 
            background: #000; 
            position: relative;
            display: flex; 
            align-items: center; 
            justify-content: center;
            overflow: hidden;
        }

        .preview-img { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
        }

        /* 3D Viewer Canvas Container */
        .viewer-canvas { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            z-index: 10; 
        }

        .controls { 
            padding: 15px; 
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        h3 { 
            margin: 0 0 10px 0; 
            font-size: 1.1rem; 
            color: #fff; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        select {
            width: 100%; 
            padding: 10px; 
            background: #2d2d2d; 
            color: white;
            border: 1px solid #444; 
            border-radius: 6px; 
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        
        .btn-row { 
            display: flex; 
            gap: 10px; 
            margin-top: auto; 
        }

        button {
            flex: 1; 
            padding: 10px; 
            border-radius: 6px; 
            border: none; 
            font-weight: 600; 
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        button:active { opacity: 0.8; }

        .btn-3d { 
            background: var(--accent); 
            color: #000; 
        }

        .btn-img { 
            background: #333; 
            color: #fff; 
        }

        /* Color Dock Footer */
        .dock {
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            background: rgba(30, 30, 30, 0.95);
            padding: 15px 10px; 
            display: flex; 
            gap: 12px; 
            overflow-x: auto;
            border-top: 1px solid var(--border); 
            z-index: 200;
            backdrop-filter: blur(5px);
            /* Hide scrollbars */
            scrollbar-width: none; 
            -ms-overflow-style: none;
        }
        .dock::-webkit-scrollbar { display: none; }

        .swatch {
            min-width: 45px; 
            height: 45px; 
            border-radius: 50%; 
            border: 2px solid #555; 
            cursor: pointer;
            position: relative;
            transition: transform 0.2s;
            flex-shrink: 0;
        }

        .swatch.active { 
            border-color: white; 
            transform: scale(1.15); 
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }

        .swatch::after {
            content: attr(data-label); 
            position: absolute; 
            bottom: 55px; 
            left: 50%; 
            transform: translateX(-50%);
            background: #000; 
            color: #fff;
            padding: 4px 8px; 
            font-size: 11px; 
            border-radius: 4px; 
            opacity: 0; 
            pointer-events: none;
            transition: opacity 0.2s;
            white-space: nowrap;
        }

        .swatch:hover::after, .swatch.active::after { opacity: 1; }

        /* Loader */
        .loader {
            width: 30px; 
            height: 30px; 
            border: 3px solid #333; 
            border-top: 3px solid var(--accent);
            border-radius: 50%; 
            animation: spin 0.8s linear infinite; 
            position: absolute;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

<div class="nav">
    <button class="nav-btn active" onclick="setTab('trays')">Trays</button>
    <button class="nav-btn" onclick="setTab('boxes')">Boxes</button>
</div>

<div id="trays-grid" class="grid active"></div>
<div id="boxes-grid" class="grid"></div>

<div class="dock" id="color-dock"></div>

<script type="module">
import * as THREE from 'three';
import { STLLoader } from 'three/addons/loaders/STLLoader.js';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

// --- CONFIGURATION ---

const colors = [
    { name: "White", hex: 0xFFFFFF, type: 'std' },
    { name: "Wood", hex: 0xDEB887, type: 'matte' },
    { name: "Grey Silk", hex: 0xBBBBBB, type: 'silk' },
    { name: "Light Grass Green", hex: 0x90EE90, type: 'std' },
    { name: "Purple Silk", hex: 0x800080, type: 'silk' },
    { name: "Light Blue", hex: 0xADD8E6, type: 'std' },
    { name: "Yellow", hex: 0xFFFF00, type: 'std' },
    { name: "Dark Blue", hex: 0x00008B, type: 'std' },
    { name: "Red", hex: 0xFF0000, type: 'std' },
    { name: "Purple", hex: 0x663399, type: 'std' },
    { name: "Black", hex: 0x111111, type: 'std' },
    { name: "Tricolor", hex: 0xffffff, type: 'tri' }, // Special shader
    { name: "Gold", hex: 0xFFD700, type: 'silk' }
];

// NOTE: 'folder' is relative to where this index.html file is.
// Since index.html is in 'traybox', we look into 'files/...' and 'pics/...'
const data = {
    trays: [
        {
            name: "EDH Tray Deboss",
            folder: "files/trays",
            files: ["edh tray deboss.stl"],
            img: "pics/edh tray deboss.jpeg"
        },
        {
            name: "EDH Tray Standard",
            folder: "files/trays",
            files: ["edh-tray.stl"],
            img: "pics/edh-tray.jpeg"
        },
        {
            name: "EDH Command Tray",
            folder: "files/trays",
            files: ["edhcommand-tray (1).stl"],
            img: "pics/edhcommand-tray (1).jpeg"
        }
    ],
    boxes: [
        {
            name: "Deck Box 100+",
            folder: "files/boxes/deck_box_100sleeve_plusdice",
            files: [
                "deck_box_100sleeve_plusdice_lid.stl",
                "deck_box_100sleeve_plusdice_bottom.stl"
            ],
            img: "pics/deck_box_100sleeve_plusdice.jpeg"
        },
        {
            name: "Deckbox Variations",
            folder: "files/boxes/deckbox",
            files: [
                "deckbox-bottom.stl",
                "deckbox-top-blank.stl",
                "AC Valhalla Lid.stl",
                "ac-ezio-deck-lid.stl",
                "autobot-lid.stl",
                "decepticon-lid.stl",
                "doctor-who-deck-lid.stl",
                "fallout-lid.stl",
                "jurassic-lid.stl",
                "masters-of-evil-deck-lid.stl"
            ],
            img: null 
        },
        {
            name: "Egg Box",
            folder: "files/boxes/egg",
            files: ["mtg-egg-box-top.stl", "mtg-egg-box-bottom.stl"],
            img: null
        },
        {
            name: "Fallout Vault Tec",
            folder: "files/boxes/fallout",
            files: ["mtg_fallout_vault_tec_deck_box.stl"],
            img: "pics/mtg_fallout_vault_tec_deck_box.jpeg"
        },
        {
            name: "Companion Cube",
            folder: "files/boxes/Magic The Gathering Deck Box Companion Cube - Commander size",
            files: [
                "Magic_Cube.stl",
                "Magic_Cube_Lid-Phyrexian.STL", 
                "Magic_Cube_Lid-Phyrexian-thicker-rim_.stl",
                "Red-mana_lid-normal_thickness.stl"
            ],
            img: "pics/Magic The Gathering Deck Box Companion Cube - Commander size.jpeg"
        },
        {
            name: "Mega MTG Box",
            folder: "files/boxes/mega_mtg",
            files: [
                "mega_mtg_lid_commander.stl",
                "mega_mtg_01_divider.stl",
                "mega_mtg_11_divider.stl",
                "mega_mtg_31_divider.stl"
            ],
            img: "pics/mega_mtg.jpeg"
        },
        {
            name: "MTG All Logos",
            folder: "files/boxes/mtgboxalllogos",
            files: ["mtgboxalllogos.stl", "mtgboxalllogos_lid.stl"],
            img: "pics/mtgboxalllogos.jpeg"
        },
        {
            name: "Ryan Deck Box",
            folder: "files/boxes/ryan-deck-box",
            files: [
                "mtg-ryan-deck-box-commander.stl",
                "mtg-ryan-lid.stl",
                "mtg-ryan-dice-base-1.stl"
            ],
            img: "pics/ryan-deck-box.jpeg"
        },
        {
            name: "Tomb Box",
            folder: "files/boxes/tomb",
            files: ["MtG_Card_Box_Ultrapro.stl"],
            img: null
        },
        {
            name: "Tome Book Box",
            folder: "files/boxes/Tome_v1.0",
            files: ["Tome.stl", "Pages_RollTray.stl"],
            img: null
        }
    ]
};

let currentMat = null;

// --- INITIALIZATION ---

function init() {
    renderGrid('trays', data.trays);
    renderGrid('boxes', data.boxes);
    renderColors();
    updateMaterial(colors[0]); // Default to White
}

function renderColors() {
    const dock = document.getElementById('color-dock');
    colors.forEach(col => {
        const d = document.createElement('div');
        d.className = 'swatch';
        d.setAttribute('data-label', col.name);
        
        if (col.name === 'Tricolor') {
            d.style.background = 'linear-gradient(135deg, red, blue, green)';
        } else {
            d.style.backgroundColor = '#' + col.hex.toString(16).padStart(6,'0');
        }

        d.onclick = () => {
            document.querySelectorAll('.swatch').forEach(s => s.classList.remove('active'));
            d.classList.add('active');
            updateMaterial(col);
        };
        dock.appendChild(d);
    });
    // Set first active
    dock.children[0].classList.add('active');
}

function updateMaterial(col) {
    if (col.type === 'tri') {
        currentMat = new THREE.MeshNormalMaterial();
    } else {
        const opts = { color: col.hex };
        
        if (col.type === 'silk') { 
            opts.metalness = 0.6; 
            opts.roughness = 0.25; 
        } else if (col.type === 'matte') { 
            opts.roughness = 1.0; 
            opts.metalness = 0.0;
        } else { 
            // Standard
            opts.roughness = 0.5; 
            opts.metalness = 0.1; 
        }
        
        currentMat = new THREE.MeshStandardMaterial(opts);
    }

    // Update active 3D scenes
    document.querySelectorAll('canvas').forEach(canvas => {
        if(canvas.sceneRef) {
            canvas.sceneRef.traverse(child => {
                if (child.isMesh) child.material = currentMat;
            });
        }
    });
}

function renderGrid(type, items) {
    const container = document.getElementById(`${type}-grid`);
    
    items.forEach(item => {
        const el = document.createElement('div');
        el.className = 'card';
        
        // Generate Dropdown if multiple files
        let selectHtml = '';
        if (item.files.length > 1) {
            selectHtml = `<select id="sel-${clean(item.name)}">
                ${item.files.map(f => `<option value="${item.folder}/${f}">${f}</option>`).join('')}
            </select>`;
        }

        const firstFile = `${item.folder}/${item.files[0]}`;
        const hasImg = !!item.img;

        el.innerHTML = `
            <div class="view-box" id="view-${clean(item.name)}">
                ${hasImg ? `<img src="${item.img}" class="preview-img">` : '<span style="color:#555">No Preview Image</span>'}
            </div>
            <div class="controls">
                <h3>${item.name}</h3>
                ${selectHtml}
                <div class="btn-row">
                    <button class="btn-3d" id="btn3d-${clean(item.name)}">View 3D</button>
                    ${hasImg ? `<button class="btn-img" id="btnimg-${clean(item.name)}">Image</button>` : ''}
                </div>
            </div>
        `;
        container.appendChild(el);

        // Attach Listeners
        const viewer = el.querySelector('.view-box');
        const btn3d = el.querySelector(`#btn3d-${clean(item.name)}`);
        const btnImg = el.querySelector(`#btnimg-${clean(item.name)}`);
        const sel = el.querySelector('select');
        
        let activeFile = firstFile;

        if (sel) {
            sel.addEventListener('change', (e) => {
                activeFile = e.target.value;
                // If 3D is already running, reload it
                if(viewer.querySelector('canvas')) loadSTL(viewer, activeFile);
            });
        }

        btn3d.onclick = () => loadSTL(viewer, activeFile);
        
        if (btnImg) {
            btnImg.onclick = () => {
                // Kill 3D, restore image
                viewer.innerHTML = `<img src="${item.img}" class="preview-img">`;
            };
        }
    });
}

async function loadSTL(container, url) {
    // Clear and show loader
    container.innerHTML = '<div class="loader"></div>';
    
    const w = container.clientWidth;
    const h = container.clientHeight;
    
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000000); // Black background for viewer
    
    const camera = new THREE.PerspectiveCamera(45, w/h, 0.1, 1000);
    camera.position.set(100, 100, 100);
    
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(w, h);
    container.appendChild(renderer.domElement);
    renderer.domElement.sceneRef = scene; // Hook for color updates

    // Lighting
    scene.add(new THREE.AmbientLight(0xffffff, 0.6));
    const dl = new THREE.DirectionalLight(0xffffff, 1.2);
    dl.position.set(50, 100, 50);
    scene.add(dl);
    const dl2 = new THREE.DirectionalLight(0xffffff, 0.5);
    dl2.position.set(-50, -50, -50);
    scene.add(dl2);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.autoRotate = true;
    controls.autoRotateSpeed = 3.0;
    controls.enableDamping = true;

    const loader = new STLLoader();
    
    try {
        const geo = await new Promise((res, rej) => loader.load(url, res, undefined, rej));
        
        // Remove loader
        const l = container.querySelector('.loader');
        if (l) l.remove();

        geo.center();
        
        // Bounding Box Logic to fit camera
        geo.computeBoundingBox();
        const box = geo.boundingBox;
        const size = new THREE.Vector3();
        box.getSize(size);
        const maxDim = Math.max(size.x, size.y, size.z);
        
        const mesh = new THREE.Mesh(geo, currentMat);
        mesh.rotation.x = -Math.PI / 2; // STL standard orientation fix
        scene.add(mesh);

        // Adjust camera based on object size
        const fov = camera.fov * (Math.PI / 180);
        const cameraZ = Math.abs(maxDim / 2 * Math.tan(fov * 2)); // rough estimate
        
        camera.position.set(maxDim * 1.5, maxDim, maxDim * 1.5);
        camera.lookAt(0,0,0);

        function animate() {
            if(!container.querySelector('canvas')) return; // Stop if removed
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

    } catch (e) {
        console.error("STL Load Error:", e);
        container.innerHTML = '<div style="color:red; text-align:center;">Error loading file.<br>Use Local Server.</div>';
    }
}

function clean(str) { return str.replace(/[^a-zA-Z0-9]/g, ''); }

init();

</script>

<script>
// Global Tab Switching
window.setTab = function(t) {
    document.querySelectorAll('.grid').forEach(g => g.classList.remove('active'));
    document.getElementById(`${t}-grid`).classList.add('active');
    
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    // Highlight the clicked button
    const buttons = document.querySelectorAll('.nav-btn');
    for (let btn of buttons) {
        if(btn.innerText.toLowerCase().includes(t.substring(0,4))) {
            btn.classList.add('active');
        }
    }
}
</script>
</body>
</html>
