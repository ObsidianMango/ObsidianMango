<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Native Haven 3D Store</title>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --bg: #121212;
            --card: #1e1e1e;
            --text: #e0e0e0;
            --accent: #bb86fc;
            --border: #333;
            --success: #03dac6;
        }

        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: var(--bg); 
            color: var(--text); 
            padding-bottom: 120px; 
        }
        
        /* Navigation */
        .nav {
            position: sticky; 
            top: 0; 
            background: rgba(18,18,18,0.95); 
            z-index: 100;
            display: flex; 
            justify-content: center; 
            padding: 15px; 
            gap: 20px;
            border-bottom: 1px solid var(--border);
            backdrop-filter: blur(10px);
        }

        .nav-btn {
            background: none; 
            border: none; 
            color: #888; 
            font-size: 1.1rem; 
            font-weight: 600;
            padding: 8px 16px; 
            cursor: pointer;
            transition: 0.2s;
        }

        .nav-btn.active { 
            color: var(--accent); 
            border-bottom: 2px solid var(--accent); 
        }

        /* Cart Icon */
        .cart-icon {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 1.2rem;
            color: var(--text);
            cursor: pointer;
        }
        .cart-count {
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--accent);
            color: #000;
            font-size: 0.7rem;
            font-weight: bold;
            padding: 2px 6px;
            border-radius: 50%;
            display: none;
        }

        /* Grid Layout */
        .grid {
            display: none; 
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
            gap: 20px;
            padding: 20px; 
            max-width: 1200px; 
            margin: 0 auto;
        }

        .grid.active { display: grid; }

        /* Card Component */
        .card { 
            background: var(--card); 
            border-radius: 12px; 
            overflow: hidden; 
            border: 1px solid var(--border); 
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        /* View Box & Carousel */
        .view-box {
            height: 280px; 
            background: #000; 
            position: relative;
            display: flex; 
            align-items: center; 
            justify-content: center;
            overflow: hidden;
        }

        .view-box.fullscreen {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 9999;
            background: #000;
        }

        .preview-img { 
            width: 100%; 
            height: 100%; 
            object-fit: contain; 
            display: none; /* Hidden by default, JS toggles active one */
        }
        .preview-img.active { display: block; }

        /* Carousel Controls */
        .carousel-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.5);
            color: white;
            border: none;
            padding: 10px;
            cursor: pointer;
            z-index: 20;
            font-size: 1.2rem;
        }
        .carousel-prev { left: 0; }
        .carousel-next { right: 0; }

        .fs-btn {
            position: absolute;
            top: 10px; right: 10px;
            background: rgba(0,0,0,0.6);
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            z-index: 30;
        }

        /* Controls Section */
        .controls { 
            padding: 15px; 
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        h3 { 
            margin: 0 0 10px 0; 
            font-size: 1.1rem; 
            color: #fff; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        select {
            width: 100%; 
            padding: 10px; 
            background: #2d2d2d; 
            color: white;
            border: 1px solid #444; 
            border-radius: 6px; 
            margin-bottom: 10px;
            font-size: 0.9rem;
        }
        
        .btn-row { 
            display: flex; 
            gap: 10px; 
            margin-top: auto; 
            flex-wrap: wrap;
        }

        button.action-btn {
            flex: 1; 
            padding: 10px; 
            border-radius: 6px; 
            border: none; 
            font-weight: 600; 
            cursor: pointer;
            transition: opacity 0.2s;
            min-width: 80px;
        }
        
        button:active { opacity: 0.8; }

        .btn-3d { background: var(--accent); color: #000; }
        .btn-img { background: #333; color: #fff; }
        .btn-cart { background: var(--success); color: #000; width: 100%; margin-top: 10px; }

        /* Color Dock */
        .dock {
            position: fixed; 
            bottom: 0; 
            left: 0; 
            width: 100%; 
            background: rgba(30, 30, 30, 0.95);
            padding: 15px 10px; 
            display: flex; 
            gap: 12px; 
            overflow-x: auto;
            border-top: 1px solid var(--border); 
            z-index: 200;
            backdrop-filter: blur(5px);
        }
        
        .swatch {
            min-width: 45px; height: 45px; 
            border-radius: 50%; 
            border: 2px solid #555; 
            cursor: pointer;
            position: relative;
            transition: transform 0.2s;
            flex-shrink: 0;
        }
        .swatch.active { 
            border-color: white; 
            transform: scale(1.15); 
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .swatch::after {
            content: attr(data-label); 
            position: absolute; 
            bottom: 55px; left: 50%; transform: translateX(-50%);
            background: #000; color: #fff;
            padding: 4px 8px; font-size: 11px; border-radius: 4px; 
            opacity: 0; pointer-events: none; transition: opacity 0.2s; white-space: nowrap;
        }
        .swatch:hover::after { opacity: 1; }

        /* Cart Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        .close-modal {
            position: absolute; top: 10px; right: 15px;
            background: none; border: none; color: #fff; font-size: 1.5rem; cursor: pointer;
        }
        .cart-item {
            display: flex; justify-content: space-between;
            padding: 10px; border-bottom: 1px solid #333;
        }
        .copy-btn {
            background: var(--accent); color: #000; width: 100%;
            padding: 12px; border: none; border-radius: 6px; font-size: 1rem; font-weight: bold;
            margin-top: 15px; cursor: pointer;
        }

        /* Loader */
        .loader {
            width: 30px; height: 30px; 
            border: 3px solid #333; border-top: 3px solid var(--accent);
            border-radius: 50%; animation: spin 0.8s linear infinite;
            position: absolute;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

<div class="nav">
    <button class="nav-btn active" onclick="setTab('trays')">Trays</button>
    <button class="nav-btn" onclick="setTab('boxes')">Boxes</button>
    
    <div class="cart-icon" onclick="toggleCart()">
        <i class="fas fa-shopping-cart"></i>
        <div id="cart-count" class="cart-count">0</div>
    </div>
</div>

<div id="trays-grid" class="grid active"></div>
<div id="boxes-grid" class="grid"></div>

<div class="dock" id="color-dock"></div>

<div class="modal" id="cart-modal">
    <div class="modal-content">
        <button class="close-modal" onclick="toggleCart()">&times;</button>
        <h2>Your Cart</h2>
        <div id="cart-items" style="margin-bottom: 20px; color: #ccc;">
            Your cart is empty.
        </div>
        <button class="copy-btn" onclick="checkout()">Copy Order to Text</button>
    </div>
</div>

<script type="module">
import * as THREE from 'three';
import { STLLoader } from 'three/addons/loaders/STLLoader.js';
import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

// --- CONFIGURATION ---

const colors = [
    { name: "White", hex: 0xFFFFFF, type: 'std' },
    { name: "Wood", hex: 0xDEB887, type: 'matte' },
    { name: "Grey Silk", hex: 0xBBBBBB, type: 'silk' },
    { name: "Light Grass Green", hex: 0x90EE90, type: 'std' },
    { name: "Purple Silk", hex: 0x800080, type: 'silk' },
    { name: "Light Blue", hex: 0xADD8E6, type: 'std' },
    { name: "Yellow", hex: 0xFFFF00, type: 'std' },
    { name: "Dark Blue", hex: 0x00008B, type: 'std' },
    { name: "Red", hex: 0xFF0000, type: 'std' },
    { name: "Purple", hex: 0x663399, type: 'std' },
    { name: "Black", hex: 0x111111, type: 'std' },
    { name: "Tricolor", hex: 0xffffff, type: 'tri' },
    { name: "Gold", hex: 0xFFD700, type: 'silk' }
];

// NOTE: I converted 'img' to 'imgs' (array) for carousel support.
const data = {
    trays: [
        {
            name: "EDH Tray Deboss",
            folder: "files/trays",
            files: ["edh tray deboss.stl"],
            imgs: ["pics/edh tray deboss.jpeg"]
        },
        {
            name: "EDH Tray Standard",
            folder: "files/trays",
            files: ["edh-tray.stl"],
            imgs: ["pics/edh-tray.jpeg"]
        },
        {
            name: "EDH Command Tray",
            folder: "files/trays",
            files: ["edhcommand-tray (1).stl"],
            imgs: ["pics/edhcommand-tray (1).jpeg"]
        }
    ],
    boxes: [
        {
            name: "Deck Box 100+",
            folder: "files/boxes/deck_box_100sleeve_plusdice",
            files: ["deck_box_100sleeve_plusdice_lid.stl", "deck_box_100sleeve_plusdice_bottom.stl"],
            imgs: ["pics/deckbox100sleeveplusdice.jpeg"]
        },
        {
            name: "Deckbox Variations",
            folder: "files/boxes/deckbox",
            files: [
                "deckbox-bottom.stl", "deckbox-top-blank.stl", "AC Valhalla Lid.stl",
                "ac-ezio-deck-lid.stl", "autobot-lid.stl", "decepticon-lid.stl",
                "doctor-who-deck-lid.stl", "fallout-lid.stl", "jurassic-lid.stl", "masters-of-evil-deck-lid.stl"
            ],
            imgs: [] // No image
        },
        {
            name: "Egg Box",
            folder: "files/boxes/egg",
            files: ["mtg-egg-box-top.stl", "mtg-egg-box-bottom.stl"],
            imgs: []
        },
        {
            name: "Fallout Vault Tec",
            folder: "files/boxes/fallout",
            files: ["mtg_fallout_vault_tec_deck_box.stl"],
            imgs: ["pics/mtgfalloutvaulttecdeckbox.jpeg"]
        },
        {
            name: "Companion Cube",
            folder: "files/boxes/Magic The Gathering Deck Box Companion Cube - Commander size",
            files: ["Magic_Cube.stl", "Red-mana_lid-normal_thickness.stl", "Magic_Cube_Lid-Phyrexian-thicker-rim_.stl"],
            imgs: ["pics/MagicTheGatheringDeckBoxCompanionCube.jpeg"]
        },
        {
            name: "Mega MTG Box",
            folder: "files/boxes/mega_mtg",
            files: ["mega_mtg_lid_commander.stl", "mega_mtg_31_divider.stl", "mega_mtg_11_divider.stl", "mega_mtg_01_divider.stl"],
            imgs: ["pics/megamtg.jpeg"]
        },
        {
            name: "MTG All Logos",
            folder: "files/boxes/mtgboxalllogos",
            files: ["mtgboxalllogos.stl", "mtgboxalllogos_lid.stl"],
            imgs: ["pics/mtgboxalllogos.jpeg"]
        },
        {
            name: "Ryan Deck Box",
            folder: "files/boxes/ryan-deck-box",
            files: ["mtg-ryan-deck-box-commander.stl", "mtg-ryan-lid.stl"],
            imgs: ["pics/ryan-deck-box.jpeg"]
        }
    ]
};

let currentMat = null;
let activeColorName = "White"; // Track for cart

// --- STATE ---
const cart = [];

// --- INITIALIZATION ---

function init() {
    renderGrid('trays', data.trays);
    renderGrid('boxes', data.boxes);
    renderColors();
    updateMaterial(colors[0]); 
}

function renderColors() {
    const dock = document.getElementById('color-dock');
    colors.forEach(col => {
        const d = document.createElement('div');
        d.className = 'swatch';
        d.setAttribute('data-label', col.name);
        
        if (col.name === 'Tricolor') {
            d.style.background = 'linear-gradient(135deg, red, blue, green)';
        } else {
            d.style.backgroundColor = '#' + col.hex.toString(16).padStart(6,'0');
        }

        d.onclick = () => {
            document.querySelectorAll('.swatch').forEach(s => s.classList.remove('active'));
            d.classList.add('active');
            activeColorName = col.name; // Store for cart
            updateMaterial(col);
        };
        dock.appendChild(d);
    });
    dock.children[0].classList.add('active');
}

function updateMaterial(col) {
    if (col.type === 'tri') {
        currentMat = new THREE.MeshNormalMaterial();
    } else {
        const opts = { color: col.hex };
        if (col.type === 'silk') { opts.metalness = 0.6; opts.roughness = 0.25; } 
        else if (col.type === 'matte') { opts.roughness = 1.0; opts.metalness = 0.0; } 
        else { opts.roughness = 0.5; opts.metalness = 0.1; }
        currentMat = new THREE.MeshStandardMaterial(opts);
    }

    // Update active 3D scenes
    document.querySelectorAll('canvas').forEach(canvas => {
        if(canvas.sceneRef) {
            canvas.sceneRef.traverse(child => {
                if (child.isMesh) child.material = currentMat;
            });
        }
    });
}

function renderGrid(type, items) {
    const container = document.getElementById(`${type}-grid`);
    
    items.forEach(item => {
        const el = document.createElement('div');
        el.className = 'card';
        const safeName = clean(item.name);

        // Files Dropdown
        let selectHtml = '';
        if (item.files.length > 1) {
            selectHtml = `<select id="sel-${safeName}">
                ${item.files.map(f => `<option value="${encodeURI(item.folder + '/' + f)}">${f}</option>`).join('')}
            </select>`;
        }

        const firstFile = encodeURI(`${item.folder}/${item.files[0]}`);
        
        // Image Carousel Logic
        let imgHtml = '<span style="color:#555">No Image</span>';
        let controlsHtml = '';

        if (item.imgs && item.imgs.length > 0) {
            imgHtml = item.imgs.map((src, i) => 
                `<img src="${encodeURI(src)}" class="preview-img ${i===0?'active':''}" data-idx="${i}">`
            ).join('');
            
            if (item.imgs.length > 1) {
                controlsHtml = `
                    <button class="carousel-btn carousel-prev" id="prev-${safeName}"><i class="fas fa-chevron-left"></i></button>
                    <button class="carousel-btn carousel-next" id="next-${safeName}"><i class="fas fa-chevron-right"></i></button>
                `;
            }
        }

        el.innerHTML = `
            <div class="view-box" id="view-${safeName}">
                <button class="fs-btn" id="fs-${safeName}"><i class="fas fa-expand"></i></button>
                ${controlsHtml}
                ${imgHtml}
            </div>
            <div class="controls">
                <h3>${item.name}</h3>
                ${selectHtml}
                <div class="btn-row">
                    <button class="action-btn btn-3d" id="btn3d-${safeName}">View 3D</button>
                    ${item.imgs.length > 0 ? `<button class="action-btn btn-img" id="btnimg-${safeName}">Images</button>` : ''}
                </div>
                <button class="action-btn btn-cart" id="cart-${safeName}">Add to Cart</button>
            </div>
        `;
        container.appendChild(el);

        // EVENT LISTENERS
        const viewBox = el.querySelector('.view-box');
        const btn3d = el.querySelector(`#btn3d-${safeName}`);
        const btnImg = el.querySelector(`#btnimg-${safeName}`);
        const btnCart = el.querySelector(`#cart-${safeName}`);
        const btnFs = el.querySelector(`#fs-${safeName}`);
        const sel = el.querySelector('select');
        
        let activeFile = firstFile;

        // 1. File Selection
        if (sel) {
            sel.addEventListener('change', (e) => {
                activeFile = e.target.value;
                if(viewBox.querySelector('canvas')) loadSTL(viewBox, activeFile);
            });
        }

        // 2. View 3D
        btn3d.onclick = () => loadSTL(viewBox, activeFile);
        
        // 3. View Images (Restore)
        if (btnImg) {
            btnImg.onclick = () => {
                const canvas = viewBox.querySelector('canvas');
                if(canvas) canvas.remove();
                
                // Show first image
                const imgs = viewBox.querySelectorAll('.preview-img');
                imgs.forEach(img => img.classList.remove('active'));
                if(imgs.length>0) imgs[0].classList.add('active');
            };
        }

        // 4. Carousel Buttons
        if (item.imgs.length > 1) {
            const nextBtn = el.querySelector(`#next-${safeName}`);
            const prevBtn = el.querySelector(`#prev-${safeName}`);
            
            const cycle = (dir) => {
                const imgs = viewBox.querySelectorAll('.preview-img');
                // Don't cycle if 3D is active
                if(viewBox.querySelector('canvas')) return; 

                let activeIdx = 0;
                imgs.forEach((img, i) => {
                    if (img.classList.contains('active')) activeIdx = i;
                    img.classList.remove('active');
                });

                let newIdx = activeIdx + dir;
                if (newIdx < 0) newIdx = imgs.length - 1;
                if (newIdx >= imgs.length) newIdx = 0;
                
                imgs[newIdx].classList.add('active');
            };

            nextBtn.onclick = () => cycle(1);
            prevBtn.onclick = () => cycle(-1);
        }

        // 5. Full Screen
        btnFs.onclick = () => {
            viewBox.classList.toggle('fullscreen');
            if (viewBox.classList.contains('fullscreen')) {
                btnFs.innerHTML = '<i class="fas fa-compress"></i>';
                // Resize 3D if present
                const canvas = viewBox.querySelector('canvas');
                if (canvas && canvas.resizeFn) canvas.resizeFn();
            } else {
                btnFs.innerHTML = '<i class="fas fa-expand"></i>';
                const canvas = viewBox.querySelector('canvas');
                if (canvas && canvas.resizeFn) canvas.resizeFn();
            }
        };

        // 6. Add to Cart
        btnCart.onclick = () => {
            addToCart(item.name, activeColorName);
            // Visual feedback
            const originalText = btnCart.innerText;
            btnCart.innerText = "Added!";
            btnCart.style.background = "#fff";
            setTimeout(() => {
                btnCart.innerText = originalText;
                btnCart.style.background = "";
            }, 1000);
        };
    });
}

// --- 3D LOGIC ---

async function loadSTL(container, url) {
    // Clean container of previous 3D or images (hide images)
    container.querySelectorAll('.preview-img').forEach(img => img.classList.remove('active'));
    const oldCanvas = container.querySelector('canvas');
    if(oldCanvas) oldCanvas.remove();

    container.insertAdjacentHTML('beforeend', '<div class="loader"></div>');
    
    // Get dimensions (handle fullscreen)
    let w = container.clientWidth;
    let h = container.clientHeight;
    
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x000000);
    
    const camera = new THREE.PerspectiveCamera(45, w/h, 0.1, 1000);
    camera.position.set(100, 100, 100);
    
    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(w, h);
    container.appendChild(renderer.domElement);
    renderer.domElement.sceneRef = scene;

    // Handle Resize
    renderer.domElement.resizeFn = function() {
        const newW = container.clientWidth;
        const newH = container.clientHeight;
        camera.aspect = newW / newH;
        camera.updateProjectionMatrix();
        renderer.setSize(newW, newH);
    };
    window.addEventListener('resize', renderer.domElement.resizeFn);

    scene.add(new THREE.AmbientLight(0xffffff, 0.6));
    const dl = new THREE.DirectionalLight(0xffffff, 1.2);
    dl.position.set(50, 100, 50);
    scene.add(dl);
    const dl2 = new THREE.DirectionalLight(0xffffff, 0.5);
    dl2.position.set(-50, -50, -50);
    scene.add(dl2);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.autoRotate = true;
    controls.autoRotateSpeed = 3.0;
    controls.enableDamping = true;

    const loader = new STLLoader();
    
    try {
        const geo = await new Promise((res, rej) => loader.load(url, res, undefined, rej));
        const l = container.querySelector('.loader');
        if (l) l.remove();

        geo.center();
        geo.computeBoundingBox();
        const maxDim = Math.max(geo.boundingBox.max.x, geo.boundingBox.max.y, geo.boundingBox.max.z);
        
        const mesh = new THREE.Mesh(geo, currentMat);
        mesh.rotation.x = -Math.PI / 2;
        scene.add(mesh);

        camera.position.set(maxDim * 1.5, maxDim, maxDim * 1.5);
        camera.lookAt(0,0,0);

        function animate() {
            if(!container.querySelector('canvas')) return;
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

    } catch (e) {
        console.error(e);
        container.querySelector('.loader')?.remove();
        container.insertAdjacentHTML('beforeend', '<div style="color:red;position:absolute;">Error</div>');
    }
}

function clean(str) { return str.replace(/[^a-zA-Z0-9]/g, ''); }

// --- CART LOGIC ---

window.addToCart = function(itemName, color) {
    cart.push({ item: itemName, color: color });
    updateCartDisplay();
}

function updateCartDisplay() {
    const count = document.getElementById('cart-count');
    count.innerText = cart.length;
    count.style.display = cart.length > 0 ? 'block' : 'none';
}

window.toggleCart = function() {
    const modal = document.getElementById('cart-modal');
    const itemsDiv = document.getElementById('cart-items');
    
    if (modal.classList.contains('active')) {
        modal.classList.remove('active');
    } else {
        // Build cart HTML
        if (cart.length === 0) {
            itemsDiv.innerHTML = 'Your cart is empty.';
        } else {
            itemsDiv.innerHTML = cart.map((c, i) => `
                <div class="cart-item">
                    <span>${c.item} <br><small style="color:#888">${c.color}</small></span>
                    <button onclick="removeFromCart(${i})" style="background:none;border:none;color:red;cursor:pointer;">&times;</button>
                </div>
            `).join('');
        }
        modal.classList.add('active');
    }
}

window.removeFromCart = function(index) {
    cart.splice(index, 1);
    updateCartDisplay();
    toggleCart(); // Refresh modal
    setTimeout(toggleCart, 0); // Hack to keep it open
}

window.checkout = function() {
    if (cart.length === 0) return;
    
    let text = "I would like to order:\n";
    cart.forEach(c => {
        text += `- ${c.item} (${c.color})\n`;
    });
    
    navigator.clipboard.writeText(text).then(() => {
        alert("Order copied to clipboard! Paste it in your message.");
    });
}

init();

</script>

<script>
window.setTab = function(t) {
    document.querySelectorAll('.grid').forEach(g => g.classList.remove('active'));
    document.getElementById(`${t}-grid`).classList.add('active');
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    const buttons = document.querySelectorAll('.nav-btn');
    for (let btn of buttons) {
        if(btn.innerText.toLowerCase().includes(t.substring(0,4))) {
            btn.classList.add('active');
        }
    }
}
</script>
</body>
</html>
